<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Forest</title>
        <link rel="icon" type="image/svg" href="/images/favicon.svg">
        <link rel="stylesheet" href="https://dfcsoftware.github.io/theme/css/main.css" type="text/css" />
        <!-- <link rel="stylesheet" href="/theme/css/main.css" type="text/css" /> -->
        <link href="https://dfcsoftware.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Linux Home Administration Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <table>
                    <td><h1><a href="https://dfcsoftware.github.io/">Linux Home Administration</a></h1></td>
                    <td> <link href="/pagefind/pagefind-ui.css" rel="stylesheet" type="text/css">
<script src="/pagefind/pagefind-ui.js"></script>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script> </td>
                </table>
                <nav><ul>
                    <li><a href="https://dfcsoftware.github.io/category/forest.html">forest</a></li>
                    <li><a href="https://dfcsoftware.github.io/category/linux.html">linux</a></li>
                    <li><a href="https://dfcsoftware.github.io/category/writing.html">writing</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
    <h1 class="entry-title">Forest</h1>
    
    <h1 id="forest-administration-system">Forest Administration System</h1>
<ul>
<li>Finally got my alerts working, so when a host goes haywire I get an alert on the Phone and Cloud, with E-Mail as backup.</li>
</ul>
<p>Hope this helps, <br>
-- Don</p>
<hr>
<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#forest-administration-system">Forest Administration System</a></li>
<li><a href="#quick-start">Quick Start</a><ul>
<li><a href="#on-controller-host">On Controller host</a></li>
<li><a href="#on-each-host">On Each Host</a></li>
<li><a href="#on-controller-host_1">On Controller host</a></li>
</ul>
</li>
<li><a href="#concepts">Concepts</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#schedule-alertsh-in-cron">Schedule alert.sh in cron</a></li>
<li><a href="#copy-ssh-keys-to-remote">Copy ssh keys to remote</a></li>
<li><a href="#alert-functions">Alert Functions</a><ul>
<li><a href="#default-is-to-send-an-e-mail-if-limits-are-exceeded">Default is to send an e-mail if limits are exceeded</a></li>
</ul>
</li>
<li><a href="#nextcloud-flow-notifications">NextCloud Flow Notifications</a></li>
<li><a href="#savelogsh">savelog.sh</a></li>
<li><a href="#logsh-log-watcher">log.sh - Log Watcher</a></li>
<li><a href="#trouble-resolution">Trouble Resolution</a><ul>
<li><a href="#armv7l-debian-10">armv7l Debian 10</a></li>
</ul>
</li>
<li><a href="#files">Files</a></li>
</ul>
</div>
<hr>
<p>alert.sh and log.sh are meant to run a few times per hour
and send alerts if watch thresholds are exceeded.</p>
<ul>
<li>alert.sh - Usually runs on one host and monitors other hosts, using a normal user ssh tunnel.</li>
<li>log.sh - Usually runs on each host as root.</li>
</ul>
<p>When any new file is uploaded into the
 <em>new alert user</em> space, an entry will be written
  to the NextCloud Conversation <name> with the name and link
  to that file.</p>
<p>On your Phone you can install NextCloud Talk, log in 
  as the new alert user and recieve notifications.
  Bonus: Your watch will alert you too!</p>
<p>On your Phone you can install NextCloud Sync, log in 
  as the new alert user and read notification files.</p>
<h1 id="quick-start">Quick Start</h1>
<h2 id="on-controller-host">On Controller host</h2>
<ul>
<li>If you do not have a controller host, just untar the files in ~/forest,</li>
</ul>
<p>otherwise deploy:</p>
<div class="highlight"><pre><span></span><code>   a. ~/forest/bin/deploy.sh first-time &lt;host&gt;
</code></pre></div>

<h2 id="on-each-host">On Each Host</h2>
<ul>
<li>Install (Dependencies: make gcc)</li>
</ul>
<div class="highlight"><pre><span></span><code>   a. cd ~/forest/install/db
      1) unzip oracle_berkely_DB...zip
      2) cd db-18.1.40/build_unix
      3) ../dist/configure
      4) make
      5) sudo make install
      6) rm -r db-18.1.40/ when done to save space
   b. cd ~/forest/install/
      1) tar -xvf nbs.tar
      2) cd nbs
      3) make clean
      4) make
   c. cd ~/forest/install/
      1) tar -xvf retail.tar
      2) cd retail
      3) make clean
      4) make
   d. cd ~/forest/install/
      1) tar -xvf cron.tar
      2) cd cron
      3) make clean
      4) make
   e. cd ~/forest
      1) ln -s /home/bob/forest/config/ /home/bob/.config/forest/
         #     ^ install location       ^ user home/.config/ 
      2) sudo mkdir /root/.config
         sudo ln -s /home/bob/forest/config/forest.txt /root/.config/forest.txt
         #          ^ install location                 ^ root home/.config/ 
   f. cd ~/forest/install/
      1) install.sh
      2) backup_links.sh
</code></pre></div>

<h2 id="on-controller-host_1">On Controller host</h2>
<ul>
<li>Configure and Deploy Configuration</li>
</ul>
<div class="highlight"><pre><span></span><code>   a. Create ~/forest/config/config.&lt;host&gt; parameters using examples in config/samples
   b. Create alert function config parameters (df.&lt;host&gt;, logwatch.&lt;host&gt;, util.&lt;host&gt;, etc)
       in ~/forest/config/ using examples in config/samples
   c. Create ~/forest/config/hosts.&lt;host&gt; file using example in config/samples
   d. Create ~/forest/config/cron.&lt;host&gt; schedule using example in config/samples
   f. Deploy configuration files to &lt;host&gt;
      1) ~/forest/bin/deploy.sh host &lt;host&gt;
      2) On the **target** &lt;host&gt; : Schedule the jobs: ~/forest/bin/schedule.sh
</code></pre></div>

<blockquote>
<p><strong>All</strong> configuration changes need to be done on the controller host, then deploy.sh to &lt;host&gt;, or else the next deploy will overwrite them.</p>
</blockquote>
<ul>
<li>Check Alerts, Jobs, and Watch Real-time stats</li>
</ul>
<div class="highlight"><pre><span></span><code>   a. ~/forest/bin/watch.sh - Watch alert functions run
   b. ~/forest/bin/react.sh - See alerts and log entries, and react on them
   c. ~/forest/bin/jobs.sh - Check scheduled cronjobs
      1) backup_home.sh
      2) backup_db.sh
      3) cert_expire.sh
      4) more...
</code></pre></div>

<blockquote>
<p>Schedule will wait for the duration of the specified forward date and time, <strong>at the time it is run</strong>. If daylight savings runs <strong>in-between</strong> the schedule execution time for this job and run time for this job , it does <strong>not</strong> change the wait time. For instance, in the fall, we fall back one hour, so instead of running at 8am the job will run at 7am; however the next runs will be at 8am as specified.</p>
</blockquote>
<h1 id="concepts">Concepts</h1>
<p>The Forest implements ssh 'doors' to other hosts of the forest using alarms.sh for automated watching from the controller host.</p>
<p>Conceptually, during a door invocation the client thread that issues the door procedure call migrates to the server process associated with the door, and starts executing the procedure while in the address space of the server. When the service procedure is finished, a door return operation is performed and the thread migrates back to the client's address space with the results, if any, from the procedure call. </p>
<h1 id="installation">Installation</h1>
<ul>
<li>Download</li>
</ul>
<p><a href="https://github.com/dfcsoftware/watch">https://github.com/dfcsoftware/watch</a></p>
<ul>
<li>or - clone</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/dfcsoftware/watch
</code></pre></div>

<p>Copy all files to ~/forest, or whatever directory you like, 
just change this documents' references of </p>
<div class="highlight"><pre><span></span><code>/home/bob
</code></pre></div>

<p>to </p>
<div class="highlight"><pre><span></span><code>_your_ directory.
</code></pre></div>

<p>Delete any lines in files /etc/issue and /etc/issue.net as they will interfere with function monitors doing ssh into a host causing alerts every time.</p>
<p>Files: /etc/issue, /etc/issue.net</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-i
$<span class="w"> </span>&gt;<span class="w"> </span>/etc/issue
$<span class="w"> </span>&gt;<span class="w"> </span>/etc/issue.net
</code></pre></div>

<h1 id="configuration">Configuration</h1>
<p>deploy.sh will create a config directory structure:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.config/forest
</code></pre></div>

<p>Create config file:</p>
<p>File: ~/.config/forest/config.\&lt;host&gt;</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">CLOUD_USER</span><span class="o">=&lt;</span><span class="n">nextcloud</span><span class="w"> </span><span class="n">user</span><span class="o">&gt;</span>
<span class="k">export</span><span class="w"> </span><span class="n">CLOUD_PASS</span><span class="o">=</span><span class="s2">&quot;&lt;nextcloud password&gt;</span>
<span class="k">export</span><span class="w"> </span><span class="n">CLOUD_DIR</span><span class="o">=</span><span class="n">alert</span>
<span class="k">export</span><span class="w"> </span><span class="n">CLOUD_SERVER</span><span class="o">=</span><span class="s2">&quot;https://www.example.com/nextcloud&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">CLOUD_LOG</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">bob</span><span class="o">/</span><span class="n">forest</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">cloud</span><span class="o">.</span><span class="n">log</span>
<span class="k">export</span><span class="w"> </span><span class="n">LOCAL_DIR</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">bob</span><span class="o">/</span><span class="n">forest</span>
<span class="k">export</span><span class="w"> </span><span class="n">SSH_USER</span><span class="o">=</span><span class="n">bob</span>
<span class="k">export</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">BerkeleyDB</span><span class="o">.</span><span class="mf">18.1</span><span class="o">/</span><span class="n">lib</span><span class="p">:</span><span class="o">$</span><span class="n">LD_LIBRARY_PATH</span>
</code></pre></div>

<ul>
<li>Make sure the LOCAL_DIR/alert exists</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_DIR</span><span class="si">}</span>/alert
</code></pre></div>

<ul>
<li>Make sure CLOUD_LOG is writeable</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>touch<span class="w"> </span><span class="si">${</span><span class="nv">CLOUD_LOG</span><span class="si">}</span>
</code></pre></div>

<ul>
<li>Create an hosts.txt list of hosts to monitor</li>
</ul>
<p>File: ~/.config/forest/hosts.txt</p>
<div class="highlight"><pre><span></span><code>#                  ssh  Remote       Remote           Backup   Function
#       Host       Port Script        Home             Home    Monitors
# ---------------- ---- ------ ---------------------- ------  ----------------------------
   vm1              22    0    /home/bob                1      df util memory 0
   vm2              23    1    /home/sam                0      df 0    memory 0
#
# Remote Script: 1=run moniter script that is on remote machine 
#                0=run monitor script on local, through ssh tunnel
# Function Monitors: Forest script to run. 0 = skip.
# Backup Home: 1=yes, 0=no
</code></pre></div>

<h1 id="schedule-alertsh-in-cron">Schedule alert.sh in cron</h1>
<p>i.e.: every 20 minutes</p>
<p>File: /etc/cron.d/alert </p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">alert</span><span class="w"> </span><span class="n">analysis</span>
<span class="n">SHELL</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="k">PATH</span><span class="o">=/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span>
<span class="n">MAILTO</span><span class="o">=</span><span class="ss">&quot;bob@bob.com&quot;</span>
<span class="o">*/</span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bob</span><span class="o">/</span><span class="n">forest</span><span class="o">/</span><span class="n">alert</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>

<h1 id="copy-ssh-keys-to-remote">Copy ssh keys to remote</h1>
<p>If remote monitoring is desired; </p>
<ul>
<li>Generate and copy the <em>linux</em> ssh keys.</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh-key-gen
$<span class="w"> </span>ssh-copy-id<span class="w"> </span>&lt;remote<span class="w"> </span>hosts&gt;
</code></pre></div>

<blockquote>
<p>Make sure the directory leading up to the remote destination has 755 permissions, and the final home directory is 700.</p>
</blockquote>
<p>The remote desination must have the ~/.ssh directory, with chmod 700</p>
<h1 id="alert-functions">Alert Functions</h1>
<p>This is a seperate file for each functional alert, and sometimes host.</p>
<blockquote>
<p>Remote Hosts need their <em>own</em> config file(s)</p>
</blockquote>
<ul>
<li>On the Remote Host(s):</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.config/forest
</code></pre></div>

<p>Example of <strong>df</strong> functional monitor. Each script will describe it's own.</p>
<p>File:  ~/.config/forest/df.<hostname></p>
<div class="highlight"><pre><span></span><code>Usage-Percent-Limit   File-System        Mount-Point
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="mf">34</span><span class="w">                    </span><span class="s">&quot;/dev/mmcblk1p2&quot;</span><span class="w">   </span><span class="s">&quot;/&quot;</span>
<span class="mf">38</span><span class="w">                    </span><span class="s">&quot;/dev/mmcblk1p1&quot;</span><span class="w">   </span><span class="s">&quot;/boot/firmware&quot;</span><span class="w"> </span>
<span class="mf">16</span><span class="w">                    </span><span class="s">&quot;/dev/md0&quot;</span><span class="w">         </span><span class="s">&quot;/mnt/raid1&quot;</span>
</code></pre></div>

<p>Dependencies:</p>
<ul>
<li>Performance Co-Pilot - <a href="https://pcp.io/">https://pcp.io/</a></li>
</ul>
<blockquote>
<p>dnf=RedHat; apt=Debian</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>pcp<span class="w"> </span>cockpit-pcp<span class="w"> </span>python3-pcp<span class="w"> </span><span class="c1"># default from cockpit web install</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>pcp<span class="w"> </span>cockpit-pcp<span class="w"> </span>python3-pcp<span class="w"> </span><span class="c1"># default from cockpit web install</span>
<span class="c1">#   - Systemd Services:</span>
<span class="c1">#     pmcd.service</span>
<span class="c1">#     pmlogger.service</span>
<span class="c1">#     pmie.service</span>
<span class="c1">#     pmproxy.service</span>
<span class="c1">#</span>
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>pcp-export-pcp2json<span class="w">         </span><span class="c1"># pcp2json</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>pcp-export-pcp2json<span class="w">         </span><span class="c1"># pcp2json</span>
<span class="c1">#     Debian 11 may need to add;</span>
<span class="c1">#      File: /etc/apt/sources.list.d/unstable.list</span>
<span class="c1">#       deb http://deb.debian.org/debian/ unstable main</span>
<span class="c1">#     Also may need to run: pip install requests</span>
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>pcp-system-tools<span class="w">            </span><span class="c1"># pmrep</span>
<span class="c1">#</span>
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>jq<span class="w">                          </span><span class="c1"># json parser</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>jq<span class="w">                          </span><span class="c1"># json parser</span>
<span class="c1">#</span>
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>jc<span class="w">                          </span><span class="c1"># json commands</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>jc<span class="w">                          </span><span class="c1"># json commands</span>
<span class="c1">#</span>
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>ncdu<span class="w">                        </span><span class="c1"># Text-based disk usage viewer</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>ncdu<span class="w">                        </span><span class="c1"># Text-based disk usage viewer</span>
<span class="c1">#</span>
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>nmon<span class="w">                        </span><span class="c1"># Text-based system utilization viewer</span>
$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nmon<span class="w">                        </span><span class="c1"># Text-based system utilization viewer</span>
</code></pre></div>

<h2 id="default-is-to-send-an-e-mail-if-limits-are-exceeded">Default is to send an e-mail if limits are exceeded</h2>
<p>To stop E-Mail, add a SEND_MAIL export to the config.txt file.</p>
<ul>
<li>0 = NO</li>
<li>1 = YES</li>
</ul>
<p>File: ~/.config/forest/config.$HOST</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span>
<span class="k">export</span><span class="w"> </span><span class="n">SEND_MAIL</span><span class="o">=</span><span class="mi">0</span>
<span class="o">~</span>
</code></pre></div>

<h1 id="nextcloud-flow-notifications">NextCloud Flow Notifications</h1>
<ul>
<li>Create <em>new alert user</em> in NextCloud</li>
<li>Add the NextCloud server as SERVER in ~/.config/forest/config.txt</li>
<li>Add the NextCloud user as CLOUD_USER in ~/.config/forest/config.txt</li>
<li>
<p>Add the NextCloud user's password as CLOUD_PASS in ~/.config/forest/config.txt</p>
</li>
<li>
<p>As the <em>new alert user</em> in NextCloud;</p>
</li>
<li>Go to Talk<ul>
<li>Create a new group Conversation <name></li>
</ul>
</li>
<li>Go to Files and create a new alert directory<ul>
<li>Add it as the CLOUD_DIR to ~/.config/forest/config.txt</li>
</ul>
</li>
<li>Go to Personal Settings &gt; Flow<ul>
<li>Add a new flow <em>Write to conversasion</em> (blue)</li>
<li>When: File created</li>
<li>and: File size (upload) is greater than 0 MB</li>
<li>-&gt; Write to conversasion using the<ul>
<li>Conversation <name> created above</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Reference: </p>
<ul>
<li><a href="https://github.com/nextcloud/flow_notifications">https://github.com/nextcloud/flow_notifications</a></li>
<li><a href="/watch.html#configuration">Example config.txt</a></li>
</ul>
<h1 id="savelogsh">savelog.sh</h1>
<p>This is used to save off several copies of the last sync.sh process sending alerts to the NextCloud server.</p>
<blockquote>
<p>The logs are better viewed using the <em>lnav</em> Linu package. <code>lnav ~/forest/log/</code></p>
</blockquote>
<p>This is released on many OS packages, but not all,
so it is included here. Thanks very much to the original authors!</p>
<p>Reference:</p>
<ul>
<li><a href="https://launchpad.net/ubuntu/xenial/+package/debianutils">https://launchpad.net/ubuntu/xenial/+package/debianutils</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/xenial/en/man8/savelog.8.html">https://manpages.ubuntu.com/manpages/xenial/en/man8/savelog.8.html</a></li>
<li><a href="https://opensource.apple.com/source/uucp/uucp-10/uucp/contrib/savelog.sh.auto.html">https://opensource.apple.com/source/uucp/uucp-10/uucp/contrib/savelog.sh.auto.html</a></li>
<li><a href="https://rhel.pkgs.org/8/lux/uucp-1.07-65.el8.lux.x86_64.rpm.html">https://rhel.pkgs.org/8/lux/uucp-1.07-65.el8.lux.x86_64.rpm.html</a></li>
</ul>
<h1 id="logsh-log-watcher">log.sh - Log Watcher</h1>
<p>This script runs as root on each node to search for Never Before Seen (NBS) entries in a log file.
It needs to be scheduled in cron.</p>
<p>The flow is:</p>
<ol>
<li>cron runs log.sh</li>
</ol>
<p>File: /etc/cron.d/logwatcher</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nf">Log</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Watcher</span>
<span class="k">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="nl">sysstat</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span>
<span class="n">MAILTO</span><span class="o">=</span><span class="ss">&quot;bob@bob.com&quot;</span>
<span class="err">#</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="nf">Log</span><span class="w"> </span><span class="n">watcher</span>
<span class="o">*/</span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bob</span><span class="w">  </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bob</span><span class="o">/</span><span class="n">forest</span><span class="o">/</span><span class="nf">log</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span>
</code></pre></div>

<ol>
<li>log.sh reads config file ~/.config/forest/logwatch.\&lt;hostname&gt;</li>
</ol>
<p>Up to two filters may be specified.</p>
<p>File: logwatch.vm7</p>
<div class="highlight"><pre><span></span><code><span class="c1"># File: logwatch.vm7</span>
<span class="c1">#           DB                      File                               Alert  Email          Filter </span>
<span class="c1"># ------------------------- ----------------------------------------- ------ ------ -----------------------------------#</span>
<span class="n">apache</span><span class="o">-</span><span class="n">access</span><span class="w">                </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="w">               </span><span class="n">N</span><span class="w">      </span><span class="n">Y</span><span class="w">     </span><span class="n">geturl</span><span class="o">.</span><span class="n">pl</span><span class="w"> </span><span class="n">skip_local_ips</span><span class="o">.</span><span class="n">sh</span>
<span class="n">apache</span><span class="o">-</span><span class="n">error</span><span class="w">                 </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="w">                </span><span class="n">Y</span><span class="w">      </span><span class="n">Y</span><span class="w">     </span><span class="n">geturl</span><span class="o">.</span><span class="n">pl</span>
<span class="n">apache</span><span class="o">-</span><span class="n">other_vhosts_access</span><span class="w">   </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">other_vhosts_access</span><span class="o">.</span><span class="n">log</span><span class="w">  </span><span class="n">Y</span><span class="w">      </span><span class="n">Y</span><span class="w">     </span><span class="n">geturl</span><span class="o">.</span><span class="n">pl</span>
</code></pre></div>

<ol>
<li>New lines in File are read by retail, filtered by any and all Filters supplied.</li>
<li>DB is checked if this has been seen before and can be ignored.</li>
<li>Any remainging lines are sent to the alert directory and an Email sent, if Y in config.txt.</li>
<li>A sync for new alert files is done, sending new files to the cloud (NextCloud).</li>
<li>NextCloud will send a Talk alert to the CLOUD_USER for new files. These are viewable on a Phone or Watch, if running the Talk app.</li>
</ol>
<p>The following software packages have to be installed and compiled locally:
 * Berkerly DB - <a href="https://www.oracle.com/database/technologies/related/berkeleydb-downloads.html#">https://www.oracle.com/database/technologies/related/berkeleydb-downloads.html#</a></p>
<blockquote>
<p>Re-directs to oracle: <a href="https://www.oracle.com/database/technologies/related/berkeleydb-downloads.html#">https://www.oracle.com/database/technologies/related/berkeleydb-downloads.html#</a>  Need to log into oracle, download (via-download manager or wget.sh script proveded)</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">~/</span><span class="n">forest</span><span class="o">/</span><span class="n">install</span><span class="o">/</span><span class="n">db</span>
<span class="o">$</span><span class="w"> </span><span class="n">unzip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">download</span><span class="o">&gt;</span>
<span class="o">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">:</span><span class="w"> </span><span class="n">db</span><span class="o">-</span><span class="mf">18.1</span><span class="o">.</span><span class="mi">40</span>
</code></pre></div>

<ul>
<li>To perform a standard UNIX build of Berkeley DB; <ol>
<li>Change to the build_unix directory</li>
<li>Enter the following two commands:</li>
</ol>
</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>../dist/configure
$<span class="w"> </span>make
</code></pre></div>

<ul>
<li>This will build the Berkeley DB library.</li>
<li>To install the Berkeley DB library, enter the following command:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
</code></pre></div>

<ul>
<li>Add/Create
     File: ${CONFIG_DIR}/config.${HOSTNAME}</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">BerkeleyDB</span><span class="o">.</span><span class="mf">18.1</span><span class="o">/</span><span class="n">lib</span>
</code></pre></div>

<ul>
<li>Never Before Seen (NBS) - <a href="http://ranum.com/security/computer_security/code/nbs.tar">http://ranum.com/security/computer_security/code/nbs.tar</a></li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/forest/install
$<span class="w"> </span>tar<span class="w"> </span>-xvf<span class="w"> </span>install/nbs.tar
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>nbs
$<span class="w"> </span>make<span class="w"> </span>clean
$<span class="w"> </span>make<span class="w"> </span>all
</code></pre></div>

<ul>
<li>Retail - <a href="https://github.com/mbucc/retail">https://github.com/mbucc/retail</a></li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/forest/install
$<span class="w"> </span>tar<span class="w"> </span>-xvf<span class="w"> </span>install/retail.tar
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>retail
$<span class="w"> </span>make<span class="w"> </span>clean
$<span class="w"> </span>make
</code></pre></div>

<p>Install nbs and retail:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/forest/install/
$<span class="w"> </span>install.sh
</code></pre></div>

<p>Refer to the log.sh script for more instructions.</p>
<p>Reference: </p>
<ul>
<li>Marcus Ranum <a href="http://ranum.com/security/computer_security/code/index.html">http://ranum.com/security/computer_security/code/index.html</a></li>
<li><a href="../E-Mail_Relay#logwatcher">Logwatcher.sh</a></li>
</ul>
<h1 id="trouble-resolution">Trouble Resolution</h1>
<h2 id="armv7l-debian-10">armv7l Debian 10</h2>
<p>The pmlogger systemd daemon had issues being installed, and the following log instructions solved it.</p>
<div class="highlight"><pre><span></span><code><span class="nv">Aug</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">11</span>:<span class="mi">07</span>:<span class="mi">39</span><span class="w"> </span><span class="nv">bob</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w"> </span><span class="nv">systemd</span>[<span class="mi">1</span>]:<span class="w"> </span><span class="nv">Starting</span><span class="w"> </span><span class="nv">LSB</span>:<span class="w"> </span><span class="nv">Control</span><span class="w"> </span><span class="nv">pmlogger</span><span class="w"> </span><span class="ss">(</span><span class="nv">the</span><span class="w"> </span><span class="nv">performance</span><span class="w"> </span><span class="nv">metrics</span><span class="w"> </span><span class="nv">logger</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">PCP</span><span class="ss">)</span>...
<span class="nv">Aug</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">11</span>:<span class="mi">07</span>:<span class="mi">43</span><span class="w"> </span><span class="nv">bob</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w"> </span><span class="nv">pmlogger</span>[<span class="mi">913</span>]:<span class="w"> </span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">pmlogger</span>:<span class="w"> </span><span class="nv">Warning</span>:<span class="w"> </span><span class="nv">Performance</span><span class="w"> </span><span class="nv">Co</span><span class="o">-</span><span class="nv">Pilot</span><span class="w"> </span><span class="nv">archive</span><span class="w"> </span><span class="nv">logger</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">permanently</span><span class="w"> </span><span class="nv">enabled</span>.
<span class="nv">Aug</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">11</span>:<span class="mi">07</span>:<span class="mi">43</span><span class="w"> </span><span class="nv">bob</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w"> </span><span class="nv">pmlogger</span>[<span class="mi">913</span>]:<span class="w">     </span><span class="nv">To</span><span class="w"> </span><span class="nv">enable</span><span class="w"> </span><span class="nv">pmlogger</span>,<span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">following</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">root</span>:
<span class="nv">Aug</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">11</span>:<span class="mi">07</span>:<span class="mi">44</span><span class="w"> </span><span class="nv">bob</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w"> </span><span class="nv">pmlogger</span>[<span class="mi">913</span>]:<span class="w">          </span><span class="nv">update</span><span class="o">-</span><span class="nv">rc</span>.<span class="nv">d</span><span class="w"> </span><span class="o">-</span><span class="nv">f</span><span class="w"> </span><span class="nv">pmlogger</span><span class="w"> </span><span class="nv">remove</span>
<span class="nv">Aug</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">11</span>:<span class="mi">07</span>:<span class="mi">44</span><span class="w"> </span><span class="nv">bob</span>.<span class="nv">example</span>.<span class="nv">com</span><span class="w"> </span><span class="nv">pmlogger</span>[<span class="mi">913</span>]:<span class="w">          </span><span class="nv">update</span><span class="o">-</span><span class="nv">rc</span>.<span class="nv">d</span><span class="w"> </span><span class="nv">pmlogger</span><span class="w"> </span><span class="nv">defaults</span><span class="w"> </span><span class="mi">94</span><span class="w"> </span><span class="mi">06</span>
</code></pre></div>

<h1 id="files">Files</h1>
<div class="highlight"><pre><span></span><code><span class="p">.</span>
<span class="o">|--</span><span class="w"> </span><span class="nx">Readme</span><span class="p">.</span><span class="nx">md</span>
<span class="o">|--</span><span class="w"> </span><span class="nx">Readme</span><span class="p">.</span><span class="nx">sh</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">alert</span><span class="w">   </span><span class="o">*</span><span class="w"> </span><span class="nx">Monitered</span><span class="w"> </span><span class="nx">events</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">bin</span><span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nx">Executables</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">config</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="nx">Configurations</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">filters</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">Log</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">selection</span><span class="w"> </span><span class="nx">criteria</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">include</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">Compiler</span><span class="w"> </span><span class="nx">includes</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">Installation</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">scripts</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">lib</span><span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nx">Compiled</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">libraries</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">log</span><span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nx">Log</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">Forest</span><span class="w"> </span><span class="nx">activities</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">share</span><span class="w">   </span><span class="o">*</span><span class="w"> </span><span class="nx">Compiler</span><span class="w"> </span><span class="nx">documentation</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">status</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="nx">Log</span><span class="w"> </span><span class="nx">watcher</span><span class="w"> </span><span class="nx">databases</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">test</span><span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="nx">Unit</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="nx">scripts</span>
<span class="o">|-+</span><span class="w"> </span><span class="nx">tmp</span><span class="w">     </span><span class="o">*</span><span class="w"> </span><span class="nx">Temporary</span><span class="w"> </span><span class="nx">files</span>
<span class="err">`</span><span class="o">--</span><span class="w"> </span><span class="nx">version</span><span class="p">.</span><span class="nx">txt</span>
</code></pre></div>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://lwn.net/">Linux Weekly News</a></li>
                            <li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
                            <li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
                            <li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
                            <li><a href="https://www.thefarside.com/">The Far Side</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://dfcsoftware.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://fosstodon.org/@LinuxintheHouse">Feedback</a></li>
                            <li><a href="https://fosstodon.org/@LinuxintheHouse.rss">Mastodon RSS feed</a></li>
                            <li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
                            <li><a href="/author/don-cohoon.html">Created by: Don Cohoon</a></li>
                            <li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License </a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>
                Site by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, via <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </p><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                <p> Version:  3.46 </p>
        </footer><!-- /#contentinfo -->

</body>
</html>