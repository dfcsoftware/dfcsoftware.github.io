<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
	<title>E-MailRelay</title>
	<meta name="date" content="2023-01-25 10:16"/>
	<meta name="modified" content="2024-04-19 9:30"/>
	<meta name="tags" content="email"/>
	<meta name="author" content="Don Cohoon"/>
	<meta name="summary" content="The following diagrams are what this document will accomplish. The challenge is to obtain and keep a good reputation that other E-Mail handlers around the world will accept. Otherwise your messages will be dumped in the trash can (SPAM) or sent back to you (bounced)."/>
	<meta name="license" content="'[CC-BY-NC-SA 4.0](http://creativecommons.org/licenses/by-nc-sa/4.0/)'"/>
<meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/linux-in-house/common.css" type="text/css" />
</head>
<body>

<p><a href="/linux-in-house/"><h1>Linux in House</h1></a></p>

<link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
window.addEventListener('DOMContentLoaded', (event) => {
      new PagefindUI({ element: "#search", showSubResults: true });
});
</script>

<blockquote>
<p><a href="/linux-in-house/linux/welcome.html">Welcome Back My Friends</a></p>
</blockquote>

<h1 id="e-mailrelay">E-Mail Relay</h1>

<p>The following diagrams are what this document will accomplish. The challenge is to obtain and keep a good reputation that other E-Mail handlers around the world will accept. Otherwise your messages will be dumped in the trash can (SPAM) or sent back to you (bounced).</p>

<hr />

<div class="TOC">

<ul>
<li><a href="#e-mailrelay">E-Mail Relay</a></li>
<li><a href="#overview">Overview</a>
<ul>
<li><a href="#outgoing:relayfrominsidehome">Outgoing: Relay from Inside Home</a></li>
<li><a href="#outgoing:relayfromoutsidehome">Outgoing: Relay from Outside Home</a></li>
<li><a href="#incoming:transportfrominternet">Incoming: Transport from Internet</a></li>
</ul>
</li>
<li><a href="#vps">VPS</a></li>
<li><a href="#securevpsonyour-domain.org">Secure VPS on <em>your-domain.org</em></a>
<ul>
<li><a href="#checknetwork">Check Network</a></li>
<li><a href="#updatepackagerepository">Update Package Repository</a></li>
<li><a href="#createnewusers">Create New User(s)</a></li>
<li><a href="#sethostanddomain">Set Host and Domain</a></li>
<li><a href="#setdateandtime">Set Date and Time</a></li>
<li><a href="#monitorcrackattempts">Monitor crack attempts</a>
<ul>
<li><a href="#installfirewallandfail2banonyour-domain.org">Install firewall and fail2ban on <em>your-domain.org</em></a>
<ul>
<li><a href="#addrulesfore-mailsmtpandsmtps.">Add rules for E-Mail smtp and smtps.</a></li>
<li><a href="#configurefail2ban">Configure fail2ban</a>
<ul>
<li><a href="#securepostfix">Secure postfix</a></li>
<li><a href="#securessh">Secure ssh</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#logmonitorsonyour-domain.org">Log Monitors on <em>your-domain.org</em></a>
<ul>
<li><a href="#installlogwatch">Install Logwatch</a></li>
<li><a href="#installlogcheck:">Install Logcheck:</a></li>
</ul>
</li>
<li><a href="#logwatcher">LogWatcher</a>
<ul>
<li><a href="#create">Create</a></li>
<li><a href="#schedule">Schedule</a></li>
<li><a href="#filters">Filters</a></li>
<li><a href="#makethescriptsexecutable">Make the Scripts Executable</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#apacheinstallenableonyour-domain.org">Apache install (enable) on <em>your-domain.org</em></a>
<ul>
<li><a href="#addssl">Add SSL</a></li>
</ul>
</li>
<li><a href="#dnsregistraryour-domain.org">DNS Registrar (your-domain.org)</a>
<ul>
<li><a href="#dnsupdates">DNS Updates</a>
<ul>
<li><a href="#createptrrecord">Create PTR Record</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#certbot-certificatemanagementforletsencrypt">certbot - Certificate Management for Let&#8217;s Encrypt</a>
<ul>
<li><a href="#install">Install</a></li>
<li><a href="#configure">Configure</a></li>
</ul>
</li>
<li><a href="#apachedisable">Apache (disable)</a></li>
<li><a href="#postfix-e-mailtransportagent">postfix - E-Mail Transport Agent</a>
<ul>
<li><a href="#installonyour-domain.org">Install on <em>your-domain.org</em></a></li>
<li><a href="#configureonyour-domain.org">Configure on <em>your-domain.org</em></a>
<ul>
<li><a href="#completemain.cffilecontents">Complete main.cf file contents</a></li>
<li><a href="#completerelaycontentsofmaster.cf">Complete relay contents of master.cf</a></li>
</ul>
</li>
<li><a href="#reloadconfig">Reload Config</a></li>
<li><a href="#definitionsofmasterfields">Definitions of master fields</a></li>
</ul>
</li>
<li><a href="#proxypostfixusingtransportmapsforincomingmailsonyour-domain.org">Proxy Postfix using Transport Maps for Incoming Mails on <em>your-domain.org</em></a>
<ul>
<li><a href="#configure">Configure</a></li>
<li><a href="#transportdefinitions">Transport Definitions</a></li>
<li><a href="#makeitadatabase">Make it a database</a></li>
<li><a href="#reloadconfig">Reload Config</a></li>
</ul>
</li>
<li><a href="#proxypostfixrelayforsmtpoutgoingmails">Proxy Postfix Relay for SMTP Outgoing Mails</a>
<ul>
<li><a href="#changemxrecordsinno-ip.comfrommail1.no-ip.comtomail.your-domain.org">Change MX records in <em>no-ip.com</em> from mail1.no-ip.com to mail.your-domain.org</a></li>
<li><a href="#changetxtspfrecordinno-ip.comfromnoipto:">Change TXT spf record in <em>no-ip.com</em> from noip, to:</a></li>
<li><a href="#changeyour-domain.compostfixmain.cfrelaytoyour-domain.org">Change <em>your-domain.com</em> postfix/main.cf relay to your-domain.org</a></li>
<li><a href="#addyour-domain.orgunixloginonhostyour-domain.com">Add your-domain.org unix login on host <em>your-domain.com</em></a></li>
<li><a href="#enabletlsonyour-domain.org">Enable TLS on <em>your-domain.org</em></a>
<ul>
<li><a href="#or">OR</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clientsmailuseragentsmua">Clients Mail User Agents (MUA)</a>
<ul>
<li><a href="#muaconnectiondefinitions">MUA Connection Definitions</a>
<ul>
<li><a href="#readmail">Read Mail</a></li>
<li><a href="#sendmail">Send Mail</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#debug">Debug</a>
<ul>
<li><a href="#ifmailqueuesuptosendresendyoucancheckandcleartoqueue">If mail queues up to send/resend, you can check and clear to queue</a>
<ul>
<li><a href="#listmailqueue">List mail queue</a></li>
<li><a href="#lookatmessage">Look at message</a></li>
<li><a href="#flushqueue">Flush queue</a></li>
<li><a href="#or">or</a></li>
</ul>
</li>
<li><a href="#installamailuseragentforssh">Install a Mail User Agent for ssh</a></li>
<li><a href="#installanicesshcapablelogreader">Install a nice ssh capable log reader</a></li>
<li><a href="#installapackagemarkingtool">Install a package marking tool</a></li>
<li><a href="#certificateexpirationcheck">Certificate Expiration Check</a></li>
</ul>
</li>
<li><a href="#configuringspfpolicyagent">Configuring SPF Policy Agent</a>
<ul>
<li><a href="#installrequiredpackages:">Install required packages:</a></li>
<li><a href="#testspf">Test SPF</a></li>
<li><a href="#configurespf">Configure SPF</a></li>
<li><a href="#restartpostfix.">Restart Postfix.</a></li>
<li><a href="#debugspf">Debug SPF</a></li>
<li><a href="#blockdomainsande-mailaddressesusingpostfixaccess">Block Domains and E-Mail Addresses using Postfix access</a></li>
</ul>
</li>
<li><a href="#settingupdkim">Setting up DKIM</a>
<ul>
<li><a href="#installopendkim">Install OpenDKIM</a></li>
<li><a href="#configureopendkim">Configure OpenDKIM</a>
<ul>
<li><a href="#mapdomainstokeys">Map Domains to Keys</a></li>
<li><a href="#hoststoignorewhenverifyingsignatures">Hosts to ignore when verifying signatures</a></li>
<li><a href="#asetofinternalhostswhosemailshouldbesigned">A set of internal hosts whose mail should be signed</a></li>
</ul>
</li>
<li><a href="#createsigningtablekeytableandtrustedhostsfile">Create Signing Table, Key Table and Trusted Hosts File</a>
<ul>
<li><a href="#checkdirectorystructureforopendkim">Check directory structure for OpenDKIM</a></li>
<li><a href="#createthesigningtable">Create the signing table</a></li>
<li><a href="#createthekeytable">Create the key table</a></li>
<li><a href="#createthetrustedhostsfile">Create the trusted hosts file</a></li>
</ul>
</li>
<li><a href="#generateprivatepublickeypair">Generate Private/Public Keypair</a>
<ul>
<li><a href="#createaseparatefolderforthedomain.">Create a separate folder for the domain.</a></li>
<li><a href="#generatekeysusingopendkim-genkeytool.">Generate keys using opendkim-genkey tool.</a></li>
</ul>
</li>
<li><a href="#publishyourpublickeyindnsrecords">Publish Your Public Key in DNS Records</a></li>
<li><a href="#testdkimkey">Test DKIM Key</a></li>
<li><a href="#connectpostfixtoopendkim">Connect Postfix to OpenDKIM</a>
<ul>
<li><a href="#setsockettolocal">Set Socket to local</a></li>
<li><a href="#addopendkimtopostfixmain.cf">Add openDKIM to Postfix main.cf</a></li>
<li><a href="#restartopendkimandpostfixservice">Restart opendkim and postfix service</a></li>
</ul>
</li>
<li><a href="#spfanddkimcheck">SPF and DKIM Check</a></li>
<li><a href="#postfixcan’tconnecttoopendkim">Postfix Can’t Connect to OpenDKIM</a></li>
<li><a href="#configurationerrorinemailclient">Configuration Error in Email Client</a>
<ul>
<li><a href="#wrongsettings">Wrong Settings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#testingemailscoreandplacement">Testing Email Score and Placement</a></li>
<li><a href="#whatisdmarc">What is DMARC?</a>
<ul>
<li><a href="#createdmarcrecord">Create DMARC Record</a>
<ul>
<li><a href="#dmarcrecordtxt">DMARC Record TXT</a></li>
</ul>
</li>
<li><a href="#dmarcrecordcheck">DMARC Record Check</a></li>
<li><a href="#dmarcteste-mail">DMARC Test E-Mail</a></li>
<li><a href="#interpretadmarcreport">Interpret a DMARC Report</a>
<ul>
<li><a href="#madeforhumansbyahuman">Made for Humans, by a Human</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#social">Social</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

<hr />

<h1 id="overview">Overview</h1>

<p>E-Mail Relay is a combination of:</p>

<ul>
<li> IP Address Reputation</li>
<li> DNS assignment of an E-Mail name to that IP Address</li>
<li> Certificates for Authentication and Encryption</li>
<li> Login protection against Open Spam Relays</li>
</ul>

<p>A VPS (Virtual Private Server) is a way to obtain a good IP address reputation, and it will stay the same number over time. There are many to choose from, some already have bad reputations and constant streams of hackers knocking on the network, while others have a good reputation and just a few random hackers on your doorstep. Choose wisely!</p>

<ul>
<li> MUA - Mail User Agent; Thunderbird, Evolution - Read, send, user interface</li>
<li> MDA - Mail Delivery Agent; Dovecot - File and organize mail, authorize user accounts</li>
<li> MTA - Mail Transport Agent; Postfix - Move messsages from one network stop to another</li>
</ul>

<h2 id="outgoing:relayfrominsidehome">Outgoing: Relay from Inside Home</h2>

<figure>
<img src="/linux-in-house/images/graph-email-relay.svg" alt="Send Mail from Home" />
<figcaption>Send Mail from Home</figcaption>
</figure>

<h2 id="outgoing:relayfromoutsidehome">Outgoing: Relay from Outside Home</h2>

<figure>
<img src="/linux-in-house/images/graph-email-relay2.svg" alt="Send Mail outside Home" />
<figcaption>Send Mail outside Home</figcaption>
</figure>

<h2 id="incoming:transportfrominternet">Incoming: Transport from Internet</h2>

<figure>
<img src="/linux-in-house/images/graph-email-relay3.svg" alt="Recieve Mail" />
<figcaption>Recieve Mail</figcaption>
</figure>

<p>This document will use:</p>

<ul>
<li> your-domain.org : The E-Mail <em>relay</em> we are setting up in this document (VPS_Postfix)</li>
<li> your-domain.com : The E-Mail <em>server</em> set up in the prior document (Home_Postfix)</li>
</ul>

<p>Recommendation:</p>

<ul>
<li> [ ] Bring up a host on a VPS somewhere, and use the <a href="/linux-in-house/setup-server.html">Setup Server</a> instructions to secure it.</li>
<li> [ ] Get a domain name and certificate set up and working.</li>
<li> [ ] Install postfix/dovecot combo and relay to your main E-Mail host. Test sending out mail too.</li>
<li> [ ] Install and configure SPF Policy Agent. Test it and make sure all is well.</li>
<li> [ ] Install and configure OpenDKIM to sign your E-Mails. Ensure it works good.</li>
</ul>

<h1 id="vps">VPS</h1>

<p>Create a VPS Cloud Server, less than $10 month for 1GB RAM, 30GB Disk, 1 CPU, 2TB Bandwidth month.</p>

<p>Criteria:</p>

<ol>
<li>IP address reputation. May have to test drive to determine IP address. Lookup tools:</li>
</ol>

<ul>
<li> <a href="https://github.com/nitefood/asn">https://github.com/nitefood/asn</a></li>
<li> <a href="https://www.ipqualityscore.com/ip-reputation-check">https://www.ipqualityscore.com/ip-reputation-check</a></li>
</ul>

<ol>
<li>Working control panel. Check online reviews, or test drive. Make sure every button works. Extra points if they allow firewall changes and creating a PTR record.</li>
<li>Current OS release. Check references below.</li>
<li>Support availability and response agreements. Test creating a support ticket. Check references below.</li>
<li>Low cost, check references below.</li>
</ol>

<ul>
<li><a href="https://cloud.ionos.com/servers/vps#packages">https://cloud.ionos.com/servers/vps#packages</a></li>
<li><a href="https://www.hostwinds.com/vps/unmanaged-linux">https://www.hostwinds.com/vps/unmanaged-linux</a></li>
<li><a href="https://www.inmotionhosting.com/cloud-vps">https://www.inmotionhosting.com/cloud-vps</a></li>
<li><a href="https://www.kamatera.com/Products/201/Cloud_Servers">https://www.kamatera.com/Products/201/Cloud_Servers</a></li>
</ul>

<h1 id="securevpsonyour-domain.org">Secure VPS on <em>your-domain.org</em></h1>

<blockquote>
<p>Change your root password <em>IMMEDIATELY</em>. Hackers know the algorithm and expliot it from creation time to change time.</p>
</blockquote>

<blockquote>
<p>Change the ssh port from 22 (File: /etc/ssh/sshd_config). Hackers know that port and constantly attack it.</p>
</blockquote>

<h2 id="checknetwork">Check Network</h2>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#check-your-network">Network Check</a></li>
</ul>

<h2 id="updatepackagerepository">Update Package Repository</h2>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#update-package-repository">Update Packages</a></li>
</ul>

<h2 id="createnewusers">Create New User(s)</h2>

<blockquote>
<p>The Linux mail user can be &lt;name&gt;@example.com, to keep things clear.</p>
</blockquote>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#new-user-and-group-to-use">New Users</a></li>
</ul>

<h2 id="sethostanddomain">Set Host and Domain</h2>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#set-your-host-and-domain-names">Host and Domain</a></li>
</ul>

<h2 id="setdateandtime">Set Date and Time</h2>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#time-control">Date and Time Settings</a></li>
</ul>

<h2 id="monitorcrackattempts">Monitor crack attempts</h2>

<h3 id="installfirewallandfail2banonyour-domain.org">Install firewall and fail2ban on <em>your-domain.org</em></h3>

<p>Be sure the <em>system firewall</em> is installed and also the &#8220;Block Bad Actors&#8221; <em>firewall.sh</em> script.</p>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#firewall">Firewall</a></li>
</ul>

<h4 id="addrulesfore-mailsmtpandsmtps.">Add rules for E-Mail smtp and smtps.</h4>

<ul>
<li>Debian:</li>
</ul>

<pre><code>$ sudo apt-get install fail2ban mailutils
</code></pre>

<ul>
<li>RedHat:</li>
</ul>

<pre><code>$ sudo dnf install fail2ban mailx
</code></pre>

<p>Make sure firewall rules open port smtp(25) and smtps(465):</p>

<ul>
<li>Debian</li>
</ul>

<pre><code>$ sudo ufw allow 25
$ sudo ufw allow 465
$ sudo ufw status numbered

     To                         Action      From
     --                         ------      ----
[ 1] 22                         ALLOW IN    Anywhere                  
[ 2] 25                         ALLOW IN    Anywhere                  
[ 3] 465                        ALLOW IN    Anywhere                  
[ 4] 22 (v6)                    ALLOW IN    Anywhere (v6)             
[ 5] 25 (v6)                    ALLOW IN    Anywhere (v6)  

</code></pre>

<ul>
<li>RedHat</li>
</ul>

<pre><code>$ sudo firewall-cmd --add-service=smtp
 success
$ sudo firewall-cmd --add-service=smtps
 success
$ sudo firewall-cmd --list-services
  smtp smtps ssh
$ firewall-cmd --runtime-to-permanent
 success
$ firewall-cmd --reload
 success
</code></pre>

<h4 id="configurefail2ban">Configure fail2ban</h4>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#fail2ban-automatic-firewall-blocking">Fail2ban</a></li>
</ul>

<h5 id="securepostfix">Secure postfix</h5>

<p>File: /etc/fail2ban/jail.d/postfix.local</p>

<pre><code>[postfix]
enabled  = true
maxretry = 3
bantime = 1d
port     = smtp,465,submission

[postfix-sasl]
enabled  = true
maxretry = 3
bantime = 1d
port     = smtp,465,submission,imap,imaps,pop3,pop3s
</code></pre>

<p>File: /etc/fail2ban/jail.d/dovecot.local</p>

<pre><code>[dovecot]
enabled = true
port    = pop3,pop3s,imap,imaps,submission,465,sieve
logpath = /var/log/maillog
findtime = 1200
bantime = 1d
</code></pre>

<h5 id="securessh">Secure ssh</h5>

<p>File: /etc/fail2ban/jail.d/sshd.local</p>

<pre><code>[sshd]
port = XXXX
enabled = true
maxretry = 3
bantime = 1d
</code></pre>

<h3 id="logmonitorsonyour-domain.org">Log Monitors on <em>your-domain.org</em></h3>

<h4 id="installlogwatch">Install Logwatch</h4>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#logwatch-daily-alert-of-logging-activity">Logwatch</a></li>
</ul>

<h4 id="installlogcheck:">Install Logcheck:</h4>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<ul>
<li> <a href="/linux-in-house/setup-server.html#logcheck-mails-anomalies-in-the-system-logfiles-to-the-admin">Logcheck</a></li>
</ul>

<h3 id="logwatcher">LogWatcher</h3>

<h4 id="create">Create</h4>

<p>Put this script in the /root directory, and install the dependencies listed.</p>

<pre><code>#!/bin/bash
##############################################################################
#
# File: logwatcher.sh
#
# Purpose: Watch for interesting new things in log files and e-mail them
#
# Dependencies: 
#  * Debian:
#   apt-get install git clang zlib1g-dev
#  * RedHat:
#   dnf install git clang zlib-devel 
#
#   git clone https://github.com/mbucc/retail
#
# Author     Date     Description
# ---------- -------- --------------------------------------------------------
# D. Cohoon  Feb-2023 Created
##############################################################################
MAILTO=root
DIR=/root
OS=$(/usr/bin/hostnamectl|/usr/bin/grep 'Operating System'|/usr/bin/cut -d: -f2|/usr/bin/awk '{print $1}')
cd ${DIR}
#--------------
log_check () {
  OFFSET=${1}
  LOGFILE=${2}
  FILTER=${3}
  OUTPUT=$(/usr/bin/mktemp)
  /root/retail/retail -o ${OFFSET} ${LOGFILE} | ${FILTER} &gt;${OUTPUT}
  if [ -s ${OUTPUT} ]; then
    /bin/cat ${OUTPUT} | /usr/bin/mail -s &quot;Logwatcher.sh: ${OFFSET}&quot; ${MAILTO} 2&gt;/dev/null
  fi
  rm -rf ${OUTPUT}
}
#
#--------------
case ${OS} in
    AlmaLinux) 
        FAIL2BAN_LOG=/var/log/fail2ban.log
        POSTFIX_LOG=/var/log/maillog
        AUTH_LOG=/var/log/secure 
        ;;
    Ubuntu|Debian) 
        FAIL2BAN_LOG=/var/log/fail2ban.log
        POSTFIX_LOG=/var/log/syslog
        AUTH_LOG=/var/log/auth.log
        ;;
esac
#           Offset  Log File               Filter
#          -------- ---------------------  -------------------------
log_check .fail2ban &quot;${FAIL2BAN_LOG}&quot;      ${DIR}/filter_fail2ban.sh
#
log_check .postfix  &quot;${POSTFIX_LOG}&quot;       ${DIR}/filter_postfix.sh
#
log_check .sshd     &quot;${AUTH_LOG}&quot;          ${DIR}/filter_ssh.sh
#
log_check .dovecot  &quot;${AUTH_LOG}&quot;          ${DIR}/filter_dovecot.sh
</code></pre>

<h4 id="schedule">Schedule</h4>

<pre><code># cat /etc/cron.d/logwatcher 
# /etc/cron.d/logwatcher: crontab entries for the logwatcher.sh script

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

@reboot         root   /root/logwatcher.sh 
2 * * * *       root   /root/logwatcher.sh 

# EOF

</code></pre>

<h4 id="filters">Filters</h4>

<p>File: filter_fail2ban.sh</p>

<pre><code>/usr/bin/grep &quot;Ban&quot;
</code></pre>

<p>File: filter_postfix.sh</p>

<pre><code>/usr/bin/grep &quot;postfix&quot;|/usr/bin/grep 'disconnect from unknown'
</code></pre>

<p>File: filter_ssh.sh</p>

<pre><code>/usr/bin/grep &quot;ssh&quot; | /usr/bin/egrep &quot;Failed|invalid format&quot;
</code></pre>

<p>File: filter_dovecot.sh</p>

<pre><code>/usr/bin/grep &quot;dovecot&quot; | /usr/bin/grep &quot;authentication failure&quot;
</code></pre>

<h4 id="makethescriptsexecutable">Make the Scripts Executable</h4>

<pre><code>$ chmod 755 *.sh
</code></pre>

<p>Reference:</p>

<ul>
<li> Watch - <a href="/linux-in-house/watch.html">System Alerts</a></li>
</ul>

<h1 id="apacheinstallenableonyour-domain.org">Apache install (enable) on <em>your-domain.org</em></h1>

<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>

<p><a href="/linux-in-house/dns.html#install-a-web-server">Apache Web Server</a></p>

<p>Test it on:</p>

<pre><code>$ curl http://&lt;domain.name&gt;
</code></pre>

<h2 id="addssl">Add SSL</h2>

<ul>
<li>Debian</li>
</ul>

<pre><code>$ sudo ufw allow 443/tcp
</code></pre>

<ul>
<li>RedHat</li>
</ul>

<pre><code>$ sudo firewall-cmd --add-service=https
  success
$ sudo firewall-cmd --list-services
  http https smtp smtps ssh
$ sudo firewall-cmd --runtime-to-permanent
  success
$ sudo firewall-cmd --reload
  success
</code></pre>

<p>Change the default landing page to blank</p>

<p>File: /var/www/html/index.html</p>

<pre><code>&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&quot;main_page&quot;&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h1 id="dnsregistraryour-domain.org">DNS Registrar (your-domain.org)</h1>

<p>Register your own name.</p>

<ul>
<li><a href="https://godaddy.com">https://godaddy.com</a></li>
<li><a href="https://www.namecheap.com/">https://www.namecheap.com/</a></li>
<li><a href="https://www.domain.com/">https://www.domain.com/</a></li>
</ul>

<h3 id="dnsupdates">DNS Updates</h3>

<p>Create Advanced DNS records, using IP Address of VPS server:</p>

<p>HOST</p>

<pre><code>Type       Host        Value               TTL
---------- ----------- ------------------- ----
A Record   @           &lt;IP Address&gt;        Auto
A Record   mail        &lt;IP Address&gt;        Auto
TXT Record @           v=spf1 mx -all      Auto
</code></pre>

<p>MAIL</p>

<pre><code>Type       Host        Value               Priority TTL
---------- ----------- ------------------- -------- ----
MX Record  @           &lt;Domain Name&gt;       10       Auto
</code></pre>

<p>Lookup status via <code>dig -t &lt;Type&gt; &lt;Domain&gt;</code></p>

<pre><code>$ dig -t a +short &lt;Domain Name&gt;
123.123.123.123
$ dig -t mx +short &lt;Domain Name&gt;
10 &lt;Domain Name&gt;.
</code></pre>

<blockquote>
<p>To install dig:
<code>$ sudo apt-get install dnsutils</code>
<code>$ sudo dnf install bind-utils</code></p>
</blockquote>

<h4 id="createptrrecord">Create PTR Record</h4>

<p>Using the Control Panel on the VPS, update the PTR record. If they do not allow this, create a support ticket, they will do it then, just trying to limit spammers.</p>

<p>Test your PTR record. Using the IP Address, it should show your domain, proving you have control over the IP Address.</p>

<pre><code>dig -x 1.2.3.4
;; ANSWER SECTION:
1.2.3.4.in-addr.arpa. 86400 IN	PTR	mail.&lt;Domain Name&gt;.
</code></pre>

<h1 id="certbot-certificatemanagementforletsencrypt">certbot - Certificate Management for Let&#8217;s Encrypt</h1>

<p>To create and maintain LetsEncrypt certificates using Apache web server</p>

<h3 id="install">Install</h3>

<ul>
<li>The Debian Way</li>
</ul>

<pre><code>$ sudo systemctl unmask apache2
$ sudo systemctl enable apache2
$ sudo systemctl start apache2
$ sudo apt-get install certbot
$ sudo apt-get install python3-certbot-apache
</code></pre>

</div>

<ul>
<li>The RedHat Way</li>
</ul>

<pre><code>$ sudo systemctl unmask httpd
$ sudo systemctl enable httpd
$ sudo systemctl start httpd
$ sudo dnf install certbot
$ sudo dnf install python3-certbot-apache
</code></pre>

</div>

<pre><code>$ sudo certbot  plugins

Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
* apache
Description: Apache Web Server plugin
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: apache = certbot_apache._internal.entrypoint:ENTRYPOINT

* standalone
Description: Spin up a temporary webserver
Interfaces: IAuthenticator, IPlugin
Entry point: standalone = certbot._internal.plugins.standalone:Authenticator

* webroot
Description: Place files in webroot directory
Interfaces: IAuthenticator, IPlugin
Entry point: webroot = certbot._internal.plugins.webroot:Authenticator
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

</code></pre>

<h3 id="configure">Configure</h3>

<blockquote>
<p>Be sure to get certificates for the <em>domain</em> and <em>all subdomains</em> (hosts)</p>
</blockquote>

<pre><code>$ certbot  --apache -d your-domain.org -d mail.your-domain.org
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator apache, Installer apache
Enter email address (used for urgent renewal and security notices)
 (Enter 'c' to cancel): you@your-domain.org

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.3-September-21-2022.pdf. You must
agree in order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: y

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let's Encrypt project and the non-profit organization that
develops Certbot? We'd like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: y
Account registered.
No names were found in your configuration files. Please enter in your domain
name(s) (comma and/or space separated)  (Enter 'c' to cancel): your-domain.org
Requesting a certificate for your-domain.org
Performing the following challenges:
http-01 challenge for your-domain.org
Enabled Apache rewrite module
Waiting for verification...
Cleaning up challenges
Created an SSL vhost at /etc/apache2/sites-available/000-default-le-ssl.conf
Enabled Apache socache_shmcb module
Enabled Apache ssl module
Deploying Certificate to VirtualHost /etc/apache2/sites-available/000-default-le-ssl.conf
Enabling available site: /etc/apache2/sites-available/000-default-le-ssl.conf
Enabled Apache rewrite module
Redirecting vhost in /etc/apache2/sites-enabled/000-default.conf to ssl vhost in /etc/apache2/sites-available/000-default-le-ssl.conf

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Congratulations! You have successfully enabled https://your-domain.org
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Subscribe to the EFF mailing list (email: you@your-domain.org).

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/your-domain.org/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/your-domain.org/privkey.pem
   Your certificate will expire on 2023-05-08. To obtain a new or
   tweaked version of this certificate in the future, simply run
   certbot again with the &quot;certonly&quot; option. To non-interactively
   renew *all* of your certificates, run &quot;certbot renew&quot;
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</code></pre>

<h1 id="apachedisable">Apache (disable)</h1>

<p>Apache is not needed, so disable it to reduce threat footprint.</p>

<ul>
<li>The Debian Way</li>
</ul>

<pre><code>$ sudo systemctl stop apache2
$ sudo systemctl disable apache2
$ sudo systemctl mask apache2
$ sudo ufw status numbered
# -&gt; ufw delete &lt;n&gt; for ports 80 &amp; 443
</code></pre>

</div>

<ul>
<li>The RedHat Way</li>
</ul>

<pre><code>$ sudo systemctl stop httpd
$ sudo systemctl disable httpd
$ sudo systemctl mask httpd
$ sudo  firewall-cmd --remove-service=https
  success
$ sudo firewall-cmd --list-services
  http smtp smtps ssh
$ sudo  firewall-cmd --remove-service=http
  success
$ sudo firewall-cmd --list-services
  smtp smtps ssh
$ sudo firewall-cmd --runtime-to-permanent
  success
</code></pre>

</div>

<p>When the Let&#8217;s Encrypt Certificate expires, you will need to enable it again and open up ports.</p>

<h1 id="postfix-e-mailtransportagent">postfix - E-Mail Transport Agent</h1>

<p>Install postfix MTA and remove exim4, if it is installed. Postfix is more mature and full-featured.</p>

<p>TLS <a href="http://www.postfix.org/TLS_README.html">http://www.postfix.org/TLS_README.html</a></p>

<h3 id="installonyour-domain.org">Install on <em>your-domain.org</em></h3>

<ul>
<li>The Debian Way</li>
</ul>

<pre><code>$ sudo apt-get remove exim4-base
$ sudo apt-get install postfix
</code></pre>

</div>

<ul>
<li>The RedHat Way</li>
</ul>

<pre><code>$ sudo dnf remove exim
$ sudo dnf install postfix
</code></pre>

</div>

<h3 id="configureonyour-domain.org">Configure on <em>your-domain.org</em></h3>

<blockquote>
<ul>
<li>smtp -&gt; outgoing mail</li>
<li>smtpd &lt;- incoming mail (daemon)</li>
</ul>
</blockquote>

<h4 id="completemain.cffilecontents">Complete main.cf file contents</h4>

<!-- TOGGLE BUTTON -->

<div><label for="checkRedHat-31" class="togButton">Change for RedHat in main.cf</label></div>
<!-- CONTENT -->
<input type="checkbox" class="togCheckRedHat" id="checkRedHat-31"/>
<div class="togContentRedHat">

<pre><code>~
mydomain = your-domain.org
myorigin = $mydomain
#myorigin = /etc/mailname
~
</code></pre>

</div>
Also in RedHat: Log is in /var/log/maillog

<p>File main.cf</p>

<pre><code>#.........................................................................
#
# * smtpd &lt;- incoming mail (daemon)
#
smtpd_tls_cert_file = /etc/letsencrypt/live/your-domain.org/fullchain.pem
smtpd_tls_key_file  = /etc/letsencrypt/live/your-domain.org/privkey.pem
smtpd_use_tls = yes
smtpd_tls_security_level=may
smtpd_tls_auth_only = yes
smtpd_tls_loglevel = 1
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
#
# Enforce TLSv1.3 or TLSv1.2
#  smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
#  smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
#  smtp_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
#  smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
#
# Sending relays allowed only if:
# -&gt; you are on mynetworks
# -&gt; you are logged in
#  all others are deferred (temp error 4.x.x), 
#   like a permanent failure that won't go away
#   until 1) added to mynetworks, or 2) sasl authenticated
smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination

# Sending sasl auth from Dovecot
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes

# I am a relay to the world
relayhost = 

#.........................................................................
#
# * smtp  -&gt; outgoing mail 
#
smtp_tls_CApath=/etc/ssl/certs
smtp_tls_security_level=may
smtp_tls_loglevel = 1
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# Receiving transport table specifies a mapping from email addresses to 
#  message delivery  transports  and  next-hop  destinations. 
# (relay forwarding back out)
transport_maps = hash:/etc/postfix/transport
relay_domains = your-domain.com

# .org host
myhostname = mail.your-domain.org
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname

# Accept final destination mail for mail.your-domain.org, your-domain.org, or locals
mydestination = $myhostname, your-domain.org, localhost.your-domain.org, localhost
#.........................................................................

# Allow my host and the .com host to send (relay out)
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128  5.6.7.8
inet_interfaces = all
inet_protocols = ipv4

# Message restrictions
mailbox_size_limit = 0
message_size_limit = 52428800
header_size_limit = 4096000
recipient_delimiter = +

#compatibility_level = 2
</code></pre>

<h4 id="completerelaycontentsofmaster.cf">Complete relay contents of master.cf</h4>

<blockquote>
<p>No spaces between = sign</p>
</blockquote>

<p>File: master.cf</p>

<pre><code>~
# ==========================================================================
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (no)    (never) (100)
# ==========================================================================
smtp      inet  n       -       y       -       -       smtpd
smtps     inet  n       -       y       -       -       smtpd
    -o syslog_name=postfix/smtps
    -o smtpd_tls_wrappermode=yes
    -o smtpd_sasl_auth_enable=yes
    -o milter_macro_daemon_name=ORIGINATING
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
# The preceeding 4 lines require SSL login for relay to internet (.com -&gt; .org -&gt; internet)
#  need cert for mail.your-domain.org, your-domain.org; 
#  and sasl_passwd for mail.your-domain.org unix login on www.your-domain.com
~
:wq
</code></pre>

<h3 id="reloadconfig">Reload Config</h3>

<pre><code>$ sudo postfix reload
</code></pre>

<h3 id="definitionsofmasterfields">Definitions of master fields</h3>

<ul>
<li><p>service</p>

<p>This refers to the name in /etc/services and matches a name to a port number.</p></li>
<li><p>type</p>

<p>Internet or pipe. Internet is a network communication, while pipe is a special file on disk that echos input as output used for local communication only.</p></li>
<li><p>private</p>

<p>Access to some components is restricted to the Postfix system itself. This column is marked with a y for private access (the default) or an n for public access. inet components must be marked n for public access, since network sockets are necessarily available to other processes.</p></li>
<li><p>unpriv</p>

<p>Postfix components run with the least amount of privilege required to accomplish their tasks. They set their identity to that of the unprivileged account specified by the mail_owner parameter. The default installation uses postfix. The default value of y for this column indicates that the service runs under the normal unprivileged account. Services that require root privileges are marked with n.</p></li>
<li><p>chroot</p>

<p>Many components can be chrooted for additional security. The chroot location is specified in the queue_directory parameter in main.cf. The default is for a service to run in a chroot environment; however, the normal installation marks all components with an n so they are not chrooted when they run. Chrooting a service adds a level of complexity that you should thoroughly understand before taking advantage of the added security. See Section 4.8 later in the chapter for more information on running Postfix services in a chroot environment.</p></li>
<li><p>wakeup</p>

<p>Some components require a wake-up timer to kick them into action at the specified interval. The pickup daemon is one example. At its default setting of 60 seconds, the master daemon wakes it up every minute to see if any new messages have arrived in the maildrop queue. The other services that require a wake-up are the qmgr and flush daemons. A question mark character (?) can be added at the end of the time to indicate that a wake-up event should be sent only if the component is being used. A 0 for the time interval indicates that no wake-up is required. The default is 0, since only the three components mentioned require a wake-up. The values as they are set in the Postfix distribution should work for almost all situations. Other services should not have wakeup enabled.</p></li>
<li><p>maxproc</p>

<p>Limits the number of processes that can be invoked simultaneously. If unspecified here, the value comes from the parameter default_process_limit in main.cf, which is set to 100 by default. A setting of 0 means no process limit. You may want to adjust maxproc settings if you run Postfix on a system with limited resources or you want to optimize different aspects of the system.</p></li>
<li><p>command</p>

<p>The actual command used to execute a service is listed in the final column. The command is specified with no path information, because it is expected to be in the Postfix daemon directory specified by the daemon_directory parameter in main.cf. By default the directory is /usr/libexec/postfix. All of the Postfix commands can be specified with one or more -v options to turn on increasingly more verbose logging information, which can be helpful if you must troubleshoot a problem. You can also enable information for a debugging program with the -D option. See the DEBUG_README file that comes with the Postfix distribution for more information on debugging if necessary.</p></li>
</ul>

<h1 id="proxypostfixusingtransportmapsforincomingmailsonyour-domain.org">Proxy Postfix using Transport Maps for Incoming Mails on <em>your-domain.org</em></h1>

<p>A postfix transport(5) table allows one domain to transfer incoming SMTP messages to another domain. For instance the .org domain will transfer all .com messages to the .com domain automatically.</p>

<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for transporting from .org to .com</p>
</blockquote>

<h2 id="configure">Configure</h2>

<p>File: /etc/postfix/main.cf:</p>

<pre><code>~
    transport_maps = hash:/etc/postfix/transport
~
</code></pre>

<p>Set postfix to accept mails for the .com addresse.</p>

<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for transporting from .org to .com</p>
</blockquote>

<p>File: /etc/postfix/main.cf:</p>

<pre><code>~
    relay_domains = example.com
~
</code></pre>

<h2 id="transportdefinitions">Transport Definitions</h2>

<p>Create a transport table to redirect all mail for one domain as well as mail for &#8220;user@mydomain.org&#8221; to another domain. You can also specify another port, to bypass port 25 restrictions.</p>

<p>File: /etc/postfix/transport</p>

<pre><code>    example.com          smtp:[example.com]:10025
    user@mydomain.org   smtp:[example.com]:10025
</code></pre>

<h2 id="makeitadatabase">Make it a database</h2>

<p>Create a postmap database from the flat ascii file.</p>

<pre><code>$ sudo postmap /etc/postfix/transport
</code></pre>

<h2 id="reloadconfig">Reload Config</h2>

<p>Finally, reload the postfix configuration files.</p>

<pre><code>$ sudo postfix reload
</code></pre>

<p>Reference:</p>

<ul>
<li> <a href="https://serverfault.com/questions/67134/proxy-mail-to-different-smtp-server-with-postfix">https://serverfault.com/questions/67134/proxy-mail-to-different-smtp-server-with-postfix</a></li>
<li> <a href="http://www.postfix.org/postconf.5.html#permit_auth_destination">http://www.postfix.org/postconf.5.html#permit_auth_destination</a></li>
<li> <a href="http://www.postfix.org/transport.5.html">http://www.postfix.org/transport.5.html</a></li>
</ul>

<h1 id="proxypostfixrelayforsmtpoutgoingmails">Proxy Postfix Relay for SMTP Outgoing Mails</h1>

<p>To send mails from a non-standard port, use a .com domain to relay to a .org domain, with the .org relay set to = (basically null) and the .com relay = &#8230;org.</p>

<h3 id="changemxrecordsinno-ip.comfrommail1.no-ip.comtomail.your-domain.org">Change MX records in <em>no-ip.com</em> from mail1.no-ip.com to mail.your-domain.org</h3>

<p>Log into noip.com, go to DNS and select <code>*.your-domain.com</code>. At the bottom of the page you can change the mail1.no-ip.com record to mail.your-domain.org.</p>

<p>Don&#8217;t forget to save and lookup the new value using <code>dig -t MX your-domain.com</code>.</p>

<h3 id="changetxtspfrecordinno-ip.comfromnoipto:">Change TXT spf record in <em>no-ip.com</em> from noip, to:</h3>

<p><em>For your-domain.com domain</em>:</p>

<table>
<colgroup>
<col />
<col />
<col />
<col />
<col />
</colgroup>

<thead>
<tr>
	<th> Type </th>
	<th> Host </th>
	<th> Value </th>
	<th> Priority </th>
	<th> TTL </th>
</tr>
</thead>

<tbody>
<tr>
	<td> MX Record </td>
	<td> @ </td>
	<td> your-domain.org </td>
	<td> 10 </td>
	<td> Auto </td>
</tr>
<tr>
	<td> TXT Record </td>
	<td> @ </td>
	<td> v=spf1 mx a include:your-domain.org <sub>all</sub> </td>
	<td> </td>
	<td> Auto </td>
</tr>
</tbody>
</table>

<blockquote>
<p>SPF tools:
<a href="https://www.dynu.com/en-US/NetworkTools/SPFGenerator#">https://www.dynu.com/en-US/NetworkTools/SPFGenerator#</a>
<a href="https://mxtoolbox.com/spf.aspx">https://mxtoolbox.com/spf.aspx</a></p>

<ul>
<li>Try not to add more than required, you might create a potential infinite loop. 8</li>
</ul>
</blockquote>

<p>On the <em>DNS for .com</em>, create a TXT record like this</p>

<pre><code>&quot;v=spf1 mx a include:&lt;Domain of .org&gt; ~all&quot;
</code></pre>

<p>Basically is says &#8220;In the DNS TXT record for email destination you@your-domain.com, validate the MX IP Address of DNS record for domain your-domain.com&#8221; for <sub>all</sub>; When an SPF record includes <sub>all</sub> (softfail qualifier), receiving servers typically accept messages from senders that aren&#8217;t in your SPF record, but mark them as suspicious.</p>

<p>Reference: <a href="http://www.open-spf.org/FAQ/Common_mistakes/#list-domains">http://www.open-spf.org/FAQ/Common_mistakes/#list-domains</a></p>

<p>Test e-mail results from google:</p>

<pre><code>~
ARC-Authentication-Results: i=1; mx.google.com;
       spf=pass (google.com: domain of you@your-domain.com designates 1.2.3.4 as permitted sender) smtp.mailfrom=you@your-domain.com
Received: from mail.your-domain.org (mail.your-domain.org. [1.2.3.4])
        by mx.google.com with ESMTPS id o6-20020a0dcc06000000b005363cf948basi2222119ywd.61.2023.02.25.05.45.43
        for &lt;you.name@gmail.com&gt;
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sat, 25 Feb 2023 05:45:44 -0800 (PST)
Received-SPF: pass (google.com: domain of you@your-domain.com designates 1.2.3.4 as permitted sender) client-ip=1.2.3.4;
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of you@your-domain.com designates 1.2.3.4 as permitted sender) smtp.mailfrom=you@your-domain.com
Received: from www.your-domain.com (unknown [5.6.7.8])
	by mail.your-domain.org (Postfix) with ESMTPSA id 9071FD3C93
	for &lt;you.name@gmail.com&gt;; Sat, 25 Feb 2023 13:45:43 +0000 (UTC)
~
</code></pre>

<h3 id="changeyour-domain.compostfixmain.cfrelaytoyour-domain.org">Change <em>your-domain.com</em> postfix/main.cf relay to your-domain.org</h3>

<p>File: /etc/postfix/main.cf</p>

<pre><code>relayhost = [mail.your-domain.org]:465
</code></pre>

<h3 id="addyour-domain.orgunixloginonhostyour-domain.com">Add your-domain.org unix login on host <em>your-domain.com</em></h3>

<p>File: /etc/postfix/sasl/sasl_passwd</p>

<pre><code>[mail.your-domain.org]:465 you:********
</code></pre>

<p>Create a postfix DB from flat file</p>

<pre><code>$ sudo postmap /etc/postfix/sasl/sasl_passwd
</code></pre>

<h3 id="enabletlsonyour-domain.org">Enable TLS on <em>your-domain.org</em></h3>

<p>TLS requires certificate(s) and SASL login verification.</p>

<p>The logon verification is done by Docevot using the userdb setting <em>pam</em>[1], while the postfix SASL verification uses a unix pipe <em>/var/spool/postfix/private/auth</em> to talk to Dovecot.</p>

<p>The encryption is enabled by Let&#8217;s Encrypt certificates (one for the <em>domain</em>, another for each <em>subdomain</em>), over the smtps (post 465) network socket to the client. The master.cf file -o settings override the main.cf settings, ensuring a connection is <em>only</em> accepted if:</p>

<ul>
<li> TLS certificate is working and accepted by both parties, on port 465</li>
<li> SASL logon passes, using postfix -&gt; Dovecot -&gt; pam login.</li>
</ul>

<h5 id="or">OR</h5>

<ul>
<li> The incoming IP address is part of mynetwork, on port 25</li>
</ul>

<blockquote>
<p>Plugable Authentication Module (PAM) is the Linux login method for users</p>
</blockquote>

<p>Two Steps:</p>

<ol>
<li>install dovecot</li>
</ol>

<ul>
<li>The Debian Way</li>
</ul>

<pre><code>$ sudo apt-get install dovecot-core
</code></pre>

</div>

<ul>
<li>The RedHat Way</li>
</ul>

<pre><code>$ sudo dnf install dovecot
</code></pre>

</div>

<p>Add <code>login</code> to dovecot auth</p>

<p>File: /etc/dovecot/conf.d/10-auth.conf</p>

<pre><code>~
     auth_mechanisms = plain login
~
:wq
</code></pre>

<p>Set the certificates to letsencrypt, require ssl and prefer server of the ciphers</p>

<p>File: /etc/dovecot/conf.d/10-ssl.conf</p>

<pre><code>~
    ssl = required
~
    ssl_cert = &lt;/etc/letsencrypt/live/your-domain.org/fullchain.pem
    ssl_key = &lt;/etc/letsencrypt/live/your-domain.org/privkey.pem
~
    # Comment out default certs
~
    ssl_prefer_server_ciphers = yes
~
:wq
</code></pre>

<p>Set up a local unix pipe for dovecot and postfix to communicate this authorization data, under the service_auth set of brackets.</p>

<p>File: /etc/dovecot/conf.d/10-master.conf</p>

<pre><code>~
  unix_listener /var/spool/postfix/private/auth {
    group = postfix
    mode = 0660
    user = postfix
  }
~
:wq
</code></pre>

<ol>
<li>Set the receiving certificates in Postfix, require TLS using Dovecot.</li>
</ol>

<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for relaying TLS on .org to the Internet</p>
</blockquote>

<p>File: /etc/postfix/main.cf</p>

<pre><code>~
#smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
#smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_cert_file = /etc/letsencrypt/live/your-domain.org/fullchain.pem
smtpd_tls_key_file  = /etc/letsencrypt/live/your-domain.org/privkey.pem
smtpd_use_tls = yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_security_level=may

~

# sasl auth from Dovecot
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes

~
:wq
</code></pre>

<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for relaying TLS on .org to the Internet</p>
</blockquote>

<p>File: /etc/postfix/master.cf</p>

<pre><code>~
# ==========================================================================
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (no)    (never) (100)
# ==========================================================================
smtp      inet  n       -       y       -       -       smtpd
smtps     inet  n       -       y       -       -       smtpd
    -o syslog_name=postfix/smtps
    -o smtpd_tls_wrappermode=yes
    -o smtpd_sasl_auth_enable=yes
    -o milter_macro_daemon_name=ORIGINATING
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
# The preceeding 4 lines require SSL login for relay to internet (.com -&gt; .org -&gt; internet)
#  need cert for mail.your-domain.org, your-domain.org; 
#  and sasl_passwd for mail.your-domain.org unix login on www.your-domain.com
~
:wq
</code></pre>

<ul>
<li>Make sure port 465 (smtps) is opened by Postfix</li>
</ul>

<p>Open on localhost</p>

<pre><code># nmap -sT -O localhost
Starting Nmap 7.70 ( https://nmap.org ) at 2023-02-19 16:46 EST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.00019s latency).
Other addresses for localhost (not scanned): ::1
Not shown: 992 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh   &lt;-
25/tcp  open  smtp  &lt;-
80/tcp  open  http  &lt;-
110/tcp open  pop3
143/tcp open  imap
443/tcp open  https &lt;-
465/tcp open  smtps &lt;-
993/tcp open  imaps
995/tcp open  pop3s
</code></pre>

<blockquote>
<p>RedHat 9 /etc/services shows port 465 as <em>urd</em>, so <strong>I switched the urd and alias smtps</strong>.</p>
</blockquote>

<pre><code># grep smtps /etc/services
smtps           465/tcp           urd   # URL Rendesvous Directory for SSM / SMTP over SSL (TLS)
</code></pre>

<p>Now ss looks better:</p>

<pre><code># ss -ltap
State        Recv-Q    Send-Q        Local Address:Port            Peer Address:Port     Process                                                   
LISTEN       0         128                 0.0.0.0:ssh                  0.0.0.0:*         users:((&quot;sshd&quot;,pid=1314,fd=3))                           
LISTEN       0         100                 0.0.0.0:smtp                 0.0.0.0:*         users:((&quot;master&quot;,pid=23736,fd=13))                       
LISTEN       0         100                 0.0.0.0:imaps                0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=41))                      
LISTEN       0         100                 0.0.0.0:pop3s                0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=23))                      
LISTEN       0         100                 0.0.0.0:pop3                 0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=21))                      
LISTEN       0         100                 0.0.0.0:imap                 0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=39))                      
LISTEN       0         100                 0.0.0.0:smtps                0.0.0.0:*         users:((&quot;master&quot;,pid=23736,fd=17))                       
ESTAB        0         52            1.2.3.4:ssh                   5.6.7.8:44958     users:((&quot;sshd&quot;,pid=2402,fd=4),(&quot;sshd&quot;,pid=2278,fd=4))    
LISTEN       0         128                    [::]:ssh                     [::]:*         users:((&quot;sshd&quot;,pid=1314,fd=4))                           
LISTEN       0         100                    [::]:imaps                   [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=42))                      
LISTEN       0         100                    [::]:pop3s                   [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=24))                      
LISTEN       0         100                    [::]:pop3                    [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=22))                      
LISTEN       0         100                    [::]:imap                    [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=40))   
</code></pre>

<p>Open to internet</p>

<pre><code>$ sudo firewall-cmd --list-services
  http https smtp smtps ssh
</code></pre>

<h1 id="clientsmailuseragentsmua">Clients Mail User Agents (MUA)</h1>

<p>These are the programs where a human interface resides, and where everybody reads, sends, deletes, and manages their E-Mail. Names such as: Thunderbird, Evolution, Mutt, Gmail, Outlook, etc.</p>

<ul>
<li><p> Mail Transport Agents (MTA) <em>only</em> connect here. Do not connect your MUA to this port!</p></li>
<li><p> SMTP (port 25): This is an restricted relay port, defined on host example.org and controlled by the /etc/postfix/master.cf smtp definition. Only addresses in $mydestination will be accepted, and nothing else will be relayed in. The transport definition will forward to it&#8217;s list of addresses/domains. After a client is authenticated, it will be allowed to relay out on port 25. Process <em>master</em>, forked from postfix, performs this responsibility.</p>

<ul>
<li> -o smtpd_relay_restrictions=permit_sasl_authenticated,reject: means that only authenticated connections can relay out</li>
</ul></li>
<li><p> Client (MUA) connect here to <strong>SEND</strong> mail <em>only</em></p></li>
<li><p> SMTPS (port 465): This is defined on host example.org, and is always an encrypted port, controlled by the /etc/postfix/master.cf smtps definition. All authentications occur here. Process <em>master</em>, forked from postfix, performs this responsibility.</p>

<ul>
<li><p> -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject: means that only $mynetworks or authenticated connections can submit messages to be sent. MUA will connect using this rule.</p></li>
<li><p> Authentication is done using /etc/dovecot/conf.d/10-auth.conf <em>auth_mechanism=login</em> definition, over unix pipe <em>unix_listener /var/spool/postfix/private/auth</em> declared in file /etc/dovecot/conf.d/10-master.conf. Linux PAM verification occurs using file /etc/pam.d/dovecot and <em>passdb{driver=pam}</em> in file /etc/dovecot/conf.d/auth-system.conf.ext.</p></li>
</ul></li>
</ul>

<p>Unix pipe for postfix to dovecot authenication of clients.</p>

<pre><code>$ sudo ls -l /var/spool/postfix/private/auth
srw-rw---- 1 postfix postfix 0 Feb 10 10:21 /var/spool/postfix/private/auth
</code></pre>

<ul>
<li> Client (MUA) connect here to <strong>READ/MANAGE</strong> mail <em>only</em>

<ul>
<li><p>IMAPS (port 993): This is defined on the example.com host Dovecot installation, file /etc/dovecot/conf.d/10-master.conf, section <em>service imap_listener imaps</em>. Process <em>imap</em>, forked from dovecot, performs this responsibility.</p></li>
<li><p> Authentication is done using /etc/dovecot/conf.d/10-auth.conf <em>auth_mechanism=plain</em> definition, over <em>unix_listener auth_userdb</em> declared in file /etc/dovecot/conf.d/10-master.conf. Linux PAM verification occurs using file /etc/pam.d/dovecot and <em>passdb{driver=pam}</em> in file /etc/dovecot/conf.d/auth-system.conf.ext.</p></li>
</ul></li>
</ul>

<blockquote>
<p>Port 587, aka: submission, is purposely ommited because it is a <em>partial encryption</em> called STARTTLS. This is deemed un-secure and not recommended.</p>
</blockquote>

<h3 id="muaconnectiondefinitions">MUA Connection Definitions</h3>

<h4 id="readmail">Read Mail</h4>

<ul>
<li> Server: mail.example.com</li>
<li> User: &lt;linux user defined on the <a href="/linux-in-house/e-mail.html#user-settings">E-Mail</a> .com host&gt;</li>
<li> Password: &lt;linux user password defined on the <a href="/linux-in-house/e-mail.html#user-settings">E-Mail</a> .com host&gt;</li>
<li> SSL: ON</li>
<li> Port: 993</li>
</ul>

<h4 id="sendmail">Send Mail</h4>

<ul>
<li> Server: smtp.example.org</li>
<li> User: &lt;linux user defined <a href="/linux-in-house/e-mailrelay.html#create-new-users">above</a> on the E-Mail .org host&gt;</li>
<li> Password: &lt;linux user password defined <a href="/linux-in-house/e-mailrelay.html#create-new-users">above</a> on the E-Mail .org host&gt;</li>
<li> SSL: ON</li>
<li> Port: 465</li>
</ul>

<h1 id="debug">Debug</h1>

<h2 id="ifmailqueuesuptosendresendyoucancheckandcleartoqueue">If mail queues up to send/resend, you can check and clear to queue</h2>

<h5 id="listmailqueue">List mail queue</h5>

<pre><code>mailq
</code></pre>

<h5 id="lookatmessage">Look at message</h5>

<pre><code>postcat -vq DCE2182DEA
</code></pre>

<h5 id="flushqueue">Flush queue</h5>

<pre><code>postsuper -d ALL deferred
</code></pre>

<h5 id="or">or</h5>

<pre><code>postqueue -f
</code></pre>

<blockquote>
<p>Cache files (send/receive) are in data_directory (/var/lib/postfix) as Berkley Databasees</p>
</blockquote>

<h2 id="installamailuseragentforssh">Install a Mail User Agent for ssh</h2>

<p>mutt is a nice local mail reader, for times when the network mail may not work, at least the local mail will.</p>

<pre><code>$ sudo apt-get install mutt
$ sudo dnf install mutt
</code></pre>

<h2 id="installanicesshcapablelogreader">Install a nice ssh capable log reader</h2>

<p>I like <em>lnav</em>. Just run <code>lnav</code> and by default it will read the syslog. Or run <code>lnav /var/log/mail.log</code>.</p>

<pre><code>$ sudo apt-get install lnav
$ sudo dnf install lnav
</code></pre>

<h2 id="installapackagemarkingtool">Install a package marking tool</h2>

<blockquote>
<p>Debian only: apt-clone will create a nice bundle of all your current packages. Save this off in case you have to re-build your server.</p>
</blockquote>

<pre><code>$ sudo apt-get install apt-clone
</code></pre>

<h2 id="certificateexpirationcheck">Certificate Expiration Check</h2>

<p>Run this every week/day in cron <code>/root/cert_expire.sh 2</code> to E-Mail you reminders before it expires.</p>

<p>File: ~/cert_expire.sh</p>

<pre><code>#!/bin/bash
# ----------------------------------------------------------------------
#
# File: cert_expire.sh
#
# Purpose: See what the expiration date is for Let's Encrypt Certificate
#
#
#  s_client : The s_client command implements a generic SSL/TLS client
#              which connects to a remote host using SSL/TLS.
#  -servername $DOM : Set the TLS SNI (Server Name Indication) extension
#                      in the ClientHello message to the given value.
#  -connect $DOM:$PORT : This specifies the host ($DOM) and optional
#                         port ($PORT) to connect to.
#  x509 : Run certificate display and signing utility.
#  -noout : Prevents output of the encoded version of the certificate.
#  -dates : Prints out the start and expiry dates of a TLS or SSL certificate.
#
# Don Cohoon - Jan 2023
# ----------------------------------------------------------------------
#
#
if [ $# -gt 0 ]; then
  A=${1}
else
  /usr/bin/echo &quot;1) E-Mail&quot;
  /usr/bin/echo &quot;2) File&quot;
  /usr/bin/echo &quot;3) Web&quot;
  /usr/bin/echo &quot;4) Local&quot;
  read A
fi
case ${A}
 in
   1)
	/usr/bin/echo &quot;REMINDER: Restart postfix and dovecot to enable new certs&quot;
	/usr/bin/echo &quot;=&gt; E-Mail Certificate: CTRL-C to exit&quot;
	#/usr/bin/openssl s_client -connect mail.your-domain.org:25 -starttls smtp 2&gt;/dev/null|/usr/bin/openssl x509 -noout -dates
	/usr/bin/openssl s_client -connect mail.your-domain.org:465  2&gt;/dev/null|/usr/bin/openssl x509 -noout -dates
	;;
   2)
	/usr/bin/echo &quot;=&gt; File Certificate&quot;
	sudo /usr/bin/openssl x509 -enddate -noout -in /etc/letsencrypt/live/your-domain.org/fullchain.pem
	;;
   3)
	/usr/bin/echo &quot;REMINDER: Restart apache2 and nginx to enable new certs&quot;
	/usr/bin/echo &quot;=&gt; www.your-domain.org Certificate: CTRL-C to exit&quot;
	/usr/bin/openssl s_client -servername your-domain.org -connect www.your-domain.org:443 2&gt;/dev/null | /usr/bin/openssl x509 -noout -dates
	;;
   4)
	/usr/bin/echo &quot;REMINDER: Restart apache2 and nginx to enable new certs&quot;
	/usr/bin/echo &quot;=&gt; Local Web Certificate: CTRL-C to exit&quot;
	/usr/bin/openssl s_client -connect localhost:443 | /usr/bin/openssl x509 -noout -dates
	;;
esac
</code></pre>

<h1 id="configuringspfpolicyagent">Configuring SPF Policy Agent</h1>

<p>We also need to tell our Postfix SMTP server to check for SPF record of incoming emails. This doesn’t help ensure outgoing email delivery but help with detecting forged incoming emails.</p>

<h2 id="installrequiredpackages:">Install required packages:</h2>

<ul>
<li> Debian</li>
</ul>

<pre><code>sudo apt install postfix-policyd-spf-python
</code></pre>

<ul>
<li> RedHat</li>
</ul>

<pre><code>sudo dnf install pypolicyd-spf
</code></pre>

<h2 id="testspf">Test SPF</h2>

<p>If you know the sender, recipient, and client_address, you can test them before turning SPF on in postfix.</p>

<blockquote>
<p>Must have blank line as last input for policyd-spf</p>
</blockquote>

<pre><code># Python Site Packages = /usr/lib/python3.9/site-packages/
# Source = /usr/lib/python3.9/site-packages/spf_engine/*
/usr/libexec/postfix/policyd-spf &lt;&lt;EOF
 request=smtpd_access_policy
 protocol_state=RCPT
 protocol_name=SMTP
 helo_name=ccpub6
 queue_id=hv8rp02v1sso
 instance=12345.6789
 sender=foo
 recipient=bar
 client_address=1.2.3.4
 client_name=bubba

EOF
</code></pre>

<h2 id="configurespf">Configure SPF</h2>

<p>Add the following lines at the end of the file, which tells Postfix to start the SPF policy daemon when it’s starting itself.</p>

<ul>
<li> Debian</li>
</ul>

<p>File: /etc/postfix/master.cf</p>

<pre><code>policyd-spf  unix  -       n       n       -       0       spawn
    user=policyd-spf argv=/usr/bin/policyd-spf
</code></pre>

<ul>
<li> Redhat</li>
</ul>

<p>File: /etc/postfix/master.cf</p>

<pre><code>policyd-spf  unix  -       n       n       -       0       spawn
    user=nobody argv=/usr/libexec/postfix/policyd-spf
</code></pre>

<p>Append the following lines at the end of the file. The first line specifies the Postfix policy agent timeout setting. The following lines will impose a restriction on incoming emails by rejecting unauthorized email and checking SPF record.</p>

<p>File: /etc/postfix/main.cf</p>

<pre><code>policyd-spf_time_limit = 3600
smtpd_recipient_restrictions =
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_unauth_destination,
   check_policy_service unix:private/policyd-spf
</code></pre>

<h2 id="restartpostfix.">Restart Postfix.</h2>

<pre><code>sudo systemctl restart postfix
</code></pre>

<p>Next time, when you receive an email from a domain that has an SPF record, you can see the SPF check results in the raw email header. The following header indicates the sender sent the email from an authorized host.</p>

<pre><code>Received-SPF: Pass (sender SPF authorized).
</code></pre>

<h2 id="debugspf">Debug SPF</h2>

<p>Config file, debug setting:</p>

<p>File: /etc/python-policyd-spf/policyd-spf.conf</p>

<pre><code>~
# level 1 is default
debugLevel = 5
~
:wq
</code></pre>

<pre><code>man policyd-spf.conf
</code></pre>

<p>check_policy_service Unix pipe:</p>

<p>File: /var/spool/postfix/private/policyd-spf</p>

<pre><code>srw-rw-rw-. 1 postfix postfix 0 Feb 25 14:37 /var/spool/postfix/private/policyd-spf
</code></pre>

<h2 id="blockdomainsande-mailaddressesusingpostfixaccess">Block Domains and E-Mail Addresses using Postfix access</h2>

<p>The following example uses an indexed file, so that the order of table
entries does not matter.</p>

<p>File: /etc/postfix/main.cf:</p>

<pre><code> smtpd_client_restrictions =
   check_client_access hash:/etc/postfix/access
</code></pre>

<p>The example permits access by the client at
address 1.2.3.4 but rejects all other clients in 1.2.3.0/24.</p>

<p>File: /etc/postfix/access:</p>

<pre><code>1.2.3   REJECT
1.2.3.4 OK
aol.com REJECT
</code></pre>

<p>Create hash map of ascii file, and restart postfix</p>

<pre><code>$ sudo postmap  /etc/postfix/access
$ sudo systemctl restart postfix
</code></pre>

<p>Reference:</p>

<ul>
<li> <a href="http://www.open-spf.org/FAQ/Common_receiver_mistakes/">http://www.open-spf.org/FAQ/Common_receiver_mistakes/</a></li>
<li> <a href="https://www.mankier.com/5/policyd-spf.conf">https://www.mankier.com/5/policyd-spf.conf</a></li>
<li> <a href="http://www.postfix.org/access.5.html">http://www.postfix.org/access.5.html</a></li>
</ul>

<h1 id="settingupdkim">Setting up DKIM</h1>

<p>OpenDKIM is an open source implementation of the DKIM (Domain Keys Identified Mail) sender authentication system proposed by the E-mail Signing Technology Group (ESTG), now standardized by the IETF (RFC6376). It also includes implementations of the RFC5617) Vouch By Reference (VBR, RFC5518) proposed standard and the experimental Authorized Third Party Signatures protocol (ATPS, RFC6541).</p>

<h2 id="installopendkim">Install OpenDKIM</h2>

<ul>
<li> Debian</li>
</ul>

<pre><code>sudo apt install opendkim opendkim-tools
</code></pre>

<ul>
<li> RedHat</li>
</ul>

<pre><code># enable the CodeReady Linux Builder repository. You already have access to it; you just need to enable it.
dnf config-manager --set-enabled crb
# install the EPEL RPM
dnf install epel-release epel-next-release
# install
sudo dnf install opendkim opendkim-tools
</code></pre>

<h2 id="configureopendkim">Configure OpenDKIM</h2>

<p>Add user postfix to group opendkim.</p>

<pre><code>sudo gpasswd -a postfix opendkim
</code></pre>

<p>Check OpenDKIM main configuration file for Syslog, Logwhy.</p>

<blockquote>
<p>Logwhy will generate more detailed logs for debugging.</p>
</blockquote>

<p>File: /etc/opendkim.conf</p>

<pre><code>Syslog               yes
Logwhy               yes
</code></pre>

<p>Set Canonicalization used when signing messages. The recognized values are relaxed and simple as defined by the DKIM specification. The default is simple. The value may include two different canonicalizations separated by a slash (&#8220;/&#8221;) character, in which case the first will be applied to the header and the second to the body.</p>

<p>Set operating Modes. The string is a concatenation of characters that indicate which mode(s) of operation are desired. Valid modes are s (signer) and v (verifier). The default is sv except in test mode (see the opendkim(8) man page) in which case the default is v. When signing mode is enabled, one of the following combinations must also be set: (a) Domain, KeyFile, Selector, no KeyTable, no SigningTable; (b) KeyTable, SigningTable, no Domain, no KeyFile, no Selector; (c) KeyTable, SetupPolicyScript, no Domain, no KeyFile, no Selector.</p>

<p>File: /etc/opendkim.conf</p>

<pre><code>Canonicalization   relaxed/simple
Mode               sv
</code></pre>

<ul>
<li>Do not set Domain or SubDomains, they are not required because we will use SigningTable.</li>
<li>Do not set Selector, it is not required because we will use SigningTable.</li>
<li>Do not set KeyFile, it is not required because we will use KeyTable.</li>
</ul>

<p>Add restart definitions to the end of the file.</p>

<ul>
<li><p> AutoRestart (Boolean): Automatically re-start on failures. Use with caution; if the filter fails instantly after it starts, this can cause a tight fork(2) loop.</p></li>
<li><p> AutoRestartCount (integer): Sets the maximum automatic restart count. After this number of automatic restarts, the filter will give up and terminate. A value of 0 implies no limit; this is the default.</p></li>
<li><p> AutoRestartRate (string): Sets the maximum automatic restart rate. If the filter begins restarting faster than the rate defined here, it will give up and terminate. This is a string of the form n/t[u] where n is an integer limiting the count of restarts in the given interval and t[u] defines the time interval through which the rate is calculated; t is an integer and u defines the units thus represented (&#8220;s&#8221; or &#8220;S&#8221; for seconds, the default; &#8220;m&#8221; or &#8220;M&#8221; for minutes; &#8220;h&#8221; or &#8220;H&#8221; for hours; &#8220;d&#8221; or &#8220;D&#8221; for days). For example, a value of &#8220;10/1h&#8221; limits the restarts to 10 in one hour. There is no default, meaning restart rate is not limited.</p></li>
</ul>

<p>File: /etc/opendkim.conf</p>

<pre><code>AutoRestart       yes
AutoRestartCount  10
AutoRestartRate   10/1H
</code></pre>

<p>Reference: <a href="http://www.opendkim.org/opendkim.conf.5.html">http://www.opendkim.org/opendkim.conf.5.html</a></p>

<h3 id="mapdomainstokeys">Map Domains to Keys</h3>

<p>The next two configuration items will create maps for E-Mail Domains in the <em>From:</em> header, to keys used to sign messages.</p>

<ul>
<li><p> KeyTable (dataset): Gives the location of a file mapping key names to signing keys. If present, overrides any KeyFile setting in the configuration file. The data set named here maps each key name to three values: (a) the name of the domain to use in the signature’s &#8220;d=&#8221; value; (b) the name of the selector to use in the signature’s &#8220;s=&#8221; value; and (c) either a private key or a path to a file containing a private key. If the first value consists solely of a percent sign (&#8220;%&#8221;) character, it will be replaced by the apparent domain of the sender when generating a signature. If the third value starts with a slash (&#8220;/&#8221;) character, or &#8220;./&#8221; or &#8220;../&#8221;, then it is presumed to refer to a file from which the private key should be read, otherwise it is itself a PEM-encoded private key or a base64-encoded DER private key; a &#8220;%&#8221; in the third value in this case will be replaced by the apparent domain name of the sender. The SigningTable (see below) is used to select records from this table to be used to add signatures based on the message sender.</p></li>
<li><p> SigningTable (dataset): Defines a table used to select one or more signatures to apply to a message based on the address found in the From: header field. Keys in this table vary depending on the type of table used; values in this data set should include one field that contains a name found in the KeyTable (see above) that identifies which key should be used in generating the signature, and an optional second field naming the signer of the message that will be included in the &#8220;i=&#8221; tag in the generated signature. Note that the &#8220;i=&#8221; value will not be included in the signature if it conflicts with the signing domain (the &#8220;d=&#8221; value).</p>

<ul>
<li><p>If the first field contains only a &#8220;%&#8221; character, it will be replaced by the domain found in the From: header field. Similarly, within the optional second field, any &#8220;%&#8221; character will be replaced by the domain found in the From: header field.</p></li>
<li><p>If this table specifies a regular expression file (&#8220;refile&#8221;), then the keys are wildcard patterns that are matched against the address found in the From: header field. Entries are checked in the order in which they appear in the file.</p></li>
<li><p>For all other database types, the full user@host is checked first, then simply host, then user@.domain (with all superdomains checked in sequence, so &#8220;foo.example.com&#8221; would first check &#8220;user@foo.example.com&#8221;, then &#8220;user@.example.com&#8221;, then &#8220;user@.com&#8221;), then .domain, then user@*, and finally *.</p></li>
<li><p>In any case, only the first match is applied, unless MultipleSignatures is enabled in which case all matches are applied.</p></li>
</ul></li>
</ul>

<p>File: /etc/opendkim.conf</p>

<pre><code>KeyTable        /etc/opendkim/KeyTable
SigningTable    refile:/etc/opendkim/SigningTable
</code></pre>

<p>KeyTable need &#8220;refile:&#8221;? (wildcards not allowed)</p>

<h3 id="hoststoignorewhenverifyingsignatures">Hosts to ignore when verifying signatures</h3>

<p>Identifies a set of &#8220;external&#8221; hosts that may send mail through the server as one of the signing domains without credentials as such. This has the effect of suppressing the &#8220;external host (hostname) tried to send mail as (domain)&#8221; log messages. Entries in the data set should be of the same form as those of the PeerList option below. The set is empty by default.</p>

<p>File: /etc/opendkim.conf</p>

<pre><code>ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
</code></pre>

<h3 id="asetofinternalhostswhosemailshouldbesigned">A set of internal hosts whose mail should be signed</h3>

<p>Identifies a set internal hosts whose mail should be signed rather than verified. Entries in this data set follow the same form as those of the PeerList option below. If not specified, the default of &#8220;127.0.0.1&#8221; is applied. Naturally, providing a value here overrides the default, so if mail from 127.0.0.1 should be signed, the list provided here should include that address explicitly.</p>

<p>File: /etc/opendkim.conf</p>

<pre><code>InternalHosts   refile:/etc/opendkim/TrustedHosts
</code></pre>

<p>Save and close the file.</p>

<h2 id="createsigningtablekeytableandtrustedhostsfile">Create Signing Table, Key Table and Trusted Hosts File</h2>

<h3 id="checkdirectorystructureforopendkim">Check directory structure for OpenDKIM</h3>

<pre><code>$ sudo ls -lR /etc/opendkim*
-rw-r--r-- 1 root     root     5346 Mar  2 11:15 /etc/opendkim.conf

/etc/opendkim:
total 12
drwx--x--- 2 opendkim opendkim    6 Feb 24  2022 keys
-rw-r----- 1 opendkim opendkim  339 Feb 24  2022 KeyTable
-rw-r----- 1 opendkim opendkim 1221 Feb 24  2022 SigningTable
-rw-r----- 1 opendkim opendkim  378 Feb 24  2022 TrustedHosts

/etc/opendkim/keys:
total 0
</code></pre>

<p>If not the same, change the owner from root to opendkim and make sure only opendkim user can read and write to the keys directory.</p>

<pre><code>sudo chown -R opendkim:opendkim /etc/opendkim

sudo chmod go-rw /etc/opendkim/keys
</code></pre>

<h3 id="createthesigningtable">Create the signing table</h3>

<p>Add two lines to the file.</p>

<p>The first line tells OpenDKIM that if a sender on your server is using a @your-domain.com address, then it should be signed with the private key identified by default._domainkey.your-domain.com.</p>

<p>The second line tells that your sub-domains will be signed by the private key also.</p>

<p>File: /etc/opendkim/SigningTable</p>

<pre><code>*@your-domain.com    default._domainkey.your-domain.com
*@*.your-domain.com    default._domainkey.your-domain.com
</code></pre>

<p>Save and close the file.</p>

<h3 id="createthekeytable">Create the key table</h3>

<p>Add the following line, defining the location of the private key.</p>

<p>File: /etc/opendkim/KeyTable</p>

<pre><code>default._domainkey.your-domain.com     your-domain.com:default:/etc/opendkim/keys/your-domain.com/default.private
</code></pre>

<p>Save and close the file.</p>

<h3 id="createthetrustedhostsfile">Create the trusted hosts file</h3>

<p>Tell OpenDKIM if an email is from <em>localhost</em> or the <em>same domain</em>, then <em>only sign the email</em>, and <em>not</em> perform DKIM verification.</p>

<p>File: /etc/opendkim/TrustedHosts</p>

<pre><code>127.0.0.1
localhost

.your-domain.com
</code></pre>

<p>Save and close the file.</p>

<blockquote>
<p>Do not add an asterisk to the domain name like this: *.your-domain.com. Put only a dot before the domain name.</p>
</blockquote>

<h2 id="generateprivatepublickeypair">Generate Private/Public Keypair</h2>

<p>DKIM is used to sign outgoing messages <em>and</em> verify incoming messages, so we need to generate a <em>private key for signing</em> and a <em>public key for remote verifier</em>. Only the public key will be published in DNS.</p>

<h3 id="createaseparatefolderforthedomain.">Create a separate folder for the domain.</h3>

<pre><code>sudo mkdir /etc/opendkim/keys/your-domain.com
</code></pre>

<h3 id="generatekeysusingopendkim-genkeytool.">Generate keys using opendkim-genkey tool.</h3>

<blockquote>
<p>You should rotate in new keys every once and a while for protection against private key leaks. Allow seven days before deleting the old keys for existing E-Mails to be delivered.</p>
</blockquote>

<pre><code>sudo opendkim-genkey -b 2048 -d your-domain.com -D /etc/opendkim/keys/your-domain.com -s default -v
opendkim-genkey: generating private key
opendkim-genkey: private key written to default.private
opendkim-genkey: extracting public key
opendkim-genkey: DNS TXT record written to default.txt
</code></pre>

<p>The above command will create 2048 bits keys. -d (domain) specifies the domain. -D (directory) specifies the directory where the keys will be stored and we use default as the selector (-s), also known as the name. Once the command is executed, the private key will be written to default.private file and the public key will be written to default.txt file.</p>

<p>Ensure opendkim is the owner of the private key.</p>

<pre><code>sudo chown opendkim:opendkim /etc/opendkim/keys/your-domain.com/default.private
</code></pre>

<p>Also change the permission, so only the opendkim user has read and write access to the file.</p>

<pre><code>sudo chmod 600 /etc/opendkim/keys/your-domain.com/default.private
</code></pre>

<h2 id="publishyourpublickeyindnsrecords">Publish Your Public Key in DNS Records</h2>

<p>Display the public key</p>

<pre><code>sudo cat /etc/opendkim/keys/your-domain.com/default.txt
default._domainkey	IN	TXT	( &quot;v=DKIM1; k=rsa; &quot;
	  &quot;p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAutisB7xnL1B1j88Er2VsEd6WuwifqSThKEcrnlkhnsVhs/UkCd2lHL+dZwivjbfH+4RXIP0LK9shGokPwaA2MHNH3GgAuWZ/Wb6ZrZwqDlmHy+H6Q0/cLsB2Py2HFthq1JUhHW31ZOIqa4qOn2suBntQdizGExHsuMMb1nJpu0lgFJLU848qPQO76QMTcC/TyssiCjLXXSQEsS&quot;
	  &quot;Kx0UmeODJ43NKAAS0OqkGBD2UE7/SW54bVpESK32lTIfzk91OdW+zDMzX6myToJtEE9WgOkgD2evSTp02dhKBBRkQvGJ0SF7el34e/smeS+XvodjjOvP2f3qW5cLvrCRByIkFzRwIDAQAB&quot; )  ; ----- DKIM key default for your-domain.com
</code></pre>

<p>The string after the p parameter is the public key, it spans two lines in the cat output because the limit per line is 256 characters. It really should be <em>one big long string with no quotes</em>.</p>

<p>In your DNS manager,</p>

<ul>
<li> create a TXT record,</li>
<li> enter default._domainkey in the name field.</li>
<li> Copy everything between the parentheses and paste it into the value field of the DNS record. Delete all <em>double quotes</em> and <em>white spaces</em> in the value field. Join all the lines into one line.</li>
</ul>

<p>For Example; look at a recent google e-mail:</p>

<pre><code>X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112; t=1677769129;
        h=to:list-unsubscribe:user-agent:mime-version:subject:message-id:from
         :date:dkim-signature:dkim-signature:delivered-to:x-gm-message-state
         :from:to:cc:subject:date:message-id:reply-to;
        bh=V22zSr/CKU90o7uszazuWVoXgsouLolWaiMhbqvqG8Y=;
        b=FUH9YP2CWhupcc6eU3hVYigxSWJ2fVJHF1F3DrkJoMb1K3hf9O7vrTWDxqNIOvGmPS
         6sCsgvynVtQ+cccVgzc6vZLBYDg3XBdQF6u2hxiMIAAkyPGVUUrYpj/OreMj1WkGDkG0
         9yVxpp0UuIK8uyrfswX9zBWT/QORjQ4Lfh3KCbzaLX8DbfWoc3P907Ebc8cfvVGDu2wX
         oNBeYjEXb4sywHcVmuUNdg//O78sAY5CnSVZ3Gc/41/pFtNHdCCjQAWSQ/W/Czfsy2TY
         Ovuebwb71h3VlUpqDIqkaIMZ5rF9pWxqeQgHkIs8Ktgd8CnAhqnk77ZXWk0SR9Q8hkuQ
         +BQw==
</code></pre>

<p>The <em>s</em> and <em>d</em> tags are used to look up the DKIM record. s is the <em>selector</em> while <em>d</em> is the domain.</p>

<p>s=20210112
d=1e100.net</p>

<p>Together they form the DNS lookup string:
<code>20210112._domainkey.1e100.net</code></p>

<pre><code>$ dig +short txt 20210112._domainkey.1e100.net
&quot;v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8Sabq+yC2d91PkWTEkjdH2AsaH31YzVJ8PKlQy2GZ9u8vtqfQM88nACYwWAbCQvLwUfCz7hbF/PyM3K/SPlDSk0HqKq89AQjv60br0pK90vWFmzt04ioNcf4QoiJjnnTWD6h5gOM&quot; &quot;ATz4WfdwCrQ9MRF0SjDHteEVeHCK4WKsWKdPshaSLiVfZxiGLv4SZkWye7Zh5iM66MUvYAr3x151AyCQroTNfJY9RN9RK2ZqLdcoulg7S/XMbnzY7EW0P8nPj2jqvMp0bcr13tOzBRnysYiQIu3cjrtyLNfAZobK6tlmy737vkVH27D0rsUrcABrFqvVox61h61JssaRYcwRpwIDAQAB&quot;
</code></pre>

<p>Your key lookup should look like:</p>

<pre><code>$ dig +short txt default._domainkey.your-domain.com
&quot;v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAutisB7xnL1B1j88Er2VsEd6WuwifqSThKEcrnlkhnsVhs/UkCd2lHL+dZwivjbfH+4RXIP0LK9shGokPwaA2MHNH3GgAuWZ/Wb6ZrZwqDlmHy+H6Q0/cLsB2Py2HFthq1JUhHW31ZOIqa4qOn2suBntQdizGExHsuMMb1nJpu0lgFJLU848qPQO76QMTcC/TyssiCjLXXSQEsS&quot; &quot;Kx0UmeODJ43NKAAS0OqkGBD2UE7/SW54bVpESK32lTIfzk91OdW+zDMzX6myToJtEE9WgOkgD2evSTp02dhKBBRkQvGJ0SF7el34e/smeS+XvodjjOvP2f3qW5cLvrCRByIkFzRwIDAQAB&quot;
</code></pre>

<p>Reference: <a href="https://www.cloudflare.com/learning/dns/dns-records/dns-dkim-record/">https://www.cloudflare.com/learning/dns/dns-records/dns-dkim-record/</a></p>

<h2 id="testdkimkey">Test DKIM Key</h2>

<p>Test your key.</p>

<pre><code>sudo opendkim-testkey -d your-domain.com -s default -vvv
</code></pre>

<p>You should see <em>Key OK</em> in the output.</p>

<pre><code>opendkim-testkey: using default configfile /etc/opendkim.conf
opendkim-testkey: checking key 'default._domainkey.your-domain.com'
opendkim-testkey: key secure
opendkim-testkey: key OK
</code></pre>

<p>Your DKIM record will take some time to propagate to the Internet.</p>

<p>To check, go to <a href="https://www.dmarcanalyzer.com/dkim/dkim-check/">https://www.dmarcanalyzer.com/dkim/dkim-check/</a>, use <em>default</em> as the selector your domain name to check DKIM record propagation.</p>

<h2 id="connectpostfixtoopendkim">Connect Postfix to OpenDKIM</h2>

<p>Postfix can talk to OpenDKIM via a Unix socket file. It is a good idea to put it where all the other postfix socket files are.</p>

<p>Create the directory OpenDKIM for a socket file and limit is to the opendkim user and postfix group.</p>

<pre><code>$sudo mkdir                  /var/spool/postfix/opendkim
$sudo chown opendkim:postfix /var/spool/postfix/opendkim
</code></pre>

<h3 id="setsockettolocal">Set Socket to local</h3>

<p>File: /etc/opendkim.conf</p>

<pre><code>Socket    local:/var/spool/postfix/opendkim/opendkim.sock
</code></pre>

<p>Change the default file as well (if it exists):</p>

<h3 id="addopendkimtopostfixmain.cf">Add openDKIM to Postfix main.cf</h3>

<blockquote>
<p>milter is a <em>modifier</em> filter</p>
</blockquote>

<p>File: /etc/postfix/main.cf</p>

<pre><code># Milter configuration
milter_default_action = accept
milter_protocol = 6
smtpd_milters = local:opendkim/opendkim.sock
non_smtpd_milters = $smtpd_milters
</code></pre>

<h3 id="restartopendkimandpostfixservice">Restart opendkim and postfix service</h3>

<pre><code>$ sudo systemctl restart opendkim postfix
</code></pre>

<h2 id="spfanddkimcheck">SPF and DKIM Check</h2>

<p>Send a test email to another domain&#8217;s account, and see if SPF and DKIM checks are passed in the message source.</p>

<p>Example:</p>

<pre><code>Authentication-Results: dkim-verifier.icloud.com;
	dkim=pass (2048-bit key) header.d=your-domain.com header.i=@your-domain.com header.b=yn+tGP2N
Authentication-Results: spf.icloud.com; spf=pass (spf.icloud.com: domain of you@your-domain.com designates 1.2.3.4 as permitted sender) smtp.mailfrom=you@your-domain.com
</code></pre>

<p>Your email server will <em>also</em> perform SPF and DKIM checks on other domains.</p>

<p>Example:</p>

<pre><code>Received-SPF: Pass (mailfrom) identity=mailfrom; client-ip=1234:f8b0:5678:90::372; helo=mail-yw1-xc2d.google.com; envelope-from=someone@gmail.com; receiver=&lt;UNKNOWN&gt; 
Authentication-Results: you.your-domain.com;
	dkim=pass (2048-bit key; unprotected) header.d=gmail.com header.i=@gmail.com header.b=&quot;IsoKGudn&quot;;
	dkim-atps=neutral
</code></pre>

<h2 id="postfixcan’tconnecttoopendkim">Postfix Can’t Connect to OpenDKIM</h2>

<p>Check the logs</p>

<pre><code>$ vi /var/log/mail*
$ sudo journalctl -eu opendkim
</code></pre>

<p>If you see this:</p>

<pre><code>connect to Milter service local:opendkim/opendkim.sock: No such file or directory
</code></pre>

<p>check the opendkim systemd service.</p>

<pre><code>$ sudo systemctl status opendkim
</code></pre>

<p>If opendkim is running, it means Postfix can’t connect to OpenDKIM via the Unix domain socket (local:opendkim/opendkim.sock).</p>

<p>Check the socket file:</p>

<pre><code>$ ls -l /var/spool/postfix/opendkim/opendkim.sock 
srwxrwxr-x 1 opendkim opendkim 0 Mar  2 15:09 /var/spool/postfix/opendkim/opendkim.sock
</code></pre>

<p>And postfix user:</p>

<pre><code>$ id postfix
uid=89(postfix) gid=89(postfix) groups=89(postfix),12(mail),988(opendkim)
</code></pre>

<p>Be sure the postfix user has group opendkim.</p>

<p>If all else fails, you can configure OpenDKIM to use a TCP/IP socket instead of Unix local socket.</p>

<p>File: /etc/opendkim.conf</p>

<pre><code>Socket     inet:8892@localhost
</code></pre>

<p>File: /etc/postfix/main.cf</p>

<pre><code>smtpd_milters = inet:127.0.0.1:8892
</code></pre>

<p>Restart OpenDKIM and Postfix.</p>

<pre><code>sudo systemctl restart opendkim postfix
</code></pre>

<p>Now Postfix will connect to OpenDKIM via the TCP/IP socket.</p>

<h2 id="configurationerrorinemailclient">Configuration Error in Email Client</h2>

<p>DKIM signing could fail if you <em>do not</em> use STARTTLS or SSL/TLS.</p>

<table>
<colgroup>
<col />
<col />
<col />
<col />
</colgroup>

<thead>
<tr>
	<th> Type </th>
	<th> Port </th>
	<th> Encryption </th>
	<th> Password </th>
</tr>
</thead>

<tbody>
<tr>
	<td> SMTP </td>
	<td> 587 </td>
	<td> STARTTLS </td>
	<td> Normal </td>
</tr>
<tr>
	<td> IMAP </td>
	<td> 143 </td>
	<td> STARTTLS </td>
	<td> Normal </td>
</tr>
<tr>
	<td> SMTP </td>
	<td> 465 </td>
	<td> SSL/TLS </td>
	<td> Normal </td>
</tr>
<tr>
	<td> IMAP </td>
	<td> 993 </td>
	<td> SSL/TLS </td>
	<td> Normal </td>
</tr>
</tbody>
</table>

<h3 id="wrongsettings">Wrong Settings</h3>

<blockquote>
<p>Port 25 as the SMTP port in mail clients to submit outgoing emails.
No encryption method was selected.</p>
</blockquote>

<h1 id="testingemailscoreandplacement">Testing Email Score and Placement</h1>

<p>Visit Mail-Tester <a href="https://www.mail-tester.com">https://www.mail-tester.com</a> and send an E-Mail to the unique email address displayed on the home page. They will analyze it and return a sender score.</p>

<p>GlockApps <a href="https://glockapps.com/">https://glockapps.com/</a> will show you where your emails are being delivered at Gmail, Outlook, &amp; all major ISPs.</p>

<h1 id="whatisdmarc">What is DMARC?</h1>

<p>DMARC stands for Domain-based message authentication, reporting and conformance. DMARC is a protcol for protecting your Internet Domain from abuse.</p>

<p>It extends SPF and DKIM using another DNS entry.</p>

<p>Originators of Internet Mail need to be able to associate reliable and authenticated domain identifiers with messages, communicate policies about messages that use those identifiers, and report about mail using those identifiers. These abilities have several benefits: Receivers can provide feedback to Domain Owners about the use of their domains; this feedback can provide valuable insight about the management of internal operations and the presence of external domain name abuse.</p>

<p>Reference: <a href="https://datatracker.ietf.org/doc/html/rfc7489">https://datatracker.ietf.org/doc/html/rfc7489</a></p>

<h2 id="createdmarcrecord">Create DMARC Record</h2>

<p>DMARC policies are published as a TXT record in DNS.</p>

<ul>
<li><p> Before creating a DMARC record, you must first create SPF and DKIM records.</p></li>
<li><p> Send a test email from your domain, and check the raw email headers at the recipient’s mailbox.
Ensure the <em>domain</em> is the same in:</p>

<ul>
<li><em>Return-path: you@domain</em></li>
<li><em>From: you@domain</em></li>
<li><em>d=domain</em> in the DKIM signature</li>
</ul></li>
</ul>

<p>If the 3 domains are identical, then they are aligned.</p>

<p>If <em>Return-Path:</em> or <em>DKIM d=</em> uses a subdomain instead of the main domain name, then this is called relaxed alignment. If no subdomain is used and the main domain names are the same, it’s called strict alignment.</p>

<h3 id="dmarcrecordtxt">DMARC Record TXT</h3>

<p>Domain Owner DMARC preferences are stored as DNS TXT records in subdomains named &#8220;_dmarc&#8221;. For example, the Domain Owner of &#8220;example.com&#8221; would post DMARC preferences in a TXT record at &#8220;_dmarc.example.com&#8221;.</p>

<p>In your Domain Registration DNS manager add a new <em>TXT</em> record.</p>

<p>Name field:</p>

<pre><code>_dmarc
</code></pre>

<p>Value field:</p>

<pre><code>v=DMARC1; p=none; pct=100; rua=mailto:dmarc-reports@your-domain.com
</code></pre>

<p>Definition:</p>

<ul>
<li> v=DMARC1: Version (plain-text; REQUIRED). Identifies the record retrieved
as a DMARC record. It MUST have the value of &#8220;DMARC1&#8221;.</li>
<li> p=none: Requested Mail Receiver policy (plain-text; REQUIRED for policy
records).</li>
<li> pct=100: (plain-text integer between 0 and 100, inclusive; OPTIONAL;
default is 100). Percentage of messages from the Domain Owner&#8217;s
mail stream to which the DMARC policy is to be applied.</li>
<li> rua: Addresses to which aggregate feedback is to be sent (comma-
separated plain-text list of DMARC URIs; OPTIONAL).</li>
</ul>

<p>There are 3 policies you can choose from:</p>

<ul>
<li> none: The Domain Owner requests no specific action be taken
 regarding delivery of messages.</li>
<li> quarantine: The Domain Owner wishes to have email that fails the
 DMARC mechanism check be treated by Mail Receivers as
 suspicious.</li>
<li> reject: The Domain Owner wishes for Mail Receivers to reject
 email that fails the DMARC mechanism check. Rejection SHOULD
 occur during the SMTP transaction.</li>
</ul>

<p>Another option to consider is:</p>

<ul>
<li><p> fo: Failure reporting options (plain-text; OPTIONAL; default is &#8220;0&#8221;)
Provides requested options for generation of failure reports.
Report generators MAY choose to adhere to the requested options.
This tag&#8217;s content MUST be ignored if a &#8220;ruf&#8221; tag (below) is not
also specified. The value of this tag is a colon-separated list
of characters that indicate failure reporting options as follows:</p>

<ul>
<li><p>0: Generate a DMARC failure report if all underlying
 authentication mechanisms fail to produce an aligned &#8220;pass&#8221;
 result.</p></li>
<li><p>1: Generate a DMARC failure report if any underlying
 authentication mechanism produced something other than an
 aligned &#8220;pass&#8221; result.</p></li>
<li><p>d: Generate a DKIM failure report if the message had a signature
 that failed evaluation, regardless of its alignment. DKIM-
 specific reporting is described in [AFRF-DKIM].</p></li>
<li><p>s: Generate an SPF failure report if the message failed SPF
 evaluation, regardless of its alignment. SPF-specific
 reporting is described in [AFRF-SPF].</p></li>
</ul></li>
<li><p> ruf: Addresses to which message-specific failure information is to
be reported (comma-separated plain-text list of DMARC URIs;
OPTIONAL). If present, the Domain Owner is requesting Mail
Receivers to send detailed failure reports about messages that
fail the DMARC evaluation in specific ways (see the &#8220;fo&#8221; tag
above).</p></li>
</ul>

<p>Try fo=1 at first for detailed DMARC failure reports. When you change to a more restrictive policy, use fo=0.</p>

<pre><code>v=DMARC1; p=none; pct=100; fo=1; ruf=mailto:dmarc-reports@your-domain.com
</code></pre>

<p>If you have a domain name that will not send emails, use <code>p=reject</code> policy.</p>

<pre><code>v=DMARC1; p=reject; pct=100;
</code></pre>

<h2 id="dmarcrecordcheck">DMARC Record Check</h2>

<p>You can check your DMARC record from Linux terminal with the following command:</p>

<pre><code>$ dig txt +short _dmarc.example.com
&quot;v=DMARC1; p=none; pct=100; rua=mailto:postmaster@your-domain.com&quot;
</code></pre>

<p>You can also install opendmarc-check that to check a DMARC record.</p>

<p>Install opendmarc package</p>

<pre><code>sudo apt install opendmarc
</code></pre>

<p>It checks DNS and translates the DMARC record to a human readable form.</p>

<pre><code>$ opendmarc-check your-domain.com
DMARC record for your-domain.com:
	Sample percentage: 100
	DKIM alignment: relaxed
	SPF alignment: relaxed
	Domain policy: none
	Subdomain policy: unspecified
	Aggregate report URIs:
		mailto:postmaster@your-domain.com
	Failure report URIs:
		(none)
</code></pre>

<h2 id="dmarcteste-mail">DMARC Test E-Mail</h2>

<p>Send an email from your domain to another domain&#8217;s account. If DMARC is configured correctly then you will see <em>dmarc=pass</em> in the <em>Authentication-Results:</em> header.</p>

<pre><code>Authentication-Results: dmarc.icloud.com; dmarc=pass header.from=your-domain.com
X-DMARC-Info: pass=pass; dmarc-policy=none; s=r1; d=r1; pdomain=your-domain.com
X-DMARC-Policy: v=DMARC1; p=none; pct=100; rua=mailto:postmaster@your-domain.com
Authentication-Results: dkim-verifier.icloud.com;
	dkim=pass (2048-bit key) header.d=your-domain.com header.i=@your-domain.com header.b=wVFZ+19t
Authentication-Results: spf.icloud.com; spf=pass (spf.icloud.com: domain of you@your-domain.com designates 1.2.3.4 as permitted sender) smtp.mailfrom=you@your-domain.com
Received-SPF: pass (spf.icloud.com: domain of you@your-domain.com designates 1.2.3.4 as permitted sender) receiver=spf.icloud.com; client-ip=1.2.3.4; helo=mail.your-domain.org; envelope-from=you@your-domain.com
</code></pre>

<h2 id="interpretadmarcreport">Interpret a DMARC Report</h2>

<p>There are two kinds of DMARC reports.</p>

<ul>
<li> Daily XML-based [1] aggregate report generated by Gmail, Yahoo, Hotmail, etc.</li>
<li> Real-time forensic reports (copies of individual pieces of email that fail the DMARC check)</li>
</ul>

<p>Normally you only want to receive the aggregate (rua) report. The data that DMARC produces is invaluable for understanding what is going on for any given email domain. However, raw DMARC report data is super hard to read and understand.</p>

<p>Postmark offers a free service to process these reports. The nice part about Postmark is that you can tell receiving email servers to send XML reports directly to Postmark for processing. So instead of entering your email address in the DMARC record, you enter an email address of postmarkapp.com that is unique to you.</p>

<pre><code>v=DMARC1; p=none; pct=100; fo=1; rua=mailto:unique-to-you@dmarc.postmarkapp.com;
</code></pre>

<p>You can also specify multiple email addresses, separated by commas.</p>

<pre><code>v=DMARC1; p=none; pct=100; fo=1; rua=mailto:unique-to-you@dmarc.postmarkapp.com,mailto:dmarc-report@your-domain.com;
</code></pre>

<p>After your DMARC record has been verified by Postmark, you will receive a DMARC report weekly every Monday in your email inbox. You don’t need to register an account at Postmark.</p>

<p>Many other firms exist to create DMARC reports. If you are into a lot of E-Mail marketing, you should check some more out.</p>

<ol>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7489#appendix-C">https://datatracker.ietf.org/doc/html/rfc7489#appendix-C</a></li>
</ol>

<p>Reference:</p>

<ul>
<li> <a href="https://www.linuxbabe.com/mail-server/create-dmarc-record">https://www.linuxbabe.com/mail-server/create-dmarc-record</a></li>
<li> <a href="https://postmarkapp.com">https://postmarkapp.com</a></li>
<li> <a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.2">https://datatracker.ietf.org/doc/html/rfc7489#section-7.2</a></li>
</ul>

<hr>

<h4 id="madeforhumansbyahuman">Made for Humans, by a Human</h4>

<h4 id="links">Links</h4>

<ul>
<li><a href="https://lwn.net/">Linux Weekly News</a></li>
<li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
<li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
<li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
<li><a href="https://www.thefarside.com/">The Far Side</a></li>
</ul>

<h4 id="social">Social</h4>

<ul>
<li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
<li><a href="/linux-in-house/feed-linux.rss">Linux RSS Feed</a></li>
<li><a href="/linux-in-house/feed-writing.rss">Writing RSS Feed</a></li>
<li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
</ul>

<div style="overflow-x:auto;">
<table style="width: 100%;">
<tr>
     <td>
<small><a href="/linux-in-house/linux/intro.html#createdwith">Created with</a></small>
     </td>
     <td>
<small>License: <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a></<small>
     </td>
     <td>

<p><small>linux-in-house Version: 4.40 </small></p>

<p></tr>
</table></p>

</div>


</body>
</html>

