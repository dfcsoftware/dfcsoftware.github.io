<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Matrix</title>
	<meta name="date" content="2023-01-25 10:28"/>
	<meta name="modified" content="2024-04-19 9:30"/>
	<meta name="tags" content="systems"/>
	<meta name="author" content="Don Cohoon"/>
	<meta name="summary" content="Matrix is a messaging system you can on your server. It allows your to send messages to a phone/watch from command line on the server. It is useful with HomeAssistant for monitoring the house."/>
	<meta name="license" content="'[CC-BY-NC-SA 4.0](http://creativecommons.org/licenses/by-nc-sa/4.0/)'"/>
<meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/linux-in-house/common.css" type="text/css" />
</head>
<body>

<p><a href="/linux-in-house/"><h1>Linux in House</h1></a></p>

<link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
window.addEventListener('DOMContentLoaded', (event) => {
      new PagefindUI({ element: "#search", showSubResults: true });
});
</script>

<blockquote>
<p><a href="/linux-in-house/linux/welcome.html">Welcome Back My Friends</a></p>
</blockquote>

<h1 id="matrixmessaging">Matrix Messaging</h1>

<p>Matrix is a messaging system you can on your server. It allows your to send messages to a phone/watch from command line on the server. It is useful with HomeAssistant for monitoring the house.</p>

<hr />

<div class="TOC">

<ul>
<li><a href="#matrixmessaging">Matrix Messaging</a>
<ul>
<li><a href="#install">Install</a></li>
<li><a href="#configure">Configure</a></li>
<li><a href="#createusers">Create User(s)</a></li>
<li><a href="#database">Database</a>
<ul>
<li><a href="#youcanconvertthedatabasetopostgresql">You can convert the database to PostgreSQL</a></li>
</ul>
</li>
<li><a href="#secureconfiguration">Secure Configuration</a></li>
<li><a href="#matrixcommandercli">Matrix Commander CLI</a></li>
<li><a href="#sendmatrix">Send Matrix</a></li>
</ul>
</li>
<li><a href="#debug">Debug</a>
<ul>
<li><a href="#matrix-commandercredentials">matrix-commander credentials</a></li>
<li><a href="#changeuserpassword">Change User Password</a></li>
<li><a href="#matrixclient-serverapi">Matrix Client-Server API</a></li>
</ul>
</li>
<li><a href="#alternative:nextcloudtalk">Alternative: Nextcloud Talk</a></li>
<li><a href="#continue">Continue</a>
<ul>
<li><a href="#madeforhumansbyahuman">Made for Humans, by a Human</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#social">Social</a></li>
</ul>
</li>
</ul>
</div>

<hr />

<blockquote>
<p>Here is an example of a Matrix Client, called Element[1], available on iOS, Android and Desktops.</p>
</blockquote>

<figure>
<img src="/linux-in-house/images/IMG_2070A268049A-1.jpeg" alt="IMG_2070A268049A-1.jpeg" />
<figcaption>IMG_2070A268049A-1.jpeg</figcaption>
</figure>

<ol>
<li><a href="https://element.io/">https://element.io/</a></li>
</ol>

<h2 id="install">Install</h2>

<p>Matrix.org provides Debian/Ubuntu packages of Synapse via https://packages.matrix.org/debian/. To install the latest release:</p>

<p>Prerequsites:</p>

<pre><code>sudo apt install -y lsb-release wget apt-transport-https
</code></pre>

<p>Matrix.org packages</p>

<pre><code>sudo wget -O /usr/share/keyrings/matrix-org-archive-keyring.gpg https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
echo &quot;deb [signed-by=/usr/share/keyrings/matrix-org-archive-keyring.gpg] https://packages.matrix.org/debian/ $(lsb_release -cs) main&quot; |
    sudo tee /etc/apt/sources.list.d/matrix-org.list

sudo apt update
sudo apt install matrix-synapse-py3
</code></pre>

<p>Reference: <a href="https://github.com/matrix-org/synapse/blob/master/INSTALL.md">https://github.com/matrix-org/synapse/blob/master/INSTALL.md</a></p>

<h2 id="configure">Configure</h2>

<ul>
<li> Set the public_baseurl to your server&#8217;s local IP address.</li>
<li> Set the listeners to your server&#8217;s local IP address too.</li>
</ul>

<p>File: /etc/matrix-synapse/homeserver.yaml</p>

<pre><code>#public_baseurl: https://example.com/
public_baseurl: http://192.168.1.3/
~
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['::1', '127.0.0.1', '192.168.1.3']

    resources:
      - names: [client, federation]
        compress: false
~
:wq
</code></pre>

<p>Set the shared secret and enable registration so we can create users for ourselves. We can disable it later because anyone with the shared secret can register, whether enabled or not.</p>

<blockquote>
<p>Create the shared secret like this:</p>

<p><code>cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1</code></p>
</blockquote>

<p>File: /etc/matrix-synapse/homeserver.yaml</p>

<pre><code>#enable_registration: false
enable_registration: true
~
# If set, allows registration of standard or admin accounts by anyone who
# has the shared secret, even if registration is otherwise disabled.
#
# Change the 'registration_shared_secret' with the random passphrase generated on below
#
registration_shared_secret: &quot;S9gYeYowVX49U6OG25EEROKU4b2gEU3S&quot;
#
server_name: localhost
#
:wq
</code></pre>

<h2 id="createusers">Create User(s)</h2>

<p>Using enable_registration=true, we can create users via register_new_matrix_user client.</p>

<pre><code>$ register_new_matrix_user -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008
New user localpart [bob]: alice
Password: 
Confirm password: 
Make admin [no]: n
Sending registration request...
Success!
</code></pre>

<blockquote>
<p>Must have python &gt; 2.7.9</p>
</blockquote>

<p>Reference: <a href="https://matrix-org.github.io/synapse/latest/usage/administration/admin_api/">https://matrix-org.github.io/synapse/latest/usage/administration/admin_api/</a></p>

<h2 id="database">Database</h2>

<p>Database is sqlite3, here:</p>

<pre><code>$ ls /var/lib/matrix-synapse
homeserver.db  media
</code></pre>

<p>Check your database settings in the configuration file, connect to the correct database using either psql [database name] (if using PostgreSQL) or sqlite3 path/to/your/database.db (if using SQLite) and elevate the user @foo:bar.com to server administrator.</p>

<pre><code>UPDATE users SET admin = 1 WHERE name = '@foo:bar.com';
</code></pre>

<p>You can also revoke server admin by setting <code>admin = 0</code> above.</p>

<blockquote>
<p>Room administrators and server administrators are different. Server admins don&#8217;t have any power over rooms. When you use the &#8220;Start chat&#8221; button in Riot, it&#8217;ll set everyone as room admin.</p>
</blockquote>

<h4 id="youcanconvertthedatabasetopostgresql">You can convert the database to PostgreSQL</h4>

<p><a href="https://github.com/matrix-org/synapse/blob/master/docs/postgres.md">https://github.com/matrix-org/synapse/blob/master/docs/postgres.md</a></p>

<h2 id="secureconfiguration">Secure Configuration</h2>

<p>Once you have tested Matrix, created users and have a SSL/TLS certificate, you can enable external communication.</p>

<blockquote>
<p>Turn off registrations and comment out the registration_key.</p>
</blockquote>

<p>File: /etc/matrix-synapse/homeserver.yaml</p>

<pre><code>~
  46 # This is set in /etc/matrix-synapse/conf.d/server_name.yaml for Debian installations.
  47 # server_name: &quot;SERVERNAME&quot;
  48 server_name: matrix.example.com
~
  64 # The public-facing base URL that clients use to access this Homeserver (not
  65 # including _matrix/...). This is the same URL a user might enter into the
  66 # 'Custom Homeserver URL' field on their client. If you use Synapse with a
  67 # reverse proxy, this should be the URL to reach Synapse via the proxy.
  68 # Otherwise, it should be the URL to reach Synapse's client HTTP listener (see
  69 # 'listeners' below).
  70 #
  71 #public_baseurl: https://example.com/
  72 public_baseurl: https://matrix.example.com:8448
~
272 #
 273 listeners:
 274   # TLS-enabled listener: for when matrix traffic is sent directly to synapse.
 275   #
 276   # Disabled by default. To enable it, uncomment the following. (Note that you
 277   # will also need to give Synapse a TLS key and certificate: see the TLS section
 278   # below.)
 279   #
 280   - port: 8448
 281     type: http
 282     tls: true
 283     bind_addresses: ['::1', '0.0.0.0']
 284     resources:
 285       - names: [client, federation]
 286 
 287   # Unsecure HTTP listener: for when matrix traffic passes through a reverse proxy
 288   # that unwraps TLS.
 289   #
 290   # If you plan to use a reverse proxy, please see
 291   # https://matrix-org.github.io/synapse/latest/reverse_proxy.html.
 292   #
 293   - port: 8008
 294     tls: false
 295     type: http
 296     x_forwarded: true
 297     bind_addresses: ['::1', '127.0.0.1', '192.168.1.3']
 298 
 299     resources:
 300       - names: [client, federation]
 301         compress: false
 302 
~
 547 ## TLS ##
 548 
 549 # PEM-encoded X509 certificate for TLS.
 550 # This certificate, as of Synapse 1.0, will need to be a valid and verifiable
 551 # certificate, signed by a recognised Certificate Authority.
 552 #
 553 # Be sure to use a `.pem` file that includes the full certificate chain including
 554 # any intermediate certificates (for instance, if using certbot, use
 555 # `fullchain.pem` as your certificate, not `cert.pem`).
 556 #
 557 #tls_certificate_path: &quot;/etc/matrix-synapse/SERVERNAME.tls.crt&quot;
 558 tls_certificate_path: &quot;/etc/letsencrypt/live/example.com/fullchain.pem&quot;
 559 
 560 # PEM-encoded private key for TLS
 561 #
 562 #tls_private_key_path: &quot;/etc/matrix-synapse/SERVERNAME.tls.key&quot;
 563 tls_private_key_path: &quot;/etc/letsencrypt/live/example.com/privkey.pem&quot;
~
755 database:
 756   name: psycopg2
 757   args:
 758     user: matrix_user
 759     password: ************
 760     database: matrix
 761     host: 127.0.0.1
 762     cp_min: 5
 763     cp_max: 10
 764 
 765     # seconds of inactivity after which TCP should send a keepalive message to the server
 766     keepalives_idle: 10
 767 
 768     # the number of seconds after which a TCP keepalive message that is not
 769     # acknowledged by the server should be retransmitted
 770     keepalives_interval: 10
 771 
 772     # the number of TCP keepalives that can be lost before the client's connection
 773     # to the server is considered dead
 774     keepalives_count: 3
~
 777 ## Logging ##
 778 
 779 # A yaml python logging config file as described by
 780 # https://docs.python.org/3.7/library/logging.config.html#configuration-dictionary-schema
 781 #
 782 log_config: &quot;/etc/matrix-synapse/log.yaml&quot;
~
 906 # Directory where uploaded images and attachments are stored.
 907 #
 908 media_store_path: &quot;/var/lib/matrix-synapse/media&quot;
~
1139 # Enable registration for new users.
1140 #
1141 #enable_registration: false
1142 enable_registration: false
~
1190 # If set, allows registration of standard or admin accounts by anyone who
1191 # has the shared secret, even if registration is otherwise disabled.
1192 #
1193 #registration_shared_secret: &lt;PRIVATE STRING&gt;
1194 registration_shared_secret: &quot;*****************************&quot;
~
1438 ## Signing Keys ##
1439 
1440 # Path to the signing key to sign messages with
1441 #
1442 signing_key_path: &quot;/etc/matrix-synapse/homeserver.signing.key&quot;
~
#trusted_key_servers:
1500 #  - server_name: &quot;my_trusted_server.example.com&quot;
1501 #    verify_keys:
1502 #      &quot;ed25519:auto&quot;: &quot;abcdefghijklmnopqrstuvwxyzabcdefghijklmopqr&quot;
1503 #  - server_name: &quot;my_other_trusted_server.example.com&quot;
1504 #
1505 trusted_key_servers:
1506   - server_name: &quot;matrix.org&quot;
~
</code></pre>

<p>File: /etc/matrix-synapse/conf.d/server_name.yaml</p>

<pre><code> # This file is autogenerated, and will be recreated on upgrade if it is deleted.
# Any changes you make will be preserved.

# The domain name of the server, with optional explicit port.
# This is used by remote servers to connect to this server,
# e.g. matrix.org, localhost:8080, etc.
# This is also the last part of your UserID.
#
server_name: matrix.example.com
</code></pre>

<h2 id="matrixcommandercli">Matrix Commander CLI</h2>

<p>This will allow us to send text messages to our phone/watch from homeassistant.</p>

<p>Follow the instruction on the matrix-commander website. Specifically run with the <code>--login</code> parameter to create ~/.config/matrix-commander/credentials.json file.</p>

<p>Reference: <a href="https://github.com/8go/matrix-commander">https://github.com/8go/matrix-commander</a></p>

<h2 id="sendmatrix">Send Matrix</h2>

<p>This script will assist in watching homeassistant for new messages, then sending them out.</p>

<p>File: ~/matrix/sendmatrix.sh</p>

<pre><code>#!/bin/bash
#----------------------------------------------------
# File: sendmatrix.sh
#
# Usage: sendmatrix.sh
#
# Purpose: Watch for new lines in a homeassistant (hass)
#  file (${HOME}/wave/hass/sendmatrix.log) and send an matrix 
#  message with those new line(s)
#
# Dependencies: 
#  - git clone https://github.com/8go/matrix-commander.git
#  - sudo apt-get install inotify-tools
#  - retail : git clone https://github.com/mbucc/retail.git
#  - NOTE: Docker configures / as /config for homeassistant
#          and ~/wave/hass is /
#  - ~/wave/hass/configuration.yaml
#       ~
#       shell_command:
#         xmpp_light_off: /config/script.sh Outside light off
#       ~
#  - ~/wave/hass/automations.yaml 
#       ~
#       - service: shell_command.xmpp_light_off
#       ~
#  - ~/wave/hass/script.sh
#       #!/bin/bash
#       echo &quot;${@} - $(date)&quot; &gt;&gt;  /config/sendxmpp.log
#
# Date     Author     Description
# ----     ------     -----------
# Sep-2021 Don Cohoon Created
# Sep-2022 Don Cohoon Updated matrix-commander version
# Oct-2022 Don Cohoon Fix matrix commander parameters
#----------------------------------------------------
HOME=${HOME}

# configure hass interface
DIR=${HOME}/wave
OFFSET=${DIR}/sendmatrix.cnt
RESULT=${DIR}/sendmatrix.txt
MSGS=${DIR}/hass/sendsms.log
LOG=${DIR}/sendmatrix.log
MATRIX_COMMANDER=$HOME/.local/lib/python3.10/site-packages/matrix_commander/matrix_commander.py
MATRIX_CONFIG=$HOME/.config/matrix-commander/credentials.json
MATRIX_STORE=$HOME/.config/matrix-commander/store
#MATRIX_DEBUG=&quot;-d&quot;
MATRIX_DEBUG=&quot;&quot;

#
date &gt;&gt; ${LOG}
# monitor mode, look for file ${MSGS} modification
/usr/bin/inotifywait -m -e modify ${MSGS} 2&gt;&amp;1 | while read line
do
  echo &quot;$(date) - $line&quot;  &gt;&gt; ${LOG}
  # grab any hass script.sh new lines since last time
  /usr/local/bin/retail -T ${OFFSET} ${MSGS} &gt; ${RESULT}
  if [ ! -s &quot;${RESULT}&quot; ]; then
    rm ${RESULT}
  else
    # send text message to phone
    MSG=$(/bin/cat ${RESULT})
    /bin/cat ${RESULT} | /usr/bin/python3 ${MATRIX_COMMANDER} \
      -c ${MATRIX_CONFIG} -s ${MATRIX_STORE} --no-ssl ${MATRIX_DEBUG} -m - &gt;&gt;${LOG} 2&gt;&amp;1
    # nextcloud talk integration 
    ${HOME}/nextcloud/talk_mattermost.sh &quot;${MSG}&quot;
    #
    /bin/cat ${RESULT} &gt;&gt;${LOG} 2&gt;&amp;1
    date &gt;&gt; ${LOG}
  fi
done
</code></pre>

<h1 id="debug">Debug</h1>

<h2 id="matrix-commandercredentials">matrix-commander credentials</h2>

<p>This is the credentials.json file matrix-commander.py creates and uses.</p>

<pre><code>$ cat  ~/.config/matrix-commander/credentials.json |jq .
{
  &quot;homeserver&quot;: &quot;http://127.0.0.1:8008&quot;,
  &quot;device_id&quot;: &quot;GTSIKDHJEG&quot;,
  &quot;user_id&quot;: &quot;@user:matrix.example.com&quot;,
  &quot;room_id&quot;: &quot;!JshkYudiHksdhKHSKk:matrix.example.com&quot;,
  &quot;access_token&quot;: &quot;syt_ZTSjdlksshoidywlSKkDHIASLJW_0D2t3m&quot;
}
</code></pre>

<p>If you are interested in where the element values derive from, check these:</p>

<ul>
<li> device_id - <a href="https://matrix-org.github.io/synapse/develop/admin_api/user_admin_api.html?highlight=device_id#show-a-device">https://matrix-org.github.io/synapse/develop/admin_api/user_admin_api.html?highlight=device_id#show-a-device</a></li>
<li> user_id - <a href="https://matrix-org.github.io/synapse/develop/admin_api/user_admin_api.html">https://matrix-org.github.io/synapse/develop/admin_api/user_admin_api.html</a></li>
<li> room_id - <a href="https://matrix-org.github.io/synapse/v1.41/admin_api/rooms.html">https://matrix-org.github.io/synapse/v1.41/admin_api/rooms.html</a></li>
<li> access_token - <code>curl -XPOST \
-d '{&quot;type&quot;:&quot;m.login.password&quot;, &quot;user&quot;:&quot;&lt;userid&gt;&quot;, &quot;password&quot;:&quot;&lt;password&gt;&quot;}' \
&quot;https://example.com:8448/_matrix/client/r0/login&quot;</code></li>
</ul>

<h2 id="changeuserpassword">Change User Password</h2>

<p>As an admin, you can reset another user&#8217;s password.</p>

<p>Login as an admin and save an access token.</p>

<pre><code>curl -XPOST -d '{&quot;type&quot;:&quot;m.login.password&quot;, &quot;user&quot;:&quot;&lt;userId&gt;&quot;, &quot;password&quot;:&quot;&lt;pasword&gt;&quot;}' &quot;https://localhost:8448/_matrix/client/r0/login&quot;
</code></pre>

<p>Using that access token, reset any user&#8217;s password.</p>

<pre><code>curl -XPOST -H &quot;Authorization: Bearer &lt;access_token&gt;&quot; -H &quot;Content-Type: application/json&quot; -d '{&quot;new_password&quot;:&quot;&lt;new_password&gt;&quot;}' &quot;https://localhost:8448/_matrix/client/r0/admin/reset_password/&lt;userId&gt;&quot;
</code></pre>

<blockquote>
<p><userId> is fully qualified. E.g. @user:server.com</p>
</blockquote>

<p>Reference:</p>

<ul>
<li> <a href="https://github.com/matrix-org/synapse/blob/develop/docs/admin_api/user_admin_api.md">https://github.com/matrix-org/synapse/blob/develop/docs/admin_api/user_admin_api.md</a></li>
</ul>

<h2 id="matrixclient-serverapi">Matrix Client-Server API</h2>

<p>The easiest way to administer a Matrix-Synapse server is through the Client-Server API [1].</p>

<p>Visit the API overview for many examples with code for:</p>

<ul>
<li> Server Administration,</li>
<li> Account Management,</li>
<li> Spaces,</li>
<li> Event Relationships,</li>
<li> Threads,</li>
<li> Room Participation,</li>
<li> Session Management,</li>
<li> Capabilities,</li>
<li> Room Creation,</li>
<li> Device Management,</li>
<li> Room Discovery,</li>
<li> Room Directory,</li>
<li> Room Membership,</li>
<li> End-to-End Encryption,</li>
<li> Push Notifications,</li>
<li> Presence,</li>
<li> User Data,</li>
<li> and more.</li>
</ul>

<ol>
<li><a href="https://matrix.org/docs/api/#overview">https://matrix.org/docs/api/#overview</a></li>
</ol>

<h1 id="alternative:nextcloudtalk">Alternative: Nextcloud Talk</h1>

<p>NextCloud Talk is part of <a href="Cloud.md?fileId=571041">NextCloud Services</a>.</p>

<h1 id="continue">Continue</h1>

<p>Now that you have set up Matrix Communication on your server, you can read some news to send to others. Read on to find out how to set up a local news/RSS reader.</p>

<p>Proceed in the order presented, some things are depending on prior setups.</p>

<hr>

<h4 id="madeforhumansbyahuman">Made for Humans, by a Human</h4>

<h4 id="links">Links</h4>

<ul>
<li><a href="https://lwn.net/">Linux Weekly News</a></li>
<li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
<li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
<li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
<li><a href="https://www.thefarside.com/">The Far Side</a></li>
</ul>

<h4 id="social">Social</h4>

<ul>
<li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
<li><a href="/linux-in-house/feed-linux.rss">Linux RSS Feed</a></li>
<li><a href="/linux-in-house/feed-writing.rss">Writing RSS Feed</a></li>
<li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
</ul>

<div style="overflow-x:auto;">
<table style="width: 100%;">
<tr>
     <td>
<small><a href="/linux-in-house/linux/intro.html#createdwith">Created with</a></small>
     </td>
     <td>
<small>License: <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a></<small>
     </td>
     <td>

<p><small>linux-in-house Version: 4.52 </small></p>

<p></tr>
</table></p>

</div>


</body>
</html>

