<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Setup Server</title>
	<meta name="date" content="2525-01-01 10:00"/>
	<meta name="modified" content="2024-05-1 9:30"/>
	<meta name="tags" content="setup"/>
	<meta name="author" content="Don Cohoon"/>
	<meta name="summary" content="I use this as a guide to enable proper monitoring and maintenance of any new server on the network."/>
	<meta name="license" content="'[CC-BY-NC-SA 4.0](http://creativecommons.org/licenses/by-nc-sa/4.0/)'"/>
<meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/linux-in-house/common.css" type="text/css" />
</head>
<body>

<p><a href="/linux-in-house/"><h1>Linux in House</h1></a></p>

<link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
window.addEventListener('DOMContentLoaded', (event) => {
      new PagefindUI({ element: "#search", showSubResults: true });
});
</script>

<blockquote>
<p><a href="/linux-in-house/linux/welcome.html">Welcome Back My Friends</a></p>
</blockquote>

<h1 id="setupanewserver">Set Up a New Server</h1>

<p>I use this as a guide to enable proper monitoring and maintenance of any new server on the network.</p>

<br/>

<hr />

<div class="TOC">

<ul>
<li><a href="#setupanewserver">Set Up a New Server</a>
<ul>
<li><a href="#samplehomenetwork:">Sample Home Network:</a></li>
<li><a href="#checkyournetwork">Check your Network</a></li>
<li><a href="#updatepackagerepository">Update Package Repository</a>
<ul>
<li><a href="#debian">Debian</a></li>
<li><a href="#redhat">RedHat</a></li>
</ul>
</li>
<li><a href="#newuserandgrouptouse">New User and Group to Use</a>
<ul>
<li><a href="#debian">Debian</a></li>
<li><a href="#redhat">RedHat</a>
<ul>
<li><a href="#alsosettherootpassword">Also set the root password</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#firewall">Firewall</a>
<ul>
<li><a href="#debian">Debian</a></li>
<li><a href="#redhat">RedHat</a>
<ul>
<li><a href="#blockbadactorswholeautonomoussystem1groupsatatime">Block bad actors, whole Autonomous System [1] groups at a time</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#setyourhostanddomainnames">Set your host and domain names</a></li>
<li><a href="#rsyslog-sendsyslogentriestoremotesysloghost">Rsyslog - Send Syslog Entries to Remote Syslog Host</a>
<ul>
<li><a href="#localsystem">Local System</a></li>
<li><a href="#remotesysloghost">Remote Syslog Host</a></li>
<li><a href="#restartrsyslog">Restart rsyslog</a></li>
</ul>
</li>
<li><a href="#timecontrol">Time Control</a>
<ul>
<li><a href="#timezone">timezone</a></li>
<li><a href="#redhat">RedHat</a></li>
<li><a href="#debian">Debian</a></li>
</ul>
</li>
<li><a href="#e-mail-clientforsendinglocalmail">E-Mail - Client for Sending Local Mail</a>
<ul>
<li><a href="#identifymailclienthostanddomain">Identify Mail Client Host and Domain</a></li>
<li><a href="#mailtransportagentmtapackages">Mail Transport Agent (MTA) packages</a></li>
<li><a href="#macossendmailtolocalservernotsystemconfiguredinmailapp">MAC OS send mail to local server, not system configured in mail app</a></li>
<li><a href="#testmail">Test mail</a></li>
</ul>
</li>
<li><a href="#monit-monitorsystemandrestartprocesses">Monit - Monitor System and Restart Processes</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#process">Process</a></li>
</ul>
</li>
<li><a href="#munin-resourcehistorymonitor">Munin - Resource History Monitor</a>
<ul>
<li><a href="#munin-architecture.pnglinux-in-houseimagesmunin-architecture.png"><img src="/linux-in-house/images/Munin-Architecture.png" alt="Munin-Architecture.png" /></a></li>
<li><a href="#alertviae-mail:">Alert via e-mail:</a></li>
<li><a href="#adjustdiskfullthresholds:">Adjust disk full thresholds:</a></li>
<li><a href="#graphexamplemunin.pnglinux-in-houseimagesmunin.png">Graph Example<img src="/linux-in-house/images/munin.png" alt="munin.png" /></a></li>
<li><a href="#redhatalternative">Redhat Alternative</a></li>
</ul>
</li>
<li><a href="#fail2ban-automaticfirewallblocking">Fail2ban - Automatic Firewall Blocking</a>
<ul>
<li><a href="#install">Install</a></li>
<li><a href="#configure">Configure</a></li>
</ul>
</li>
<li><a href="#backup-saveyourfilesdaily">Backup - Save Your Files Daily</a>
<ul>
<li><a href="#automaticbackuptousbdisk">Automatic backup to USB disk</a></li>
<li><a href="#automaticbackupofpostgresqldatabase">Automatic Backup of PostgreSQL Database</a>
<ul>
<li><a href="#cron.daily">cron.daily</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#rsync-remotefilesynchronization">Rsync - Remote File Synchronization</a>
<ul>
<li><a href="#schedule">Schedule</a></li>
<li><a href="#script">Script</a></li>
</ul>
</li>
<li><a href="#logwatch-dailyalertofloggingactivity">Logwatch - Daily Alert of Logging Activity</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#schedule">Schedule</a></li>
<li><a href="#addservices">Add services</a></li>
</ul>
</li>
<li><a href="#logcheck-mailsanomaliesinthesystemlogfilestotheadmin">Logcheck - mails anomalies in the system logfiles to the admin</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#schedule">Schedule</a></li>
<li><a href="#changeemaildestination">Change email destination</a></li>
</ul>
</li>
<li><a href="#sysstat-gathersystemusagestatistics">Sysstat - Gather System Usage Statistics</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#paststatisticsreport">Past Statistics Report</a></li>
<li><a href="#sampleruns">Sample Runs</a></li>
</ul>
</li>
<li><a href="#s.m.a.r.t.diskmonitoring">S.M.A.R.T. Disk Monitoring</a>
<ul>
<li><a href="#installsoftware:">Install software:</a></li>
<li><a href="#configure">Configure</a></li>
<li><a href="#restart">Restart</a></li>
<li><a href="#monitoringscriptfortestingandreporting.">Monitoring script for testing and reporting.</a></li>
<li><a href="#smartddatabase">smartd database</a></li>
</ul>
</li>
<li><a href="#loginnoticestousers-motdissueissue.net">Login Notices to Users - motd/issue/issue.net</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#verify">Verify</a></li>
<li><a href="#examplelogin">Example login</a></li>
</ul>
</li>
<li><a href="#loginnotification">Login notification</a></li>
<li><a href="#continue">Continue</a>
<ul>
<li><a href="#madeforhumansbyahuman">Made for Humans, by a Human</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#social">Social</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

<hr />

<h3 id="samplehomenetwork:">Sample Home Network:</h3>

<p>..graphviz dot
strict digraph graphName {
bgcolor=&#8220;lightsteelblue&#8221;;
graph [rankdir = TD];
Modem  -&gt; Router  [dir=&#8220;both&#8221;];
Router  -&gt; MainSwitch [dir=&#8220;both&#8221;];
Router  -&gt; WiFi   [dir=&#8220;both&#8221;];
Router  -&gt; GuestWiFi;
GuestWiFi -&gt; Camera;
MainSwitch -&gt; ServerSwitch [dir=&#8220;both&#8221;];
MainSwitch -&gt; Desktop  [dir=&#8220;both&#8221;];
MainSwitch -&gt; Laptop  [dir=&#8220;both&#8221;];
ServerSwitch -&gt; MailServer;
ServerSwitch -&gt; WebServer;
ServerSwitch -&gt; NetworkAccessStorage;
}</p>

<p>Sometimes the Modem, Router and Main Switch are one unit, or there is no modem.</p>

<blockquote>
<p>&#8212;&#8211;&gt; Single Arrow is a limited access network (VLAN)</p>
</blockquote>

<blockquote>
<p>&lt;&#8212;-&gt; Double Arrows is an Open Network</p>
</blockquote>

<p>The key point here is that the servers are isolated on a separate switch for performance and security reasons, using a VLAN (Virtual Local Area Network) local to the Server Switch. Server VLAN network packets between each other never leave the Server Switch. Each server has another IP address <strong>not</strong> on the VLAN for public access.</p>

<p>A guest WiFi service does not have access to the Main Switch because it is on it&#8217;s own VLAN, so local resources are protected from that experimental 12 year old guest.</p>

<p>If my camera accesses a cloud service (most do), then I link it to the Guest WiFi for security purposes. Any other untrusted device will also be on the Guest WiFi, like Robot Vacuum Cleaners, Car Chargers, Car, TV streaming box, VOIP (Telephone VoiceOverIP), Garage Door Opener, Door Locks, etc&#8230;</p>

<p>Reference: <a href="https://www.graphviz.org/doc/info/colors.html">https://www.graphviz.org/doc/info/colors.html</a></p>

<p>Graph also available in:
bgcolor=&#8220;transparent&#8221;;</p>

<h3 id="checkyournetwork">Check your Network</h3>

<ul>
<li>See Network Interfaces</li>
</ul>

<hr/>

<p>The Debian Way</label></div></p>

<pre><code>:::Text
$ ifconfig
eno1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.0.8  netmask 255.255.255.0  broadcast 192.168.0.255
        inet6 fe80::0000:1111:3333:2222  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 2a:53:9b:00:f9:21  txqueuelen 1000  (Ethernet)
        RX packets 342047883  bytes 378663045018 (378.6 GB)
        RX errors 0  dropped 54131  overruns 0  frame 0
        TX packets 221663343  bytes 165067861773 (165.0 GB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        device interrupt 16  memory 0xc0b00000-c0b20000  
    
lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 32619960  bytes 99080107335 (99.0 GB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 32619960  bytes 99080107335 (99.0 GB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre>

<hr/>

<p>The RedHat and Newer Debian Way</p>

<pre><code>::Text
# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 36:27:10:52:32:96 brd ff:ff:ff:ff:ff:ff
    altname enp0s3
    inet 192.168.0.5/24 brd 10.0.2.255 scope global dynamic noprefixroute ens3
       valid_lft 66645sec preferred_lft 66645sec
    inet6 fec0::000:ff:1111:1111/64 scope site dynamic noprefixroute 
       valid_lft 86390sec preferred_lft 14390sec
    inet6 fe80::000:ff:1111:1111/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
</code></pre>

<hr/>

<ul>
<li>System Log is</li>
</ul>

<hr/>

<p>The Debian Way</p>

<pre><code>:::Text
/var/log/syslog
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>:::Text
/var/log/messages
</code></pre>

<hr/>

<ul>
<li>Bring Network Up:</li>
</ul>

<hr/>

<p>The Debian Way</p>

<pre><code>::Text
$ sudo cat /etc/netplan/01-network-manager-all.yaml
network:
    version: 2
    renderer: networkd
    ethernets:
        enp3s0:
            dhcp4: true
$ sudo netplan try
$ sudo netplan -d apply
$ sudo systemctl restart system-networkd
</code></pre>

<p>Reference: <a href="https://netplan.io/">https://netplan.io/</a></p>

<hr/>

<p>The RedHat Way</p>

<pre><code>::Text
$ sudo nmcli connection up ens3
    
vi /etc/sysconfig/network-scripts/ifcfg-ens3
~
ONBOOT=yes
~
:wq
</code></pre>

<p>Reference: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/configuring-an-ethernet-connection_configuring-and-managing-networking">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/configuring-an-ethernet-connection_configuring-and-managing-networking</a></p>

<hr/>

<h3 id="updatepackagerepository">Update Package Repository</h3>

<hr/>

<h4 id="debian">Debian</h4>

<p>Always refresh the package repository before getting started.</p>

<pre><code>:::Text
$ sudo apt-get update
</code></pre>

<p>You may need to add extra repositories, just check the sources.</p>

<p>The four main repositories are:</p>

<ul>
<li> Main - Canonical-supported free and open-source software.</li>
<li> Universe - Community-maintained free and open-source software.</li>
<li> Restricted - Proprietary drivers for devices.</li>
<li> Multiverse - Software restricted by copyright or legal issues.</li>
<li> Backports[1] - Software from older releases that should still work.</li>
</ul>

<p>Reference:</p>

<ol>
<li> Backports for old stuff you really really need.</li>
</ol>

<p>Universe is a typical add-on, beware of unstable.</p>

<pre><code>::Text
$ sudo add-apt-repository universe
$ sudo grep '^deb ' /etc/apt/sources.list
...
deb http://us.archive.ubuntu.com/ubuntu/ jammy universe
...
$ sudo add-apt-repository --remove universe
</code></pre>

<hr/>

<h4 id="redhat">RedHat</h4>

<p>Always refresh the package repository before getting started.</p>

<pre><code>:::Text
$ sudo dnf update
</code></pre>

</div>

<ul>
<li>Now I can disable <em>subscription-manager</em> since I do not have a RedHat subscription.</li>
</ul>

<p>Change:</p>

<ul>
<li> From -&gt; enabled=1</li>
<li> To -&gt; enabled=0</li>
</ul>

<p>In file: /etc/yum/pluginconf.d/subscription-manager.conf</p>

<pre><code>:::Text
$ sudo vi /etc/yum/pluginconf.d/subscription-manager.conf
$ sudo yum clean all
0 files removed
</code></pre>

<ul>
<li>You may need to add extra repositories, just check the sources.</li>
</ul>

<p>The EPEL repository provides additional high-quality packages for RHEL-based distributions. EPEL is a selection of packages from Fedora, but only packages that are not in RHEL or its layered products to avoid conflicts.</p>

<p>The folks at Fedora have very nicely put up an automatic build and repo system and they are calling it COPR (Cool Other Package Repositories).</p>

<pre><code>:::Text
$ sudo dnf install epel-release 'dnf-command(copr)' 
</code></pre>

<p>Reference:</p>

<ul>
<li> <a href="https://www.redhat.com/sysadmin/install-epel-linux">https://www.redhat.com/sysadmin/install-epel-linux</a></li>
<li> <a href="https://copr.fedorainfracloud.org/">https://copr.fedorainfracloud.org/</a></li>
</ul>

<hr/>

<h3 id="newuserandgrouptouse">New User and Group to Use</h3>

<p>Be sure to match the same <em>user numbers</em> across systems, because when sharing files using NFS, the numbers need to match.</p>

<pre><code>:::Text
$ sudo adduser don --uid 1001
Adding user `don' ...
Adding new group `don' (1001) ...
Adding new user `don' (1001) with group `don' ...
Creating home directory `/home/don' ...
Copying files from `/etc/skel' ...
New password:
Retype new password:
passwd: password updated successfully
Changing the user information for don
Enter the new value, or press ENTER for the default
 . . .  Full Name []: Don
 . . .  Room Number []:
 . . .  Work Phone []:
 . . .  Home Phone []:
 . . .  Other []:
Is the information correct? [Y/n] y
Adding new user `don' to extra groups ...
Adding user `don' to group `dialout' ...
Adding user `don' to group `i2c' ...
Adding user `don' to group `spi' ...
Adding user `don' to group `cdrom' ...
Adding user `don' to group `floppy' ...
Adding user `don' to group `audio' ...
Adding user `don' to group `video' ...
Adding user `don' to group `plugdev' ...
Adding user `don' to group `users' ...
</code></pre>

<p>If this user is an administrator;</p>

<hr/>

<h4 id="debian">Debian</h4>

<pre><code>:::Text
$ sudo usermod -aG sudo rootbk
</code></pre>

<p>Check user for group &#8216;27(sudo)&#8217;.</p>

<pre><code>:::Text
$ id rootbk
uid=1002(rootbk) gid=1002(rootbk) 
groups=1002(rootbk),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),44(video),46(plugdev),100(users),114(i2c),993(spi)
</code></pre>

<hr/>

<h4 id="redhat">RedHat</h4>

<pre><code>:::Text
$ sudo usermod -aG wheel rootbk
</code></pre>

<p>Check user for group &#8216;10(wheel)&#8217;.</p>

<pre><code>:::Text
# id don
uid=1002(rootbk) gid=1002(rootbk) groups=1002(rootbk),10(wheel)
</code></pre>

<hr/>

<h5 id="alsosettherootpassword">Also set the root password</h5>

<p>in case the system will not boot</p>

<pre><code>:::Bash
$ sudo passwd root
[sudo] password for don: 
New password: 
Retype new password: 
passwd: password updated successfully
</code></pre>

<h3 id="firewall">Firewall</h3>

<p>Every machine should have a firewall enabled, especially before connecting to the internet.</p>

<p>Now adays there is a choice between Uncomplicated Firewall (ufw) and firewalld. I choose firewalld.</p>

<hr/>

<h4 id="debian">Debian</h4>

<p>ufw - Uncomplicated Firewall</p>

<pre><code>:::Text
$ sudo apt-get install ufw
$ sudo ufw allow 22/tcp
$ sudo ufw enable
$ sudo ufw status numbered
Status: active
    
     To                         Action      From
     --                         ------      ----
[ 1] 22/tcp                     ALLOW IN    Anywhere                               
[ 2] 22/tcp (v6)                ALLOW IN    Anywhere (v6)           
    
$ sudo ufw delete 2
$ sudo ufw logging low
$ sudo ufw logging on
    
NOTE: Logging values are: low|medium|high. Only network blocks are logged on low.
</code></pre>

<p>Reference: <a href="https://launchpad.net/ufw">https://launchpad.net/ufw</a></p>

<hr/>

<h4 id="redhat">RedHat</h4>

<p>firewalld</p>

<pre><code>::Text
$ sudo dnf install firewalld
$ sudo firewall-cmd --add-service=ssh
success
$ sudo firewall-cmd --list-services
cockpit dhcpv6-client ssh
$ sudo firewall-cmd --remove-service=cockpit
success
$ sudo firewall-cmd --remove-service=dhcpv6-client
success
$ sudo firewall-cmd --list-services
ssh
$ sudo firewall-cmd --runtime-to-permanent
success
</code></pre>

<p>Reference: <a href="https://firewalld.org/">https://firewalld.org/</a></p>

<hr/>

<h5 id="blockbadactorswholeautonomoussystem1groupsatatime">Block bad actors, whole Autonomous System [1] groups at a time</h5>

<p>Using IP addresses from Logwatch, Logcheck, and Logwatcher, feed them into the firewall.sh script.</p>

<p>Run the <code>git clone</code> and install the dependencies based on your operating system.</p>

<p>File: ~/firewall.sh</p>

<pre><code>#!/bin/bash
##############################################################################
#
# File: firewall.sh
#
# Purpose: Block IP address or CIDR range using OS firewall
#
# Dependencies: 
#
#  git clone https://github.com/nitefood/asn 
#
#  * For more detail get an ~/.asn/iqs_token
#     from https://github.com/nitefood/asn#ip-reputation-api-token
#
# * **Debian 10 / Ubuntu 20.04 (or newer):**
#
#  ```
#  apt -y install curl whois bind9-host mtr-tiny jq ipcalc grepcidr nmap ncat aha
#  ```
#  * Enable ufw and allow the ports you need
#
#  # ufw allow 22
#  # ufw enable
#
#  * Delete rules not needed:
#  # ufw status numbered
#  # ufw delete &lt;number&gt;
#
# * **CentOS / RHEL / Rocky Linux 8:**
#
# # Install repos:
# $ sudo dnf repolist
# repo id                                repo name
# appstream                              CentOS Stream 9 - AppStream
# baseos                                 CentOS Stream 9 - BaseOS
# epel                                   Extra Packages for Enterprise Linux 9 - x86_64
# epel-next                              Extra Packages for Enterprise Linux 9 - Next - x86_64
# extras-common                          CentOS Stream 9 - Extras packages
#
# $ ls /etc/yum.repos.d
# centos-addons.repo  centos.repo  epel-next.repo  epel-next-testing.repo  epel.repo  epel-testing.repo  redhat.repo
#
# dnf install bind-utils jq whois curl nmap ipcalc grepcidr aha
#
#   If you have a list of IP addresses to block (text file, each IP on a separate line),
#     you can easily import that to your block list:
#
#    # firewall-cmd --permanent --ipset=networkblock --add-entries-from-file=/path/to/blocklist.txt
#    # firewall-cmd --reload
#
#   To view ipsets:
#    # firewall-cmd --permanent --get-ipsets
#     networkblock
#    # firewall-cmd --permanent --info-ipset=networkblock
#     networkblock
#       type: hash:net
#       options: maxelem=1000000 family=inet hashsize=4096
#       entries: 46.148.40.0/24
#
#   # firewall-cmd --add-service=smtp
#   success
#   # firewall-cmd --add-service=smtps
#   success
#   # firewall-cmd --list-services
#   cockpit dhcpv6-client smtp smtps ssh
#   # firewall-cmd --remove-service=cockpit
#   success
#   # firewall-cmd --remove-service=dhcpv6-client
#   success
#   # firewall-cmd --list-services
#   smtp smtps ssh
#   # firewall-cmd --runtime-to-permanent
#   success
#
#   # firewall-cmd --list-all
#     public (active)
#       target: default
#       icmp-block-inversion: no
#       interfaces: ens3
#       sources: 
#       services: smtp smtps ssh
#       ports: 
#       protocols: 
#       forward: no
#       masquerade: no
#       forward-ports: 
#       source-ports: 
#       icmp-blocks: 
#       rich rules: 
#
# https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/sec-setting_and_controlling_ip_sets_using_firewalld
#
# * TO UNDO A MISTAKEN BLOCK:
#   # firewall-cmd --permanent --ipset=networkblock --remove-entry=x.x.x.x/y
#   # firewall-cmd --reload
#
# * To drop ipset
#   # firewall-cmd --permanent --delete-ipset=networkblock
#   # firewall-cmd --reload
#
# Author     Date     Description
# ---------- -------- --------------------------------------------------------
# D. Cohoon  Jan-2023 Created
# D. Cohoon  Feb-2023 Add RedHat firewalld
##############################################################################
DIR=/root
LOG=${DIR}/firewall.log
WHO=/tmp/whois.txt
CIDR=/tmp/whois.cidr
IP=&quot;${1}&quot;
OS=$(/usr/bin/hostnamectl|/usr/bin/grep 'Operating System'|/usr/bin/cut -d: -f2|/usr/bin/awk '{print $1}')
#.............................................................................
function set_ipset() {
  FOUND_IPSET=0
  while read SET
  do
    if [ ! -z ${SET} ] &amp;&amp; [ ${SET} == &quot;networkblock&quot; ]; then
      FOUND_IPSET=1
    fi
  done &lt;&lt;&lt; $(sudo /usr/bin/firewall-cmd --permanent --get-ipsets) 
  #
  if [ $FOUND_IPSET -eq 0 ]; then
    # Create networkblock ipset
    sudo /usr/bin/firewall-cmd --permanent --new-ipset=networkblock --type=hash:net \
      --option=maxelem=1000000 --option=family=inet --option=hashsize=4096
    # Add new ipset to drop zone
    sudo /usr/bin/firewall-cmd --permanent --zone=drop --add-source=ipset:networkblock
    # reload
    sudo /usr/bin/firewall-cmd --reload
  fi
}
#
#.............................................................................
function run_asn() {
  ${DIR}/asn/asn -n ${IP} &gt; ${WHO}
  /usr/bin/cat ${WHO}
  RANGE=$(/usr/bin/cat ${WHO} | /usr/bin/grep 'NET' | /usr/bin/grep '/' | /usr/bin/awk -Fm '{print $6}' | /usr/bin/cut -d&quot; &quot; -f1)
  /usr/bin/echo &quot;CDR: ${RANGE}&quot;
  /usr/bin/echo &quot;${RANGE}&quot; &gt; ${CIDR}
}
#.............................................................................
#
if [ ${1} ]; then
  run_asn
else
  /usr/bin/echo &quot;Usage: ${0} &lt;IP Address&gt;&quot;
  exit 1
fi
#.............................................................................
#
  /usr/bin/grep -v deaggregate ${CIDR} &gt; ${CIDR}.block
  while read -r IP
  do
    /usr/bin/echo &quot;$(/usr/bin/date) - OS: ${OS}&quot; | /usr/bin/tee -a ${LOG}
    /usr/bin/echo &quot;Blocking: ${IP}&quot; | /usr/bin/tee -a ${LOG}
    case ${OS} in
      AlmaLinux|CentOS) 
        /usr/bin/echo &quot;Firewalld&quot;
        set_ipset
        sudo /usr/bin/firewall-cmd --permanent --ipset=networkblock --add-entry=${IP}
        sudo /usr/bin/firewall-cmd --reload
        ;;
      Ubuntu|Debian) 
        /usr/bin/echo &quot;ufw&quot;
        sudo /usr/sbin/ufw prepend deny from ${IP} to any 2&gt;&amp;1 |tee -a $LOG
        ;;
    esac
  done &lt; ${CIDR}.block
</code></pre>

<ol>
<li><a href="https://www.arin.net/resources/guide/asn/">https://www.arin.net/resources/guide/asn/</a></li>
</ol>

<h3 id="setyourhostanddomainnames">Set your host and domain names</h3>

<p>File: /etc/hosts</p>

<pre><code>:::Text
127.0.0.1	  localhost
192.168.1.5 	www.example.com 	example.com	www

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre>

<p>File: /etc/hostname</p>

<pre><code>:::Text
don.example.com
</code></pre>

<h3 id="rsyslog-sendsyslogentriestoremotesysloghost">Rsyslog - Send Syslog Entries to Remote Syslog Host</h3>

<p>It is a good idea to send log messages to another host in case the system crashes. You will be able to see that last gasping breath of the dying server. Also in the event of a compromised system hackers usually zero out the local syslog to cover their tracks. Now you still have any trace of the hackers on the central rsyslog host. It makes things simpler for detailed log analysis with combined logs on one system too.</p>

<h4 id="localsystem">Local System</h4>

<p><strong>Replicate log entries</strong>: Add the following to cause log entries to be in /var/log/syslog locally <em>and</em> be sent to a remote syslog host. If you do not have a Remote Syslog Host, skip this.</p>

<p>File: /etc/rsyslog.conf</p>

<p>Add these lines on local system.</p>

<pre><code>:::Text
~
# Remote logging - Aug 2020 Don
# Provides UDP forwarding
*.* @192.168.1.5:514 #this is the logging host
~
</code></pre>

<p><strong>Alert</strong>: Create the following to send syslog <strong>alerts</strong> to email if the <strong>severity</strong> is <strong>high</strong> (3 or below).</p>

<p>File: /etc/rsyslog.d/alert.conf</p>

<p>Create the file if it does not exist and replace with these lines.</p>

<pre><code>:::Text
module(load=&quot;ommail&quot;)
template (name=&quot;mailBody&quot;  type=&quot;string&quot; string=&quot;Alert for %hostname%:\n\nTimestamp: %timereported%\nSeverity:  %syslogseverity-text%\nProgram:   %programname%\nMessage:  %msg%&quot;)
template (name=&quot;mailSubject&quot; type=&quot;string&quot; string=&quot;[%hostname%] Syslog alert for %programname%&quot;)
    
if $syslogseverity &lt;= 3 and not ($msg contains 'brcmfmac') then {
   action(type=&quot;ommail&quot; server=&quot;192.168.1.3&quot; port=&quot;25&quot;
          mailfrom=&quot;rsyslog@localhost&quot;
          mailto=&quot;don@example.com&quot;
          subject.template=&quot;mailSubject&quot;
          template=&quot;mailBody&quot;
          action.execonlyonceeveryinterval=&quot;3600&quot;)
}
</code></pre>

<h4 id="remotesysloghost">Remote Syslog Host</h4>

<p><strong>Allow remote hosts to log here</strong>: Open firewall port 514/udp on remote syslog host.</p>

<pre><code>:::Text
$ sudo ufw allow 514/udp
</code></pre>

<p>File: /etc/rsyslog.conf</p>

<p>Add these lines to remote syslog host.</p>

<pre><code>:::Text
~
# provides UDP syslog reception
module(load=&quot;imudp&quot;)
input(type=&quot;imudp&quot; port=&quot;514&quot;)
~
# Process remote logs into seperate directories, then stop. Do not duplicate into syslog
$template RemoteLogs,&quot;/var/log/%HOSTNAME%/%PROGRAMNAME%.log&quot;
*.* ?RemoteLogs
&amp; stop
</code></pre>

<h4 id="restartrsyslog">Restart rsyslog</h4>

<pre><code>:::Text
$ sudo systemctl restart rsyslog
</code></pre>

<h3 id="timecontrol">Time Control</h3>

<p>All servers should be set up to synchronize their time over the network using Network Time Protocol (NTP). This is critical in validating security certificates. For offline systems, consider using a <a href="BeagleBone.md#real-time-clock-rtc-system-service-and-setup?fileId=697174">Real Time Clock</a> (RTC) attached to something like BeagleBone.</p>

<p>TODO: Link to Beaglebone</p>

<h4 id="timezone">timezone</h4>

<p>Change to match your timezone.</p>

<p>File: /etc/timezone</p>

<pre><code>:::Text
$ cat /etc/timezone
America/New_York
</code></pre>

<p>Set timezone with timedatactl, and verify.</p>

<pre><code>:::Text
$ sudo timedatectl set-timezone America/New_York
$ timedatectl
               Local time: Sun 2022-10-09 18:27:11 EDT
           Universal time: Sun 2022-10-09 22:27:11 UTC
                 RTC time: n/a
                Time zone: America/New_York (EDT, -0400)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
</code></pre>

<h4 id="redhat">RedHat</h4>

<p>RedHat uses chronyd service</p>

<p>File: /etc/chrony.conf</p>

<pre><code>:::Text
server pool.ntp.org iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
</code></pre>

<p>Restart to pick up new config</p>

<pre><code>:::Text
$ sudo systemctl restart chronyd
$ sudo systemctl status chronyd
 * chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2023-02-17 15:47:28 EST; 20h ago
     Docs: man:chronyd(8)
           man:chrony.conf(5)
  Process: 798 ExecStartPost=/usr/libexec/chrony-helper update-daemon (code=exited, status=0/SUCCESS)
  Process: 789 ExecStart=/usr/sbin/chronyd $OPTIONS (code=exited, status=0/SUCCESS)
 Main PID: 796 (chronyd)
    Tasks: 1 (limit: 11366)
   Memory: 2.3M
   CGroup: /system.slice/chronyd.service
           └─796 /usr/sbin/chronyd
</code></pre>

<p>Test</p>

<pre><code>:::Text
$ chronyc sources -v
    
  .-- Source mode  '^' = server, '=' = peer, '#' = local clock.
 / .- Source state '*' = current best, '+' = combined, '-' = not combined,
| /             'x' = may be in error, '~' = too variable, '?' = unusable.
||                                                 .- xxxx [ yyyy ] +/- zzzz
||      Reachability register (octal) -.           |  xxxx = adjusted offset,
||      Log2(Polling interval) --.      |          |  yyyy = measured offset,
||                                \     |          |  zzzz = estimated error.
||                                 |    |           \
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
== ============================================================================
^? your-ip-name-d&gt;             0   8     0     -     +0ns[   +0ns] +/-    0ns
...
$ timedatectl
               Local time: Wed 2023-07-12 09:03:57 EDT
           Universal time: Wed 2023-07-12 13:03:57 UTC
                 RTC time: Wed 2023-07-12 13:03:57
                Time zone: America/New_York (EDT, -0400)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
...
$ systemctl is-active chronyd.service
active
...
$ chronyc tracking
Reference ID    : 404F64C5 (ntpool1.258.ntp.org)
Stratum         : 3
Ref time (UTC)  : Wed Jul 12 12:47:34 2023
System time     : 0.000000002 seconds slow of NTP time
Last offset     : +1.114915133 seconds
RMS offset      : 1.114915133 seconds
Frequency       : 32.362 ppm slow
Residual freq   : +22.860 ppm
Skew            : 3.901 ppm
Root delay      : 0.046558209 seconds
Root dispersion : 0.050582517 seconds
Update interval : 0.0 seconds
Leap status     : Normal
</code></pre>

<p>Reference:</p>

<ul>
<li> <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_basic_system_settings/using-chrony-to-configure-ntp_configuring-basic-system-settings">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_basic_system_settings/using-chrony-to-configure-ntp_configuring-basic-system-settings</a></li>
</ul>

<h4 id="debian">Debian</h4>

<p>Debian uses systemd-timesyncd service.</p>

<pre><code>:::Bash
$ sudo systemctl status systemd-timesyncd
 * systemd-timesyncd.service - Network Time Synchronization
   Loaded: loaded (/lib/systemd/system/systemd-timesyncd.service; enabled; vendor preset: enabled)
  Drop-In: /lib/systemd/system/systemd-timesyncd.service.d
           └─disable-with-time-daemon.conf
   Active: active (running) since Sun 2022-07-24 12:06:36 EDT; 2 weeks 3 days ago
     Docs: man:systemd-timesyncd.service(8)
 Main PID: 559 (systemd-timesyn)
   Status: &quot;Synchronized to time server for the first time 192.155.94.72:123 (2.debian.pool.ntp.org).&quot;
    Tasks: 2 (limit: 951)
   Memory: 1.0M
   CGroup: /system.slice/systemd-timesyncd.service
           └─559 /lib/systemd/systemd-timesyncd
</code></pre>

<p>Reference:</p>

<ul>
<li> Debian: <a href="https://www.debian.org/doc/manuals/debian-handbook/sect.config-misc.en.html#sect.time-synchronization">https://www.debian.org/doc/manuals/debian-handbook/sect.config-misc.en.html#sect.time-synchronization</a></li>
<li> Ubuntu: <a href="https://ubuntu.com/server/docs/network-ntp">https://ubuntu.com/server/docs/network-ntp</a></li>
</ul>

<h3 id="e-mail-clientforsendinglocalmail">E-Mail - Client for Sending Local Mail</h3>

<h4 id="identifymailclienthostanddomain">Identify Mail Client Host and Domain</h4>

<p>Edit the following files:</p>

<ul>
<li>/etc/hostname (add fully qualified host &amp; domain; i.e.: www.example.com)</li>
<li>/etc/mailname (add domain; i.e.: example.com)</li>
</ul>

<h4 id="mailtransportagentmtapackages">Mail Transport Agent (MTA) packages</h4>

<p>Install an SMTP daemon to transfer mail to the E-Mail server.</p>

<hr/>

<ul>
<li>Debian</li>
</ul>

<p>Install postfix</p>

<pre><code>:::Text
$ sudo apt-get install postfix
</code></pre>

<p>Reconfigure postfix, if it does not pop up, and select <em>satellite</em> system.</p>

<pre><code>:::Text
$ sudo dpkg-reconfigure postfix
</code></pre>

<p>The following assumes your host is named <em>app</em> and your email server is <em>smtp.&lt;domain&gt;</em></p>

<p>File: /etc/postfix/main.cf</p>

<pre><code>:::Text
# See /usr/share/postfix/main.cf.dist for a commented, more complete version
# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname
    
smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no
    
# appending .domain is the MUA's job.
append_dot_mydomain = no
    
# Uncomment the next line to generate &quot;delayed mail&quot; warnings
#delay_warning_time = 4h
    
readme_directory = no
    
# See http://www.postfix.org/COMPATIBILITY_README.html -- default to 3.6 on
# fresh installs.
compatibility_level = 3.6
    
# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_security_level=may
    
smtp_tls_CApath=/etc/ssl/certs
smtp_tls_security_level=may
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
    
smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = app
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = app.example.com, $myhostname, app, localhost.localdomain, localhost
relayhost = smtp.example.com
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = loopback-only
inet_protocols = all
</code></pre>

<p>Check postfix systemd service.</p>

<pre><code>:::Text
$ sudo systemctl status postfix
● postfix.service - Postfix Mail Transport Agent
     Loaded: loaded (/lib/systemd/system/postfix.service; enabled; preset: enabled)
     Active: active (exited) since Sat 2023-07-22 09:32:00 EDT; 5h 26min ago
       Docs: man:postfix(1)
    Process: 1178 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 1178 (code=exited, status=0/SUCCESS)
        CPU: 1ms
    
Jul 22 09:32:00 app.example.com systemd[1]: Starting postfix.service - Postfix Mail Transport Agent...
Jul 22 09:32:00 app.example.com systemd[1]: Finished postfix.service - Postfix Mail Transport Agent.
</code></pre>

<hr/>

<ul>
<li>RedHat</li>
</ul>

<p>Install postfix</p>

<pre><code>:::Text
$ sudo dnf install postfix
</code></pre>

<p>The following assumes your host is named <em>app</em> and your email server is <em>smtp.&lt;domain&gt;</em></p>

<p>File: /etc/postfix/main.cf</p>

<pre><code>:::Text
smtpd_banner = $myhostname ESMTP $mail_name (Linux)
biff = no
    
# appending .domain is the MUA's job.
append_dot_mydomain = no
    
# Uncomment the next line to generate &quot;delayed mail&quot; warnings
#delay_warning_time = 4h
    
readme_directory = no
    
# See http://www.postfix.org/COMPATIBILITY_README.html -- default to 2 on
# fresh installs.
compatibility_level = 2
    
# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
    
# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.
    
smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = app.example.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
mydestination = app.example.com, localhost.example.com, localhost
relayhost = smtp.example.com
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.1.0/32
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = loopback-only
inet_protocols = all
</code></pre>

<p>Check the status of postfix</p>

<pre><code>:::Text
$ sudo systemctl status postfix
[sudo] password for don: 
● postfix.service - Postfix Mail Transport Agent
     Loaded: loaded (/usr/lib/systemd/system/postfix.service; enabled; preset: disabled)
     Active: active (running) since Wed 2023-06-07 17:43:43 EDT; 22h ago
   Main PID: 2182 (master)
      Tasks: 3 (limit: 99462)
     Memory: 8.6M
        CPU: 1.975s
     CGroup: /system.slice/postfix.service
             ├─ 2182 /usr/libexec/postfix/master -w
             ├─ 2184 qmgr -l -t unix -u
             └─15581 pickup -l -t unix -u
</code></pre>

<hr/>

<h4 id="macossendmailtolocalservernotsystemconfiguredinmailapp">MAC OS send mail to local server, not system configured in mail app</h4>

<p>Use the IP address of the local mail server, or you can edit /etc/hosts and use that name. Postfix does not run as a daemon, but is run by the SMTP process, probably fired of by a listener for port 25.</p>

<p>File: /etc/postfix/main.cf</p>

<pre><code>:::Text
% sudo vi /etc/postfix/main.cf
~
myhostname = square.example.com
~
mydomain = example.com
~
relayhost = [192.168.1.3]
</code></pre>

<hr/>

<h4 id="testmail">Test mail</h4>

<p>First install the command line mail interface(s). I use mail and mutt.</p>

<hr/>

<ul>
<li><p>Debian</p>

<p>:::Text
$ sudo apt-get install mailutils mutt
</p></li>
</ul>

<hr/>

<ul>
<li><p>RedHat</p>

<p>:::Text
$ sudo dnf install s-nail mutt
</p></li>
</ul>

<hr/>

<pre><code>:::Text
% mail -s &quot;Hello internal mail&quot;  don@example.com &lt;/dev/null
Null message body; hope that's ok
    
Shows up as: don@square.example.com
...
mutt -s &quot;Hello internal mail from mutt&quot;  don@example.com
    
Shows up as: don@square.local
</code></pre>

<p>Mutt change <em>from</em> address</p>

<p>File: ~/.muttrc</p>

<pre><code>:::Text
set from=&quot;Square &lt;don@square.example.com&gt;&quot;
set hostname=&quot;square.example.com&quot;
</code></pre>

<p>Shows up as: don@square.example.com</p>

<ul>
<li>Update root destination in aliases</li>
</ul>

<p>File: /etc/aliases</p>

<pre><code>:::Text
~
# Person who should get root's mail
#root:		marc
root:		bob@example.com
~
</code></pre>

<p>Update aliases into database format</p>

<pre><code>:::Text
$ sudo newaliases
</code></pre>

<ul>
<li>Create mail script to set variables</li>
</ul>

<p>File: ~/mail.sh</p>

<pre><code>#!/bin/bash
#######################################################################
#
# File: mail.sh
#
# Usage: mail.sh &lt;File Name to Mail&gt; &lt;Subject&gt;
#  Change the REPLYTO, FROM, and MAILTO variables
#  and choose RedHat or Debian
#
# Who       When        Why
# --------- ----------- -----------------------------------------------
# D. Cohoon Feb-2023    VPS host name cannot be changed, so set headers
#######################################################################
function usage () {
   /usr/bin/echo &quot;Usage: ${0} &lt;File Name to Mail&gt; &lt;Subject&gt;&quot;
   exit 1
}
#------------------
if [ $# -lt 2 ]; then
  usage
fi
#
if [ ! -z ${1} ] &amp;&amp; [ ! -f ${1} ]; then
  usage 
fi
#
#------------------
HOSTNAME=$(hostname -s)
DOMAINNAME=$(hostname -d)
FILE=${1}    # First arg
shift 1
SUBJECT=&quot;${HOSTNAME}.${DOMAINNAME}:${@}&quot; # Remainder of args
#
#------------------
export REPLYTO=root@app.example.com
FROM=root@app.example.com
#FROM=&quot;${HOSTNAME}@${DOMAINNAME}&quot;
MAILTO=bob@example.com
#
#------------------
# Debian: install mailutils
#/usr/bin/cat ${FILE} | /usr/bin/mail -aFROM:${FROM}  -s &quot;${SUBJECT}&quot; ${MAILTO}
# RedHat: install s-nail
#/usr/bin/cat ${FILE} | /usr/bin/mail --from-address=${FROM} -s &quot;${SUBJECT}&quot; ${MAILTO}
</code></pre>

<h3 id="monit-monitorsystemandrestartprocesses">Monit - Monitor System and Restart Processes</h3>

<p>Monit is a small Open Source utility for managing and monitoring Unix systems. Monit conducts automatic maintenance and repair and can execute meaningful causal actions in error situations.</p>

<p>Reference: <a href="https://mmonit.com/monit/">https://mmonit.com/monit/</a></p>

<h4 id="installation">Installation</h4>

<hr/>

<p>The Debian Way</p>

<pre><code>:::Text
$ sudo apt-get install monit
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>:::Text
$ sudo dnf install monit
</code></pre>

<hr/>

<h4 id="configuration">Configuration</h4>

<p>Change the mailserver to yours, and add some general monitoring.</p>

<p>File: /etc/monit/monitrc:</p>

<pre><code>:::Text
# Mail server
set mailserver www.example.com port 25   # primary mailserver
# Don 28-Dec 2021 - general monitoring
check system $HOST
  if loadavg (1min) per core &gt; 2 for 5 cycles then alert
  if loadavg (5min) per core &gt; 1.5 for 10 cycles then alert
  if cpu usage &gt; 95% for 5 cycles then alert
  if memory usage &gt; 90% then alert
  if swap usage &gt; 50% then alert
    
check device root with path /
  if space usage &gt; 90% then alert
  if inode usage &gt; 90% then alert
  if changed fsflags then alert
  if service time &gt; 250 milliseconds for 5 cycles then alert
  if read rate &gt; 500 operations/s for 5 cycles then alert
  if write rate &gt; 200 operations/s for 5 cycles then alert
    
check network eth0 with interface eth0
  if failed link then alert
  if changed link then alert
  if saturation &gt; 90%  for 2 cycles then alert
  if download &gt; 10 MB/s for 5 cycles then alert
  if total uploaded &gt; 1 GB in last hour then alert
    
check host REACHABILITY with address 1.1.1.1
  if failed ping with timeout 10 seconds then alert
</code></pre>

<h4 id="process">Process</h4>

<p>Monitor and restart the ssh process (and others that you may need using this as a guide).</p>

<p>File: /etc/monit/conf.d/sshd</p>

<pre><code>:::Text
check process sshd with pidfile /var/run/sshd.pid
    alert root@example.com with mail-format {
           from: monit@example.com
        subject: monit alert: $SERVICE $EVENT $DATE
        message: $DESCRIPTION
    }
  start program &quot;/etc/init.d/ssh start&quot;
  stop program &quot;/etc/init.d/ssh stop&quot;
</code></pre>

<h3 id="munin-resourcehistorymonitor">Munin - Resource History Monitor</h3>

<p>Munin is a networked resource monitoring tool (<a href="https://guide.munin-monitoring.org/en/latest/reference/history.html#history">started in 2002</a>) that can help analyze resource trends and <em>what just happened to kill our performance?</em> problems. It is designed to be very plug and play.</p>

<p>A default installation provides a lot of graphs with almost no work. <strong>Requires Apache or nginx for graphs.</strong></p>

<p>Reference: <a href="http://guide.munin-monitoring.org/en/latest/tutorial/alert.html">http://guide.munin-monitoring.org/en/latest/tutorial/alert.html</a></p>

<h4 id="munin-architecture.pnglinux-in-houseimagesmunin-architecture.png"><img src="/linux-in-house/images/Munin-Architecture.png" alt="Munin-Architecture.png" /></h4>

<p>Installation</p>

<p>On <em>all</em> nodes</p>

<hr/>

<p>The Debian Way</label></div></p>

<p>package libdb-pg-perl is required for postgresql</p>

<pre><code>:::Text
# sudo apt-get install munin libdbd-pg-perl
</code></pre>

<hr/>

<p>The RedHat Way</p>

<p>package perl-DBD-Pg is required for postgresql</p>

<pre><code>:::Text
# sudo dnf install munin perl-DBD-Pg
</code></pre>

<hr/>

<p>On <em>Munin-Master</em> node, add the following list of hosts to monitor:</p>

<p>File: /etc/munin.munin.conf</p>

<pre><code>:::Text
~
# Local Host
[app.example.com]
    address 127.0.0.1
    use_node_name yes
    
# E-Mail host
[www.example.com]
    address 192.168.1.3
    use_node_name yes
~
</code></pre>

<hr/>

<ul>
<li> The Debian (ufw) Way</li>
</ul>

<p>On <em>Munin-Node</em> node, allow master into IPv4/6 port:</p>

<pre><code>:::Text
$ sudo ufw allow 4949
$ sudo ufw status | grep 4949
4949                       ALLOW       Anywhere                  
4949 (v6)                  ALLOW       Anywhere (v6)    
</code></pre>

<p>IPv4 and IPv6</p>

<hr/>

<ul>
<li> The RedHat (firewall-cmd) Way</li>
</ul>

<p>On <em>Munin-Node</em> node, allow master into IPv4 port:</p>

<pre><code>:::Text
$ sudo firewall-cmd --permanent --zone=public --add-port=4949/tcp
$ sudo firewall-cmd --reload
$ sudo firewall-cmd --permanent --list-ports
4949/tcp
</code></pre>

<p>IPv4</p>

<hr/>

<ul>
<li> On <em>Munin-Node</em> node, add the <em>Munin-Master</em> IP address to the following:</li>
</ul>

<p>File: /etc/munin/munin-node.conf</p>

<pre><code>:::Text
~
# A list of addresses that are allowed to connect.  This must be a
# regular expression, since Net::Server does not understand CIDR-style
# network notation unless the perl module Net::CIDR is installed.  You
# may repeat the allow line as many times as you'd like
    
allow ^127\.0\.0\.1$
allow ^::1$
allow ^192\.168\.1\.3$
allow ^fe80::abcd:1234:0000:abcd$
~
</code></pre>

<p>Check your munin-node functions from command line using the <em>network cat</em> utility
Debian -&gt; <code>$ sudo apt-get install ncat</code>:
RedHat -&gt; <code>$ sudo dnf install ncat</code>:</p>

<p>Try comands:</p>

<ul>
<li> list</li>
<li> nodes</li>
<li> config &lt;item from list&gt;</li>
<li> fetch &lt;item from list&gt;</li>
<li> version</li>
<li> quit quit</li>
</ul>

<p>Examples:</p>

<pre><code>:::Text
$ ncat 127.0.0.1 4949
# munin node at app.example.com
list
acpi apache_accesses apache_processes apache_volume cpu df df_inode entropy forks fw_packets http_loadtime if_em1 if_eno1 if_err_em1 if_err_eno1 if_err_tun0 if_err_wlp58s0 if_tun0 if_wlp58s0 interrupts irqstats load lpstat memory munin_stats netstat ntp_198.23.200.19 ntp_208.94.243.142 ntp_216.218.254.202 ntp_91.189.94.4 ntp_96.126.100.203 ntp_kernel_err ntp_kernel_pll_freq ntp_kernel_pll_off ntp_offset ntp_states open_files open_inodes postfix_mailqueue postfix_mailvolume postgres_autovacuum postgres_bgwriter postgres_cache_ALL postgres_cache_twotree postgres_checkpoints postgres_connections_ALL postgres_connections_db postgres_connections_twotree postgres_locks_ALL postgres_locks_twotree postgres_querylength_ALL postgres_querylength_twotree postgres_scans_twotree postgres_size_ALL postgres_size_twotree postgres_transactions_ALL postgres_transactions_twotree postgres_tuples_twotree postgres_users postgres_xlog proc_pri processes swap threads uptime users vmstat
.
fetch df
_dev_nvme0n1p2.value 34.4721606114914
_dev_shm.value 0.000540811610733636
_run.value 0.183629672785198
_run_lock.value 0.15625
_run_qemu.value 0
_dev_sda1.value 39.2182617590549
_dev_nvme0n1p1.value 1.02513530868728
_dev_sdb1.value 29.1143742265263
.
fetch cpu
user.value 3392679
nice.value 310628
system.value 792413
idle.value 49254331
iowait.value 202415
irq.value 0
softirq.value 56281
steal.value 0
guest.value 0
</code></pre>

<p>Apache monitoring requires the mod_status to be enabled and add your IP address range to the status.conf.</p>

<p>Enable apache module mod_status:</p>

<pre><code>:::Text
$ sudo a2enmod status
</code></pre>

<p>Check the IP addresses in the apache status configuration. Change <code>Require ip &lt;address&gt;</code> to allow other IP addresses to connect to the munin monitor.</p>

<p>File: /etc/apache2/mods-enabled/status.conf</p>

<pre><code>:::Text
~
	&lt;Location /server-status&gt;
		SetHandler server-status
		Require local
		Require ip 192.168.1.0/24
		#Require ip 192.0.2.0/24
	&lt;/Location&gt;
~
</code></pre>

<p>Check apache plugin:</p>

<pre><code>:::Text
$ sudo munin-run apache_volume
volume80.value 500736
</code></pre>

<p>Check postgresql plugin:</p>

<pre><code>:::Text
$ sudo munin-run postgres_connections_miniflux
active.value 0
idle.value 1
idletransaction.value 0
unknown.value 0
waiting.value 0
</code></pre>

<p>Check the munin-node daemon status:</p>

<pre><code>:::Text
$ sudo systemctl status munin-node
</code></pre>

<p>Check the munin-master daemon status:</p>

<pre><code>:::Text
$ sudo systemctl status munin
</code></pre>

<p>The utility <strong>munin-node-configure</strong> is used by the Munin installation procedure to check which plugins are suitable for your node and create the links automatically. <em>It can be called every time when a system configuration changes (services, hardware, etc) on the node and it will adjust the collection of plugins accordingly.</em> &#8216;**-shell&#8217;** will display new configuration plugin links &#8216;ln -s &#8230;&#8217; for you.</p>

<p>For instance, below a new network interface (if) was discovered since the last configuration of munin. To enable the new monitoring simply execute the &#8216;ln -s &#8230;&#8217; commands to create soft links, so interface veth2e40fe9 will be monitored.</p>

<pre><code>:::Text
$ sudo munin-node-configure -shell
ln -s '/usr/share/munin/plugins/if_' '/etc/munin/plugins/if_veth2e40fe9'
ln -s '/usr/share/munin/plugins/if_err_' '/etc/munin/plugins/if_err_veth2e40fe9'
</code></pre>

<p>To have <a href="https://guide.munin-monitoring.org/en/latest/reference/munin-node-configure.html#munin-node-configure">munin-node-configure</a> display &#8216;rm &#8230;&#8217; commands for plugins with software that may no longer be installed, use the option ‘–remove-also’.</p>

<pre><code>:::Text
$ sudo munin-node-configure -shell -remove-also
ln -s '/usr/share/munin/plugins/if_' '/etc/munin/plugins/if_veth2e40fe9'
rm -f '/etc/munin/plugins/if_veth0049d71'
ln -s '/usr/share/munin/plugins/if_err_' '/etc/munin/plugins/if_err_veth2e40fe9'
rm -f '/etc/munin/plugins/if_err_veth0049d71'
</code></pre>

<p>Enabled monitors can be found in the same location</p>

<pre><code>:::Text
$ ls -l /etc/munin/plugins | grep apache
lrwxrwxrwx 1 root root 40 Jun 30  2018 apache_accesses -&gt; /usr/share/munin/plugins/apache_accesses
lrwxrwxrwx 1 root root 41 Jun 30  2018 apache_processes -&gt; /usr/share/munin/plugins/apache_processes
lrwxrwxrwx 1 root root 38 Jun 30  2018 apache_volume -&gt; /usr/share/munin/plugins/apache_volume
</code></pre>

<p>Testing new plugins has an <strong>autoconf</strong> option to munin-run. Errors will be displayed, and a debug &#8216;-d&#8217; option is also available.</p>

<pre><code>:::Text
$ sudo munin-run postgres_connections_miniflux autoconf
yes
    
$ sudo munin-run -d postgres_connections_miniflux autoconf
# Running 'munin-run' via 'systemd-run' with systemd properties based on 'munin-node.service'.
# Command invocation: systemd-run --collect --pipe --quiet --wait --property EnvironmentFile=/tmp/YRfAa1dq9U --property UMask=0022 --property LimitCPU=infinity --property LimitFSIZE=infinity --property LimitDATA=infinity --property LimitSTACK=infinity --property LimitCORE=infinity --property LimitRSS=infinity --property LimitNOFILE=524288 --property LimitAS=infinity --property LimitNPROC=14150 --property LimitMEMLOCK=65536 --property LimitLOCKS=infinity --property LimitSIGPENDING=14150 --property LimitMSGQUEUE=819200 --property LimitNICE=0 --property LimitRTPRIO=0 --property LimitRTTIME=infinity --property SecureBits=0 --property 'CapabilityBoundingSet=cap_chown cap_dac_override cap_dac_read_search cap_fowner cap_fsetid cap_kill cap_setgid cap_setuid cap_setpcap cap_linux_immutable cap_net_bind_service cap_net_broadcast cap_net_admin cap_net_raw cap_ipc_lock cap_ipc_owner cap_sys_module cap_sys_rawio cap_sys_chroot cap_sys_ptrace cap_sys_pacct cap_sys_admin cap_sys_boot cap_sys_nice cap_sys_resource cap_sys_time cap_sys_tty_config cap_mknod cap_lease cap_audit_write cap_audit_control cap_setfcap cap_mac_override cap_mac_admin cap_syslog cap_wake_alarm cap_block_suspend cap_audit_read cap_perfmon cap_bpf cap_checkpoint_restore' --property AmbientCapabilities= --property DynamicUser=no --property MountFlags= --property PrivateTmp=yes --property PrivateDevices=no --property ProtectClock=no --property ProtectKernelTunables=no --property ProtectKernelModules=no --property ProtectKernelLogs=no --property ProtectControlGroups=no --property PrivateNetwork=no --property PrivateUsers=no --property PrivateMounts=no --property ProtectHome=yes --property ProtectSystem=full --property NoNewPrivileges=no --property LockPersonality=no --property MemoryDenyWriteExecute=no --property RestrictRealtime=no --property RestrictSUIDSGID=no --property RestrictNamespaces=no --property ProtectProc=default --property ProtectHostname=no -- /usr/sbin/munin-run --ignore-systemd-properties -d postgres_connections_miniflux autoconf
# Processing plugin configuration from /etc/munin/plugin-conf.d/README
# Processing plugin configuration from /etc/munin/plugin-conf.d/dhcpd3
# Processing plugin configuration from /etc/munin/plugin-conf.d/munin-node
# Processing plugin configuration from /etc/munin/plugin-conf.d/spamstats
# Setting /rgid/ruid/ to /130/117/
# Setting /egid/euid/ to /130 130/117/
# Setting up environment
# Environment PGPORT = 5432
# Environment PGUSER = postgres
# About to run '/etc/munin/plugins/postgres_connections_miniflux autoconf'
yes
</code></pre>

<h4 id="alertviae-mail:">Alert via e-mail:</h4>

<p>Reference: <a href="https://guide.munin-monitoring.org/en/latest/tutorial/alert.html#alerts-send-by-local-system-tools">https://guide.munin-monitoring.org/en/latest/tutorial/alert.html#alerts-send-by-local-system-tools</a></p>

<p>Change your email here</p>

<p>File: /etc/munin/munin.conf</p>

<pre><code>:::Text
~
contact.email.command mail -s &quot;Munin-notification for ${var:group} :: ${var:host}&quot; your@email.address.here
~
</code></pre>

<h4 id="adjustdiskfullthresholds:">Adjust disk full thresholds:</h4>

<p>Adjust this in <em>master</em> /etc/munin.conf section for node</p>

<p>File: /etc/munin.conf</p>

<pre><code>:::Text
[beaglebone]
    address 192.168.1.7
    use_node_name yes
    diskstats_latency.mmcblk0.avgrdwait.warning 0:10
    diskstats_latency.mmcblk0.avgrdwait.critical -5:5
    diskstats_latency.mmcblk0.avgwdwait.warning 0:10
    diskstats_latency.mmcblk0.avgwdwait.critical -5:5
    diskstats_latency.mmcblk0.avgwait.warning 0:10
    diskstats_latency.mmcblk0.avgwait.critical -5:5
</code></pre>

<h4 id="graphexamplemunin.pnglinux-in-houseimagesmunin.png">Graph Example<img src="/linux-in-house/images/munin.png" alt="munin.png" /></h4>

<h4 id="redhatalternative">Redhat Alternative</h4>

<p>Cockpit</p>

<figure>
<img src="/linux-in-house/images/Cockpit-dashboard.png" alt="Cockpit Dashboard" />
<figcaption>Cockpit Dashboard</figcaption>
</figure>

<pre><code>:::Text
$ sudo systemctl start Cockpit
</code></pre>

<p>To log in to Cockpit, open your web browser to localhost:9090 and enter your Linux username and password.</p>

<p>Reference: <a href="https://www.redhat.com/sysadmin/intro-cockpit">https://www.redhat.com/sysadmin/intro-cockpit</a></p>

<h3 id="fail2ban-automaticfirewallblocking">Fail2ban - Automatic Firewall Blocking</h3>

<p>Daemon to ban hosts that cause multiple authentication errors by monitoring system logs.</p>

<p>Reference: <a href="https://github.com/fail2ban/fail2ban">https://github.com/fail2ban/fail2ban</a></p>

<h4 id="install">Install</h4>

<hr/>

<p>The Debian Way</p>

<pre><code>:::Text
$ sudo apt-get install fail2ban
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>:::Text
$ sudo dnf install fail2ban
</code></pre>

<hr/>

<h4 id="configure">Configure</h4>

<p>Create a jail.local file to override the defaults. Update your email and IP addresses to suit your environment. Also add or disable applications you do not run. See the reference above for example of how to do that.</p>

<p><code>action = %(action_)s</code> This defines the action to execute when a limit is reached. By default it will only block the user.</p>

<p>To receive an email at each ban, set it to:</p>

<p><code>action = %(action_mw)</code></p>

<p>To receive the logs with the mail, set it to:</p>

<p><code>action = %(action_mwl)</code></p>

<p>File: /etc/fail2ban/jail.local</p>

<pre><code>:::Text
[DEFAULT]
# email
destemail = don@example.com
sender = root@example.com
# ban &amp; send an e-mail with whois report and relevant log lines
# to the destemail.
action = %(action_mwl)s
# whitelist
ignoreip = 127.0.0.1 192.168.1.0/24 8.8.8.8 1.1.1.1
</code></pre>

<p>Secure sshd</p>

<p>File: /etc/fail2ban/jail.d/sshd.local</p>

<hr/>
The Debian Way

<pre><code>:::Text
[sshd]
enabled = true
port = 22
filter = sshd
action = iptables-multiport[name=sshd, port=&quot;ssh&quot;]
logpath = /var/log/auth.log
maxretry = 3
bantime = 1d
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>::Text
[sshd]
enabled = true
port = 22
filter = sshd
action = iptables-multiport[name=sshd, port=&quot;ssh&quot;]
logpath = /var/log/secure
maxretry = 3
bantime = 1d
</code></pre>

<hr/>

<p>More filters show which daemons are available to be enabled here: /etc/fail2ban/filter.d/</p>

<h3 id="backup-saveyourfilesdaily">Backup - Save Your Files Daily</h3>

<p>To find the proper name of your USB stick, check the current mounts:</p>

<pre><code>::Text
$ sudo lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
sda           8:0    0   1.8T  0 disk  
└─sda1        8:1    0   1.8T  0 part  
sdb           8:16   1     0B  0 disk  
sdc           8:32   1     0B  0 disk  
nvme0n1     259:0    0 238.5G  0 disk  
├─nvme0n1p1 259:1    0   300M  0 part  /boot/efi
├─nvme0n1p2 259:2    0 119.2G  0 part  /
├─nvme0n1p3 259:3    0  16.9G  0 part  [SWAP]
</code></pre>

<p>Plug it is, then check <code>dmesg -x</code> immediately after plugging it in. Look for :</p>

<pre><code>:::Text
[201373.210797]  sdd: sdd1
[201373.211917] sd 2:0:0:0: [sdd] Attached SCSI removable disk
</code></pre>

<p>Then run blkid again. You can see the new entry, sdd.</p>

<pre><code>:::Text
$ sudo lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
sda           8:0    0   1.8T  0 disk  
└─sda1        8:1    0   1.8T  0 part  
sdb           8:16   1     0B  0 disk  
sdc           8:32   1     0B  0 disk  
sdd           8:48   1  28.9G  0 disk  &lt;----- New USB Stick
nvme0n1     259:0    0 238.5G  0 disk  
├─nvme0n1p1 259:1    0   300M  0 part  /boot/efi
├─nvme0n1p2 259:2    0 119.2G  0 part  /
├─nvme0n1p3 259:3    0  16.9G  0 part  [SWAP]
</code></pre>

<h4 id="automaticbackuptousbdisk">Automatic backup to USB disk</h4>

<p>Format new USB stick.</p>

<p>Here are the commands to fdisk:</p>

<ul>
<li><p>m - menu</p></li>
<li><p>p - print existing partitions</p></li>
<li><p>d - delete partition</p></li>
<li><p>n - create new partition (in this case only a primary partition is required)</p></li>
<li><p>w - write partition</p></li>
<li><p>q - quit</p>

<p>::Text
$ sudo fdisk /dev/sdd
</p></li>
</ul>

<p>Check the USB stick label and filesystem (this example has no filesystem)</p>

<pre><code>::Text
$ sudo blkid /dev/sdd1
/dev/sdd1: PARTUUID=&quot;66bc7da7-1234-abcd-1234-ea4bfe7e00a7&quot;
</code></pre>

<p>So create an ext4 filesystem on the new partition(1)</p>

<pre><code>::Text
$ sudo mkfs.ext4 /dev/sdd1
mke2fs 1.46.2 (28-Feb-2021)
/dev/sdc1 contains a vfat file system
Proceed anyway? (y,N) y
Creating filesystem with 7566075 4k blocks and 1892352 inodes
Filesystem UUID: 8e33672c-1283-49de-98b8-6fd841372db6
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
	4096000
    
Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done 
</code></pre>

<p>Check the new filesystem, now we see it is TYPE=&#8220;ext4&#8221;</p>

<pre><code>:::Text
$ sudo blkid /dev/sdd1
/dev/sdc1: UUID=&quot;8e33672c-1234-49de-abcd-6fd841372db6&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;ext4&quot; PARTUUID=&quot;66bc7da7-c9c3-4342-8073-ea4bfe7e00a7&quot;
</code></pre>

<p>Label the USB stick as &#8216;backup&#8217; so autobackup can find and mount it, then verify that LABEL=&#8220;backup&#8221;</p>

<pre><code>:::Text
$ sudo e2label /dev/sdd1 backup
$ sudo blkid /dev/sdd1
/dev/sdd1: LABEL=&quot;backup&quot; UUID=&quot;8e33672c-1234-49de-abcd-6fd841372db6&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;ext4&quot; PARTUUID=&quot;66bc7da7-c9c3-4342-8073-ea4bfe7e00a7&quot;
</code></pre>

<p>Copy the autobackup software onto this server</p>

<pre><code>:::Text
$ git clone https://github.com/bablokb/autobackup-service
</code></pre>

<p>Install the autobackup software</p>

<pre><code>:::Text
$ cd autobackup-service/
$ sudo ./tools/install
</code></pre>

<p>RedHat Changes</p>

<p>Lines: 21, 30, 31</p>

<p>File: ./tools/install</p>

<pre><code> 17 check_packages() {
 18   local p
 19   for p in &quot;$@&quot;; do
 20     echo -en &quot;Checking $p ... &quot; &gt;&amp;2
 21     rpm -qa &quot;$p&quot; 2&gt;/dev/null | grep -q &quot;Status.*ok&quot; || return 0
 22     echo &quot;ok&quot; &gt;&amp;2
 23   done
 24   return 1
 25 }
 26 
 27 install_packages() {
 28   if [ -n &quot;$PACKAGES&quot; ] &amp;&amp; check_packages $PACKAGES; then
 29     echo -e &quot;[INFO] installing additional packages&quot; 2&gt;&amp;1
 30     dnf update
 31     dnf -y --no-upgrade install $PACKAGES
 32   fi
 33 }
</code></pre>

<p>Edit the autobackup configuration file, assigning LABEL=backup, and other items below:</p>

<p>File: /etc/autobackup.conf</p>

<pre><code>~
# =&gt; File: /etc/autobackup.conf &lt;=
# label of backup partition
LABEL=backup

# write messages to syslog
SYSLOG=1

# wait for device to appear (in seconds)
WAIT_FOR_DEVICE=2

# run a backup on every mount (i.e. multiple daily backups)
force_daily=0

# backup-levels - this must match your entries in /etc/rsnapshot.conf,
i.e.
# you must have a corresponding 'retain' or 'interval' entry.
# The autobackup-script will skip empty levels
daily=&quot;day&quot;
weekly=&quot;week&quot;
monthly=&quot;month&quot;
yearly=&quot;&quot;
&quot;/etc/autobackup.conf&quot; line 29 of 29 --100%--
</code></pre>

<p>Edit the rsnapshot configuration file, be sure to use TABS in the BACKUP POINTS / SCRIPTS section.</p>

<p>File: /etc/rsnapshot.conf</p>

<pre><code>~
# =&gt; File /etc/rsnapshot.conf &lt;=
###########################
# SNAPSHOT ROOT DIRECTORY #
###########################
 
# All snapshots will be stored under this root directory.
#
#snapshot_root  /var/cache/rsnapshot/
snapshot_root   /tmp/autobackup/.autobackup/
~ 
~
#########################################
#     BACKUP LEVELS / INTERVALS         #
# Must be unique and in ascending order #
# e.g. alpha, beta, gamma, etc.         #
#########################################

retain  day     7
retain  week    4
retain  month   3
#retain year    3

###############################
### BACKUP POINTS / SCRIPTS ###
###############################
 
# LOCALHOST
# backup  /etc/           ./
# backup  /var/backups/   ./
# backup  /usr/local/     ./
# backup  /home           ./
# NOTE: Use tabs!
# LOCALHOST$
backup^I/etc/^I./$
backup^I/var/backups/^I./$
backup^I/usr/local/^I./$
backup^I/home^I^I./$    
~
> &quot;/etc/rsnapshot.conf&quot;
</code></pre>

<p>Copy autobackup script from install to your home directory</p>

<pre><code>cp autobackup-service/files/usr/local/sbin/autobackup $HOME/autobackup-service/autobackup.sh
</code></pre>

<p>Comment out lines 58 through 61 from &#8220;&lt;&quot; to &quot;&gt;&#8221; below, to allow running in cron.</p>

<blockquote>
<p>autobackup-service normally runs automatically when a USB stick with the proper label is inserted into the machine. Comment out the <code>if</code> statement to allow it to run by cron.</p>
</blockquote>

<p>File: $HOME/autobackup-service/autobackup.sh</p>

<pre><code>:::Text
58,61c60,64
&lt;   if [ &quot;${DEVICE:5:3}&quot; != &quot;$udev_arg&quot; ]; then
&lt;     msg &quot;info: partition with label $LABEL is not on newly plugged device $udev_arg&quot;
&lt;     exit 0
&lt;   fi
---
&gt; # Don -&gt; do not check, as we are screduling through cron
&gt; #  if [ &quot;${DEVICE:5:3}&quot; != &quot;$udev_arg&quot; ]; then
&gt; #    msg &quot;info: partition with label $LABEL is not on newly plugged device $udev_arg&quot;
&gt; #    exit 0
&gt; #  fi
</code></pre>

<p>Schedule in /etc/cron.d (change your home directory):</p>

<p>File: /etc/cron.d/autobackup-daily</p>

<pre><code>:::Text
# This is a cron file for autobackup/rsnapshot.
# 0 */4		* * *		root	/usr/bin/rsnapshot alpha
# 30 3   	* * *		root	/usr/bin/rsnapshot beta
# 0  3   	* * 1		root    /usr/bin/rsnapshot gamma
# 30 2   	1 * *		root	/usr/bin/rsnapshot delta
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=&quot;don@example.com&quot;
# m h  dom mon dow user  command
55 12  *   *   *   root  /home/don/autobackup-service/autobackup.sh
</code></pre>

<p>Log entries will be in the syslog</p>

<pre><code>:::Text
$ sudo grep autobackup.sh /var/log/syslog
Jan 23 12:51:11 box autobackup.sh: info: LABEL           = backup
Jan 23 12:51:11 box autobackup.sh: info: WAIT_FOR_DEVICE = 2
Jan 23 12:51:11 box autobackup.sh: info: force_daily     = 0
Jan 23 12:51:11 box autobackup.sh: info: yearly          = 
Jan 23 12:51:11 box autobackup.sh: info: monthly         = month
Jan 23 12:51:11 box autobackup.sh: info: weekly          = week
Jan 23 12:51:11 box autobackup.sh: info: daily           = day
Jan 23 12:51:13 box autobackup.sh: info: checking: 
Jan 23 12:51:13 box autobackup.sh: info: mount-directory: /tmp/autobackup
Jan 23 12:51:13 box autobackup.sh: info: current year:  2021
Jan 23 12:51:13 box autobackup.sh: info: current month: 01
Jan 23 12:51:13 box autobackup.sh: info: current week:  03
Jan 23 12:51:13 box autobackup.sh: info: current day:   023
Jan 23 12:51:13 box autobackup.sh: info: starting backup for interval: month (last backup: 0)
Jan 23 12:51:13 box autobackup.sh: info: starting backup for interval: week (last backup: 0)
Jan 23 12:51:13 box autobackup.sh: info: starting backup for interval: day (last backup: 0)
Jan 23 12:51:15 box autobackup.sh: info: umounting /dev/sda1
</code></pre>

<h4 id="automaticbackupofpostgresqldatabase">Automatic Backup of PostgreSQL Database</h4>

<p>Place a script in /etc/cron.daily and it will be run once a day, using the root account.</p>

<h5 id="cron.daily">cron.daily</h5>

<p>To check the times look here:</p>

<hr/>
The Debian Way

<pre><code>:::Text
$ grep run-parts /etc/crontab
17 *	* * *	root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )
</code></pre>

<p>So our daily runs start at 6:25am every day.</p>

<hr/>

<p>The RedHat Way</p>

<pre><code>:::Text
# cat /etc/anacrontab 
# /etc/anacrontab: configuration file for anacron
    
# See anacron(8) and anacrontab(5) for details.
    
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
# the maximal random delay added to the base delay of the jobs
RANDOM_DELAY=45
# the jobs will be started during the following hours only
START_HOURS_RANGE=3-22
    
#period in days   delay in minutes   job-identifier   command
1	5	cron.daily		nice run-parts /etc/cron.daily
7	25	cron.weekly		nice run-parts /etc/cron.weekly
@monthly 45	cron.monthly		nice run-parts /etc/cron.monthly
</code></pre>

<p>So our daily runs start &#8230; any idea?</p>

<hr/>

<p>Backing up a PostrgreSQL database can be done while everything is up and running with the following script. Backups are stored in /data/backups.</p>

<p>File: /etc/cron.daily/backup_nextcloud</p>

<pre><code>#!/bin/bash
LOGFILE=/var/log/backup_db.log
ID=$(id -un)
if [ ${ID} != &quot;root&quot; ]; then
  echo &quot;Must run as root, try sudo&quot;
  exit 1
fi
#
echo $(date) ${0} &gt;&gt; $LOGFILE

umask 027
export DATA=/data/backups
if cd ${DATA}; then
  # Postgres
  #/usr/bin/pg_dump -c nextcloud &gt; $DATA/nextcloud.db.$(date +%j) &lt;/dev/null
  sudo -u postgres /usr/bin/pg_dump -c nextcloud &gt; $DATA/nextcloud.db &lt;/dev/null
  
  date &gt;&gt; $LOGFILE
  sync
  sync
  sync
  sync
  savelog -c 7 nextcloud.db &gt;&gt;$LOGFILE 2&gt;&amp;1
fi
</code></pre>

<h3 id="rsync-remotefilesynchronization">Rsync - Remote File Synchronization</h3>

<p>Rsync is a good way to keep a daily backup as it only copies changed files to the destination. Make sure you use a separate disk and preferably separate system, as rsync works great over the network.</p>

<blockquote>
<p>The PostgreSQL backup above should be sent off to another system using this method. Another rsync script should be called by PostgreSQL backup to do the database network backup. Just copy this one, change the directories, and call it at the end of the database backup.</p>
</blockquote>

<h4 id="schedule">Schedule</h4>

<p>This cron entry will run at 8:40am every day by user root.</p>

<p>File: /etc/cron.d/rsync</p>

<pre><code>:::Text
# This is a cron file for rsync to NAS 
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=&quot;don@example.com&quot;
# m h  dom mon dow user  command
40 8  *   *   *   root  /mnt/raid1/rsync.sh noask
</code></pre>

<h4 id="script">Script</h4>

<p>This script will backup the local directory, /mnt/raid1/data, to a remote system (IP Address 192.168.1.2). The files on the remote system will be at /mnt/vol09/backups. The first run will copy everything, all next runs will only copy changed files. Any files deleted on the source will also be deleted on the destination.</p>

<p>To schedule in cron the parameter &#8216;noask&#8217; is used, as shown above. Otherwise there is a prompt for y/n.</p>

<p>The last run&#8217;s history is in log file /mnt/raid1/rsync.log.</p>

<p>File: /mnt/raid1/rsync.sh</p>

<pre><code>#!/bin/bash
DIR=/mnt/raid1
LOG=${DIR}/rsync.log
cd ${DIR}
date &gt;${LOG}
ASK=${1}
if [ -z ${ASK} ]; then
	echo &quot;Asking&quot;
fi
#
if [ -z ${ASK} ]; then
  echo -n &quot;Copy data? y/n: &quot;
  read askme
  if [[ $askme =~ ^[Yy]$ ]]; then
    rsync -avzz --ignore-errors --progress --delete ${DIR}/data root@192.168.1.2:/mnt/vol09/backups/ |tee -a ${LOG}
  else
    echo &quot;Sync of data skipped&quot;
    echo &quot;. . .&quot;
  fi
else
  rsync -avzz --ignore-errors --progress --delete ${DIR}/data root@192.168.1.2:/mnt/vol09/backups/ |tee -a ${LOG}
fi
#
date &gt;&gt;${LOG}
</code></pre>

<h3 id="logwatch-dailyalertofloggingactivity">Logwatch - Daily Alert of Logging Activity</h3>

<p>Logwatch is a customizable, pluggable log-monitoring system. It will go through your logs for a given period of time and make a report in the areas that you wish with the detail that you wish. Logwatch is being used for Linux and many types of UNIX.</p>

<h4 id="installation">Installation</h4>

<p>Debian:</p>

<pre><code>$ sudo apt-get install logwatch
</code></pre>

<p>Redhat:</p>

<pre><code>$ sudo dnf install logwatch
</code></pre>

<h4 id="schedule">Schedule</h4>

<p>File: /etc/cron.daily/00logwatch</p>

<pre><code>#!/bin/bash

#Check if removed-but-not-purged
test -x /usr/share/logwatch/scripts/logwatch.pl || exit 0

#execute
#/usr/sbin/logwatch --output mail
/usr/sbin/logwatch --mailto don@example.com

#Note: It's possible to force the recipient in above command
#Just pass --mailto address@a.com instead of --output mail
</code></pre>

<h4 id="addservices">Add services</h4>

<p>You can add iptables summary on the daily report. It shows which IP addresses have been blocked by UFW.</p>

<pre><code>$ sudo cp /usr/share/logwatch/default.conf/services/iptables.conf /etc/logwatch/conf/services/
</code></pre>

<p>You may need to add syslog on Ubuntu servers</p>

<p>File: /etc/logwatch/conf/services/iptables.conf</p>

<hr/>

<p>The Debian Way</p>

<pre><code>~
# Which logfile group...
LogFile = syslog
~
</code></pre>

<hr/>

<h3 id="logcheck-mailsanomaliesinthesystemlogfilestotheadmin">Logcheck - mails anomalies in the system logfiles to the admin</h3>

<p>The logcheck program helps spot problems and security violations in your logfiles automatically and will send the results to you periodically in an e-mail. By default logcheck runs as an hourly cronjob just off the hour and after every reboot.</p>

<h4 id="installation">Installation</h4>

<hr/>

<p>The Debian Way</p>

<pre><code>$ sudo apt-get install logcheck
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>$ sudo dnf install epel-release 'dnf-command(copr)'
$ sudo dnf copr enable brianjmurrell/epel-8
$ sudo dnf install logcheck
$ sudo setfacl -R -m u:logcheck:rx /var/log/secure*
$ sudo setfacl -R -m u:logcheck:rx /var/log/messages*
$ sudo dnf copr disable brianjmurrell/epel-8
</code></pre>

<hr/>

<h4 id="schedule">Schedule</h4>

<p>Normally the package installation will schedule a cron job for you. Check it here:</p>

<p>File: /etc/cron.d/logcheck</p>

<pre><code>:::Text
# Cron job runs at 2 minutes past every hour
# /etc/cron.d/logcheck: crontab entries for the logcheck package
    
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
    
@reboot         logcheck    if [ -x /usr/sbin/logcheck ]; then nice -n10 /usr/sbin/logcheck -R; fi
2 * * * *       logcheck    if [ -x /usr/sbin/logcheck ]; then nice -n10 /usr/sbin/logcheck; fi
    
# EOF
</code></pre>

<h4 id="changeemaildestination">Change email destination</h4>

<p>Change SENDMAILTO variable to point to your email.</p>

<p>File: /etc/logcheck/logcheck.conf</p>

<pre><code>~
# Controls the address mail goes to:
# *NOTE* the script does not set a default value for this variable!
# Should be set to an offsite &quot;emailaddress@some.domain.tld&quot;

#SENDMAILTO=&quot;logcheck&quot;
SENDMAILTO=&quot;don@example.com&quot;
~
</code></pre>

<h3 id="sysstat-gathersystemusagestatistics">Sysstat - Gather System Usage Statistics</h3>

<p>The sysstat[1] package contains various utilities, common to many commercial Unixes, to monitor system performance and usage activity:</p>

<ul>
<li>iostat reports CPU statistics and input/output statistics for block devices and partitions.</li>
<li>mpstat reports individual or combined processor related statistics.</li>
<li>pidstat reports statistics for Linux tasks (processes) : I/O, CPU, memory, etc.</li>
<li>tapestat reports statistics for tape drives connected to the system.</li>
<li>cifsiostat reports CIFS statistics.</li>
</ul>

<p>Sysstat also contains tools you can schedule via cron or systemd to collect and historize performance and activity data:</p>

<ul>
<li>sar collects, reports and saves system activity information (see below a list of metrics collected by sar).</li>
<li>sadc is the system activity data collector, used as a backend for sar.</li>
<li>sa1 collects and stores binary data in the system activity daily data file. It is a front end to sadc designed to be run from cron or systemd.</li>
<li>sa2 writes a summarized daily activity report. It is a front end to sar designed to be run from cron or systemd.</li>
<li>sadf displays data collected by sar in multiple formats (CSV, XML, JSON, etc.) and can be used for data exchange with other programs. This command can also be used to draw graphs for the various activities collected by sar using SVG (Scalable Vector Graphics) format.</li>
</ul>

<p>Default sampling interval is 10 minutes but this can be changed of course (it can be as small as 1 second).</p>

<blockquote>
<p>Redhat Cockpit uses pmlogger.service [2] from systemd. Install from Cockpit&#8217;s Overview, Metrics and history.</p>
</blockquote>

<p>RedHat pmstat [3]</p>

<pre><code>:::Text
$ pmstat
@ Mon Jun 12 10:02:01 2023
 loadavg                      memory      swap        io    system         cpu
   1 min   swpd   free   buff  cache   pi   po   bi   bo   in   cs  us  sy  id
    0.00 116224 231636   3284 13116m    0    0    0   17  348  387   0   0 100
    0.00 116224 233328   3284 13116m    0    0    0    0  339  383   0   0 100
    0.00 116224 228704   3284 13116m    0    0    0    0  333  358   0   0 100
    0.00 116224 227192   3284 13116m    0    0    0    6  493  548   0   0  99
^C
$ pmstat -a /var/log/pcp/pmlogger/bob.example.com/20230610.0.xz -t 2hour -A 1hour -z
Note: timezone set to local timezone of host &quot;bob.example.com&quot; from archive
    
@ Sat Jun 10 01:00:00 2023
 loadavg                      memory      swap        io    system         cpu
   1 min   swpd   free   buff  cache   pi   po   bi   bo   in   cs  us  sy  id
    0.08   2048  7646m   6440  6591m    0    0    0    3  198  237   0   0 100
    0.08   2048  7650m   6440  6596m    0    0    0    3  202  237   0   0 100
    0.06   2048  7643m   6440  6600m    0    0    0    3  204  236   0   0 100
    0.00   2048  7597m   6440  6624m    0    0    2   27  219  261   0   0 100
    0.09   2048  7609m   6440  6629m    0    0    0    3  215  259   0   0 100
    0.03   2048  7593m   6440  6633m    0    0    0    3  220  261   0   0 100
    0.00   2048  7585m   6440  6638m    0    0    0    4  223  263   0   0 100
    0.01      0 14402m   6740 495508    ?    ?    ?    ?    ?    ?   ?   ?   ?
    0.00      0 14268m   6740 630344    ?    ?    ?    ?    ?    ?   ?   ?   ?
    0.15      0 14272m   6740 634764    0    0    0    2  162  151   0   0 100
    0.13      0 14266m   6740 639188    0    0    0    2  164  152   0   0 100
 pmFetchGroup: End of PCP archive log
</code></pre>

<p>Reference:
 1 <a href="https://github.com/sysstat/sysstat">https://github.com/sysstat/sysstat</a>
2 <a href="https://cockpit-project.org/guide/latest/feature-pcp.html">https://cockpit-project.org/guide/latest/feature-pcp.html</a>
3 <a href="https://pcp.readthedocs.io/en/latest/UAG/MonitoringSystemPerformance.html#the-pmstat-command">https://pcp.readthedocs.io/en/latest/UAG/MonitoringSystemPerformance.html#the-pmstat-command</a></p>

<h4 id="installation">Installation</h4>

<hr/>

<p>The Debian Way</p>

<pre><code>$ sudo apt-get install sysstat
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>$ sudo dnf install sysstat
</code></pre>

<hr/>

<h4 id="configuration">Configuration</h4>

<p>It should configure itself, but just in case:</p>

<hr/>

<p>The Debian Way</p>

<pre><code>$ sudo dpkg-reconfigure sysstat
Replacing config file /etc/default/sysstat with new version
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>$ vi /etc/sysconfig/sysstat
$ sudo systemctl enable --now sysstat
</code></pre>

<hr/>

<p>The history files are kept here:</p>

<hr/>

<p>The Debian Way</p>

<pre><code>$ ls /var/log/sysstat/
sa07
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>$ ls /var/log/sa/
sa07
</code></pre>

<hr/>

<p>The timer is in the systemd configuration file. OnCalendar defines the interval. In this case data is collected every ten minutes. WantedBy defines that the timer should be active when the sysstat.service is running.</p>

<blockquote>
<p>Use <code>systemctl edit sysstat-collect.timer</code> to edit this file. It will automatically create an override file in the right place and enable it for you, and preserve the change over release updates.</p>
</blockquote>

<p>File: /usr/lib/systemd/system/sysstat-collect.timer</p>

<pre><code># /lib/systemd/system/sysstat-collect.timer
# (C) 2014 Tomasz Torcz &lt;tomek@pipebreaker.pl&gt;
#
# sysstat-12.5.2 systemd unit file:
#        Activates activity collector every 10 minutes

[Unit]
Description=Run system activity accounting tool every 10 minutes

[Timer]
OnCalendar=*:00/10

[Install]
WantedBy=sysstat.service
</code></pre>

<p>Above, Systemd edit override example changing the interval from 10 minutes to 5:</p>

<pre><code>:::Text
# ls -lrt /etc/systemd/system/sysstat-collect.timer.d/
total 4
-rw-r--r--. 1 root root 27 Feb 19 09:38 override.conf
# more /etc/systemd/system/sysstat-collect.timer.d/override.conf 
[Timer]
OnCalendar=*:00/05
</code></pre>

<p>Reference:</p>

<p><a href="https://www.catalyst2.com/knowledgebase/server-management/how-to-install-configure-sysstat/">https://www.catalyst2.com/knowledgebase/server-management/how-to-install-configure-sysstat/</a></p>

<h4 id="paststatisticsreport">Past Statistics Report</h4>

<p>Report on system statistics over the last few days.</p>

<p>File: sar.sh</p>

<pre><code>#!/bin/bash
#################################
# Files are here:
# ls -l /var/log/sysstat/
#  -rw-r--r-- 1 root root 49064 Feb  9 16:35 sa09
#
# Report on some other day:
#  sar -u 2 3 -f /var/log/sysstat/sa15
#
# Output to file:
#  sar -u 2 3 -o /tmp/logfile
#################################
echo &quot;Disk&quot;
sar -d 2 3
echo &quot;Network&quot;
sar -n DEV 2 3
echo &quot;CPU&quot;
sar -u 2 3
sar -P ALL -u 2 3
echo &quot;Memory&quot;
sar -r 2 3
echo &quot;Paging&quot;
sar -B 2 3
echo &quot;Swap&quot;
sar -S 2 3
echo &quot;Load&quot;
sar -q 2 3
</code></pre>

<h4 id="sampleruns">Sample Runs</h4>

<p>Memory</p>

<pre><code>:::Text
$ sar -r
Linux 5.10.120-ti-arm64-r64 (app.example.com) 	11/07/2022 	_aarch64_	(2 CPU)
    
02:09:36 PM kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
02:10:01 PM    872556   2467364   1037140     27.37    162024   1529680   3898804     66.24    999112   1645384       536
Average:       872556   2467364   1037140     27.37    162024   1529680   3898804     66.24    999112   1645384       536
</code></pre>

<p>IO</p>

<pre><code>:::Text
$ sar -b
Linux 5.10.120-ti-arm64-r64 (app.example.com) 	11/07/2022 	_aarch64_	(2 CPU)
    
02:09:36 PM       tps      rtps      wtps      dtps   bread/s   bwrtn/s   bdscd/s
02:10:01 PM      6.63      0.16      6.47      0.00      2.25    312.46      0.00
Average:         6.63      0.16      6.47      0.00      2.25    312.46      0.00
</code></pre>

<p>Network</p>

<pre><code>::Text
$ sar -n DEV
Linux 5.10.120-ti-arm64-r64 (app.example.com) 	11/07/2022 	_aarch64_	(2 CPU)
    
02:09:36 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
02:10:01 PM        lo      3.94      3.94      1.66      1.66      0.00      0.00      0.00      0.00
02:10:01 PM      eth0      4.10      5.27      0.37      1.72      0.00      0.00      0.00      0.00
02:10:01 PM      usb0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
02:10:01 PM      usb1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
02:10:01 PM   docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
Average:           lo      3.94      3.94      1.66      1.66      0.00      0.00      0.00      0.00
Average:         eth0      4.10      5.27      0.37      1.72      0.00      0.00      0.00      0.00
Average:         usb0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
Average:         usb1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
Average:      docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
</code></pre>

<p>Load and Run Queue</p>

<pre><code>:::Text
$ sar -q
Linux 5.10.120-ti-arm64-r64 (app.example.com) 	11/07/2022 	_aarch64_	(2 CPU)
    
02:09:36 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
02:10:01 PM         3       531      0.74      0.61      0.51         0
Average:            3       531      0.74      0.61      0.51         0
</code></pre>

<h3 id="s.m.a.r.t.diskmonitoring">S.M.A.R.T. Disk Monitoring</h3>

<p>Monitor and notify disk health using smartmontools, and email any notifications.</p>

<h4 id="installsoftware:">Install software:</h4>

<hr/>

<p>The Debian Way</label></div></p>

<pre><code>$ sudo apt-get install smartmontools
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>$ sudo dnf install smartmontools
</code></pre>

<hr/>

<h4 id="configure">Configure</h4>

<p>Add Long monitoring test for Sunday (/dev/sda through /dev/sdX) and comment out DEVICESCAN:</p>

<hr/>

<p>The Debian Way</p>

<p>File: /etc/smartd.conf</p>

<hr/>

<p>The RedHat Way</p>

<p>File: /etc/smartmontools/smartd.conf</p>

<hr/>

<pre><code>~
# Don - 5-Nov-2021
#   -a      Default: equivalent to -H -f -t -l error -l selftest -C 197 -U 198
#   -d TYPE Set the device type: ata, scsi, marvell, removable, 3ware,N, hpt,L/M/N
#   -n MODE No check. MODE is one of: never, sleep, standby, idle
#   -s REGE Start self-test when type/date matches regular expression (see man page)
#           T/MM/DD/d/HH 
#           ^ ^  ^  ^ ^
#           | |  |  | + 24 Hour
#           | |  |  +-- Day of week, 1(monday) through 7(sunday)
#           | |  +----- Day of month, 1 ~ 31
#           | +-------- Month of year, 01 (January) to 12 (December)
#           +---------- T is the type of test that should be run, options are:
#
#                       L for long self-test
#                       S for short self-test
#                       C for conveyance test
#                       O for an Offline immediate Test
#
#   -W D,I,C Monitor Temperature D)ifference, I)nformal limit, C)ritical limit
#   -m ADD  Send warning email to ADD for -H, -l error, -l selftest, and -f
#/dev/nvme0 -a -n never -W 2,30,40 -m don@example.com
# Start long tests on Sunday 9am and short
#  self-tests every night at 2am and send errors to me
#/dev/sda   -a -n never -s (L/../../7/09|S/../.././02) -W 2,30,40 -m don@example.com -M test
/dev/sda   -a -n never -s (L/../../7/09|S/../.././02) -W 2,42,50 -m don@example.com -M diminishing
#/dev/sdb   -a -n never -s (L/../../7/09|S/../.././02) -W 2,30,40 -m don@example.com
# Don - 5-Nov-2021
~
#DEVICESCAN -d removable -n standby -m root -M exec /usr/share/smartmontools/smartd-runner
~
</code></pre>

<h4 id="restart">Restart</h4>

<p>Restart smartd daemon to pick up configuration changes</p>

<pre><code>$ sudo systemctl restart smartd
</code></pre>

<h4 id="monitoringscriptfortestingandreporting.">Monitoring script for testing and reporting.</h4>

<p>Change the DEV below and see if your disks support SMART monitoring.</p>

<pre><code>#!/bin/bash
DEV=&quot;/dev/sda&quot;
# Info
sudo smartctl -i &quot;${DEV}&quot;
# Show
sudo smartctl -P show &quot;${DEV}&quot;
# turn smart on/off
#sudo smartctl -s on &quot;${DEV}&quot;
# Errors?
sudo smartctl -l error &quot;${DEV}&quot;
# Health Check
sudo smartctl -Hc &quot;${DEV}&quot;
# Selftest Log
sudo smartctl -l selftest &quot;${DEV}&quot;
# Attributes
#  Problems if...
#    Reallocated_Sector_Ct &gt; 0
#    Current_Pending_Sector &gt; 0
sudo smartctl -A &quot;${DEV}&quot;
#
#.... T E S T S ....
# -&gt; short ... couple of minutes
# sudo smartctl -t short /dev/sda
# -&gt; long ... one hour
# sudo smartctl -t long /dev/sda
# -&gt; Look at test results
# sudo smartctl -a /dev/sda
# 
#.... R E P O R T ....
sudo smartctl --attributes --log=selftest   &quot;${DEV}&quot;
#
# - Get the temprature
sudo hddtemp /dev/sda
</code></pre>

<h4 id="smartddatabase">smartd database</h4>

<p>The history of each smartd monitored disk is located here:</p>

<pre><code>$ ls /var/lib/smartmontools/
drivedb						       smartd.Samsung_SSD_980_1TB-S64ANS0T408956M.nvme.state~  smartd.Samsung_SSD_980_1TB-S64ANS0T418940T.nvme.state~
smartd.Samsung_SSD_980_1TB-S64ANS0T408956M.nvme.state  smartd.Samsung_SSD_980_1TB-S64ANS0T418940T.nvme.state

</code></pre>

<p>If you replace the disks and get error reports, you can remove the files and new ones will be created</p>

<pre><code>$ sudo rm /var/lib/smartmontools/smartd.Samsung_SSD_980_1TB-S64ANS0T4*
</code></pre>

<p>Run smartctl for each disk:</p>

<pre><code>sudo smartctl -i /dev/sda
sudo smartctl -i /dev/sdb
...
</code></pre>

<p>Then check the history data files. New ones should show up.</p>

<pre><code>$ ls /var/lib/smartmontools/
attrlog.CT1000BX500SSD1-2251E695AE97.ata.csv  smartd.CT1000BX500SSD1-2251E695AE97.ata.state   smartd.CT1000BX500SSD1-2251E695AE9E.ata.state~
attrlog.CT1000BX500SSD1-2251E695AE9E.ata.csv  smartd.CT1000BX500SSD1-2251E695AE97.ata.state~  smartd.Samsung_SSD_980_1TB-S64ANS0T408956M.nvme.state
drivedb					      smartd.CT1000BX500SSD1-2251E695AE9E.ata.state   smartd.Samsung_SSD_980_1TB-S64ANS0T418940T.nvme.state
</code></pre>

<h3 id="loginnoticestousers-motdissueissue.net">Login Notices to Users - motd/issue/issue.net</h3>

<p>You can customize the Message of the Day (motd), and infomation displayed when loggin in to the system.</p>

<h4 id="installation">Installation</h4>

<hr/>

<p>The Debian Way</label></div></p>

<pre><code>$ sudo apt-get install cowsay fortune
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>$ sudo dnf install cowsay fortune-mod
</code></pre>

<hr/>

<h4 id="configuration">Configuration</h4>

<p>Update the message (/etc/motd) every hour.</p>

<p>File: /etc/cron.hourly/motd</p>

<hr/>

<p>The Debian Way</p>

<pre><code>#!/bin/bash
/usr/games/cowsay $(/usr/games/fortune) &gt; /etc/motd
</code></pre>

<hr/>

<p>The RedHat Way</p>

<pre><code>#!/bin/bash
/bin/cowsay $(/bin/fortune) &gt; /etc/motd
</code></pre>

<hr/>

<h4 id="verify">Verify</h4>

<p>File: /etc/motd</p>

<pre><code> _________________________________________
/ Your mind is the part of you that says, \
| &quot;Why'n'tcha eat that piece of cake?&quot;    |
| ... and then, twenty minutes later,     |
| says, &quot;Y'know, if I were you, I         |
| wouldn't have done that!&quot; -- Steven and |
\ Ondrea Levine                           /
 -----------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre>

<p>File: /etc/issue</p>

<pre><code>Look out!
</code></pre>

<p>File: /etc/issue.net</p>

<pre><code>Looke out!
</code></pre>

<h4 id="examplelogin">Example login</h4>

<pre><code>% ssh don@example         
Looke out!
 _________________________________________
/ Individuality My words are easy to      \
| understand And my actions are easy to   |
| perform Yet no other can understand or  |
| perform them. My words have meaning; my |
| actions have reason; Yet these cannot   |
| be known and I cannot be known. We are  |
| each unique, and therefore valuable;    |
| Though the sage wears coarse clothes,   |
| his heart is jade. -- Lao Tse, &quot;Tao Te  |
\ Ching&quot;                                  /
 -----------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
Last login: Sun Aug 21 10:13:57 2022 from 192.168.1.4
</code></pre>

<h3 id="loginnotification">Login notification</h3>

<p>Add the following lines to the end of the system bashrc for notification whenever <em>any user</em> logs into the system (with the bash shell).</p>

<hr/>

<p>The Debian Way</label></div></p>

<p>File: /etc/bash.bashrc</p>

<hr/>

<p>The RedHat Way</p>

<p>File: /etc/bashrc</p>

<hr/>

<pre><code>:::Text
~
# Email logins - Don November 2020
echo $(who am i) ' just logged on ' $(hostname) ' ' $(date) $(who) | mail -s &quot;Login on&quot; don@example.com
</code></pre>

<h3 id="continue">Continue</h3>

<p>Now that I have set up my new server, I&#8217;ll consider giving it an internet name with DNS.</p>

<p>Proceeding in the order presented, some things are depending on prior setups.</p>

<object type="image/svg+xml" data="/images/Linux-in-the-House2.svg" style="width:5%; height:10%; text-align: right">
Linux-in-the-House.svg<!-- fallback image in CSS -->
</object>

<hr>

<h4 id="madeforhumansbyahuman">Made for Humans, by a Human</h4>

<h4 id="links">Links</h4>

<ul>
<li><a href="https://lwn.net/">Linux Weekly News</a></li>
<li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
<li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
<li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
<li><a href="https://www.thefarside.com/">The Far Side</a></li>
</ul>

<h4 id="social">Social</h4>

<ul>
<li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
<li><a href="/linux-in-house/feed-Linux.rss">Linux RSS Feed</a></li>
<li><a href="/linux-in-house/feed-Writing.rss">Writing RSS Feed</a></li>
<li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
</ul>

<div style="overflow-x:auto;">
<table style="width: 100%;">
<tr>
     <td>
<small><a href="http://10.123.50.59:8080/linux-in-house/linux/intro.html#createdwith">Created with</a></small>
     </td>
     <td>
<small>License: <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a></<small>
     </td>
     <td>
<small>linux-in-house Version:  4.18 </small>

<p></tr>
</table></p>

</div>


</body>
</html>

