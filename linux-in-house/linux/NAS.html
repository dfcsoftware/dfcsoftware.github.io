<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
	<title>NAS</title>
	<meta name="date" content="2023-01-25 10:10"/>
	<meta name="modified" content="2024-04-19 9:30"/>
	<meta name="tags" content="systems, hardware"/>
	<meta name="author" content="Don Cohoon"/>
	<meta name="summary" content="The NAS provides a safe place to store important data. Set this up before running E-Mail or a cloud service because it is the best place to put important files. If an E-Mail server crashes you still have all your E-Mail files on the NFS (see below) attached NAS server. That's what it's for."/>
	<meta name="license" content="'[CC-BY-NC-SA 4.0](http://creativecommons.org/licenses/by-nc-sa/4.0/)'"/>
<meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/linux-in-house/common.css" type="text/css" />
</head>
<body>

<p><a href="/linux-in-house/"><h1>Linux in House</h1></a></p>

<link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
window.addEventListener('DOMContentLoaded', (event) => {
      new PagefindUI({ element: "#search", showSubResults: true });
});
</script>

<blockquote>
<p><a href="/linux-in-house/linux/welcome.html">Welcome Back My Friends</a></p>
</blockquote>

<h1 id="networkattachedstoragenas">Network Attached Storage (NAS)</h1>

<p>The NAS provides a safe place to store important data. Set this up before running E-Mail or a cloud service because it is the best place to put important files. If an E-Mail server crashes you still have all your E-Mail files on the NFS (see below) attached NAS server. That&#8217;s what it&#8217;s for.</p>

<br/>

<hr />

<div class="TOC">

<ul>
<li><a href="#networkattachedstoragenas">Network Attached Storage (NAS)</a>
<ul>
<li><a href="#truenasstorage">TrueNAS Storage</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#unixlinuxserver-networkfilesystemnfs">Unix/Linux Server - Network File System (NFS)</a>
<ul>
<li><a href="#installnfssoftware">Install NFS software</a></li>
<li><a href="#enablenfsservice">Enable NFS Service</a></li>
<li><a href="#createdirectorytoshare">Create Directory to Share</a></li>
<li><a href="#exportshare">Export Share</a></li>
<li><a href="#loadexportsintolivesystem">Load exports into live system</a></li>
<li><a href="#connecttonfsserverfromlinuxclient">Connect to NFS server from Linux client</a>
<ul>
<li><a href="#installsoftwareonclient">Install Software on Client</a></li>
<li><a href="#mountdirectory">Mount Directory</a></li>
<li><a href="#makemountpermanent">Make mount permanent</a></li>
</ul>
</li>
<li><a href="#nfsmountonmacosclient">NFS mount on Macos Client</a>
<ul>
<li><a href="#createlocaldirectory">Create local directory</a></li>
<li><a href="#mount">Mount</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#microsoftwindowssmbcifs">Microsoft Windows (SMB/CIFS)</a>
<ul>
<li><a href="#disablingtheautomaticprintersharing">Disabling the Automatic Printer Sharing</a></li>
<li><a href="#restartsamba">Restart Samba</a></li>
<li><a href="#addlinuxowner">Add Linux owner</a></li>
<li><a href="#addsmbuser">Add SMB User</a></li>
<li><a href="#securethefilesystem">Secure the filesystem</a></li>
<li><a href="#sambasharemountonlinuxclient">Samba Share mount on Linux client</a></li>
<li><a href="#sambasharemountonmacclient">Samba Share mount on Mac client</a></li>
</ul>
</li>
<li><a href="#mirrordisksforfailureprotection">Mirror Disks for Failure Protection</a></li>
<li><a href="#virtualmachines">Virtual Machines</a></li>
<li><a href="#continue">Continue</a>
<ul>
<li><a href="#madeforhumansbyahuman">Made for Humans, by a Human</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#social">Social</a></li>
</ul>
</li>
</ul>
</div>

<hr />

<p>Three (common) ways to do this:</p>

<ol>
<li>TrueNAS Storage</li>
<li>Microsoft Windows - SMB/CIFS</li>
<li>Linux - NFS</li>
</ol>

<blockquote>
<p>TrueNAS supports SMB/CIFS, NFS and several other protocols.</p>
</blockquote>

<h2 id="truenasstorage">TrueNAS Storage</h2>

<p>This is a complete machine install that creates a TrueNAS Application <em>and</em> the operating system using either:</p>

<ul>
<li>Operating System -&gt; FreeBSD; TrueNAS -&gt; Core [1]</li>
<li>Operating System -&gt; Linux; TrueNAS -&gt; Scale [2]</li>
</ul>

<p>Personally I use Linux after running FreeBSD for years. Both have a complete Graphical Web Interface (GWI), with no need to learn the operating system details. Be aware this package will <strong>take over the whole machine</strong> and you <em>should not</em> install other packages or change the configuration without using the provided GWI.</p>

<p>Additionally TrueNAS enables apps [3] to be installed with a single click. These are docker containers running the newer versions of popular applications.</p>

<ol>
<li><a href="https://www.truenas.com/download-truenas-core/#">https://www.truenas.com/download-truenas-core/#</a></li>
<li><a href="https://www.truenas.com/download-truenas-scale/">https://www.truenas.com/download-truenas-scale/</a></li>
<li><a href="https://www.truenas.com/apps/">https://www.truenas.com/apps/</a></li>
</ol>

<h3 id="installation">Installation</h3>

<ul>
<li><p>Make sure you have at least three disks/SSDs. One for the Operating System (OS) and at least two more for data. An ideal setup would be one M2 on the motherboard for the OS, and five SATA disks (NAS friendly). Also at least 32GB RAM and a PCI 1Gbit ethernet network board.</p></li>
<li><p>Download the iso image here:</p></li>
</ul>

<p><a href="https://www.truenas.com/download-truenas-scale/">https://www.truenas.com/download-truenas-scale/</a></p>

<ul>
<li>Boot into the new image with a bootable USB stick and do the install:</li>
</ul>

<p><a href="https://www.truenas.com/docs/scale/gettingstarted/install/installingscale/">https://www.truenas.com/docs/scale/gettingstarted/install/installingscale/</a></p>

<h3 id="configuration">Configuration</h3>

<ul>
<li>Console Setup Menu Configuration [1]</li>
</ul>

<p>This article provides instructions on configuration network settings using the Console setup menu after you install TrueNAS SCALE from the iso file.</p>

<ol>
<li><a href="https://www.truenas.com/docs/scale/gettingstarted/install/consolesetupmenuscale/">https://www.truenas.com/docs/scale/gettingstarted/install/consolesetupmenuscale/</a></li>
</ol>

<hr />

<ul>
<li>Setting Up Storage [2]</li>
</ul>

<p>This article provides basic instructions for setting up your first storage pool, and also provides storage requirement information.</p>

<ol>
<li><a href="https://www.truenas.com/docs/scale/gettingstarted/install/setupstoragescale/">https://www.truenas.com/docs/scale/gettingstarted/install/setupstoragescale/</a></li>
</ol>

<hr />

<ul>
<li>Setting Up Data Sharing [3]</li>
</ul>

<p>This article provides general information on setting up basic data sharing on TrueNAS SCALE.</p>

<ol>
<li><a href="https://www.truenas.com/docs/scale/gettingstarted/install/setupsharing/">https://www.truenas.com/docs/scale/gettingstarted/install/setupsharing/</a></li>
</ol>

<hr />

<ul>
<li>Backing Up TrueNAS [4]</li>
</ul>

<p>This article provides general information and instructions on setting up storage data backup solutions and saving the system configuration file in TrueNAS SCALE.</p>

<ol>
<li><a href="https://www.truenas.com/docs/scale/gettingstarted/install/setupbackupscale/">https://www.truenas.com/docs/scale/gettingstarted/install/setupbackupscale/</a></li>
</ol>

<hr />

<p><strong>Set Admin User:</strong> Enable your personal userid for administration and use it to log into the web interface instead of root.</p>

<ul>
<li>Add groups 544(builtin_administrators) and 27(sudo) as secondary groups to your personal user via the web interface.</li>
</ul>

<ol>
<li>Credentials &gt; Local Users &gt;</li>
<li>Un-click &#8216;Show Built-in Users&#8217; on the top right</li>
<li>Find user, select it, then edit</li>
<li>Auxiliary Groups &gt; add: sudo and builtin_administrators</li>
</ol>

<blockquote>
<p>For Core -&gt; Scale upgrades, you may need to unmount /var/tmp/firmware to unpack the update archive. Filesystem /var has more disk space. <code>umount -f /var/tmp/firmware</code></p>
</blockquote>

<p>There is a large community of support around each of these, ready for research and question asking.</p>

<p>It supports Redundant Array of Disks using ZFS [1], so one disk failure will not interrupt a running system, and you can <em>replace a failed drive</em> [2] (check out the GUI action) without loss of data.</p>

<p>If you do not use TrueNAS, at least <em>Mirror your Disks</em> [3]</p>

<ol>
<li><a href="https://en.wikipedia.org/wiki/ZFS">https://en.wikipedia.org/wiki/ZFS</a></li>
<li><a href="https://www.truenas.com/docs/core/13.0/coretutorials/storage/disks/diskreplace/">https://www.truenas.com/docs/core/13.0/coretutorials/storage/disks/diskreplace/</a></li>
<li><a href="/linux-in-house/mirrordisks.html">Mirror_Disks</a></li>
</ol>

<h1 id="unixlinuxserver-networkfilesystemnfs">Unix/Linux Server - Network File System (NFS)</h1>

<p>NFS allow one server to share it&#8217;s filesystem to another server. To the other server the file system appears to be local, but all changes on the local client are actually done on the remote NFS server.</p>

<h3 id="installnfssoftware">Install NFS software</h3>

<p>On the server with the physical filesystem:</p>

<pre><code>$ sudo apt install nfs-kernel-server
</code></pre>

<h3 id="enablenfsservice">Enable NFS Service</h3>

<pre><code>$ sudo systemctl enable --now nfs-server
</code></pre>

<h3 id="createdirectorytoshare">Create Directory to Share</h3>

<pre><code>$ sudo mkdir -p /media/nfs
</code></pre>

<h3 id="exportshare">Export Share</h3>

<p>Edit the <code>/etc/exports</code> configuration file. Here, you can configure which directories you’re sharing and who can access them. You can also set specific permissions for the shares to further limit access.</p>

<pre><code>$ sudo vi /etc/exports
</code></pre>

<p>In the file, each share gets its own line. That line begins with the location of the share on the server machine. Across from that, you can list the hostname of an accepted client, if is available in the server’s hosts file, or an IP or range of IPs. Directly behind the IP address, place the rules for the share in a set of parenthesis. Altogether, it should look something like this:</p>

<pre><code>/media/nfs		192.168.1.0/24(rw,sync,no_subtree_check)
</code></pre>

<p>You can include as many shares as you like, provided each has its own line. You can also include more than one hostname or IP in each line and assign them different permissions. For example:</p>

<pre><code>/media/nfs		192.168.1.112(rw,sync,no_subtree_check) 192.168.1.121(ro,sync,no_subtree_check)
</code></pre>

<p>In the second instance, each of those machines could view and read from the share, but only the computer at <code>192.168.1.112</code> could write to it.</p>

<p>Options:</p>

<p><code>ro</code> – specifies that the directory may only be mounted as read only<br />
<code>rw</code> – grants both read and write permissions on the directory<br />
<code>no_root_squash</code> – is an extremely dangerous option that allows remote root users the same privilege as the root user of the host machine<br />
<code>subtree_check</code> – specifies that, in the case of a directory is exported instead of an entire filesystem, the host should verify the location of files and directories on the host filesystem<br />
<code>no_subtree_check</code> – specifies that the host should not check the location of the files being accessed within the host filesystem<br />
<code>sync</code> – this just ensures that the host keeps any changes uploaded to the shared directory in sync<br />
<code>async</code> – ignores synchronization checks in favor of increased speed</p>

<h3 id="loadexportsintolivesystem">Load exports into live system</h3>

<pre><code>$ sudo exportfs -arv
exporting 192.168.1.0/24:/media/nfs
</code></pre>

<blockquote>
<p>You should consider running NFS over a VLAN. The <a href="/linux-in-house/virtualip.html">Virtual IP</a> article has information on setting up a vlan.</p>
</blockquote>

<h2 id="connecttonfsserverfromlinuxclient">Connect to NFS server from Linux client</h2>

<h3 id="installsoftwareonclient">Install Software on Client</h3>

<p>On the remote server, access the NFS share over the network.</p>

<p>Debian:</p>

<pre><code>$ sudo apt install nfs-common
</code></pre>

<p>Redhat:</p>

<pre><code>$ sudo dnf install nfs-utils
</code></pre>

<p>See what servers are available. This also shows <em>allowed</em> IP addresses, so make sure <em>yours</em> is in the list.</p>

<pre><code>$ showmount -e nas01
Exports list on nas01:
/mnt/nfs 192.168.1.2 192.168.1.3      
</code></pre>

<h3 id="mountdirectory">Mount Directory</h3>

<pre><code>$ sudo mkdir -p /media/share

$ sudo mount -t nfs4 192.168.1.110:/media/nfs /media/share
</code></pre>

<h3 id="makemountpermanent">Make mount permanent</h3>

<p>Add an entry to file /etc/fstab</p>

<pre><code>192.168.1.110:/media/nfs	/media/share	nfs4	defaults,user,exec	   0   0
</code></pre>

<p>Add <code>noauto</code> to the list of options to prevent your system from trying to mount it automatically.</p>

<pre><code># NAS
192.168.1.2:/mnt/nfs /data nfs rw,soft,intr,rsize=8192,wsize=8192,timeo=300,nofail,nolock 0 0
</code></pre>

<p>Reference: <a href="https://linuxconfig.org/how-to-configure-nfs-on-linux">https://linuxconfig.org/how-to-configure-nfs-on-linux</a></p>

<h2 id="nfsmountonmacosclient">NFS mount on Macos Client</h2>

<p>See what servers are available. This also shows <em>allowed</em> IP addresses, so make sure <em>yours</em> is in the list.</p>

<pre><code>% showmount -e nas01
Exports list on nas01:
/mnt/nfs 192.168.1.2 192.168.1.3      
</code></pre>

<h3 id="createlocaldirectory">Create local directory</h3>

<pre><code>% mkdir $HOME/nfs
</code></pre>

<h3 id="mount">Mount</h3>

<p>Create a directory, say <code>/Users/don/nfs</code>, then mount nfs on it:</p>

<pre><code>% sudo mount -o rw -t nfs nas01:/nfs /Users/don/nfs
</code></pre>

<p>Optional performance options</p>

<pre><code>sudo mount -t nfs -o soft,intr,rsize=8192,wsize=8192,timeo=900,retrans=3,proto=tcp nas01:/nfs /Users/don/nfs
</code></pre>

<h1 id="microsoftwindowssmbcifs">Microsoft Windows (SMB/CIFS)</h1>

<p>This is done on Linux using Samba software.</p>

<pre><code>$ sudo apt-get install samba samba-common-bin
</code></pre>

<p>At the bottom of the config file, add:</p>

<pre><code>$ sudo vi /etc/samba/smb.conf

~
[shared]
path=/mnt/raid1/shared
writeable=Yes
create mask=0777
directory mask=0777
public=no
~
:wq
</code></pre>

<h3 id="disablingtheautomaticprintersharing">Disabling the Automatic Printer Sharing</h3>

<p>To disable the automatic printer sharing:</p>

<p>Add the following parameter to the [global] section of your <code>/etc/samba/smb.conf</code> file:</p>

<pre><code>load printers = no
</code></pre>

<p>This will disable samba trying to open port 631 TCP every 12 minutes, eliminating ufw block warnings in the syslog.</p>

<h3 id="restartsamba">Restart Samba</h3>

<pre><code>$ sudo systemctl restart smbd
$ sudo systemctl status smbd
● smbd.service - Samba SMB Daemon
   Loaded: loaded (/lib/systemd/system/smbd.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2021-11-26 19:08:12 UTC; 5s ago
     Docs: man:smbd(8)
           man:samba(7)
           man:smb.conf(5)
  Process: 3337 ExecStartPre=/usr/share/samba/update-apparmor-samba-profile (code=exited, status=0/SUCCESS)
 Main PID: 3346 (smbd)
   Status: &quot;smbd: ready to serve connections...&quot;
    Tasks: 4 (limit: 951)
   Memory: 4.5M
   CGroup: /system.slice/smbd.service
           ├─3346 /usr/sbin/smbd --foreground --no-process-group
           ├─3348 /usr/sbin/smbd --foreground --no-process-group
           ├─3349 /usr/sbin/smbd --foreground --no-process-group
           └─3350 /usr/sbin/smbd --foreground --no-process-group

Nov 26 19:08:09 beaglebone systemd[1]: Starting Samba SMB Daemon...
Nov 26 19:08:12 beaglebone systemd[1]: Started Samba SMB Daemon.
</code></pre>

<h3 id="addlinuxowner">Add Linux owner</h3>

<pre><code>$ sudo adduser bone
Adding user `bone' ...
Adding new group `bone' (1001) ...
Adding new user `bone' (1001) with group `bone' ...
Creating home directory `/home/bone' ...
Copying files from `/etc/skel' ...
New password:
Retype new password:
passwd: password updated successfully
Changing the user information for bone
Enter the new value, or press ENTER for the default
    Full Name []: bone
    Room Number []:
    Work Phone []:
    Home Phone []:
    Other []:
Is the information correct? [Y/n] y
Adding new user `bone' to extra groups ...
Adding user `bone' to group `dialout' ...
Adding user `bone' to group `i2c' ...
Adding user `bone' to group `spi' ...
Adding user `bone' to group `cdrom' ...
Adding user `bone' to group `floppy' ...
Adding user `bone' to group `audio' ...
Adding user `bone' to group `video' ...
Adding user `bone' to group `plugdev' ...
Adding user `bone' to group `users' ...
</code></pre>

<h3 id="addsmbuser">Add SMB User</h3>

<p>Use different password for SMB:</p>

<pre><code>$ sudo smbpasswd -a bone
New SMB password:
Retype new SMB password:
Added user bone.
</code></pre>

<h3 id="securethefilesystem">Secure the filesystem</h3>

<p>If you want to create file shares that are private to individual users, just create their own directory on the RAID array.</p>

<pre><code>mkdir /mnt/raid1/shared/username
sudo chown -R username /mnt/raid1/shared/username
sudo chmod -R 700 /mnt/raid1/shared/username
</code></pre>

<p>Replace username with the user you want. Now only that user can access that directory.</p>

<p>Alternatively, you can create additional entries in smb.conf for multiple shares.</p>

<h2 id="sambasharemountonlinuxclient">Samba Share mount on Linux client</h2>

<pre><code>//nas/cifs2_share /mnt/share cifs credentials=/home/don/.smbcredentials,rw,noauto,user,uid=1000 0 0 
</code></pre>

<p>Where credentials format is:</p>

<p>File: /home/don/.smbcrendentials</p>

<pre><code>user=&lt;name&gt;
pass=&lt;password&gt;
</code></pre>

<h2 id="sambasharemountonmacclient">Samba Share mount on Mac client</h2>

<p>File: /Users/don/mount-smb.sh</p>

<pre><code>#!/bin/zsh
export USER=&lt;user&gt;
export PASS=&lt;password&gt;
export NAS=&lt;192.168.1.8&gt;
export HOME=/Users/don
#
mkdir -p ${HOME}/share
#
/sbin/mount -t smbfs //${USER}:${PASS}@${NAS}/share ${HOME}/share
</code></pre>

<h1 id="mirrordisksforfailureprotection">Mirror Disks for Failure Protection</h1>

<p>Refer to the <a href="/linux-in-house/mirrordisks.md">Mirror Disk</a> page.</p>

<h1 id="virtualmachines">Virtual Machines</h1>

<ul>
<li><p>Virtual Machines can be created via the web GUI, selection Virtualization. It uses the qemu/kvm method. If the selection is disabled, you may be able to fix that by going into the system BIOS and enabling the Secure VM (SVM) option or some other tweak.</p></li>
<li><p> On AMD Ryzen, for example, it is found in the Advanced &gt; Tweaker section. Turn SVM from Disabled to Enabled, and try the VM screen on TrueNAS again.</p></li>
<li><p>To create a VM, I used these option for Debian 12:</p></li>
<li><p> Create a DataSet in advance, i.e.: Local-VM, assign it to your VM and new VM&#8217;s Storage Volumes will reside there</p></li>
<li><p> Set Threads and Core to 1, VM hyper threading on AMD is not supported</p></li>
<li><p> 4 virtual CPUs, 1 core 1 hyper thread</p></li>
<li><p> CPU Model: HOST Model</p></li>
<li><p> 8 GB memory</p></li>
<li><p> Use Legacy BIOS, not UEFI</p></li>
</ul>

<blockquote>
<p>After installing <em>OS&#8230;iso</em> file from the Virtual CD-ROM, power off the VM and go into it&#8217;s settings. Under devices find CD-ROM and delete the device. This will keep it from rebooting back into the installer.</p>
</blockquote>

<h1 id="continue">Continue</h1>

<p>Now that you have set a NAS data protection, consider installing an E-Mail server using some of that safe storage.</p>

<p>Proceed in the order presented, some things are depending on prior setups.</p>

<hr>

<h4 id="madeforhumansbyahuman">Made for Humans, by a Human</h4>

<h4 id="links">Links</h4>

<ul>
<li><a href="https://lwn.net/">Linux Weekly News</a></li>
<li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
<li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
<li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
<li><a href="https://www.thefarside.com/">The Far Side</a></li>
</ul>

<h4 id="social">Social</h4>

<ul>
<li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
<li><a href="/linux-in-house/feed-linux.rss">Linux RSS Feed</a></li>
<li><a href="/linux-in-house/feed-writing.rss">Writing RSS Feed</a></li>
<li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
</ul>

<div style="overflow-x:auto;">
<table style="width: 100%;">
<tr>
     <td>
<small><a href="/linux-in-house/linux/intro.html#createdwith">Created with</a></small>
     </td>
     <td>
<small>License: <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a></<small>
     </td>
     <td>

<p><small>linux-in-house Version: 4.59 </small></p>

<p></tr>
</table></p>

</div>


</body>
</html>

