<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
	<title>VirtualIP</title>
	<meta name="date" content="2023-02-01 10:20"/>
	<meta name="modified" content="20025-07-19 10:20"/>
	<meta name="tags" content="network"/>
	<meta name="author" content="Don Cohoon"/>
	<meta name="summary" content="Virtual IP Interface behaves like a normal interface. All traffic routed to it will go through the master interface (for example, eth0)."/>
	<meta name="license" content="'[CC-BY-NC-SA 4.0](http://creativecommons.org/licenses/by-nc-sa/4.0/)'"/>
<meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" href="/linux-in-house/common.css" type="text/css" />
</head>
<body>

<p><a href="/linux-in-house/"><h1>Linux in House</h1></a></p>

<link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
window.addEventListener('DOMContentLoaded', (event) => {
      new PagefindUI({ element: "#search", showSubResults: true });
});
</script>

<blockquote>
<p><a href="/linux-in-house/linux/welcome.html">Welcome Back My Friends</a></p>
</blockquote>

<h1 id="virtualipethernetinterface">Virtual IP Ethernet Interface</h1>

<p>Virtual IP Interface behaves like a normal interface. All traffic routed to it will go through the master interface (for example, eth0).</p>

<p>You can also set a VLAN ID. Only VLAN-aware devices can accept these packets, or the traffic is dropped.</p>

<br/>

<hr />

<div class="TOC">

<ul>
<li><a href="#virtualipethernetinterface">Virtual IP Ethernet Interface</a>
<ul>
<li><a href="#networkdvirtualip">NetworkD Virtual IP</a></li>
<li><a href="#createvlanfromcommandline">Create vlan from command line</a>
<ul>
<li><a href="#redhatversion">Redhat Version</a>
<ul>
<li><a href="#madeforhumansbyahuman">Made for Humans, by a Human</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#social">Social</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

<hr />

<p>You can create a Virtual IP address for special routing purposes or security. Normally these are used for server to server connections, or to isolate guest connections.</p>

<h2 id="networkdvirtualip">NetworkD Virtual IP</h2>

<ul>
<li>Create a file in directory /etc/netplan ending with yaml. They will be processed in numeric/alphabetical order.</li>
</ul>

<p>File: /etc/netplan/60-vlan-init.yaml</p>

<pre><code># Remove NetworkManager - add second interface - Don Sept 2019
network:
  version: 2
  renderer: networkd
  # ERROR: vlan1: NetworkManager only supports global scoped routes
  #renderer: NetworkManager
  ethernets:
    eno1:
      addresses: [192.168.1.3/24]
      gateway4: 192.168.1.1
      nameservers:
        addresses: [1.1.1.1, 1.0.0.1]
      optional: true
    eno2: {}
  vlans:
    vlan1:
      id: 1
      link: eno1
      addresses: [192.168.2.3/24]

</code></pre>

<ul>
<li>Try the change in debug mode first:</li>
</ul>

<pre><code>$ sudo netplan --debug try
DEBUG:eno1 not found in {}
DEBUG:eno2 not found in {'eno1': {'addresses': ['192.168.1.3/24'], 'gateway4': '192.168.1.1', 'nameservers': {'addresses': ['1.1.1.1', '1.0.0.1']}, 'optional': True}}
DEBUG:vlan1 not found in {}
DEBUG:Merged config:
network:
  bonds: {}
  bridges: {}
  ethernets:
    eno1:
      addresses:
      - 192.168.1.3/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
        - 1.1.1.1
        - 1.0.0.1
      optional: true
    eno2: {}
  vlans:
    vlan1:
      addresses:
      - 192.168.2.3/24
      id: 1
      link: eno1
  wifis: {}

DEBUG:New interfaces: set()
** (generate:11029): DEBUG: 08:52:30.927: Processing input file /etc/netplan/60-vlan-init.yaml..
** (generate:11029): DEBUG: 08:52:30.927: starting new processing pass
** (generate:11029): DEBUG: 08:52:30.927: vlan1: setting default backend to 1
** (generate:11029): DEBUG: 08:52:30.927: Configuration is valid
** (generate:11029): DEBUG: 08:52:30.927: eno1: setting default backend to 1
** (generate:11029): DEBUG: 08:52:30.927: Configuration is valid
** (generate:11029): DEBUG: 08:52:30.927: eno2: setting default backend to 1
** (generate:11029): DEBUG: 08:52:30.927: Configuration is valid
** (generate:11029): DEBUG: 08:52:30.928: Generating output files..
** (generate:11029): DEBUG: 08:52:30.928: NetworkManager: definition eno1 is not for us (backend 1)
** (generate:11029): DEBUG: 08:52:30.928: NetworkManager: definition eno2 is not for us (backend 1)
** (generate:11029): DEBUG: 08:52:30.928: NetworkManager: definition vlan1 is not for us (backend 1)
DEBUG:netplan generated networkd configuration changed, restarting networkd
DEBUG:no netplan generated NM configuration exists
DEBUG:eno1 not found in {}
DEBUG:eno2 not found in {'eno1': {'addresses': ['192.168.1.3/24'], 'gateway4': '192.168.1.1', 'nameservers': {'addresses': ['1.1.1.1', '1.0.0.1']}, 'optional': True}}
DEBUG:vlan1 not found in {}
DEBUG:Merged config:
network:
  bonds: {}
  bridges: {}
  ethernets:
    eno1:
      addresses:
      - 192.168.1.3/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
        - 1.1.1.1
        - 1.0.0.1
      optional: true
    eno2: {}
  vlans:
    vlan1:
      addresses:
      - 192.168.2.3/24
      id: 1
      link: eno1
  wifis: {}

DEBUG:Skipping non-physical interface: lo
DEBUG:device eno1 operstate is up, not changing
DEBUG:Skipping non-physical interface: vlan1
DEBUG:Skipping non-physical interface: wlp58s0
DEBUG:Skipping non-physical interface: tun0
DEBUG:{}
DEBUG:netplan triggering .link rules for lo
DEBUG:netplan triggering .link rules for eno1
DEBUG:netplan triggering .link rules for vlan1
DEBUG:netplan triggering .link rules for wlp58s0
DEBUG:netplan triggering .link rules for tun0
Do you want to keep these settings?


Press ENTER before the timeout to accept the new configuration


Changes will revert in 118 seconds
Configuration accepted.
</code></pre>

<ul>
<li>If you have success, make the change permanent:</li>
</ul>

<pre><code>$ sudo netplan apply
</code></pre>

<ul>
<li>Test it with a ping:</li>
</ul>

<pre><code># ping 192.168.2.3
PING 192.168.2.3 (192.168.2.3) 56(84) bytes of data.
64 bytes from 192.168.2.3: icmp_seq=1 ttl=64 time=0.088 ms
64 bytes from 192.168.2.3: icmp_seq=2 ttl=64 time=0.104 ms
^C
--- 192.168.2.3 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1011ms
rtt min/avg/max/mdev = 0.088/0.096/0.104/0.008 ms
</code></pre>

<ul>
<li>Check the routes. One for physical interface eno1, another for virtual interface vlan1.</li>
</ul>

<pre><code># route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         _gateway        0.0.0.0         UG    0      0        0 eno1
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eno1
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 vlan1
</code></pre>

<ul>
<li>Another way to check routes:</li>
</ul>

<pre><code># ip r
default via 192.168.1.1 dev eno1 proto static 
192.168.1.0/24 dev eno1 proto kernel scope link src 192.168.1.3 
192.168.2.0/24 dev vlan1 proto kernel scope link src 192.168.2.3 
</code></pre>

<ul>
<li>Also you can check the ip addresses:</li>
</ul>

<blockquote>
<p>Notice the virtual interface is called <code>vlan1@eno1</code> because it is <em>stacked</em> on top of physical interface eno1.</p>
</blockquote>

<pre><code># ip a
~
2: eno1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 1c:69:7a:09:e7:61 brd ff:ff:ff:ff:ff:ff
    altname enp0s31f6
    inet 192.168.1.3/24 brd 192.168.1.255 scope global eno1
       valid_lft forever preferred_lft forever
    inet6 fe80::1e69:7aff:fe09:e761/64 scope link 
       valid_lft forever preferred_lft forever
~
4: vlan1@eno1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 1c:69:7a:09:e7:61 brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.3/24 brd 192.168.2.255 scope global vlan1
       valid_lft forever preferred_lft forever
    inet6 fe80::1e69:7aff:fe09:e761/64 scope link 
       valid_lft forever preferred_lft forever
~
</code></pre>

<p>Reference: <a href="https://netplan.io/examples">https://netplan.io/examples</a></p>

<h2 id="createvlanfromcommandline">Create vlan from command line</h2>

<p>Create a vlan called vlan9 on physical device eth0, with vlan id of 9.</p>

<pre><code>$ sudo ip link add link eth0 name vlan9 type vlan id 9
</code></pre>

<p>Display interface</p>

<pre><code>$ sudo ip -d link show vlan9
4: vlan9@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000
    link/ether 1c:69:7a:09:e7:61 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 0 maxmtu 65535 
    vlan protocol 802.1Q id 9 &lt;REORDER_HDR&gt; addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 
</code></pre>

<p>Of course this interface will go away after a reboot, unless you run this command again.</p>

<blockquote>
<p>The -d flag shows full details of an interface. Notice the vlan protocol 802.1Q id is 9.</p>
</blockquote>

<pre><code>$ sudo ip -d addr show
4: vlan9@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default 
   link/ether 96:4a:9c:84:36:51 brd ff:ff:ff:ff:ff:ff promiscuity 0 
   vlan protocol 802.1Q id 9 &lt;REORDER_HDR&gt; 
   inet6 fe80::944a:9cff:fe84:3651/64 scope link 
      valid_lft forever preferred_lft forever
</code></pre>

<p>Add an IPv4 address:</p>

<pre><code>#                  IP Address           Broadcast           Device
$ sudo ip addr add 192.168.100.1/24 brd 192.168.100.255 dev vlan9
$ sudo ip link set dev vlan9 up
</code></pre>

<p>Shut down the link:</p>

<pre><code>$ sudo ip link set dev vlan9 down
</code></pre>

<p>Remove VLAN interface:</p>

<pre><code># sudo ip link delete vlan9
</code></pre>

<p>Reference:</p>

<ul>
<li> <a href="https://wiki.archlinux.org/title/VLAN">https://wiki.archlinux.org/title/VLAN</a></li>
</ul>

<h3 id="redhatversion">Redhat Version</h3>

<p>Install nmstate package</p>

<pre><code>$ sudo dnf install nmstate
</code></pre>

<p>Create config file</p>

<p>File: /etc/nmstate/60-create-vlan.yml</p>

<pre><code>---
interfaces:
- name: vlan10
  type: vlan
  state: up
  ipv4:
    enabled: true
    address:
    - ip: 192.168.22.1
      prefix-length: 24
    dhcp: false
  ipv6:
    enabled: false
  vlan:
    base-iface: eno1
    id: 10
- name: eno1
  type: ethernet
  state: up
</code></pre>

<p>Apply config file</p>

<pre><code>$ sudo nmstatectl apply /etc/nmstate/60-create-vlan.yml
</code></pre>

<ul>
<li>Verification</li>
</ul>

<p>Display the status of the devices and connections:</p>

<pre><code># nmcli device status
  DEVICE      TYPE      STATE      CONNECTION
  vlan10      vlan      connected  vlan10
</code></pre>

<p>Display all settings of the connection profile:</p>

<pre><code># nmcli connection show vlan10
  connection.id:              vlan10
  connection.uuid:            1722970f-788e-4f81-bd7d-a86bf21c9df5
  connection.stable-id:       --
  connection.type:            vlan
  connection.interface-name:  vlan10
  ...
</code></pre>

<p>Display the connection settings in YAML format:</p>

<pre><code># nmstatectl show vlan10
</code></pre>

<p>Permanent setup is performed by nmstate.service. It invokes nmstatectl service command which apply all network state files ending with .yml in /etc/nmstate folder. The applied network state file will be renamed with postfix .applied to prevent repeated applied on next service start. Rename the file to .yml and restart nmstate to make changes active.</p>

<pre><code>$ sudo systemctl status nmstate.service
● nmstate.service - Apply nmstate on-disk state
     Loaded: loaded (/usr/lib/systemd/system/nmstate.service; enabled; preset: disabled)
     Active: active (exited) since Sat 2023-06-10 15:31:04 EDT; 50s ago
       Docs: man:nmstate.service(8)
             https://www.nmstate.io
    Process: 77788 ExecStart=/usr/bin/nmstatectl service (code=exited, status=0/SUCCESS)
   Main PID: 77788 (code=exited, status=0/SUCCESS)
        CPU: 40ms

Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::nm::query_apply::profile] Modifying connection UUID Some(&quot;050da471-2365-4e&gt;
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::nm::query_apply::profile] Reapplying connection 1f39a84e-5d13-3ea0-8b34-fd&gt;
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::nm::query_apply::profile] Reapplying connection 0a0d9431-27a5-4e7e-b370-47&gt;
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::nispor::base_iface] Got unsupported interface type Tun: vnet5, ignoring
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::nispor::show] Got unsupported interface vnet5 type Tun
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::nm::show] Got unsupported interface type tun: vnet5, ignoring
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstate::query_apply::net_state] Destroyed checkpoint /org/freedesktop/NetworkManag&gt;
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstatectl::service] Applied nmstate config: /etc/nmstate/60-create-vlan.yml
Jun 10 15:31:04 bob.example.com nmstatectl[77788]: [2022-06-10T19:31:04Z INFO  nmstatectl::service] Renamed applied config /etc/nmstate/60-create-vlan.yml to /etc/nm&gt;
Jun 10 15:31:04 bob.example.com systemd[1]: Finished Apply nmstate on-disk state.
</code></pre>

<p>Reference:</p>

<ul>
<li> <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/configuring_and_managing_networking/index#proc_configuring-vlan-tagging-by-using-nmstatectl_configuring-vlan-tagging">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/configuring_and_managing_networking/index#proc_configuring-vlan-tagging-by-using-nmstatectl_configuring-vlan-tagging</a></li>
</ul>

<hr>

<h4 id="madeforhumansbyahuman">Made for Humans, by a Human</h4>

<h4 id="links">Links</h4>

<ul>
<li><a href="https://lwn.net/">Linux Weekly News</a></li>
<li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
<li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
<li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
<li><a href="https://www.thefarside.com/">The Far Side</a></li>
</ul>

<h4 id="social">Social</h4>

<ul>
<li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
<li><a href="/linux-in-house/feed-linux.rss">Linux RSS Feed</a></li>
<li><a href="/linux-in-house/feed-writing.rss">Writing RSS Feed</a></li>
<li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
</ul>

<div style="overflow-x:auto;">
<table style="width: 100%;">
<tr>
     <td>
<small><a href="/linux-in-house/linux/intro.html#createdwith">Created with</a></small>
     </td>
     <td>
<small>License: <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC-BY-NC-SA 4.0</a></<small>
     </td>
     <td>

<p><small>linux-in-house Version: 4.67 </small></p>

<p></tr>
</table></p>

</div>


</body>
</html>

