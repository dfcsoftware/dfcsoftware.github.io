<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Linux Home Administration - email</title>
        <link rel="icon" type="image/svg" href="https://dfcsoftware.github.io/linux-in-house/images/favicon.svg">
        <link rel="stylesheet" href="https://dfcsoftware.github.io/linux-in-house/theme/css/main.css" type="text/css" />
        <!-- <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />  -->
        <link href="https://dfcsoftware.github.io/linux-in-house/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Linux Home Administration Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <table>
                    <td><h1><a href="https://dfcsoftware.github.io/linux-in-house/">Linux Home Administration</a></h1></td>
                    <td> <link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet" type="text/css">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script> </td>
                </table>
                <nav><ul>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/quest.html">quest</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/writing.html">writing</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/zines.html">zines</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://dfcsoftware.github.io/linux-in-house/e-mail.html">E-Mail</a></h1>
<footer class="post-info">
        <abbr class="published" title="2023-01-25T10:20:00-05:00">
                Published: Wed 25 January 2023
        </abbr>
		<br />
        <abbr class="modified" title="2024-04-19T09:30:00-04:00">
                Updated: Fri 19 April 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://dfcsoftware.github.io/linux-in-house/author/don-cohoon.html">Don Cohoon</a>
        </address>
<p>In <a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a>.</p>
<p>tags: <a href="https://dfcsoftware.github.io/linux-in-house/tag/email.html">email</a> </p>
</footer><!-- /.post-info --><h1 id="e-mail">E-Mail</h1>
<p>Electronic Mail (E-Mail) is a way to type letters onto a computer and send them to other people. These other people's computers will then use E-Mail to read your letters. It is an electronic version of the Post Office.</p>
<hr>
<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#e-mail">E-Mail</a><ul>
<li><a href="#dovecot-presents-e-mails-to-clients">Dovecot - Presents E-Mails to Clients</a><ul>
<li><a href="#installation">Installation</a><ul>
<li><a href="#debian">Debian</a></li>
<li><a href="#redhat">RedHat</a></li>
</ul>
</li>
<li><a href="#user-settings">User Settings</a></li>
<li><a href="#non-default-settings">Non-Default Settings</a></li>
<li><a href="#update-systemd-startup-service">Update systemd startup service</a></li>
<li><a href="#sieve-filters-mail-to-certain-boxes">Sieve - filters mail to certain boxes</a></li>
</ul>
</li>
<li><a href="#postfix-sends-and-recieves-e-mail-over-the-network">Postfix - sends and recieves e-mail over the network</a><ul>
<li><a href="#configuration-main">Configuration - main</a></li>
<li><a href="#configuration-login">Configuration - Login</a></li>
<li><a href="#configuration-master">Configuration - Master</a></li>
</ul>
</li>
<li><a href="#spamassasin-puts-spam-into-a-spam-folder-automatically">Spamassasin - Puts SPAM into a SPAM folder automatically</a><ul>
<li><a href="#configure">Configure</a></li>
<li><a href="#start-spamassassin-and-restart-postfix">Start spamassassin and restart postfix</a></li>
<li><a href="#daily-update-in-etccrondaily">Daily update in /etc/cron.daily</a></li>
<li><a href="#put-spamham-learning-into-a-script">Put spam/ham learning into a script</a></li>
</ul>
</li>
<li><a href="#mail-readers">Mail Readers</a><ul>
<li><a href="#mutt">Mutt</a><ul>
<li><a href="#install">Install</a></li>
<li><a href="#configure_1">Configure</a></li>
</ul>
</li>
<li><a href="#evolution">Evolution</a><ul>
<li><a href="#install_1">Install</a></li>
<li><a href="#configure_2">Configure</a></li>
</ul>
</li>
<li><a href="#thunderbird">Thunderbird</a><ul>
<li><a href="#install_2">Install</a></li>
<li><a href="#configure_3">Configure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#offlineimap-makes-a-backup-copy-of-all-email">Offlineimap - Makes a backup copy of all email</a><ul>
<li><a href="#install_3">Install</a></li>
<li><a href="#configure_4">Configure</a></li>
<li><a href="#schedule">Schedule</a></li>
</ul>
</li>
<li><a href="#postfix-log-summary">Postfix Log Summary</a><ul>
<li><a href="#install_4">Install</a></li>
<li><a href="#schedule_1">Schedule</a></li>
</ul>
</li>
<li><a href="#alternatives">Alternatives</a><ul>
<li><a href="#exim4">exim4</a><ul>
<li><a href="#what-it-does">What it does</a></li>
</ul>
</li>
<li><a href="#iredmail">iRedMail</a></li>
<li><a href="#mail-in-a-box">Mail-in-a-Box</a></li>
<li><a href="#citadel">Citadel</a></li>
</ul>
</li>
<li><a href="#continue">Continue</a></li>
</ul>
</li>
</ul>
</div>
<hr>
<h2 id="dovecot-presents-e-mails-to-clients">Dovecot - Presents E-Mails to Clients</h2>
<p>Dovecot [1] provides a way for Mail User Agents (MUA) to <em>manage</em> their E-Mail. Typical MUAs are Thunderbird [2], Evolution [3], and Mutt [4].</p>
<p>Dovecot supports Internet Message Access Protocol (IMAP, port 993) [5] as a server over the network to multiple clients at the same time. It is commonly referred to as a Mail Delivery Agent (MDA) delivering mail from a file repository on some server to the MUA.</p>
<p>The Maildir database sets each E-Mail as a seperate file on the server, arranged into folders as dictated by the MUA. Indexing is automatic.</p>
<p>Postfix [6] is a Mail Transfer Agent (MTA) that <em>receives</em> E-Mail over the Internet using Simple Mail Transfer Protocol (SMTP, port 25 [7]) and delivers it locally to Dovecot. MUA <em>sending</em> is also done by postfix using Submission (ports 587 [8], and 465 for SSL [9]). Message relay from one mail server to another is done by postfix using SMTP too.</p>
<p><img alt="E-Mail" src="/linux-in-house/images/graph-email.svg"></p>
<ol>
<li><a href="https://www.dovecot.org/">https://www.dovecot.org/</a></li>
<li><a href="https://www.thunderbird.net/en-US/">https://www.thunderbird.net/en-US/</a></li>
<li><a href="https://help.gnome.org/users/evolution/stable/">https://help.gnome.org/users/evolution/stable/</a></li>
<li><a href="http://www.mutt.org/">http://www.mutt.org/</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc9051">https://www.rfc-editor.org/rfc/rfc9051</a></li>
<li><a href="http://www.postfix.org/">http://www.postfix.org/</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc5321.html">https://www.rfc-editor.org/rfc/rfc5321.html</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4409">https://datatracker.ietf.org/doc/html/rfc4409</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8314">https://datatracker.ietf.org/doc/html/rfc8314</a></li>
</ol>
<h3 id="installation">Installation</h3>
<p>Install the four main packages:</p>
<ul>
<li>core - core files</li>
<li>imapd - IMAP daemon</li>
<li>managesieved - ManageSieve server</li>
<li>sieve - Sieve filters support</li>
</ul>
<h4 id="debian">Debian</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>dovecot-core<span class="w"> </span>dovecot-imapd<span class="w"> </span>dovecot-managesieved<span class="w"> </span>dovecot-sieve<span class="w"> </span>
</code></pre></div>

<h4 id="redhat">RedHat</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>dovecot<span class="w"> </span>dovecot-pigeonhole
</code></pre></div>

<blockquote>
<p>Pigeonhole is the name of the project that adds support for the Sieve language (RFC 5228) and the ManageSieve protocol (RFC 5804) to the Dovecot Secure IMAP Server. In the literal sense, a pigeonhole is a hole or recess inside a dovecot for pigeons to nest in. It is, however, also the name for one of a series of small, open compartments in a cabinet used for filing or sorting mail. As a verb, it describes the act of putting an item into one of those pigeonholes. The name `Pigeonhole' therefore well describes an important part of the functionality that this project adds to Dovecot: sorting and filing e-mail messages. </p>
</blockquote>
<h3 id="user-settings">User Settings</h3>
<p>Create a symbolic link for the mail location (\~/Maildir) to an NFS mount that you created in the NAS page, such as <code>/home/&lt;user&gt;/Maildir</code>. This will provide the extra protection of ZFS for your E-Mail database, should a disk fail.</p>
<p>For instance, for NFS Mount at <code>/media/share</code> and Linux <code>&lt;user&gt;@&lt;domain&gt;.com</code>:</p>
<ul>
<li>Create Linux user for E-Mail bob@example.com, and directory:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>useradd<span class="w"> </span>bob@example.com
$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/home/bob@example.com
$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span>bob@example.com<span class="w">  </span>/home/bob@example.com
$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/media/share/bob/Maildir
$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>bob@example.com<span class="w">  </span>/media/share/bob
$<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/media/share/bob/Maildir<span class="w"> </span>/home/bob@example.com<span class="w"> </span>
</code></pre></div>

<p>Dovecot MUA logins are Linux logins. Multiple MUAs will log into Dovecot using <em>different</em> logins so \~/Maildir will also be different. Data will be stored on the /media/share NFS mount.</p>
<table>
<thead>
<tr>
<th>User</th>
<th>Maildir</th>
</tr>
</thead>
<tbody>
<tr>
<td>bob</td>
<td>/media/share/bob/Maildir -&gt; /home/bob@example.com/Maildir</td>
</tr>
<tr>
<td>ted</td>
<td>/media/share/ted/Maildir -&gt; /home/ted@example.com/Maildir</td>
</tr>
</tbody>
</table>
<h3 id="non-default-settings">Non-Default Settings</h3>
<p>Create a configuration file that will override the default setting you want to change. Default settings are in directory: <code>/etc/dovecot/conf.d/</code></p>
<p>File: /etc/dovecot/local.conf</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Hostname: mail</span>
<span class="c1"># Version: 21-Jan-2023</span>
<span class="n">mail_fsync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">always</span>
<span class="n">mail_location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maildir</span><span class="p">:</span><span class="o">~/</span><span class="n">Maildir</span>
<span class="n">mail_privileged_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mail</span>
<span class="n">managesieve_notify_capability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mailto</span>
<span class="n">managesieve_sieve_capability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileinto</span><span class="w"> </span><span class="n">reject</span><span class="w"> </span><span class="n">envelope</span><span class="w"> </span><span class="n">encoded</span><span class="o">-</span><span class="n">character</span><span class="w"> </span><span class="n">vacation</span><span class="w"> </span><span class="n">subaddress</span><span class="w"> </span><span class="n">comparator</span><span class="o">-</span><span class="n">i</span><span class="p">;</span><span class="n">ascii</span><span class="o">-</span><span class="n">numeric</span><span class="w"> </span><span class="n">relational</span><span class="w"> </span><span class="n">regex</span><span class="w"> </span><span class="n">imap4flags</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="n">enotify</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">mailbox</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">ihave</span><span class="w"> </span><span class="n">duplicate</span><span class="w"> </span><span class="n">mime</span><span class="w"> </span><span class="n">foreverypart</span><span class="w"> </span><span class="n">extracttext</span>
<span class="n">mmap_disable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="n">namespace</span><span class="w"> </span><span class="n">inbox</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">inbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="w">  </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="n">mailbox</span><span class="w"> </span><span class="n">Drafts</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">special_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">Drafts</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">mailbox</span><span class="w"> </span><span class="n">Junk</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">special_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">Junk</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">mailbox</span><span class="w"> </span><span class="n">Sent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">special_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">Sent</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">mailbox</span><span class="w"> </span><span class="s2">&quot;Sent Messages&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">special_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">Sent</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">mailbox</span><span class="w"> </span><span class="n">Trash</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">special_use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">Trash</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="p">}</span>
<span class="n">passdb</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pam</span>
<span class="p">}</span>
<span class="n">plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sieve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="o">~/</span><span class="n">sieve</span><span class="p">;</span><span class="n">active</span><span class="o">=~/.</span><span class="n">dovecot</span><span class="o">.</span><span class="n">sieve</span>
<span class="w">  </span><span class="n">sieve_default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dovecot</span><span class="o">/</span><span class="n">sieve</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">sieve</span>
<span class="p">}</span>
<span class="n">protocols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; imap sieve&quot;</span>
<span class="n">service</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">unix_listener</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">auth</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0660</span>
<span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">service</span><span class="w"> </span><span class="n">imap</span><span class="o">-</span><span class="n">login</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">inet_listener</span><span class="w"> </span><span class="n">imap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">143</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">inet_listener</span><span class="w"> </span><span class="n">imaps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">993</span>
<span class="w">    </span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">service</span><span class="w"> </span><span class="n">imap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">process_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span>
<span class="p">}</span>
<span class="n">ssl_cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span>
<span class="n">ssl_client_ca_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span>
<span class="n">ssl_dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">dovecot</span><span class="o">/</span><span class="n">dh</span><span class="o">.</span><span class="n">pem</span>
<span class="n">ssl_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span>
<span class="n">userdb</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">passwd</span>
<span class="p">}</span>
<span class="n">protocol</span><span class="w"> </span><span class="n">lda</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">mail_plugins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; sieve&quot;</span>
<span class="p">}</span>
<span class="n">protocol</span><span class="w"> </span><span class="n">imap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">mail_max_userip_connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="update-systemd-startup-service">Update systemd startup service</h3>
<p>Change systemd startup <em>After</em> dependencies to wait for the network to be online and NFS filesystem to be mounted.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>edit<span class="w"> </span>dovecot.service
</code></pre></div>

<p>Add these lines</p>
<div class="highlight"><pre><span></span><code><span class="c1">#After=local-fs.target network-online.target</span>
<span class="c1"># Add fs-remote... Don - Jan 2023</span>
<span class="k">[Unit]</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target network-online.target local-fs.target remote-fs.target nss-lookup.target</span>
</code></pre></div>

<blockquote>
<p>This creates a new file to override the system defaults: /etc/systemd/system/dovecot.service.d/override.conf </p>
</blockquote>
<p>Generate a file with Diffie-Hellman parameters</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>openssl<span class="w"> </span>dhparam<span class="w"> </span>-dsaparam<span class="w"> </span>-out<span class="w"> </span>/etc/dovecot/dh.pem<span class="w"> </span><span class="m">2048</span>
</code></pre></div>

<p>Depending on the hardware and entropy on the server, generating Diffie-Hellman parameters with 4096 bits can take several minutes. </p>
<p>Restart systemd and Dovecot to pick up changes:</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">dovecot</span>
</code></pre></div>

<h3 id="sieve-filters-mail-to-certain-boxes">Sieve - filters mail to certain boxes</h3>
<p>Edit your rules.</p>
<p>File: /var/lib/dovecot/sieve/default.sieve</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/var/lib/dovecot/sieve/default.sieve
require<span class="w"> </span><span class="o">[</span><span class="s2">&quot;fileinto&quot;</span>,<span class="w"> </span><span class="s2">&quot;envelope&quot;</span><span class="o">]</span><span class="p">;</span>
<span class="c1">#if header  :contains &quot;X-Spam-Flag&quot; &quot;YES&quot;  {</span>
<span class="k">if</span><span class="w"> </span>header<span class="w"> </span>:comparator<span class="w"> </span><span class="s2">&quot;i;ascii-casemap&quot;</span><span class="w"> </span>:contains<span class="w"> </span><span class="s2">&quot;X-Spam-Flag&quot;</span><span class="w"> </span><span class="s2">&quot;YES&quot;</span><span class="w">  </span><span class="o">{</span>
<span class="w">    </span>fileinto<span class="w"> </span><span class="s2">&quot;INBOX.Spam&quot;</span><span class="p">;</span>
<span class="w">    </span>stop<span class="p">;</span>
<span class="o">}</span><span class="w"> </span>elsif<span class="w"> </span>address<span class="w"> </span>:is<span class="w"> </span><span class="s2">&quot;to&quot;</span><span class="w"> </span><span class="s2">&quot;bob@example.com&quot;</span><span class="w"> </span><span class="o">{</span>
<span class="w"> </span>fileinto<span class="w"> </span><span class="s2">&quot;INBOX.Bob&quot;</span><span class="p">;</span>
<span class="o">}</span><span class="w"> </span>elsif<span class="w"> </span>address<span class="w"> </span>:is<span class="w"> </span><span class="s2">&quot;from&quot;</span><span class="w"> </span><span class="s2">&quot;logcheck@example.com&quot;</span><span class="w"> </span><span class="o">{</span>
<span class="w"> </span>fileinto<span class="w"> </span><span class="s2">&quot;INBOX.Bob.logcheck&quot;</span><span class="p">;</span>
<span class="o">}</span><span class="w"> </span>elsif<span class="w"> </span>header<span class="w"> </span>:contains<span class="w"> </span><span class="s2">&quot;subject&quot;</span><span class="w"> </span><span class="o">[</span><span class="s2">&quot;Change to Camera&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">{</span>
<span class="w"> </span>fileinto<span class="w"> </span><span class="s2">&quot;INBOX.Camera&quot;</span><span class="p">;</span>
<span class="o">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="o">{</span>
<span class="w"> </span><span class="c1"># The rest goes into INBOX</span>
<span class="w"> </span><span class="c1"># default is &quot;implicit keep&quot;, we do it explicitly here</span>
<span class="w"> </span>keep<span class="p">;</span>
<span class="o">}</span>
</code></pre></div>

<p>Compile when done, then restart dovecot to pick up new changes</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>sievec<span class="w"> </span>/var/lib/dovecot/sieve/default.sieve
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>dovecot
</code></pre></div>

<p>Reference: <a href="https://doc.dovecot.org/configuration_manual/sieve/usage/">https://doc.dovecot.org/configuration_manual/sieve/usage/</a></p>
<h2 id="postfix-sends-and-recieves-e-mail-over-the-network">Postfix - sends and recieves e-mail over the network</h2>
<h3 id="configuration-main">Configuration - main</h3>
<p>Create aliases to enable mail to go through from several standard unix accounts</p>
<blockquote>
<p>seperate words with the TAB character, not spaces.</p>
</blockquote>
<p>File: /etc/aliases</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="nv">See</span><span class="w"> </span><span class="nv">man</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">aliases</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">format</span>
<span class="nv">postmaster</span>:<span class="w">    </span><span class="nv">root</span>
<span class="nv">mail</span>:<span class="w">   </span><span class="nv">root</span>
<span class="nv">nobody</span>:<span class="w"> </span><span class="nv">root</span>
<span class="nv">monit</span>:<span class="w">  </span><span class="nv">root</span>
<span class="nv">clamav</span>:<span class="w"> </span><span class="nv">root</span>
<span class="nv">logcheck</span>:<span class="w"> </span><span class="nv">root</span>
</code></pre></div>

<p>Update the aliases so postfix can read them</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>newaliases
</code></pre></div>

<p>Unix account uses home_mailbox of <em>\~/Maildir</em>.</p>
<p>Reference: <a href="http://www.postfix.org/BASIC_CONFIGURATION_README.html">http://www.postfix.org/BASIC_CONFIGURATION_README.html</a></p>
<p>File: /etc/postfix/main.cf</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">See</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">share</span><span class="o">/</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">cf</span><span class="p">.</span><span class="nx">dist</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">commented</span><span class="p">,</span><span class="w"> </span><span class="nx">more</span><span class="w"> </span><span class="nx">complete</span><span class="w"> </span><span class="nx">version</span>
<span class="err">#</span><span class="w"> </span><span class="nx">Debian</span><span class="w"> </span><span class="nx">specific</span><span class="p">:</span><span class="w">  </span><span class="nx">Specifying</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">cause</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">first</span>
<span class="err">#</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">used</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="w">  </span><span class="nx">The</span><span class="w"> </span><span class="nx">Debian</span><span class="w"> </span><span class="k">default</span>
<span class="err">#</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">mailname</span><span class="p">.</span>
<span class="err">#</span><span class="nx">myorigin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">mailname</span>

<span class="err">#</span><span class="w"> </span><span class="nx">misc</span>
<span class="err">#</span><span class="w"> </span><span class="nx">only</span><span class="w"> </span><span class="nx">hostname</span>
<span class="nx">smtpd_banner</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">myhostname</span><span class="w"> </span><span class="nx">ESMTP</span><span class="w"> </span><span class="nx">e</span><span class="o">-</span><span class="nx">mail</span><span class="w"> </span><span class="p">(</span><span class="nx">Linux</span><span class="p">)</span>
<span class="nx">biff</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">no</span>
<span class="err">#</span><span class="w"> </span><span class="nx">appending</span><span class="w"> </span><span class="p">.</span><span class="nx">domain</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">MUA</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">job</span><span class="p">.</span>
<span class="nx">append_dot_mydomain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">no</span>
<span class="err">#</span><span class="w"> </span><span class="nx">Uncomment</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">generate</span><span class="w"> </span><span class="s">&quot;delayed mail&quot;</span><span class="w"> </span><span class="nx">warnings</span>
<span class="err">#</span><span class="nx">delay_warning_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4</span><span class="nx">h</span>
<span class="nx">readme_directory</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">no</span>

<span class="err">#</span><span class="w"> </span><span class="kd">alias</span>
<span class="nx">alias_maps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">aliases</span>
<span class="nx">alias_database</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">aliases</span>

<span class="err">#</span><span class="w"> </span><span class="nx">hosts</span>
<span class="nx">myhostname</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">www</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">myorigin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">mailname</span>
<span class="nx">mydestination</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span><span class="w"> </span><span class="nx">example</span><span class="p">,</span><span class="w"> </span><span class="nx">localhost</span><span class="p">.</span><span class="nx">localdomain</span><span class="p">,</span><span class="w"> </span><span class="nx">localhost</span>
<span class="nx">mynetworks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m m-Double">127.0.0.0</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="o">::</span><span class="nx">ffff</span><span class="p">:</span><span class="m m-Double">127.0.0.0</span><span class="p">]</span><span class="o">/</span><span class="mi">104</span><span class="w"> </span><span class="p">[</span><span class="o">::</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">128</span><span class="w"> </span><span class="m m-Double">192.168.0.0</span><span class="o">/</span><span class="mi">16</span>

<span class="err">#</span><span class="w"> </span><span class="nx">mail</span><span class="w"> </span><span class="nx">box</span>
<span class="nx">home_mailbox</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Maildir</span><span class="o">/</span>
<span class="nx">mailbox_size_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="nx">message_size_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">52428800</span>
<span class="nx">header_size_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4096000</span>
<span class="nx">recipient_delimiter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">+</span>
<span class="nx">inet_interfaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">all</span>
<span class="nx">mailbox_command</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">dovecot</span><span class="o">/</span><span class="nx">deliver</span><span class="w"> </span><span class="o">-</span><span class="nx">c</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">dovecot</span><span class="o">/</span><span class="nx">dovecot</span><span class="p">.</span><span class="nx">conf</span><span class="w"> </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="s">&quot;${EXTENSION}&quot;</span>

<span class="err">#</span><span class="w"> </span><span class="nx">transport</span>
<span class="nx">virtual_transport</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dovecot</span>
<span class="nx">dovecot_destination_recipient_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="nx">compatibility_level</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>
<span class="nx">inet_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ipv4</span>

<span class="err">#</span><span class="w"> </span><span class="nx">TLS</span><span class="w"> </span><span class="nx">parameters</span>
<span class="nx">smtpd_use_tls</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtpd_tls_cert_file</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">letsencrypt</span><span class="o">/</span><span class="nx">live</span><span class="o">/</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">fullchain</span><span class="p">.</span><span class="nx">pem</span>
<span class="nx">smtpd_tls_key_file</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">letsencrypt</span><span class="o">/</span><span class="nx">live</span><span class="o">/</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">privkey</span><span class="p">.</span><span class="nx">pem</span>
<span class="nx">smtpd_tls_session_cache_database</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">btree</span><span class="p">:</span><span class="err">$</span><span class="p">{</span><span class="nx">data_directory</span><span class="p">}</span><span class="o">/</span><span class="nx">smtpd_scache</span>
<span class="nx">smtp_tls_session_cache_database</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">btree</span><span class="p">:</span><span class="err">$</span><span class="p">{</span><span class="nx">data_directory</span><span class="p">}</span><span class="o">/</span><span class="nx">smtp_scache</span>

<span class="err">#</span><span class="w"> </span><span class="nx">No</span><span class="o">-</span><span class="nx">IP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">begin</span>
<span class="err">#</span><span class="w"> </span><span class="nx">http</span><span class="p">:</span><span class="c1">//www.noip.com/support/knowledgebase/configure-postfix-work-alternate-port-smtp/</span>
<span class="err">#</span><span class="nx">debug_peer_list</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m m-Double">192.168.1.1</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nx">sasl</span>
<span class="nx">smtp_sasl_auth_enable</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtp_sasl_security_options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">noanonymous</span>
<span class="nx">smtp_sasl_password_maps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">sasl</span><span class="o">/</span><span class="nx">sasl_passwd</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nx">relay</span>
<span class="nx">relayhost</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="nx">smtp</span><span class="o">-</span><span class="nx">auth</span><span class="p">.</span><span class="nx">no</span><span class="o">-</span><span class="nx">ip</span><span class="p">.</span><span class="nx">com</span><span class="p">]:</span><span class="mi">465</span>
<span class="nx">relay_destination_concurrency_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="w">    </span>
<span class="nx">relay_domains</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">mydestination</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nx">tls</span>
<span class="nx">smtp_tls_wrappermode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtp_tls_security_level</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">encrypt</span>
<span class="err">#</span><span class="w"> </span><span class="nx">No</span><span class="o">-</span><span class="nx">IP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">end</span>

<span class="err">#</span><span class="w"> </span><span class="nx">sasl</span><span class="w"> </span><span class="nx">authentication</span>
<span class="nx">smtpd_sasl_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dovecot</span>
<span class="nx">smtpd_sasl_path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">private</span><span class="o">/</span><span class="nx">auth</span>
<span class="nx">smtpd_sasl_authenticated_header</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtpd_sasl_local_domain</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>

<span class="err">#</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="nx">spammers</span>
<span class="nx">smtpd_sender_restrictions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">permit_mynetworks</span><span class="p">,</span><span class="w"> </span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="w"> </span><span class="nx">reject_unknown_reverse_client_hostname</span><span class="p">,</span><span class="w"> </span><span class="nx">reject_unknown_client_hostname</span><span class="p">,</span>
<span class="err">#</span>
<span class="nx">smtpd_client_restrictions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>
<span class="w">  </span><span class="nx">check_client_access</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">blacklist</span>
<span class="nx">smtpd_relay_restrictions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">permit_mynetworks</span><span class="p">,</span><span class="w"> </span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="w"> </span><span class="nx">reject_unauth_destination</span>
<span class="err">#</span><span class="w"> </span><span class="nx">block</span><span class="w"> </span><span class="nx">spammers</span><span class="o">...</span><span class="nx">end</span>

<span class="err">#</span><span class="w"> </span><span class="nx">TLS</span>
<span class="nx">smtpd_tls_received_header</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtpd_tls_mandatory_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">SSLv3</span><span class="p">,</span><span class="w"> </span><span class="nx">TLSv1</span>
<span class="nx">smtpd_tls_mandatory_ciphers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">medium</span>
<span class="nx">smtpd_tls_auth_only</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>

<span class="err">#</span><span class="w"> </span><span class="nx">CA</span>
<span class="nx">smtp_tls_CAfile</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">cacert</span><span class="p">.</span><span class="nx">pem</span>
<span class="nx">tls_random_source</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dev</span><span class="p">:</span><span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">urandom</span>

<span class="err">#</span><span class="w"> </span><span class="nx">extra</span><span class="w"> </span><span class="nx">spam</span><span class="w"> </span><span class="nx">protection</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">-</span><span class="nx">April</span><span class="o">-</span><span class="mi">2019</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">begin</span>
<span class="nx">smtpd_helo_required</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtpd_helo_restrictions</span><span class="w"> </span><span class="p">=</span>
<span class="w">    </span><span class="nx">permit_mynetworks</span>
<span class="w">    </span><span class="nx">permit_sasl_authenticated</span>
<span class="err">#</span><span class="w"> </span><span class="nx">extra</span><span class="w"> </span><span class="nx">spam</span><span class="w"> </span><span class="nx">protection</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">-</span><span class="nx">April</span><span class="o">-</span><span class="mi">2019</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">end</span>

<span class="err">#</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">max</span><span class="w"> </span><span class="nx">connection</span><span class="w"> </span><span class="nx">rate</span><span class="w">  </span><span class="mi">9</span><span class="o">-</span><span class="nx">May</span><span class="o">-</span><span class="mi">2019</span>
<span class="nx">smtpd_error_sleep_time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="nx">s</span>
<span class="nx">smtpd_soft_error_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span>
<span class="nx">smtpd_hard_error_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span>
</code></pre></div>

<h3 id="configuration-login">Configuration - Login</h3>
<p>Change *'s to real passwords</p>
<p>File: /etc/postfix/sasl/sasl_passwd</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">smtp-auth.no-ip.com</span><span class="o">]</span><span class="err">:</span><span class="mi">465</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="nv">@noip</span><span class="o">-</span><span class="nl">smtp</span><span class="p">:</span><span class="o">***************</span>
</code></pre></div>

<blockquote>
<p>Use the <code>postmap</code> command whenever you change the <code>/etc/postfix/sasl/sasl_passwd</code> file.</p>
</blockquote>
<p>Reference: <a href="http://www.postfix.com/SASL_README.html">http://www.postfix.com/SASL_README.html</a></p>
<p>Create sasl_passwd database for postfix relay to nop-ip</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>postmap<span class="w"> </span>/etc/postfix/sasl_passwd

<span class="c1"># Protect the source file</span>
$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span>root:root<span class="w"> </span>/etc/postfix/sasl<span class="w"> </span>/etc/postfix/sasl/sasl_passwd
$<span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">0600</span><span class="w">      </span>/etc/postfix/sasl<span class="w"> </span>/etc/postfix/sasl/sasl_passwd

<span class="c1"># Protect the database file</span>
$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span>root:root<span class="w"> </span>/etc/postfix/sasl<span class="w"> </span>/etc/postfix/sasl/sasl_passwd.db
$<span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">0600</span><span class="w">      </span>/etc/postfix/sasl<span class="w"> </span>/etc/postfix/sasl/sasl_passwd.db
</code></pre></div>

<h3 id="configuration-master">Configuration - Master</h3>
<p>Reference: <a href="http://www.postfix.org/master.5.html">http://www.postfix.org/master.5.html</a></p>
<p>Add smtp, smtps and submission internet services (smtpd) and spamassassin, dovecot local services (pipe) to the default master.cf file.</p>
<p>The <code>-o</code> lines override options in the main.cf file.</p>
<p>File: /etc/postfix/master.cf</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span>==========================================================================
#<span class="w"> </span>service<span class="w"> </span>type<span class="w">  </span>private<span class="w"> </span>unpriv<span class="w">  </span>chroot<span class="w">  </span>wakeup<span class="w">  </span>maxproc<span class="w"> </span>command<span class="w"> </span>+<span class="w"> </span>args
#<span class="w">               </span>(yes)<span class="w">   </span>(yes)<span class="w">   </span>(yes)<span class="w">   </span>(never)<span class="w"> </span>(100)
#<span class="w"> </span>==========================================================================
#............................................................................
#<span class="w"> </span>P<span class="w"> </span>O<span class="w"> </span>S<span class="w"> </span>T<span class="w"> </span>F<span class="w"> </span>I<span class="w"> </span>X
smtp<span class="w">       </span>inet<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>smtpd<span class="w"> </span>-o<span class="w"> </span>content_filter=spamassassin
submission<span class="w"> </span>inet<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>smtpd
<span class="w">    </span>-o<span class="w"> </span>smtpd_tls_security_level=encrypt
<span class="w">    </span>-o<span class="w"> </span>smtpd_sasl_auth_enable=yes
<span class="w">    </span>-o<span class="w"> </span>smtpd_sasl_type=dovecot
<span class="w">    </span>-o<span class="w"> </span>smtpd_sasl_path=private/auth
<span class="w">    </span>-o<span class="w"> </span>smtpd_sasl_security_options=noanonymous
<span class="w">    </span>-o<span class="w"> </span>smtpd_sasl_local_domain=<span class="nv">$myhostname</span>
<span class="w">    </span>-o<span class="w"> </span>smtpd_sender_login_maps=hash:/etc/postfix/virtual
smtps<span class="w">      </span>inet<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>smtpd
<span class="w">    </span>-o<span class="w"> </span>smtpd_tls_wrappermode=yes
<span class="w">    </span>-o<span class="w"> </span>smtpd_sasl_auth_enable=yes
<span class="w">    </span>-o<span class="w"> </span>milter_macro_daemon_name=ORIGINATING
#............................................................................
#<span class="w"> </span>S<span class="w"> </span>P<span class="w"> </span>A<span class="w"> </span>M<span class="w"> </span>A<span class="w"> </span>S<span class="w"> </span>S<span class="w"> </span>A<span class="w"> </span>S<span class="w"> </span>S<span class="w"> </span>I<span class="w"> </span>N
spamassassin<span class="w"> </span>unix<span class="w"> </span>-<span class="w">     </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>pipe
<span class="w">  </span>user=debian-spamd<span class="w"> </span>argv=/usr/bin/spamc<span class="w"> </span>-f<span class="w"> </span>-e<span class="w">  </span>/usr/sbin/sendmail<span class="w"> </span>-oi<span class="w"> </span>-f<span class="w"> </span><span class="cp">${</span><span class="n">sender</span><span class="cp">}</span><span class="w"> </span><span class="cp">${</span><span class="n">recipient</span><span class="cp">}</span>
#............................................................................
#<span class="w"> </span>D<span class="w"> </span>O<span class="w"> </span>V<span class="w"> </span>E<span class="w"> </span>C<span class="w"> </span>O<span class="w"> </span>T
dovecot<span class="w">   </span>unix<span class="w">  </span>-<span class="w">       </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>pipe
<span class="w"> </span>flags=DRhu<span class="w"> </span>user=mail:mail<span class="w"> </span>argv=/usr/libexec/dovecot/deliver<span class="w"> </span>-f<span class="w"> </span><span class="cp">${</span><span class="n">sender</span><span class="cp">}</span><span class="w"> </span>-d<span class="w"> </span><span class="cp">${</span><span class="n">recipient</span><span class="cp">}</span><span class="w"> </span>-a<span class="w"> </span><span class="cp">${</span><span class="n">original_recipient</span><span class="cp">}</span>
#............................................................................
#<span class="w"> </span>M<span class="w"> </span>I<span class="w"> </span>S<span class="w"> </span>C
pickup<span class="w">     </span>fifo<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>60<span class="w">      </span>1<span class="w">       </span>pickup
cleanup<span class="w">    </span>unix<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>0<span class="w">       </span>cleanup
qmgr<span class="w">      </span>fifo<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>n<span class="w">       </span>300<span class="w">     </span>1<span class="w">       </span>qmgr
#qmgr<span class="w">     </span>fifo<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>300<span class="w">     </span>1<span class="w">       </span>oqmgr
tlsmgr<span class="w">     </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>1000?<span class="w">   </span>1<span class="w">       </span>tlsmgr
rewrite<span class="w">    </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>trivial-rewrite
bounce<span class="w">     </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>0<span class="w">       </span>bounce
defer<span class="w">      </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>0<span class="w">       </span>bounce
trace<span class="w">      </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>0<span class="w">       </span>bounce
verify<span class="w">     </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>1<span class="w">       </span>verify
flush<span class="w">      </span>unix<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>1000?<span class="w">   </span>0<span class="w">       </span>flush
proxymap<span class="w">  </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>proxymap
proxywrite<span class="w"> </span>unix<span class="w"> </span>-<span class="w">       </span>-<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>1<span class="w">       </span>proxymap
relay<span class="w">      </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>smtp
<span class="w">    </span>-o<span class="w"> </span>smtp_fallback_relay=
showq<span class="w">      </span>unix<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>showq
error<span class="w">      </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>error
retry<span class="w">      </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>error
discard<span class="w">    </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>discard
local<span class="w">     </span>unix<span class="w">  </span>-<span class="w">       </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>local
virtual<span class="w">   </span>unix<span class="w">  </span>-<span class="w">       </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>virtual
lmtp<span class="w">       </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>lmtp
anvil<span class="w">      </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>1<span class="w">       </span>anvil
#
scache<span class="w">     </span>unix<span class="w">  </span>-<span class="w">       </span>-<span class="w">       </span>y<span class="w">       </span>-<span class="w">       </span>1<span class="w">       </span>scache
maildrop<span class="w">  </span>unix<span class="w">  </span>-<span class="w">       </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>pipe
<span class="w">  </span>flags=DRhu<span class="w"> </span>user=vmail<span class="w"> </span>argv=/usr/bin/maildrop<span class="w"> </span>-d<span class="w"> </span><span class="cp">${</span><span class="n">recipient</span><span class="cp">}</span>
</code></pre></div>

<h2 id="spamassasin-puts-spam-into-a-spam-folder-automatically">Spamassasin - Puts SPAM into a SPAM folder automatically</h2>
<h3 id="configure">Configure</h3>
<p>Install</p>
<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code>dnf install spamassassin
</code></pre></div>

<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code>apt-get install spamassassin spamc
</code></pre></div>

<p>Create a spam user, unless Debian/Ubuntu did this for you.</p>
<p>Check for spam user:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>grep<span class="w"> </span>spam<span class="w"> </span>/etc/passwd
debian-spamd:x:135:140::/var/lib/spamassassin:/bin/sh
</code></pre></div>

<p>If no user exists yet, create one</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>adduser<span class="w"> </span>spamd<span class="w"> </span>--disabled-login
</code></pre></div>

<p>Config file</p>
<p>Be sure to set CRON=1 and allow IPv6.</p>
<ul>
<li>Debian
File: /etc/default/spamassassin</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># /etc/default/spamassassin</span>
<span class="c1"># Duncan Findlay</span>

<span class="c1"># WARNING: please read README.spamd before using.</span>
<span class="c1"># There may be security risks.</span>

<span class="c1"># Prior to version 3.4.2-1, spamd could be enabled by setting</span>
<span class="c1"># ENABLED=1 in this file. This is no longer supported. Instead, please</span>
<span class="c1"># use the update-rc.d command, invoked for example as &quot;update-rc.d</span>
<span class="c1"># spamassassin enable&quot;, to enable the spamd service.</span>

<span class="c1"># Options</span>
<span class="c1"># See man spamd for possible options. The -d option is automatically added.</span>

<span class="c1"># SpamAssassin uses a preforking model, so be careful! You need to</span>
<span class="c1"># make sure --max-children is not set to anything higher than 5,</span>
<span class="c1"># unless you know what you&#39;re doing.</span>

<span class="c1">#OPTIONS=&quot;--create-prefs --max-children 5 --helper-home-dir&quot;</span>
<span class="c1"># Don 17-Jan-2022 - fix connection refused on ipv6</span>
<span class="n">OPTIONS</span><span class="o">=</span><span class="s2">&quot;-A 127.0.0.1 -A ::1 --create-prefs --max-children 5 --helper-home-dir&quot;</span>

<span class="c1"># Pid file</span>
<span class="c1"># Where should spamd write its PID to file? If you use the -u or</span>
<span class="c1"># --username option above, this needs to be writable by that user.</span>
<span class="c1"># Otherwise, the init script will not be able to shut spamd down.</span>
<span class="n">PIDFILE</span><span class="o">=</span><span class="s2">&quot;/var/run/spamd.pid&quot;</span>

<span class="c1"># Set nice level of spamd</span>
<span class="c1">#NICE=&quot;--nicelevel 15&quot;</span>

<span class="c1"># Cronjob</span>
<span class="c1"># Set to anything but 0 to enable the cron job to automatically update</span>
<span class="c1"># spamassassin&#39;s rules on a nightly basis</span>
<span class="n">CRON</span><span class="o">=</span><span class="mi">1</span>
</code></pre></div>

<p>All local customization happen in the next file.</p>
<p>I like to change the header to add the SPAM_SCORE, modify the original E-Mail with the new header information, and lower the threshold to mark as spam from 5 to 3.</p>
<ul>
<li>
<p>RedHat
File: /etc/mail/spamassassin/local.cf</p>
</li>
<li>
<p>Debian
File: /etc/spamassassin/local.cf</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># This is the right place to customize your installation of SpamAssassin.</span>
<span class="c1">#</span>
<span class="c1"># See &#39;perldoc Mail::SpamAssassin::Conf&#39; for details of what can be</span>
<span class="c1"># tweaked.</span>
<span class="c1">#</span>
<span class="c1"># Only a small subset of options are listed below</span>
<span class="c1">#</span>
<span class="c1">###########################################################################</span>

<span class="c1">#   Add *****SPAM***** to the Subject header of spam e-mails</span>
<span class="c1">#</span>
<span class="c1"># rewrite_header Subject *****SPAM*****</span>
<span class="c1"># Don - b</span>
<span class="n">rewrite_header</span><span class="w"> </span><span class="n">Subject</span><span class="w"> </span><span class="o">*****</span><span class="w"> </span><span class="n">SPAM</span><span class="w"> </span><span class="n">_SCORE_</span><span class="w"> </span><span class="o">*****</span><span class="w"> </span>
<span class="c1"># Don - e</span>


<span class="c1">#   Save spam messages as a message/rfc822 MIME attachment instead of</span>
<span class="c1">#   modifying the original message (0: off, 2: use text/plain instead)</span>
<span class="c1">#</span>
<span class="c1"># report_safe 1</span>
<span class="c1"># Don - b</span>
<span class="n">report_safe</span><span class="w"> </span><span class="mi">0</span>
<span class="c1"># Don - e</span>


<span class="c1">#   Set which networks or hosts are considered &#39;trusted&#39; by your mail</span>
<span class="c1">#   server (i.e. not spammers)</span>
<span class="c1">#</span>
<span class="c1"># trusted_networks 212.17.35.</span>


<span class="c1">#   Set file-locking method (flock is not safe over NFS, but is faster)</span>
<span class="c1">#</span>
<span class="c1"># lock_method flock</span>


<span class="c1">#   Set the threshold at which a message is considered spam (default: 5.0)</span>
<span class="c1">#</span>
<span class="c1"># required_score 5.0</span>
<span class="c1"># Don -b</span>
<span class="n">required_score</span><span class="w"> </span><span class="mf">3.0</span>
<span class="c1"># Don -e</span>


<span class="c1">#   Use Bayesian classifier (default: 1)</span>
<span class="c1">#</span>
<span class="c1"># use_bayes 1</span>
<span class="c1"># Don -b</span>
<span class="n">use_bayes</span><span class="w"> </span><span class="mi">1</span>
<span class="c1"># Don -e</span>


<span class="c1">#   Bayesian classifier auto-learning (default: 1)</span>
<span class="c1">#</span>
<span class="c1"># bayes_auto_learn 1</span>
<span class="c1"># Don -b</span>
<span class="n">bayes_auto_learn</span><span class="w"> </span><span class="mi">1</span>
<span class="c1"># Don -e</span>


<span class="c1">#   Set headers which may provide inappropriate cues to the Bayesian</span>
<span class="c1">#   classifier</span>
<span class="c1">#</span>
<span class="c1"># bayes_ignore_header X-Bogosity</span>
<span class="c1"># bayes_ignore_header X-Spam-Flag</span>
<span class="c1"># bayes_ignore_header X-Spam-Status</span>


<span class="c1">#   Whether to decode non- UTF-8 and non-ASCII textual parts and recode</span>
<span class="c1">#   them to UTF-8 before the text is given over to rules processing.</span>
<span class="c1">#</span>
<span class="c1"># normalize_charset 1</span>

<span class="c1">#   Textual body scan limit    (default: 50000)</span>
<span class="c1">#</span>
<span class="c1">#   Amount of data per email text/* mimepart, that will be run through body</span>
<span class="c1">#   rules.  This enables safer and faster scanning of large messages,</span>
<span class="c1">#   perhaps having very large textual attachments.  There should be no need</span>
<span class="c1">#   to change this well tested default.</span>
<span class="c1">#</span>
<span class="c1"># body_part_scan_size 50000</span>

<span class="c1">#   Textual rawbody data scan limit    (default: 500000)</span>
<span class="c1">#</span>
<span class="c1">#   Amount of data per email text/* mimepart, that will be run through</span>
<span class="c1">#   rawbody rules.</span>
<span class="c1">#</span>
<span class="c1"># rawbody_part_scan_size 500000</span>

<span class="c1">#   Some shortcircuiting, if the plugin is enabled</span>
<span class="c1"># </span>
<span class="n">ifplugin</span><span class="w"> </span><span class="n">Mail</span><span class="p">::</span><span class="n">SpamAssassin</span><span class="p">::</span><span class="n">Plugin</span><span class="p">::</span><span class="n">Shortcircuit</span>
<span class="c1">#</span>
<span class="c1">#   default: strongly-whitelisted mails are *really* whitelisted now, if the</span>
<span class="c1">#   shortcircuiting plugin is active, causing early exit to save CPU load.</span>
<span class="c1">#   Uncomment to turn this on</span>
<span class="c1">#</span>
<span class="c1">#   SpamAssassin tries hard not to launch DNS queries before priority -100. </span>
<span class="c1">#   If you want to shortcircuit without launching unneeded queries, make</span>
<span class="c1">#   sure such rule priority is below -100. These examples are already:</span>
<span class="c1">#</span>
<span class="c1"># shortcircuit USER_IN_WHITELIST       on</span>
<span class="c1"># shortcircuit USER_IN_DEF_WHITELIST   on</span>
<span class="c1"># shortcircuit USER_IN_ALL_SPAM_TO     on</span>
<span class="c1"># shortcircuit SUBJECT_IN_WHITELIST    on</span>

<span class="c1">#   the opposite; blacklisted mails can also save CPU</span>
<span class="c1">#</span>
<span class="c1"># shortcircuit USER_IN_BLACKLIST       on</span>
<span class="c1"># shortcircuit USER_IN_BLACKLIST_TO    on</span>
<span class="c1"># shortcircuit SUBJECT_IN_BLACKLIST    on</span>

<span class="c1">#   if you have taken the time to correctly specify your &quot;trusted_networks&quot;,</span>
<span class="c1">#   this is another good way to save CPU</span>
<span class="c1">#</span>
<span class="c1"># shortcircuit ALL_TRUSTED             on</span>

<span class="c1">#   and a well-trained bayes DB can save running rules, too</span>
<span class="c1">#</span>
<span class="c1"># shortcircuit BAYES_99                spam</span>
<span class="c1"># shortcircuit BAYES_00                ham</span>

<span class="n">endif</span><span class="w"> </span><span class="c1"># Mail::SpamAssassin::Plugin::Shortcircuit</span>
</code></pre></div>

<blockquote>
<p>These next SPAM settings to the <code>/etc/postfix/master.cf</code> were also shown above, so just repeating here for clarity.</p>
</blockquote>
<p>File: /etc/postfix/master.cf</p>
<div class="highlight"><pre><span></span><code>=&gt;<span class="w"> </span>Then<span class="w"> </span>we<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>line<span class="w"> </span>and<span class="w"> </span>add<span class="w"> </span>the<span class="w"> </span>spamassassin<span class="w"> </span>filter:
~
smtp<span class="w">      </span>inet<span class="w">  </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>smtpd
-o<span class="w"> </span>content_filter=spamassassin
~

=&gt;<span class="w"> </span>Finally<span class="w"> </span>we<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>append<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>parameters:
~
spamassassin<span class="w"> </span>unix<span class="w"> </span>-<span class="w">     </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>pipe
user=spamd<span class="w"> </span>argv=/usr/bin/spamc<span class="w"> </span>-f<span class="w"> </span>-e
/usr/sbin/sendmail<span class="w"> </span>-oi<span class="w"> </span>-f<span class="w"> </span><span class="cp">${</span><span class="n">sender</span><span class="cp">}</span><span class="w"> </span><span class="cp">${</span><span class="n">recipient</span><span class="cp">}</span>
~
</code></pre></div>

<h3 id="start-spamassassin-and-restart-postfix">Start spamassassin and restart postfix</h3>
<p><strong>IMPORTANT</strong>: Spamassassin must connect to the network to complete initialization, but during reboot the network is not fully up and DNS resolvable, so we need to force a wait in the systemd service script for spamassassin.</p>
<p><em>Replace 'ExecStartPre' with the bash line below.</em> - and - <em>Replace 'After' to add dependency on network and nslookup working</em></p>
<p>File: /lib/systemd/system/spamassassin.service</p>
<div class="highlight"><pre><span></span><code><span class="na">~</span>
<span class="na">[Unit]</span>
<span class="na"># Depend on: online, remote, nss...</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target network-online.target remote-fs.target nss-lookup.target</span>
<span class="na">~</span>
<span class="na">[Service]</span>
<span class="na"># Wait for dns resolver</span>
<span class="na">ExecStartPre</span><span class="o">=</span><span class="s">/bin/bash -c &#39;until host google.com; do sleep 1; done&#39;</span>
<span class="err">~</span>
</code></pre></div>

<p>Now restart systemd, spamassassin and postfix to pick up new configuration changes.</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">spamassassin</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">postfix</span>
</code></pre></div>

<h3 id="daily-update-in-etccrondaily">Daily update in /etc/cron.daily</h3>
<p>This is to update the spam databases from the internet</p>
<p>FYI: Check the file in /etc/cron.daily for the scheduled entry</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/etc/cron.daily/spamassassin
<span class="c1">#!/bin/bash</span>
<span class="c1"># -v verbose</span>
<span class="c1"># -D debug</span>
/bin/sa-update<span class="w"> </span>-v<span class="w"> </span>-D
</code></pre></div>

<h3 id="put-spamham-learning-into-a-script">Put spam/ham learning into a script</h3>
<p>If you find spam in your inbox, move it to the SPAM folder and the sa-learn command will update the local learning. Conversely, if you find good E-Mail in the SPAM folder, move it your your INBOX and the next learning cycle will mark it as good E-Mail (ham).</p>
<p>In the next script, <em>change to your Maildir directory</em>, and <em>add/delete E-Mail folders</em> as required for spam and ham actions.</p>
<p>Reference: <a href="https://spamassassin.apache.org/doc.html">https://spamassassin.apache.org/doc.html</a></p>
<p>File: /home/bob/spam</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>spam
<span class="nv">HOME</span><span class="o">=</span>/home/bob
<span class="c1"># https://spamassassin.apache.org/full/3.1.x/doc/sa-learn.html</span>
sa-learn<span class="w"> </span>-u<span class="w"> </span>debian-spamd<span class="w"> </span>--backup<span class="w"> </span>&gt;/tmp/spam.bkup
sa-learn<span class="w"> </span>-u<span class="w"> </span>debian-spamd<span class="w"> </span>--no-sync<span class="w"> </span>--spam<span class="w"> </span><span class="nv">$HOME</span>/Maildir/.Junk/<span class="o">{</span>cur,new<span class="o">}</span>
sa-learn<span class="w"> </span>-u<span class="w"> </span>debian-spamd<span class="w"> </span>--no-sync<span class="w"> </span>--spam<span class="w"> </span><span class="nv">$HOME</span>/Maildir/.Junk<span class="se">\ </span>E-mail/<span class="o">{</span>cur,new<span class="o">}</span>
sa-learn<span class="w"> </span>-u<span class="w"> </span>debian-spamd<span class="w"> </span>--no-sync<span class="w"> </span>--ham<span class="w">  </span><span class="nv">$HOME</span>/Maildir/.INBOX.Bob/<span class="o">{</span>cur,new<span class="o">}</span>
sa-learn<span class="w"> </span>-u<span class="w"> </span>debian-spamd<span class="w"> </span>--sync
sa-learn<span class="w"> </span>-u<span class="w"> </span>debian-spamd<span class="w"> </span>--dump<span class="w"> </span>magic
</code></pre></div>

<p>Now schedule the spam local learning. Create this script and put in in ```/etc/cron.daily`` so it will run once a day.</p>
<p>File: /etc/cron.daily/spam</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">DIR</span><span class="o">=</span>/tmp
<span class="nv">RESULT</span><span class="o">=</span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/spam.txt
/home/bob/spam<span class="w"> </span>&gt;<span class="si">${</span><span class="nv">RESULT</span><span class="si">}</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RESULT</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span>rm<span class="w"> </span><span class="si">${</span><span class="nv">RESULT</span><span class="si">}</span>
<span class="k">else</span>
<span class="w">  </span>cat<span class="w"> </span><span class="si">${</span><span class="nv">RESULT</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>mail<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;Spam refresh&quot;</span><span class="w"> </span>bob@example.com<span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="k">fi</span>
</code></pre></div>

<h2 id="mail-readers">Mail Readers</h2>
<h3 id="mutt">Mutt</h3>
<p>Mutt [1] is a text only e-mail reader, capable of running over an ssh connection.</p>
<p><img alt="mutt_index.gif" src="/linux-in-house/images/mutt_index.gif"></p>
<h4 id="install">Install</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>mutt
</code></pre></div>

<h4 id="configure_1">Configure</h4>
<p>Global options are in file /etc/Muttrc. User options are in file: \~/.muttrc</p>
<p>Assuming your <strong>local</strong> maildir is in /backup/Maildir...</p>
<div class="highlight"><pre><span></span><code><span class="nx">source</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="nx">mutt</span><span class="o">/</span><span class="nx">mailboxes</span>
<span class="nx">folder</span><span class="o">-</span><span class="nx">hook</span><span class="w"> </span><span class="nx">Home</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">from</span><span class="p">=</span><span class="s">&quot;bob@example.com&quot;</span>
<span class="err">#</span><span class="nx">folder</span><span class="o">-</span><span class="nx">hook</span><span class="w"> </span><span class="nx">Work</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">from</span><span class="p">=</span><span class="s">&quot;youremail@work.com&quot;</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">mbox_type</span><span class="p">=</span><span class="nx">Maildir</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">folder</span><span class="p">=</span><span class="s">&quot;/backup/Maildir/Home&quot;</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">mask</span><span class="p">=</span><span class="s">&quot;!^\\.[^.]&quot;</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">mbox</span><span class="p">=</span><span class="s">&quot;/backup/Maildir/Home&quot;</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">record</span><span class="p">=</span><span class="s">&quot;+.Sent&quot;</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">postponed</span><span class="p">=</span><span class="s">&quot;+.Drafts&quot;</span>
<span class="nx">set</span><span class="w"> </span><span class="nx">spoolfile</span><span class="p">=</span><span class="s">&quot;/backup/Maildir/Home/.INBOX&quot;</span>
</code></pre></div>

<p>If your mail server is over a <strong>network</strong>, use this configuration</p>
<div class="highlight"><pre><span></span><code><span class="c1">#    Tell mutt to use your IMAP INBOX as your $spoolfile: set spoolfile=imap://hostname/INBOX</span>
<span class="c1">#    Set your $folder to your IMAP root: set folder=imap://hostname/</span>
<span class="c1"># activate TLS if available on the server</span>
<span class="n">set</span><span class="w"> </span><span class="n">ssl_starttls</span><span class="o">=</span><span class="n">yes</span>
<span class="c1"># always use SSL when connecting to a server</span>
<span class="n">set</span><span class="w"> </span><span class="n">ssl_force_tls</span><span class="o">=</span><span class="n">yes</span>

<span class="n">set</span><span class="w"> </span><span class="n">spoolfile</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">imaps:</span><span class="sr">//</span><span class="n">example</span><span class="o">.</span><span class="n">org:993</span><span class="o">/</span><span class="n">INBOX</span>
<span class="n">set</span><span class="w"> </span><span class="n">folder</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">imaps:</span><span class="sr">//</span><span class="n">example</span><span class="o">.</span><span class="n">org:993</span><span class="o">/</span>
<span class="n">set</span><span class="w"> </span><span class="n">imap_user</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">bob</span><span class="nv">@example</span><span class="o">.</span><span class="n">org</span>
<span class="n">set</span><span class="w"> </span><span class="n">imap_pass</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">abcdIfYouSeeMe1234</span>
<span class="n">set</span><span class="w"> </span><span class="n">spoolfile</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="n">INBOX</span>
<span class="n">mailboxes</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="n">INBOX</span>
<span class="n">set</span><span class="w"> </span><span class="n">smtp_url</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">smtps:</span><span class="sr">//</span><span class="n">bob:abcdIfYouSeeMe1234</span><span class="nv">@example</span><span class="o">.</span><span class="n">org:25</span>

<span class="c1"># Refresh new messages</span>
<span class="n">set</span><span class="w"> </span><span class="n">mail_check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>

<span class="c1"># Store message headers locally to speed things up.</span>
<span class="c1"># If hcache is a folder, Mutt will create sub cache folders for each account which may speeds things</span>
<span class="n">set</span><span class="w"> </span><span class="n">header_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="sr">/.cache/m</span><span class="n">utt</span>

<span class="c1"># Store messages locally to speed things up, like searching message bodies.</span>
<span class="c1"># Can be the same folder as header_cache.</span>
<span class="c1"># This will cost important disk usage according to your e-mail amount.</span>
<span class="n">set</span><span class="w"> </span><span class="n">message_cachedir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;~/.cache/mutt&quot;</span>

<span class="c1"># Specify where to save and/or look for postponed messages.</span>
<span class="n">set</span><span class="w"> </span><span class="n">postponed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="n">Drafts</span>

<span class="c1"># Allow Mutt to open a new IMAP connection automatically.</span>
<span class="n">unset</span><span class="w"> </span><span class="n">imap_passive</span>

<span class="c1"># Keep the IMAP connection alive by polling intermittently (time in seconds).</span>
<span class="n">set</span><span class="w"> </span><span class="n">imap_keepalive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span>

<span class="c1"># How often to check for new mail (time in seconds).</span>
<span class="n">set</span><span class="w"> </span><span class="n">mail_check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span>
</code></pre></div>

<ol>
<li><a href="http://www.mutt.org/">http://www.mutt.org/</a></li>
</ol>
<h3 id="evolution">Evolution</h3>
<p>Evolution [1] is a Graphical User Interface (GUI) mail reader, the best one for Linux desktop.</p>
<p><img alt="evolution_window-overview-layers.png" src="/linux-in-house/images/evolution_window-overview-layers.png"><br>
<img alt="evolution_legend.png" src="/linux-in-house/images/evolution_legend.png"></p>
<h4 id="install_1">Install</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>evolution
</code></pre></div>

<h4 id="configure_2">Configure</h4>
<p>Launch the application and configure the receiving (IMAPS), sending server(SMTP) and options like timezone.</p>
<ol>
<li><a href="https://help.gnome.org/users/evolution/stable/">https://help.gnome.org/users/evolution/stable/</a></li>
</ol>
<h3 id="thunderbird">Thunderbird</h3>
<p>Thunderbird [1] is a GUI mail reader, the best one for MacOS or Windows.</p>
<p><img alt="Thunderbird-email.png" src="/linux-in-house/images/Thunderbird-email.png"></p>
<h4 id="install_2">Install</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>thunderbird
</code></pre></div>

<h4 id="configure_3">Configure</h4>
<p>Launch the application and configure the receiving (IMAPS), sending server(SMTP) and options like timezone.</p>
<ol>
<li><a href="https://www.thunderbird.net/en-US/">https://www.thunderbird.net/en-US/</a></li>
</ol>
<h2 id="offlineimap-makes-a-backup-copy-of-all-email">Offlineimap - Makes a backup copy of all email</h2>
<p>OfflineIMAP [1] will save a workable entire E-Mail clone in case of total loss on the E-Mail server. You can even run Evolution/Thunderbird/mutt on the new remote server.</p>
<h3 id="install_3">Install</h3>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>offlineimap
</code></pre></div>

<h3 id="configure_4">Configure</h3>
<p>If you run IMAPS, get your cert_fingerprint using the following on the E-Mail server:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span>^-<span class="w"> </span>/etc/letsencrypt/live/example.com/cert.pem<span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>sha1sum
</code></pre></div>

<p>Create the <code>.offlineimaprc</code> file in your $HOME directory (~) on the <em>remote</em> host, and change things like <code>localfolders</code>, <code>remotehost</code>, <code>remoteuser</code>, <code>remotepass</code>, and <code>cert_fingerprint</code>.</p>
<p>File: \~/.offlineimaprc</p>
<div class="highlight"><pre><span></span><code><span class="cp"># Sample minimal config file.  Copy this to ~/.offlineimaprc and edit to</span>
<span class="cp"># get started fast.</span>
<span class="cp"># sha1 fingerprint:</span>
<span class="cp"># grep -v ^- cert.pem  | base64 -d | sha1sum</span>

<span class="p">[</span><span class="n">general</span><span class="p">]</span>
<span class="n">accounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Home</span>

<span class="p">[</span><span class="n">Account</span><span class="w"> </span><span class="n">Home</span><span class="p">]</span>
<span class="n">localrepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalHome</span>
<span class="n">remoterepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RemoteHome</span>

<span class="p">[</span><span class="n">Repository</span><span class="w"> </span><span class="n">LocalHome</span><span class="p">]</span>
<span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Maildir</span>
<span class="n">localfolders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">Maildir</span><span class="o">/</span><span class="n">Home</span>

<span class="cp"># Translate your maildir folder names to the format the remote server expects</span>
<span class="cp"># So this reverses the change we make with the remote nametrans setting</span>
<span class="n">nametrans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="err">&#39;</span><span class="o">^</span><span class="err">\</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>


<span class="p">[</span><span class="n">Repository</span><span class="w"> </span><span class="n">RemoteHome</span><span class="p">]</span>
<span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IMAP</span>
<span class="n">remotehost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">com</span>
<span class="n">remoteuser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mail</span>
<span class="n">remotepass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*************</span>
<span class="cp"># openssl_sha1</span>
<span class="n">cert_fingerprint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*************************************</span>
<span class="cp"># Need to exclude &#39;&#39; otherwise it complains about infinite naming loop?</span>
<span class="n">folderfilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">foldername</span><span class="o">:</span><span class="w"> </span><span class="n">foldername</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;&#39;</span><span class="p">]</span>
<span class="cp"># For Dovecot to see the folders right I want them starting with a dot,</span>
<span class="cp"># and dovecot set to look for .INBOX as the toplevel Maildir</span>
<span class="n">nametrans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span>

<span class="p">[</span><span class="n">mbnames</span><span class="p">]</span>
<span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~/</span><span class="p">.</span><span class="n">mutt</span><span class="o">/</span><span class="n">mailboxes</span>
<span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mailboxes &quot;</span>
<span class="n">peritem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;+%(accountname)s/%(foldername)s&quot;</span>
<span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span>
<span class="n">footer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</code></pre></div>

<p>Reference: <a href="https://blog.wikichoon.com/2017/05/configuring-offlineimap-dovecot.html">https://blog.wikichoon.com/2017/05/configuring-offlineimap-dovecot.html</a></p>
<p>Create a script to run it on remote host</p>
<p>File: ~/offlineimap.sh </p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HOME</span><span class="o">=</span>/home/bob
<span class="nv">LOGFILE</span><span class="o">=</span>/var/log/offlineimap.log
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-d<span class="w"> </span>~/Maildir<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span>/usr/bin/date<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$LOGFILE</span>
<span class="w">  </span>/usr/bin/offlineimap<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$LOGFILE</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="w">  </span>/usr/bin/date<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$LOGFILE</span>
<span class="k">fi</span>
</code></pre></div>

<h3 id="schedule">Schedule</h3>
<p>Schedule the script to run on the remote host</p>
<p>File: /etc/cron.d/offlineimap </p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">cron</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">offlineimap</span>
<span class="err">#</span><span class="w"> </span>
<span class="n">SHELL</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="k">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span>
<span class="n">MAILTO</span><span class="o">=</span><span class="ss">&quot;bob@example.com&quot;</span>
<span class="err">#</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">h</span><span class="w">  </span><span class="n">dom</span><span class="w"> </span><span class="n">mon</span><span class="w"> </span><span class="n">dow</span><span class="w"> </span><span class="k">user</span><span class="w">  </span><span class="n">command</span>
<span class="mi">33</span><span class="w">  </span><span class="o">*</span><span class="w">  </span><span class="o">*</span><span class="w">   </span><span class="o">*</span><span class="w">   </span><span class="o">*</span><span class="w">   </span><span class="n">bob</span><span class="w">   </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bob</span><span class="o">/</span><span class="n">offlineimap</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>

<ol>
<li><a href="http://www.offlineimap.org/">http://www.offlineimap.org/</a></li>
</ol>
<h2 id="postfix-log-summary">Postfix Log Summary</h2>
<p>Pflogsumm is a log analyzer/summarizer for the Postfix MTA. It is designed to provide an over-view of Postfix activity. Pflogsumm generates summaries and, in some cases, detailed reports of mail server traffic volumes, rejected and bounced email, and server warnings, errors and panics.</p>
<h3 id="install_4">Install</h3>
<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>pflogsumm
</code></pre></div>

<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>postfix-perl-scripts
</code></pre></div>

<h3 id="schedule_1">Schedule</h3>
<p>Create a script in /etc/cron.daily to run it, like this:</p>
<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">pflogsumm</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">yesterday</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">mail</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="o">--</span><span class="n">problems</span><span class="o">-</span><span class="n">first</span><span class="w"> </span><span class="o">--</span><span class="n">rej</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">from</span><span class="w"> </span><span class="o">--</span><span class="n">verbose</span><span class="o">-</span><span class="n">msg</span><span class="o">-</span><span class="n">detail</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mail</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">&quot;`uname -n` daily mail stats&quot;</span><span class="w"> </span><span class="n">me</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</code></pre></div>

<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">pflogsumm</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">yesterday</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">maillog</span><span class="w"> </span><span class="o">--</span><span class="n">problems</span><span class="o">-</span><span class="n">first</span><span class="w"> </span><span class="o">--</span><span class="n">rej</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">from</span><span class="w"> </span><span class="o">--</span><span class="n">verbose</span><span class="o">-</span><span class="n">msg</span><span class="o">-</span><span class="n">detail</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mail</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">&quot;`uname -n` daily mail stats&quot;</span><span class="w"> </span><span class="n">me</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</code></pre></div>

<h2 id="alternatives">Alternatives</h2>
<h3 id="exim4">exim4</h3>
<p>Exim (Experimental Internet Mailer) [1] receives and sends mail, referred to as an MTA like postfix. It does not provide POP or IMAP interfaces to read mail. It is available on most Linux distributions as a package install, but was removed from RedHat due to low populatity.</p>
<h4 id="what-it-does">What it does</h4>
<ul>
<li>
<p>RFC 2821 SMTP and RFC 2033 LMTP email message transport.</p>
</li>
<li>
<p>Incoming (as SMTP server):</p>
<ul>
<li>SMTP over TCP/IP (Exim daemon or inetd);</li>
<li>SMTP over the standard input and output (the -bs option);</li>
<li>Batched SMTP on the standard input (the -bS option).</li>
</ul>
</li>
<li>
<p>Exim also supports RFC 5068 Message Submission, as an SMTP server with (for example, encrypted and authenticated connections on port 587).</p>
</li>
<li>
<p>Outgoing email (as SMTP or LMTP client):</p>
<ul>
<li>SMTP over TCP/IP (the smtp transport);</li>
<li>LMTP [2] over TCP/IP (the smtp transport with the protocol option set to “lmtp”);</li>
<li>LMTP over a pipe to a process running in the local host (the lmtp transport);</li>
<li>Batched SMTP to a file or pipe (the appendfile and pipetransports with the use_bsmtp option set).</li>
</ul>
</li>
<li>
<p>Configuration</p>
<ul>
<li>Access Control Lists - flexible policy controls.</li>
<li>Content scanning, including easy integration with and other spam and virus scanners like SpamAssassin and ClamAV.</li>
<li>Encrypted SMTP connections using TLS/SSL.</li>
<li>Authentication with a variety of front end and back end methods, including PLAIN, LOGIN, sasl, dovecot, spa, cram_md5.</li>
<li>Rewrite - rewrite envelope and/or header addresses using regular expressions.</li>
<li>Routing controls - use routers to redirect, quarantine, or deliver messages.</li>
<li>Transports - use transports to deliver messages by smtp, lmtp, or to files, directories, or other programs.</li>
<li>Flexible retry rules for temporary delivery problems.</li>
</ul>
</li>
</ul>
<p>I usually install it on non-email Debian servers because it is very light weight and works great sending monitoring messages from servers to the main E-Mail server [3].</p>
<p>Pros: 
 * Small footprint is able to run on SBC like Rasberry PI
 * Simple configuration on Debian only
 * Extendable </p>
<p>Cons:
 * Only MTA, does not support mailboxes without an MDA like Dovecot
 * Not as well known as postfix, probably not as many people or businesses supporting it 
 * Not available on RedHat mainstream, Postfix and Sendmail are the only alternative</p>
<ol>
<li><a href="https://www.exim.org/docs.html">https://www.exim.org/docs.html</a></li>
<li>Local Mail Transfer Protocol</li>
<li><a href="Setup_Server.md">Setup_Server</a></li>
</ol>
<h3 id="iredmail">iRedMail</h3>
<p>With iRedMail [1], you can deploy an OPEN SOURCE, FULLY FLEDGED, FULL-FEATURED mail server in several minutes, for free.</p>
<p>It supports all major Linux distributions, has calendar/contact sync,antispam/anitvirus protection, TLS security and webmail locally on your server. This would replace the Dovecot/postfix combination described above.</p>
<p>Read the documentation [2] and decide for yourself. This takes over a host, installing many different products, like database (mySQL/PostgreSQL,LDAP), DKIM, Spam filter, fail2ban, netdata, postfix, Dovecot, webmail, etc.  You will need about 4GB of memory and a couple CPUs along with 20GB disk.</p>
<p>Pros: 
 * multiple E-Mail domains
 * multiple E-Mail accounts
 * Nice GUI for managing the E-Mail accounts
 * Includes massive system monitor, netdata [3]
 * You can buy support</p>
<p>Cons:
 * Need a bigger, dedicated machine to host it
 * Puts much of the configuration inside a database
 * Not well suited for small setup at home, due to the complexity</p>
<ol>
<li><a href="https://www.iredmail.org/">https://www.iredmail.org/</a></li>
<li><a href="https://docs.iredmail.org/index.html">https://docs.iredmail.org/index.html</a></li>
<li><a href="https://www.netdata.cloud/">https://www.netdata.cloud/</a></li>
</ol>
<h3 id="mail-in-a-box">Mail-in-a-Box</h3>
<p>Technically, Mail-in-a-Box [1] turns a fresh cloud computer into a working mail server. But you don’t need to be a technology expert to set it up.</p>
<p>Each Mail-in-a-Box provides webmail and an IMAP/SMTP server for use with mobile devices and desktop mail software. It also includes contacts and calendar synchronization.</p>
<p>This project provides a simple, turn-key solution. There are basically no configuration options and you can’t tweak the machine’s configuration files after installation. </p>
<p>My observation is that this is good for a dedicated mail server machine, and that's all that machine should do. Perhaps it would work well on a Rasberry PI SBC.</p>
<p>Pros:
 * Do not need to know all the technical details of E-Mail to setup and use
 * Small system requirements, runable on a SBC</p>
<p>Cons:
 * Requires dedicated machine, as it takes over 
 * Not sure how well support will be, especially for critital systems</p>
<ol>
<li><a href="https://mailinabox.email/">https://mailinabox.email/</a></li>
</ol>
<h3 id="citadel">Citadel</h3>
<p>This open source project provides "Email, collaboration, groupware, and content management - up and running in minutes, on your own hardware or in the cloud."</p>
<p>Citadel is groupware with BBS roots, and still offers a traditional text-based BBS front end and chat. If you like old school, this is for you.</p>
<p>To find out more, just read the FAQS [2]. Looks interesting to me, at least one person posted about running it on a Rasberry PI [3].</p>
<p>Pros:
 * Do not need to know all the technical details of E-Mail to setup and use
 * Small system requirements, runable on a SBC</p>
<p>Cons:
 * Does more than E-Mail, you may not need all the features installed
 * Not sure how well support will be, especially for critital systems</p>
<ol>
<li><a href="https://www.citadel.org/">https://www.citadel.org/</a></li>
<li><a href="https://www.citadel.org/faq.html">https://www.citadel.org/faq.html</a></li>
<li><a href="https://www.ionos.com/digitalguide/server/configuration/set-up-your-own-raspberry-pi-mail-server/">https://www.ionos.com/digitalguide/server/configuration/set-up-your-own-raspberry-pi-mail-server/</a></li>
</ol>
<h2 id="continue">Continue</h2>
<p>Now that you have set up E-Mail on your server, you will need a Database for many more things, so now is a good time to install the versatile PostgreSQL database.</p>
<p>Proceed in the order presented, some things are depending on prior setups.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://dfcsoftware.github.io/linux-in-house/e-mailrelay.html" rel="bookmark"
                           title="Permalink to E-MailRelay">E-MailRelay</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-01-25T10:20:00-05:00">
                Published: Wed 25 January 2023
        </abbr>
		<br />
        <abbr class="modified" title="2024-04-19T09:30:00-04:00">
                Updated: Fri 19 April 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://dfcsoftware.github.io/linux-in-house/author/don-cohoon.html">Don Cohoon</a>
        </address>
<p>In <a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a>.</p>
<p>tags: <a href="https://dfcsoftware.github.io/linux-in-house/tag/email.html">email</a> </p>
</footer><!-- /.post-info -->                <h1 id="e-mail-relay">E-Mail Relay</h1>
<p>The following diagrams are what this document will accomplish. The challenge is to obtain and keep a good reputation that other E-Mail handlers around the world will accept. Otherwise your messages will be dumped in the trash can (SPAM) or sent back to you (bounced). </p>
<hr>
<div class="toc"><span class="toctitle">Table of Contents …</span></div>
                <a class="readmore" href="https://dfcsoftware.github.io/linux-in-house/e-mailrelay.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://lwn.net/">Linux Weekly News</a></li>
                            <li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
                            <li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
                            <li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
                            <li><a href="https://www.thefarside.com/">The Far Side</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://dfcsoftware.github.io/linux-in-house/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
                            <li><a href="https://fosstodon.org/@Cohoon.rss">Mastodon RSS feed</a></li>
                            <li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
                            <li><a href="/linux-in-house/author/don-cohoon.html">Created by: Don Cohoon</a></li>
                            <li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License </a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>
                Site by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, via <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </p><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                <p> Version:  3.214 </p>
        </footer><!-- /#contentinfo -->

</body>
</html>