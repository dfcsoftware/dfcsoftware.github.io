<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>E-MailRelay</title>
        <link rel="icon" type="image/svg" href="https://dfcsoftware.github.io/linux-in-house/images/favicon.svg">
        <link rel="stylesheet" href="https://dfcsoftware.github.io/linux-in-house/theme/css/main.css" type="text/css" />
        <!-- <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />  -->
        <link href="https://dfcsoftware.github.io/linux-in-house/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Linux Home Administration Atom Feed" />
        <meta name="description" content="E-Mail Relay The following diagrams are what this document will accomplish. The challenge is to obtain and keep a good reputation that other..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <table>
                    <td><h1><a href="https://dfcsoftware.github.io/linux-in-house/">Linux Home Administration</a></h1></td>
                    <td> <link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet" type="text/css">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script> </td>
                </table>
                <nav><ul>
                    <li class="active"><a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/quest.html">quest</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/writing.html">writing</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/zines.html">zines</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://dfcsoftware.github.io/linux-in-house/e-mailrelay.html" rel="bookmark"
           title="Permalink to E-MailRelay">E-MailRelay</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-01-25T10:20:00-05:00">
                Published: Wed 25 January 2023
        </abbr>
		<br />
        <abbr class="modified" title="2024-04-19T09:30:00-04:00">
                Updated: Fri 19 April 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://dfcsoftware.github.io/linux-in-house/author/don-cohoon.html">Don Cohoon</a>
        </address>
<p>In <a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a>.</p>
<p>tags: <a href="https://dfcsoftware.github.io/linux-in-house/tag/email.html">email</a> </p>
</footer><!-- /.post-info -->      <h1 id="e-mail-relay">E-Mail Relay</h1>
<p>The following diagrams are what this document will accomplish. The challenge is to obtain and keep a good reputation that other E-Mail handlers around the world will accept. Otherwise your messages will be dumped in the trash can (SPAM) or sent back to you (bounced). </p>
<hr>
<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#e-mail-relay">E-Mail Relay</a></li>
<li><a href="#overview">Overview</a><ul>
<li><a href="#outgoing-relay-from-inside-home">Outgoing: Relay from Inside Home</a></li>
<li><a href="#outgoing-relay-from-outside-home">Outgoing: Relay from Outside Home</a></li>
<li><a href="#incoming-transport-from-internet">Incoming: Transport from Internet</a></li>
</ul>
</li>
<li><a href="#vps">VPS</a></li>
<li><a href="#secure-vps-on-your-domainorg">Secure VPS on your-domain.org</a><ul>
<li><a href="#check-network">Check Network</a></li>
<li><a href="#update-package-repository">Update Package Repository</a></li>
<li><a href="#create-new-users">Create New User(s)</a></li>
<li><a href="#set-host-and-domain">Set Host and Domain</a></li>
<li><a href="#set-date-and-time">Set Date and Time</a></li>
<li><a href="#monitor-crack-attempts">Monitor crack attempts</a><ul>
<li><a href="#install-firewall-and-fail2ban-on-your-domainorg">Install firewall and fail2ban on your-domain.org</a><ul>
<li><a href="#add-rules-for-e-mail-smtp-and-smtps">Add rules for E-Mail smtp and smtps.</a></li>
<li><a href="#configure-fail2ban">Configure fail2ban</a><ul>
<li><a href="#secure-postfix">Secure postfix</a></li>
<li><a href="#secure-ssh">Secure ssh</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#log-monitors-on-your-domainorg">Log Monitors on your-domain.org</a><ul>
<li><a href="#install-logwatch">Install Logwatch</a></li>
<li><a href="#install-logcheck">Install Logcheck:</a></li>
</ul>
</li>
<li><a href="#logwatcher">LogWatcher</a><ul>
<li><a href="#create">Create</a></li>
<li><a href="#schedule">Schedule</a></li>
<li><a href="#filters">Filters</a></li>
<li><a href="#make-the-scripts-executable">Make the Scripts Executable</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#apache-install-enable-on-your-domainorg">Apache install (enable) on your-domain.org</a><ul>
<li><a href="#add-ssl">Add SSL</a></li>
</ul>
</li>
<li><a href="#dns-registrar-your-domainorg">DNS Registrar (your-domain.org)</a><ul>
<li><a href="#dns-updates">DNS Updates</a><ul>
<li><a href="#create-ptr-record">Create PTR Record</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#certbot-certificate-management-for-lets-encrypt">certbot - Certificate Management for Let's Encrypt</a><ul>
<li><a href="#install">Install</a></li>
<li><a href="#configure">Configure</a></li>
</ul>
</li>
<li><a href="#apache-disable">Apache (disable)</a></li>
<li><a href="#postfix-e-mail-transport-agent">postfix - E-Mail Transport Agent</a><ul>
<li><a href="#install-on-your-domainorg">Install on your-domain.org</a></li>
<li><a href="#configure-on-your-domainorg">Configure on your-domain.org</a><ul>
<li><a href="#complete-maincf-file-contents">Complete main.cf file contents</a></li>
<li><a href="#complete-relay-contents-of-mastercf">Complete relay contents of master.cf</a></li>
</ul>
</li>
<li><a href="#reload-config">Reload Config</a></li>
<li><a href="#definitions-of-master-fields">Definitions of master fields</a></li>
</ul>
</li>
<li><a href="#proxy-postfix-using-transport-maps-for-incoming-mails-on-your-domainorg">Proxy Postfix using Transport Maps for Incoming Mails on your-domain.org</a><ul>
<li><a href="#configure_1">Configure</a></li>
<li><a href="#transport-definitions">Transport Definitions</a></li>
<li><a href="#make-it-a-database">Make it a database</a></li>
<li><a href="#reload-config_1">Reload Config</a></li>
</ul>
</li>
<li><a href="#proxy-postfix-relay-for-smtp-outgoing-mails">Proxy Postfix Relay for SMTP Outgoing Mails</a><ul>
<li><a href="#change-mx-records-in-no-ipcom-from-mail1no-ipcom-to-mailyour-domainorg">Change MX records in no-ip.com from mail1.no-ip.com to mail.your-domain.org</a></li>
<li><a href="#change-txt-spf-record-in-no-ipcom-from-noip-to">Change TXT spf record in no-ip.com from noip, to:</a></li>
<li><a href="#change-your-domaincom-postfixmaincf-relay-to-your-domainorg">Change your-domain.com postfix/main.cf relay to your-domain.org</a></li>
<li><a href="#add-your-domainorg-unix-login-on-host-your-domaincom">Add your-domain.org unix login on host your-domain.com</a></li>
<li><a href="#enable-tls-on-your-domainorg">Enable TLS on your-domain.org</a><ul>
<li><a href="#or">OR</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clients-mail-user-agents-mua">Clients Mail User Agents (MUA)</a><ul>
<li><a href="#mua-connection-definitions">MUA Connection Definitions</a><ul>
<li><a href="#read-mail">Read Mail</a></li>
<li><a href="#send-mail">Send Mail</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#debug">Debug</a><ul>
<li><a href="#if-mail-queues-up-to-sendresend-you-can-check-and-clear-to-queue">If mail queues up to send/resend, you can check and clear to queue</a><ul>
<li><a href="#list-mail-queue">List mail queue</a></li>
<li><a href="#look-at-message">Look at message</a></li>
<li><a href="#flush-queue">Flush queue</a></li>
<li><a href="#or_1">or</a></li>
</ul>
</li>
<li><a href="#install-a-mail-user-agent-for-ssh">Install a Mail User Agent for ssh</a></li>
<li><a href="#install-a-nice-ssh-capable-log-reader">Install a nice ssh capable log reader</a></li>
<li><a href="#install-a-package-marking-tool">Install a package marking tool</a></li>
<li><a href="#certificate-expiration-check">Certificate Expiration Check</a></li>
</ul>
</li>
<li><a href="#configuring-spf-policy-agent">Configuring SPF Policy Agent</a><ul>
<li><a href="#install-required-packages">Install required packages:</a></li>
<li><a href="#test-spf">Test SPF</a></li>
<li><a href="#configure-spf">Configure SPF</a></li>
<li><a href="#restart-postfix">Restart Postfix.</a></li>
<li><a href="#debug-spf">Debug SPF</a></li>
<li><a href="#block-domains-and-e-mail-addresses-using-postfix-access">Block Domains and E-Mail Addresses using Postfix access</a></li>
</ul>
</li>
<li><a href="#setting-up-dkim">Setting up DKIM</a><ul>
<li><a href="#install-opendkim">Install OpenDKIM</a></li>
<li><a href="#configure-opendkim">Configure OpenDKIM</a><ul>
<li><a href="#map-domains-to-keys">Map Domains to Keys</a></li>
<li><a href="#hosts-to-ignore-when-verifying-signatures">Hosts to ignore when verifying signatures</a></li>
<li><a href="#a-set-of-internal-hosts-whose-mail-should-be-signed">A set of internal hosts whose mail should be signed</a></li>
</ul>
</li>
<li><a href="#create-signing-table-key-table-and-trusted-hosts-file">Create Signing Table, Key Table and Trusted Hosts File</a><ul>
<li><a href="#check-directory-structure-for-opendkim">Check directory structure for OpenDKIM</a></li>
<li><a href="#create-the-signing-table">Create the signing table</a></li>
<li><a href="#create-the-key-table">Create the key table</a></li>
<li><a href="#create-the-trusted-hosts-file">Create the trusted hosts file</a></li>
</ul>
</li>
<li><a href="#generate-privatepublic-keypair">Generate Private/Public Keypair</a><ul>
<li><a href="#create-a-separate-folder-for-the-domain">Create a separate folder for the domain.</a></li>
<li><a href="#generate-keys-using-opendkim-genkey-tool">Generate keys using opendkim-genkey tool.</a></li>
</ul>
</li>
<li><a href="#publish-your-public-key-in-dns-records">Publish Your Public Key in DNS Records</a></li>
<li><a href="#test-dkim-key">Test DKIM Key</a></li>
<li><a href="#connect-postfix-to-opendkim">Connect Postfix to OpenDKIM</a><ul>
<li><a href="#set-socket-to-local">Set Socket to local</a></li>
<li><a href="#add-opendkim-to-postfix-maincf">Add openDKIM to Postfix main.cf</a></li>
<li><a href="#restart-opendkim-and-postfix-service">Restart opendkim and postfix service</a></li>
</ul>
</li>
<li><a href="#spf-and-dkim-check">SPF and DKIM Check</a></li>
<li><a href="#postfix-cant-connect-to-opendkim">Postfix Can’t Connect to OpenDKIM</a></li>
<li><a href="#configuration-error-in-email-client">Configuration Error in Email Client</a><ul>
<li><a href="#wrong-settings">Wrong Settings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#testing-email-score-and-placement">Testing Email Score and Placement</a></li>
<li><a href="#what-is-dmarc">What is DMARC?</a><ul>
<li><a href="#create-dmarc-record">Create DMARC Record</a><ul>
<li><a href="#dmarc-record-txt">DMARC Record TXT</a></li>
</ul>
</li>
<li><a href="#dmarc-record-check">DMARC Record Check</a></li>
<li><a href="#dmarc-test-e-mail">DMARC Test E-Mail</a></li>
<li><a href="#interpret-a-dmarc-report">Interpret a DMARC Report</a></li>
</ul>
</li>
</ul>
</div>
<hr>
<h1 id="overview">Overview</h1>
<p>E-Mail Relay is a combination of:</p>
<ul>
<li>IP Address Reputation</li>
<li>DNS assignment of an E-Mail name to that IP Address</li>
<li>Certificates for Authentication and Encryption</li>
<li>Login protection against Open Spam Relays</li>
</ul>
<p>A VPS (Virtual Private Server) is a way to obtain a good IP address reputation, and it will stay the same number over time. There are many to choose from, some already have bad reputations and constant streams of hackers knocking on the network, while others have a good reputation and just a few random hackers on your doorstep. Choose wisely!</p>
<ul>
<li>MUA - Mail User Agent; Thunderbird, Evolution - Read, send, user interface</li>
<li>MDA - Mail Delivery Agent; Dovecot - File and organize mail, authorize user accounts</li>
<li>MTA - Mail Transport Agent; Postfix - Move messsages from one network stop to another</li>
</ul>
<h2 id="outgoing-relay-from-inside-home">Outgoing: Relay from Inside Home</h2>
<p><img alt="Send Mail from Home" src="/linux-in-house/images/graph-email-relay.svg"></p>
<h2 id="outgoing-relay-from-outside-home">Outgoing: Relay from Outside Home</h2>
<p><img alt="Send Mail outside Home" src="/linux-in-house/images/graph-email-relay2.svg"></p>
<h2 id="incoming-transport-from-internet">Incoming: Transport from Internet</h2>
<p><img alt="Recieve Mail" src="/linux-in-house/images/graph-email-relay3.svg"></p>
<p>This document will use:</p>
<ul>
<li>your-domain.org : The E-Mail <em>relay</em> we are setting up in this document (VPS_Postfix)</li>
<li>your-domain.com : The E-Mail <em>server</em> set up in the prior document (Home_Postfix)</li>
</ul>
<p>Recommendation:</p>
<ul>
<li>[ ] Bring up a host on a VPS somewhere, and use the <a href="/linux-in-house/setup-server.html">Setup Server</a> instructions to secure it.</li>
<li>[ ] Get a domain name and certificate set up and working.</li>
<li>[ ] Install postfix/dovecot combo and relay to your main E-Mail host. Test sending out mail too.</li>
<li>[ ] Install and configure SPF Policy Agent. Test it and make sure all is well.</li>
<li>[ ] Install and configure OpenDKIM to sign your E-Mails. Ensure it works good.</li>
</ul>
<h1 id="vps">VPS</h1>
<p>Create a VPS Cloud Server, less than $10 month for 1GB RAM, 30GB Disk, 1 CPU, 2TB Bandwidth month.</p>
<p>Criteria:</p>
<ol>
<li>IP address reputation. May have to test drive to determine IP address. Lookup tools:</li>
<li><a href="https://github.com/nitefood/asn">https://github.com/nitefood/asn</a></li>
<li><a href="https://www.ipqualityscore.com/ip-reputation-check">https://www.ipqualityscore.com/ip-reputation-check</a> </li>
<li>Working control panel. Check online reviews, or test drive. Make sure every button works. Extra points if they allow firewall changes and creating a PTR record.</li>
<li>Current OS release. Check references below.</li>
<li>Support availability and response agreements. Test creating a support ticket. Check references below.</li>
<li>
<p>Low cost, check references below.</p>
</li>
<li>
<p><a href="https://cloud.ionos.com/servers/vps#packages">https://cloud.ionos.com/servers/vps#packages</a></p>
</li>
<li><a href="https://www.hostwinds.com/vps/unmanaged-linux">https://www.hostwinds.com/vps/unmanaged-linux</a></li>
<li><a href="https://www.inmotionhosting.com/cloud-vps">https://www.inmotionhosting.com/cloud-vps</a></li>
<li><a href="https://www.kamatera.com/Products/201/Cloud_Servers">https://www.kamatera.com/Products/201/Cloud_Servers</a></li>
</ol>
<h1 id="secure-vps-on-your-domainorg">Secure VPS on <em>your-domain.org</em></h1>
<blockquote>
<p>Change your root password <em>IMMEDIATELY</em>. Hackers know the algorithm and expliot it from creation time to change time.</p>
<p>Change the ssh port from 22 (File: /etc/ssh/sshd_config). Hackers know that port and constantly attack it.</p>
</blockquote>
<h2 id="check-network">Check Network</h2>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#check-your-network">Network Check</a></p>
<h2 id="update-package-repository">Update Package Repository</h2>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#update-package-repository">Update Packages</a></p>
<h2 id="create-new-users">Create New User(s)</h2>
<blockquote>
<p>The Linux mail user can be \&lt;name&gt;@example.com, to keep things clear.</p>
</blockquote>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#new-user-and-group-to-use">New Users</a></p>
<h2 id="set-host-and-domain">Set Host and Domain</h2>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#set-your-host-and-domain-names">Host and Domain</a></p>
<h2 id="set-date-and-time">Set Date and Time</h2>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#time-control">Date and Time Settings</a></p>
<h2 id="monitor-crack-attempts">Monitor crack attempts</h2>
<h3 id="install-firewall-and-fail2ban-on-your-domainorg">Install firewall and fail2ban on <em>your-domain.org</em></h3>
<p>Be sure the <em>system firewall</em> is installed and also the "Block Bad Actors" <em>firewall.sh</em> script.</p>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#firewall">Firewall</a></p>
<h4 id="add-rules-for-e-mail-smtp-and-smtps">Add rules for E-Mail smtp and smtps.</h4>
<ul>
<li>Debian:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>fail2ban<span class="w"> </span>mailutils
</code></pre></div>

<ul>
<li>RedHat:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>fail2ban<span class="w"> </span>mailx
</code></pre></div>

<p>Make sure firewall rules open port smtp(25) and smtps(465):</p>
<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>ufw<span class="w"> </span>allow<span class="w"> </span><span class="m">25</span>
$<span class="w"> </span>sudo<span class="w"> </span>ufw<span class="w"> </span>allow<span class="w"> </span><span class="m">465</span>
$<span class="w"> </span>sudo<span class="w"> </span>ufw<span class="w"> </span>status<span class="w"> </span>numbered

<span class="w">     </span>To<span class="w">                         </span>Action<span class="w">      </span>From
<span class="w">     </span>--<span class="w">                         </span>------<span class="w">      </span>----
<span class="o">[</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">22</span><span class="w">                         </span>ALLOW<span class="w"> </span>IN<span class="w">    </span>Anywhere<span class="w">                  </span>
<span class="o">[</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="m">25</span><span class="w">                         </span>ALLOW<span class="w"> </span>IN<span class="w">    </span>Anywhere<span class="w">                  </span>
<span class="o">[</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="m">465</span><span class="w">                        </span>ALLOW<span class="w"> </span>IN<span class="w">    </span>Anywhere<span class="w">                  </span>
<span class="o">[</span><span class="w"> </span><span class="m">4</span><span class="o">]</span><span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="o">(</span>v6<span class="o">)</span><span class="w">                    </span>ALLOW<span class="w"> </span>IN<span class="w">    </span>Anywhere<span class="w"> </span><span class="o">(</span>v6<span class="o">)</span><span class="w">             </span>
<span class="o">[</span><span class="w"> </span><span class="m">5</span><span class="o">]</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="o">(</span>v6<span class="o">)</span><span class="w">                    </span>ALLOW<span class="w"> </span>IN<span class="w">    </span>Anywhere<span class="w"> </span><span class="o">(</span>v6<span class="o">)</span><span class="w">  </span>
</code></pre></div>

<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">smtp</span>
<span class="w"> </span><span class="n">success</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">smtps</span>
<span class="w"> </span><span class="n">success</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">list</span><span class="o">-</span><span class="n">services</span>
<span class="w">  </span><span class="n">smtp</span><span class="w"> </span><span class="n">smtps</span><span class="w"> </span><span class="n">ssh</span>
<span class="o">$</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">runtime</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">permanent</span>
<span class="w"> </span><span class="n">success</span>
<span class="o">$</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">reload</span>
<span class="w"> </span><span class="n">success</span>
</code></pre></div>

<h4 id="configure-fail2ban">Configure fail2ban</h4>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>
<ul>
<li><a href="/linux-in-house/setup-server.html#fail2ban-automatic-firewall-blocking">Fail2ban</a></li>
</ul>
<h5 id="secure-postfix">Secure postfix</h5>
<p>File: /etc/fail2ban/jail.d/postfix.local</p>
<div class="highlight"><pre><span></span><code><span class="k">[postfix]</span>
<span class="na">enabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">maxretry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3</span>
<span class="na">bantime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1d</span>
<span class="na">port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s">smtp,465,submission</span>

<span class="k">[postfix-sasl]</span>
<span class="na">enabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">maxretry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3</span>
<span class="na">bantime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1d</span>
<span class="na">port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s">smtp,465,submission,imap,imaps,pop3,pop3s</span>
</code></pre></div>

<p>File: /etc/fail2ban/jail.d/dovecot.local</p>
<div class="highlight"><pre><span></span><code><span class="k">[dovecot]</span>
<span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">port</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s">pop3,pop3s,imap,imaps,submission,465,sieve</span>
<span class="na">logpath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/var/log/maillog</span>
<span class="na">findtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1200</span>
<span class="na">bantime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1d</span>
</code></pre></div>

<h5 id="secure-ssh">Secure ssh</h5>
<p>File: /etc/fail2ban/jail.d/sshd.local</p>
<div class="highlight"><pre><span></span><code><span class="k">[sshd]</span>
<span class="na">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">XXXX</span>
<span class="na">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">maxretry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3</span>
<span class="na">bantime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1d</span>
</code></pre></div>

<h3 id="log-monitors-on-your-domainorg">Log Monitors  on <em>your-domain.org</em></h3>
<h4 id="install-logwatch">Install Logwatch</h4>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#logwatch-daily-alert-of-logging-activity">Logwatch</a></p>
<h4 id="install-logcheck">Install Logcheck:</h4>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:
 * <a href="/linux-in-house/setup-server.html#logcheck-mails-anomalies-in-the-system-logfiles-to-the-admin">Logcheck</a></p>
<h3 id="logwatcher">LogWatcher</h3>
<h4 id="create">Create</h4>
<p>Put this script in the /root directory, and install the dependencies listed.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1"># File: logwatcher.sh</span>
<span class="c1">#</span>
<span class="c1"># Purpose: Watch for interesting new things in log files and e-mail them</span>
<span class="c1">#</span>
<span class="c1"># Dependencies: </span>
<span class="c1">#  * Debian:</span>
<span class="c1">#   apt-get install git clang zlib1g-dev</span>
<span class="c1">#  * RedHat:</span>
<span class="c1">#   dnf install git clang zlib-devel </span>
<span class="c1">#</span>
<span class="c1">#   git clone https://github.com/mbucc/retail</span>
<span class="c1">#</span>
<span class="c1"># Author     Date     Description</span>
<span class="c1"># ---------- -------- --------------------------------------------------------</span>
<span class="c1"># D. Cohoon  Feb-2023 Created</span>
<span class="c1">##############################################################################</span>
<span class="nv">MAILTO</span><span class="o">=</span>root
<span class="nv">DIR</span><span class="o">=</span>/root
<span class="nv">OS</span><span class="o">=</span><span class="k">$(</span>/usr/bin/hostnamectl<span class="p">|</span>/usr/bin/grep<span class="w"> </span><span class="s1">&#39;Operating System&#39;</span><span class="p">|</span>/usr/bin/cut<span class="w"> </span>-d:<span class="w"> </span>-f2<span class="p">|</span>/usr/bin/awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>
<span class="c1">#--------------</span>
log_check<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="nv">OFFSET</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
<span class="w">  </span><span class="nv">LOGFILE</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span>
<span class="w">  </span><span class="nv">FILTER</span><span class="o">=</span><span class="si">${</span><span class="nv">3</span><span class="si">}</span>
<span class="w">  </span><span class="nv">OUTPUT</span><span class="o">=</span><span class="k">$(</span>/usr/bin/mktemp<span class="k">)</span>
<span class="w">  </span>/root/retail/retail<span class="w"> </span>-o<span class="w"> </span><span class="si">${</span><span class="nv">OFFSET</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">LOGFILE</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="si">${</span><span class="nv">FILTER</span><span class="si">}</span><span class="w"> </span>&gt;<span class="si">${</span><span class="nv">OUTPUT</span><span class="si">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-s<span class="w"> </span><span class="si">${</span><span class="nv">OUTPUT</span><span class="si">}</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>/bin/cat<span class="w"> </span><span class="si">${</span><span class="nv">OUTPUT</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>/usr/bin/mail<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;Logwatcher.sh: </span><span class="si">${</span><span class="nv">OFFSET</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">MAILTO</span><span class="si">}</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="w">  </span><span class="k">fi</span>
<span class="w">  </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="si">${</span><span class="nv">OUTPUT</span><span class="si">}</span>
<span class="o">}</span>
<span class="c1">#</span>
<span class="c1">#--------------</span>
<span class="k">case</span><span class="w"> </span><span class="si">${</span><span class="nv">OS</span><span class="si">}</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>AlmaLinux<span class="o">)</span><span class="w"> </span>
<span class="w">        </span><span class="nv">FAIL2BAN_LOG</span><span class="o">=</span>/var/log/fail2ban.log
<span class="w">        </span><span class="nv">POSTFIX_LOG</span><span class="o">=</span>/var/log/maillog
<span class="w">        </span><span class="nv">AUTH_LOG</span><span class="o">=</span>/var/log/secure<span class="w"> </span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">    </span>Ubuntu<span class="p">|</span>Debian<span class="o">)</span><span class="w"> </span>
<span class="w">        </span><span class="nv">FAIL2BAN_LOG</span><span class="o">=</span>/var/log/fail2ban.log
<span class="w">        </span><span class="nv">POSTFIX_LOG</span><span class="o">=</span>/var/log/syslog
<span class="w">        </span><span class="nv">AUTH_LOG</span><span class="o">=</span>/var/log/auth.log
<span class="w">        </span><span class="p">;;</span>
<span class="k">esac</span>
<span class="c1">#           Offset  Log File               Filter</span>
<span class="c1">#          -------- ---------------------  -------------------------</span>
log_check<span class="w"> </span>.fail2ban<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">FAIL2BAN_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">      </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/filter_fail2ban.sh
<span class="c1">#</span>
log_check<span class="w"> </span>.postfix<span class="w">  </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">POSTFIX_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">       </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/filter_postfix.sh
<span class="c1">#</span>
log_check<span class="w"> </span>.sshd<span class="w">     </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AUTH_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">          </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/filter_ssh.sh
<span class="c1">#</span>
log_check<span class="w"> </span>.dovecot<span class="w">  </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">AUTH_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">          </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/filter_dovecot.sh
</code></pre></div>

<h4 id="schedule">Schedule</h4>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">logwatcher</span><span class="w"> </span>
<span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="nl">logwatcher</span><span class="p">:</span><span class="w"> </span><span class="n">crontab</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">logwatcher</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="n">script</span>

<span class="k">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span>
<span class="n">MAILTO</span><span class="o">=</span><span class="n">root</span>

<span class="nv">@reboot</span><span class="w">         </span><span class="n">root</span><span class="w">   </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">logwatcher</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span>
<span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w">       </span><span class="n">root</span><span class="w">   </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">logwatcher</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span>

<span class="err">#</span><span class="w"> </span><span class="n">EOF</span>
</code></pre></div>

<h4 id="filters">Filters</h4>
<p>File: filter_fail2ban.sh</p>
<div class="highlight"><pre><span></span><code>/usr/bin/grep &quot;Ban&quot;
</code></pre></div>

<p>File: filter_postfix.sh</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">grep</span><span class="w"> </span><span class="s2">&quot;postfix&quot;</span><span class="o">|/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">grep</span><span class="w"> </span><span class="s1">&#39;disconnect from unknown&#39;</span>
</code></pre></div>

<p>File: filter_ssh.sh</p>
<div class="highlight"><pre><span></span><code>/usr/bin/grep &quot;ssh&quot; | /usr/bin/egrep &quot;Failed|invalid format&quot;
</code></pre></div>

<p>File: filter_dovecot.sh</p>
<div class="highlight"><pre><span></span><code>/usr/bin/grep &quot;dovecot&quot; | /usr/bin/grep &quot;authentication failure&quot;
</code></pre></div>

<h4 id="make-the-scripts-executable">Make the Scripts Executable</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>*.sh
</code></pre></div>

<p>Reference:</p>
<ul>
<li>Watch - <a href="/linux-in-house/watch.html">System Alerts</a></li>
</ul>
<h1 id="apache-install-enable-on-your-domainorg">Apache install (enable) on <em>your-domain.org</em></h1>
<p>Click on this heading, then refer to these instructions, then come back here with the Back Arrow on the Browser:</p>
<p><a href="/linux-in-house/dns.html#install-a-web-server">Apache Web Server</a></p>
<p>Test it on:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>curl<span class="w"> </span>http://&lt;domain.name&gt;
</code></pre></div>

<h2 id="add-ssl">Add SSL</h2>
<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>ufw<span class="w"> </span>allow<span class="w"> </span><span class="m">443</span>/tcp
</code></pre></div>

<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">https</span>
<span class="w">  </span><span class="n">success</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">list</span><span class="o">-</span><span class="n">services</span>
<span class="w">  </span><span class="n">http</span><span class="w"> </span><span class="n">https</span><span class="w"> </span><span class="n">smtp</span><span class="w"> </span><span class="n">smtps</span><span class="w"> </span><span class="n">ssh</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">runtime</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">permanent</span>
<span class="w">  </span><span class="n">success</span>
<span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">reload</span>
<span class="w">  </span><span class="n">success</span>
</code></pre></div>

<p>Change the default landing page to blank</p>
<p>File: /var/www/html/index.html </p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;main_page&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<h1 id="dns-registrar-your-domainorg">DNS Registrar (your-domain.org)</h1>
<p>Register your own name. </p>
<ul>
<li><a href="https://godaddy.com">https://godaddy.com</a></li>
<li><a href="https://www.namecheap.com/">https://www.namecheap.com/</a></li>
<li><a href="https://www.domain.com/">https://www.domain.com/</a></li>
</ul>
<h3 id="dns-updates">DNS Updates</h3>
<p>Create Advanced DNS records, using IP Address of VPS server:</p>
<p>HOST</p>
<div class="highlight"><pre><span></span><code>Type       Host        Value               TTL
---------- ----------- ------------------- ----
A Record   @           &lt;IP Address&gt;        Auto
A Record   mail        &lt;IP Address&gt;        Auto
TXT Record @           v=spf1 mx -all      Auto
</code></pre></div>

<p>MAIL</p>
<div class="highlight"><pre><span></span><code>Type       Host        Value               Priority TTL
---------- ----------- ------------------- -------- ----
MX Record  @           &lt;Domain Name&gt;       10       Auto
</code></pre></div>

<p>Lookup status via <code>dig -t &lt;Type&gt; &lt;Domain&gt;</code></p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dig<span class="w"> </span>-t<span class="w"> </span>a<span class="w"> </span>+short<span class="w"> </span>&lt;Domain<span class="w"> </span>Name&gt;
<span class="m">123</span>.123.123.123
$<span class="w"> </span>dig<span class="w"> </span>-t<span class="w"> </span>mx<span class="w"> </span>+short<span class="w"> </span>&lt;Domain<span class="w"> </span>Name&gt;
<span class="m">10</span><span class="w"> </span>&lt;Domain<span class="w"> </span>Name&gt;.
</code></pre></div>

<blockquote>
<p>To install dig:
<code>$ sudo apt-get install dnsutils</code>
<code>$ sudo dnf install bind-utils</code></p>
</blockquote>
<h4 id="create-ptr-record">Create PTR Record</h4>
<p>Using the Control Panel on the VPS, update the PTR record. If they do not allow this, create a support ticket, they will do it then, just trying to limit spammers.</p>
<p>Test your PTR record. Using the IP Address, it should show your domain, proving you have control over the IP Address.</p>
<div class="highlight"><pre><span></span><code><span class="nx">dig</span><span class="w"> </span><span class="o">-</span><span class="nx">x</span><span class="w"> </span><span class="m m-Double">1.2.3.4</span>
<span class="p">;;</span><span class="w"> </span><span class="nx">ANSWER</span><span class="w"> </span><span class="nx">SECTION</span><span class="p">:</span>
<span class="m m-Double">1.2.3.4</span><span class="p">.</span><span class="k">in</span><span class="o">-</span><span class="kd">addr</span><span class="p">.</span><span class="nx">arpa</span><span class="p">.</span><span class="w"> </span><span class="mi">86400</span><span class="w"> </span><span class="nx">IN</span><span class="w">  </span><span class="nx">PTR</span><span class="w"> </span><span class="nx">mail</span><span class="p">.&lt;</span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Name</span><span class="p">&gt;.</span>
</code></pre></div>

<h1 id="certbot-certificate-management-for-lets-encrypt">certbot - Certificate Management for Let's Encrypt</h1>
<p>To create and maintain LetsEncrypt certificates using Apache web server</p>
<h3 id="install">Install</h3>
<ul>
<li>The Debian Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>unmask<span class="w"> </span>apache2
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>apache2
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>apache2
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>certbot
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>python3-certbot-apache
</code></pre></div>

</div>
<ul>
<li>The RedHat Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>unmask<span class="w"> </span>httpd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>httpd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>httpd
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>certbot
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>python3-certbot-apache
</code></pre></div>

</div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>certbot<span class="w">  </span>plugins

Saving<span class="w"> </span>debug<span class="w"> </span>log<span class="w"> </span>to<span class="w"> </span>/var/log/letsencrypt/letsencrypt.log

-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
*<span class="w"> </span>apache
Description:<span class="w"> </span>Apache<span class="w"> </span>Web<span class="w"> </span>Server<span class="w"> </span>plugin
Interfaces:<span class="w"> </span>IAuthenticator,<span class="w"> </span>IInstaller,<span class="w"> </span>IPlugin
Entry<span class="w"> </span>point:<span class="w"> </span><span class="nv">apache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>certbot_apache._internal.entrypoint:ENTRYPOINT

*<span class="w"> </span>standalone
Description:<span class="w"> </span>Spin<span class="w"> </span>up<span class="w"> </span>a<span class="w"> </span>temporary<span class="w"> </span>webserver
Interfaces:<span class="w"> </span>IAuthenticator,<span class="w"> </span>IPlugin
Entry<span class="w"> </span>point:<span class="w"> </span><span class="nv">standalone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>certbot._internal.plugins.standalone:Authenticator

*<span class="w"> </span>webroot
Description:<span class="w"> </span>Place<span class="w"> </span>files<span class="w"> </span><span class="k">in</span><span class="w"> </span>webroot<span class="w"> </span>directory
Interfaces:<span class="w"> </span>IAuthenticator,<span class="w"> </span>IPlugin
Entry<span class="w"> </span>point:<span class="w"> </span><span class="nv">webroot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>certbot._internal.plugins.webroot:Authenticator
-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
</code></pre></div>

<h3 id="configure">Configure</h3>
<blockquote>
<p>Be sure to get certificates for the <em>domain</em> and <em>all subdomains</em> (hosts)</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>certbot<span class="w">  </span>--apache<span class="w"> </span>-d<span class="w"> </span>your-domain.org<span class="w"> </span>-d<span class="w"> </span>mail.your-domain.org
Saving<span class="w"> </span>debug<span class="w"> </span>log<span class="w"> </span>to<span class="w"> </span>/var/log/letsencrypt/letsencrypt.log
Plugins<span class="w"> </span>selected:<span class="w"> </span>Authenticator<span class="w"> </span>apache,<span class="w"> </span>Installer<span class="w"> </span>apache
Enter<span class="w"> </span>email<span class="w"> </span>address<span class="w"> </span><span class="o">(</span>used<span class="w"> </span><span class="k">for</span><span class="w"> </span>urgent<span class="w"> </span>renewal<span class="w"> </span>and<span class="w"> </span>security<span class="w"> </span>notices<span class="o">)</span>
<span class="w"> </span><span class="o">(</span>Enter<span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="w"> </span>to<span class="w"> </span>cancel<span class="o">)</span>:<span class="w"> </span>you@your-domain.org

-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
Please<span class="w"> </span><span class="nb">read</span><span class="w"> </span>the<span class="w"> </span>Terms<span class="w"> </span>of<span class="w"> </span>Service<span class="w"> </span>at
https://letsencrypt.org/documents/LE-SA-v1.3-September-21-2022.pdf.<span class="w"> </span>You<span class="w"> </span>must
agree<span class="w"> </span><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>register<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>ACME<span class="w"> </span>server.<span class="w"> </span>Do<span class="w"> </span>you<span class="w"> </span>agree?
-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
<span class="o">(</span>Y<span class="o">)</span>es/<span class="o">(</span>N<span class="o">)</span>o:<span class="w"> </span>y

-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
Would<span class="w"> </span>you<span class="w"> </span>be<span class="w"> </span>willing,<span class="w"> </span>once<span class="w"> </span>your<span class="w"> </span>first<span class="w"> </span>certificate<span class="w"> </span>is<span class="w"> </span>successfully<span class="w"> </span>issued,<span class="w"> </span>to
share<span class="w"> </span>your<span class="w"> </span>email<span class="w"> </span>address<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>Electronic<span class="w"> </span>Frontier<span class="w"> </span>Foundation,<span class="w"> </span>a<span class="w"> </span>founding
partner<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>Let<span class="s1">&#39;s Encrypt project and the non-profit organization that</span>
<span class="s1">develops Certbot? We&#39;</span>d<span class="w"> </span>like<span class="w"> </span>to<span class="w"> </span>send<span class="w"> </span>you<span class="w"> </span>email<span class="w"> </span>about<span class="w"> </span>our<span class="w"> </span>work<span class="w"> </span>encrypting<span class="w"> </span>the<span class="w"> </span>web,
EFF<span class="w"> </span>news,<span class="w"> </span>campaigns,<span class="w"> </span>and<span class="w"> </span>ways<span class="w"> </span>to<span class="w"> </span>support<span class="w"> </span>digital<span class="w"> </span>freedom.
-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
<span class="o">(</span>Y<span class="o">)</span>es/<span class="o">(</span>N<span class="o">)</span>o:<span class="w"> </span>y
Account<span class="w"> </span>registered.
No<span class="w"> </span>names<span class="w"> </span>were<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span>your<span class="w"> </span>configuration<span class="w"> </span>files.<span class="w"> </span>Please<span class="w"> </span>enter<span class="w"> </span><span class="k">in</span><span class="w"> </span>your<span class="w"> </span>domain
name<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="o">(</span>comma<span class="w"> </span>and/or<span class="w"> </span>space<span class="w"> </span>separated<span class="o">)</span><span class="w">  </span><span class="o">(</span>Enter<span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="w"> </span>to<span class="w"> </span>cancel<span class="o">)</span>:<span class="w"> </span>your-domain.org
Requesting<span class="w"> </span>a<span class="w"> </span>certificate<span class="w"> </span><span class="k">for</span><span class="w"> </span>your-domain.org
Performing<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>challenges:
http-01<span class="w"> </span>challenge<span class="w"> </span><span class="k">for</span><span class="w"> </span>your-domain.org
Enabled<span class="w"> </span>Apache<span class="w"> </span>rewrite<span class="w"> </span>module
Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>verification...
Cleaning<span class="w"> </span>up<span class="w"> </span>challenges
Created<span class="w"> </span>an<span class="w"> </span>SSL<span class="w"> </span>vhost<span class="w"> </span>at<span class="w"> </span>/etc/apache2/sites-available/000-default-le-ssl.conf
Enabled<span class="w"> </span>Apache<span class="w"> </span>socache_shmcb<span class="w"> </span>module
Enabled<span class="w"> </span>Apache<span class="w"> </span>ssl<span class="w"> </span>module
Deploying<span class="w"> </span>Certificate<span class="w"> </span>to<span class="w"> </span>VirtualHost<span class="w"> </span>/etc/apache2/sites-available/000-default-le-ssl.conf
Enabling<span class="w"> </span>available<span class="w"> </span>site:<span class="w"> </span>/etc/apache2/sites-available/000-default-le-ssl.conf
Enabled<span class="w"> </span>Apache<span class="w"> </span>rewrite<span class="w"> </span>module
Redirecting<span class="w"> </span>vhost<span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/apache2/sites-enabled/000-default.conf<span class="w"> </span>to<span class="w"> </span>ssl<span class="w"> </span>vhost<span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/apache2/sites-available/000-default-le-ssl.conf

-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
Congratulations!<span class="w"> </span>You<span class="w"> </span>have<span class="w"> </span>successfully<span class="w"> </span>enabled<span class="w"> </span>https://your-domain.org
-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-<span class="w"> </span>-
Subscribe<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>EFF<span class="w"> </span>mailing<span class="w"> </span>list<span class="w"> </span><span class="o">(</span>email:<span class="w"> </span>you@your-domain.org<span class="o">)</span>.

IMPORTANT<span class="w"> </span>NOTES:
<span class="w"> </span>-<span class="w"> </span>Congratulations!<span class="w"> </span>Your<span class="w"> </span>certificate<span class="w"> </span>and<span class="w"> </span>chain<span class="w"> </span>have<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span>at:
<span class="w">   </span>/etc/letsencrypt/live/your-domain.org/fullchain.pem
<span class="w">   </span>Your<span class="w"> </span>key<span class="w"> </span>file<span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span>at:
<span class="w">   </span>/etc/letsencrypt/live/your-domain.org/privkey.pem
<span class="w">   </span>Your<span class="w"> </span>certificate<span class="w"> </span>will<span class="w"> </span>expire<span class="w"> </span>on<span class="w"> </span><span class="m">2023</span>-05-08.<span class="w"> </span>To<span class="w"> </span>obtain<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>or
<span class="w">   </span>tweaked<span class="w"> </span>version<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>certificate<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>future,<span class="w"> </span>simply<span class="w"> </span>run
<span class="w">   </span>certbot<span class="w"> </span>again<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span><span class="s2">&quot;certonly&quot;</span><span class="w"> </span>option.<span class="w"> </span>To<span class="w"> </span>non-interactively
<span class="w">   </span>renew<span class="w"> </span>*all*<span class="w"> </span>of<span class="w"> </span>your<span class="w"> </span>certificates,<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;certbot renew&quot;</span>
<span class="w"> </span>-<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>like<span class="w"> </span>Certbot,<span class="w"> </span>please<span class="w"> </span>consider<span class="w"> </span>supporting<span class="w"> </span>our<span class="w"> </span>work<span class="w"> </span>by:

<span class="w">   </span>Donating<span class="w"> </span>to<span class="w"> </span>ISRG<span class="w"> </span>/<span class="w"> </span>Let<span class="err">&#39;</span>s<span class="w"> </span>Encrypt:<span class="w">   </span>https://letsencrypt.org/donate
<span class="w">   </span>Donating<span class="w"> </span>to<span class="w"> </span>EFF:<span class="w">                    </span>https://eff.org/donate-le
</code></pre></div>

<h1 id="apache-disable">Apache (disable)</h1>
<p>Apache is not needed, so disable it to reduce threat footprint. </p>
<ul>
<li>The Debian Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>apache2
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>apache2
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>mask<span class="w"> </span>apache2
$<span class="w"> </span>sudo<span class="w"> </span>ufw<span class="w"> </span>status<span class="w"> </span>numbered
<span class="c1"># -&gt; ufw delete &lt;n&gt; for ports 80 &amp; 443</span>
</code></pre></div>

</div>
<ul>
<li>The RedHat Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>httpd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>httpd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>mask<span class="w"> </span>httpd
$<span class="w"> </span>sudo<span class="w">  </span>firewall-cmd<span class="w"> </span>--remove-service<span class="o">=</span>https
<span class="w">  </span>success
$<span class="w"> </span>sudo<span class="w"> </span>firewall-cmd<span class="w"> </span>--list-services
<span class="w">  </span>http<span class="w"> </span>smtp<span class="w"> </span>smtps<span class="w"> </span>ssh
$<span class="w"> </span>sudo<span class="w">  </span>firewall-cmd<span class="w"> </span>--remove-service<span class="o">=</span>http
<span class="w">  </span>success
$<span class="w"> </span>sudo<span class="w"> </span>firewall-cmd<span class="w"> </span>--list-services
<span class="w">  </span>smtp<span class="w"> </span>smtps<span class="w"> </span>ssh
$<span class="w"> </span>sudo<span class="w"> </span>firewall-cmd<span class="w"> </span>--runtime-to-permanent
<span class="w">  </span>success
</code></pre></div>

</div>
<p>When the Let's Encrypt Certificate expires, you will need to enable it again and open up ports.</p>
<h1 id="postfix-e-mail-transport-agent">postfix - E-Mail Transport Agent</h1>
<p>Install postfix MTA and remove exim4, if it is installed. Postfix is more mature and full-featured.</p>
<p>TLS <a href="http://www.postfix.org/TLS_README.html">http://www.postfix.org/TLS_README.html</a></p>
<h3 id="install-on-your-domainorg">Install on <em>your-domain.org</em></h3>
<ul>
<li>The Debian Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>remove<span class="w"> </span>exim4-base
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>postfix
</code></pre></div>

</div>
<ul>
<li>The RedHat Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>remove<span class="w"> </span>exim
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>postfix
</code></pre></div>

</div>
<h3 id="configure-on-your-domainorg">Configure on <em>your-domain.org</em></h3>
<blockquote>
<ul>
<li>smtp  -&gt; outgoing mail </li>
<li>smtpd &lt;- incoming mail (daemon)</li>
</ul>
</blockquote>
<h4 id="complete-maincf-file-contents">Complete main.cf file contents</h4>
<!-- TOGGLE BUTTON -->
<div><label for="checkRedHat-31" class="togButton">Change for RedHat in main.cf</label></div>
<!-- CONTENT -->
<p><input type="checkbox" class="togCheckRedHat" id="checkRedHat-31"/></p>
<div class="togContentRedHat">


<div class="highlight"><pre><span></span><code>~
mydomain = your-domain.org
myorigin = $mydomain
#myorigin = /etc/mailname
~
</code></pre></div>


</div>
<p>Also in RedHat: Log is in /var/log/maillog</p>
<p>File main.cf</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="o">........................................................................</span><span class="p">.</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">smtpd</span><span class="w"> </span><span class="p">&lt;</span><span class="o">-</span><span class="w"> </span><span class="nx">incoming</span><span class="w"> </span><span class="nx">mail</span><span class="w"> </span><span class="p">(</span><span class="nx">daemon</span><span class="p">)</span>
<span class="err">#</span>
<span class="nx">smtpd_tls_cert_file</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">letsencrypt</span><span class="o">/</span><span class="nx">live</span><span class="o">/</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">fullchain</span><span class="p">.</span><span class="nx">pem</span>
<span class="nx">smtpd_tls_key_file</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">letsencrypt</span><span class="o">/</span><span class="nx">live</span><span class="o">/</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">privkey</span><span class="p">.</span><span class="nx">pem</span>
<span class="nx">smtpd_use_tls</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtpd_tls_security_level</span><span class="p">=</span><span class="nx">may</span>
<span class="nx">smtpd_tls_auth_only</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>
<span class="nx">smtpd_tls_loglevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="nx">smtpd_tls_session_cache_database</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">btree</span><span class="p">:</span><span class="err">$</span><span class="p">{</span><span class="nx">data_directory</span><span class="p">}</span><span class="o">/</span><span class="nx">smtpd_scache</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nx">Enforce</span><span class="w"> </span><span class="nx">TLSv1</span><span class="m m-Double">.3</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">TLSv1</span><span class="m m-Double">.2</span>
<span class="err">#</span><span class="w">  </span><span class="nx">smtpd_tls_mandatory_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv2</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv3</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="m m-Double">.1</span>
<span class="err">#</span><span class="w">  </span><span class="nx">smtpd_tls_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv2</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv3</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="m m-Double">.1</span>
<span class="err">#</span><span class="w">  </span><span class="nx">smtp_tls_mandatory_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv2</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv3</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="m m-Double">.1</span>
<span class="err">#</span><span class="w">  </span><span class="nx">smtp_tls_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv2</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">SSLv3</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="p">,</span><span class="w"> </span><span class="p">!</span><span class="nx">TLSv1</span><span class="m m-Double">.1</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nx">Sending</span><span class="w"> </span><span class="nx">relays</span><span class="w"> </span><span class="nx">allowed</span><span class="w"> </span><span class="nx">only</span><span class="w"> </span><span class="k">if</span><span class="p">:</span>
<span class="err">#</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">mynetworks</span>
<span class="err">#</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">logged</span><span class="w"> </span><span class="k">in</span>
<span class="err">#</span><span class="w">  </span><span class="nx">all</span><span class="w"> </span><span class="nx">others</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">deferred</span><span class="w"> </span><span class="p">(</span><span class="nx">temp</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span><span class="w"> </span>
<span class="err">#</span><span class="w">   </span><span class="k">like</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">permanent</span><span class="w"> </span><span class="nx">failure</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">won</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">go</span><span class="w"> </span><span class="nx">away</span>
<span class="err">#</span><span class="w">   </span><span class="nx">until</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="nx">added</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">mynetworks</span><span class="p">,</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="nx">sasl</span><span class="w"> </span><span class="nx">authenticated</span>
<span class="nx">smtpd_relay_restrictions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">permit_mynetworks</span><span class="w"> </span><span class="nx">permit_sasl_authenticated</span><span class="w"> </span><span class="nx">defer_unauth_destination</span>

<span class="err">#</span><span class="w"> </span><span class="nx">Sending</span><span class="w"> </span><span class="nx">sasl</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">Dovecot</span>
<span class="nx">smtpd_sasl_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dovecot</span>
<span class="nx">smtpd_sasl_path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">private</span><span class="o">/</span><span class="nx">auth</span>
<span class="nx">smtpd_sasl_auth_enable</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">yes</span>

<span class="err">#</span><span class="w"> </span><span class="nx">I</span><span class="w"> </span><span class="nx">am</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">relay</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">world</span>
<span class="nx">relayhost</span><span class="w"> </span><span class="p">=</span><span class="w"> </span>

<span class="err">#</span><span class="o">........................................................................</span><span class="p">.</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">smtp</span><span class="w">  </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">outgoing</span><span class="w"> </span><span class="nx">mail</span><span class="w"> </span>
<span class="err">#</span>
<span class="nx">smtp_tls_CApath</span><span class="p">=</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">ssl</span><span class="o">/</span><span class="nx">certs</span>
<span class="nx">smtp_tls_security_level</span><span class="p">=</span><span class="nx">may</span>
<span class="nx">smtp_tls_loglevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="nx">smtp_tls_session_cache_database</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">btree</span><span class="p">:</span><span class="err">$</span><span class="p">{</span><span class="nx">data_directory</span><span class="p">}</span><span class="o">/</span><span class="nx">smtp_scache</span>

<span class="err">#</span><span class="w"> </span><span class="nx">Receiving</span><span class="w"> </span><span class="nx">transport</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="nx">specifies</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">mapping</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span>
<span class="err">#</span><span class="w">  </span><span class="nx">message</span><span class="w"> </span><span class="nx">delivery</span><span class="w">  </span><span class="nx">transports</span><span class="w">  </span><span class="k">and</span><span class="w">  </span><span class="nx">next</span><span class="o">-</span><span class="nx">hop</span><span class="w">  </span><span class="nx">destinations</span><span class="p">.</span><span class="w"> </span>
<span class="err">#</span><span class="w"> </span><span class="p">(</span><span class="nx">relay</span><span class="w"> </span><span class="nx">forwarding</span><span class="w"> </span><span class="nx">back</span><span class="w"> </span><span class="nx">out</span><span class="p">)</span>
<span class="nx">transport_maps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">transport</span>
<span class="nx">relay_domains</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">com</span>

<span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="nx">org</span><span class="w"> </span><span class="nx">host</span>
<span class="nx">myhostname</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span>
<span class="nx">alias_maps</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">aliases</span>
<span class="nx">alias_database</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hash</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">aliases</span>
<span class="nx">myorigin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">mailname</span>

<span class="err">#</span><span class="w"> </span><span class="nx">Accept</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="nx">destination</span><span class="w"> </span><span class="nx">mail</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">locals</span>
<span class="nx">mydestination</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">$</span><span class="nx">myhostname</span><span class="p">,</span><span class="w"> </span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">localhost</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">localhost</span>
<span class="err">#</span><span class="o">........................................................................</span><span class="p">.</span>

<span class="err">#</span><span class="w"> </span><span class="nx">Allow</span><span class="w"> </span><span class="nx">my</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="p">.</span><span class="nx">com</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="p">(</span><span class="nx">relay</span><span class="w"> </span><span class="nx">out</span><span class="p">)</span>
<span class="nx">mynetworks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="m m-Double">127.0.0.0</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="p">[</span><span class="o">::</span><span class="nx">ffff</span><span class="p">:</span><span class="m m-Double">127.0.0.0</span><span class="p">]</span><span class="o">/</span><span class="mi">104</span><span class="w"> </span><span class="p">[</span><span class="o">::</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">128</span><span class="w">  </span><span class="m m-Double">5.6.7.8</span>
<span class="nx">inet_interfaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">all</span>
<span class="nx">inet_protocols</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ipv4</span>

<span class="err">#</span><span class="w"> </span><span class="nx">Message</span><span class="w"> </span><span class="nx">restrictions</span>
<span class="nx">mailbox_size_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="nx">message_size_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">52428800</span>
<span class="nx">header_size_limit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">4096000</span>
<span class="nx">recipient_delimiter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">+</span>

<span class="err">#</span><span class="nx">compatibility_level</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span>
</code></pre></div>

<h4 id="complete-relay-contents-of-mastercf">Complete relay contents of master.cf</h4>
<blockquote>
<p>No spaces between = sign</p>
</blockquote>
<p>File: master.cf</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span>
<span class="err">#</span><span class="w"> </span><span class="o">==========================================================================</span>
<span class="err">#</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">unpriv</span><span class="w">  </span><span class="nx">chroot</span><span class="w">  </span><span class="nx">wakeup</span><span class="w">  </span><span class="nx">maxproc</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span>
<span class="err">#</span><span class="w">               </span><span class="p">(</span><span class="nx">yes</span><span class="p">)</span><span class="w">   </span><span class="p">(</span><span class="nx">yes</span><span class="p">)</span><span class="w">   </span><span class="p">(</span><span class="nx">no</span><span class="p">)</span><span class="w">    </span><span class="p">(</span><span class="nx">never</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="err">#</span><span class="w"> </span><span class="o">==========================================================================</span>
<span class="nx">smtp</span><span class="w">      </span><span class="nx">inet</span><span class="w">  </span><span class="nx">n</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">y</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">smtpd</span>
<span class="nx">smtps</span><span class="w">     </span><span class="nx">inet</span><span class="w">  </span><span class="nx">n</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">y</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">smtpd</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">syslog_name</span><span class="p">=</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">smtps</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_tls_wrappermode</span><span class="p">=</span><span class="nx">yes</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_auth_enable</span><span class="p">=</span><span class="nx">yes</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">milter_macro_daemon_name</span><span class="p">=</span><span class="nx">ORIGINATING</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_relay_restrictions</span><span class="p">=</span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="nx">reject</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_recipient_restrictions</span><span class="p">=</span><span class="nx">permit_mynetworks</span><span class="p">,</span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="nx">reject</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_type</span><span class="p">=</span><span class="nx">dovecot</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_path</span><span class="p">=</span><span class="k">private</span><span class="o">/</span><span class="nx">auth</span>
<span class="err">#</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">preceeding</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="nx">require</span><span class="w"> </span><span class="nx">SSL</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">relay</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">internet</span><span class="w"> </span><span class="p">(.</span><span class="nx">com</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="nx">org</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">internet</span><span class="p">)</span>
<span class="err">#</span><span class="w">  </span><span class="nx">need</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">;</span><span class="w"> </span>
<span class="err">#</span><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="nx">sasl_passwd</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="w"> </span><span class="nx">unix</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">www</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">com</span>
<span class="o">~</span>
<span class="p">:</span><span class="nx">wq</span>
</code></pre></div>

<h3 id="reload-config">Reload Config</h3>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="n">reload</span>
</code></pre></div>

<h3 id="definitions-of-master-fields">Definitions of master fields</h3>
<ul>
<li>
<p>service</p>
<p>This refers to the name in /etc/services and matches a name to a port number.</p>
</li>
<li>
<p>type</p>
<p>Internet or pipe. Internet is a network communication, while pipe is a special file on disk that echos input as output used for local communication only.</p>
</li>
<li>
<p>private</p>
<p>Access to some components is restricted to the Postfix system itself. This column is marked with a y for private access (the default) or an n for public access. inet components must be marked n for public access, since network sockets are necessarily available to other processes.</p>
</li>
<li>
<p>unpriv</p>
<p>Postfix components run with the least amount of privilege required to accomplish their tasks. They set their identity to that of the unprivileged account specified by the mail_owner parameter. The default installation uses postfix. The default value of y for this column indicates that the service runs under the normal unprivileged account. Services that require root privileges are marked with n.</p>
</li>
<li>
<p>chroot</p>
<p>Many components can be chrooted for additional security. The chroot location is specified in the queue_directory parameter in main.cf. The default is for a service to run in a chroot environment; however, the normal installation marks all components with an n so they are not chrooted when they run. Chrooting a service adds a level of complexity that you should thoroughly understand before taking advantage of the added security. See Section 4.8 later in the chapter for more information on running Postfix services in a chroot environment.</p>
</li>
<li>
<p>wakeup</p>
<p>Some components require a wake-up timer to kick them into action at the specified interval. The pickup daemon is one example. At its default setting of 60 seconds, the master daemon wakes it up every minute to see if any new messages have arrived in the maildrop queue. The other services that require a wake-up are the qmgr and flush daemons. A question mark character (?) can be added at the end of the time to indicate that a wake-up event should be sent only if the component is being used. A 0 for the time interval indicates that no wake-up is required. The default is 0, since only the three components mentioned require a wake-up. The values as they are set in the Postfix distribution should work for almost all situations. Other services should not have wakeup enabled.</p>
</li>
<li>
<p>maxproc</p>
<p>Limits the number of processes that can be invoked simultaneously. If unspecified here, the value comes from the parameter default_process_limit in main.cf, which is set to 100 by default. A setting of 0 means no process limit. You may want to adjust maxproc settings if you run Postfix on a system with limited resources or you want to optimize different aspects of the system.</p>
</li>
<li>
<p>command</p>
<p>The actual command used to execute a service is listed in the final column. The command is specified with no path information, because it is expected to be in the Postfix daemon directory specified by the daemon_directory parameter in main.cf. By default the directory is /usr/libexec/postfix. All of the Postfix commands can be specified with one or more -v options to turn on increasingly more verbose logging information, which can be helpful if you must troubleshoot a problem. You can also enable information for a debugging program with the -D option. See the DEBUG_README file that comes with the Postfix distribution for more information on debugging if necessary.</p>
</li>
</ul>
<h1 id="proxy-postfix-using-transport-maps-for-incoming-mails-on-your-domainorg">Proxy Postfix using Transport Maps for Incoming Mails on <em>your-domain.org</em></h1>
<p>A postfix transport(5) table allows one domain to transfer incoming SMTP messages to another domain. For instance the .org domain will transfer all .com messages to the .com domain automatically.</p>
<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for transporting from .org to .com</p>
</blockquote>
<h2 id="configure_1">Configure</h2>
<p>File: /etc/postfix/main.cf:</p>
<div class="highlight"><pre><span></span><code>~
    transport_maps = hash:/etc/postfix/transport
~
</code></pre></div>

<p>Set postfix to accept mails for the .com addresse.</p>
<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for transporting from .org to .com</p>
</blockquote>
<p>File: /etc/postfix/main.cf:</p>
<div class="highlight"><pre><span></span><code>~
    relay_domains = example.com
~
</code></pre></div>

<h2 id="transport-definitions">Transport Definitions</h2>
<p>Create a transport table to redirect all mail for one domain as well as mail for "user@mydomain.org" to another domain. You can also specify another port, to bypass port 25 restrictions.</p>
<p>File: /etc/postfix/transport</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="w">          </span><span class="nl">smtp</span><span class="p">:</span><span class="o">[</span><span class="n">example.com</span><span class="o">]</span><span class="err">:</span><span class="mi">10025</span>
<span class="w">    </span><span class="k">user</span><span class="nv">@mydomain</span><span class="p">.</span><span class="n">org</span><span class="w">   </span><span class="nl">smtp</span><span class="p">:</span><span class="o">[</span><span class="n">example.com</span><span class="o">]</span><span class="err">:</span><span class="mi">10025</span>
</code></pre></div>

<h2 id="make-it-a-database">Make it a database</h2>
<p>Create a postmap database from the flat ascii file.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>postmap<span class="w"> </span>/etc/postfix/transport
</code></pre></div>

<h2 id="reload-config_1">Reload Config</h2>
<p>Finally, reload the postfix configuration files.</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="n">reload</span>
</code></pre></div>

<p>Reference:</p>
<ul>
<li><a href="https://serverfault.com/questions/67134/proxy-mail-to-different-smtp-server-with-postfix">https://serverfault.com/questions/67134/proxy-mail-to-different-smtp-server-with-postfix</a></li>
<li><a href="http://www.postfix.org/postconf.5.html#permit_auth_destination">http://www.postfix.org/postconf.5.html#permit_auth_destination</a></li>
<li><a href="http://www.postfix.org/transport.5.html">http://www.postfix.org/transport.5.html</a></li>
</ul>
<h1 id="proxy-postfix-relay-for-smtp-outgoing-mails">Proxy Postfix Relay for SMTP Outgoing Mails</h1>
<p>To send mails from a non-standard port, use a .com domain to relay to a .org domain, with the .org relay set to = (basically null) and the .com relay = ...org.</p>
<h3 id="change-mx-records-in-no-ipcom-from-mail1no-ipcom-to-mailyour-domainorg">Change MX records in <em>no-ip.com</em> from mail1.no-ip.com to mail.your-domain.org</h3>
<p>Log into noip.com, go to DNS and select <code>*.your-domain.com</code>. At the bottom of the page you can change the mail1.no-ip.com record to mail.your-domain.org.</p>
<p>Don't forget to save and lookup the new value using <code>dig -t MX your-domain.com</code>.</p>
<h3 id="change-txt-spf-record-in-no-ipcom-from-noip-to">Change TXT spf record in <em>no-ip.com</em> from noip, to:</h3>
<p><em>For your-domain.com domain</em>: </p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Host</th>
<th>Value</th>
<th>Priority</th>
<th>TTL</th>
</tr>
</thead>
<tbody>
<tr>
<td>MX Record</td>
<td>@</td>
<td>your-domain.org</td>
<td>10</td>
<td>Auto</td>
</tr>
<tr>
<td>TXT Record</td>
<td>@</td>
<td>v=spf1 mx a include:your-domain.org ~all</td>
<td></td>
<td>Auto</td>
</tr>
</tbody>
</table>
<blockquote>
<p>SPF tools:
<a href="https://www.dynu.com/en-US/NetworkTools/SPFGenerator#">https://www.dynu.com/en-US/NetworkTools/SPFGenerator#</a>
<a href="https://mxtoolbox.com/spf.aspx">https://mxtoolbox.com/spf.aspx</a></p>
<ul>
<li>Try not to add more than required, you might create a potential infinite loop. 8</li>
</ul>
</blockquote>
<p>On the <em>DNS for .com</em>, create a TXT record like this</p>
<div class="highlight"><pre><span></span><code><span class="s2">&quot;v=spf1 mx a include:&lt;Domain of .org&gt; ~all&quot;</span>
</code></pre></div>

<p>Basically is says "In the DNS TXT record for email destination you@your-domain.com, validate the MX IP Address of DNS record for domain your-domain.com" for ~all; When an SPF record includes ~all (softfail qualifier), receiving servers typically accept messages from senders that aren't in your SPF record, but mark them as suspicious.</p>
<p>Reference: <a href="http://www.open-spf.org/FAQ/Common_mistakes/#list-domains">http://www.open-spf.org/FAQ/Common_mistakes/#list-domains</a></p>
<p>Test e-mail results from google:</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span>
<span class="n">ARC</span><span class="o">-</span><span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">spf</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="n">google</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">designates</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">permitted</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="n">smtp</span><span class="p">.</span><span class="n">mailfrom</span><span class="o">=</span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Received</span><span class="p">:</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="p">(</span><span class="n">mail</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="p">.</span><span class="w"> </span><span class="o">[</span><span class="n">1.2.3.4</span><span class="o">]</span><span class="p">)</span>
<span class="w">        </span><span class="k">by</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">ESMTPS</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">o6</span><span class="o">-</span><span class="mi">20020</span><span class="n">a0dcc06000000b005363cf948basi2222119ywd</span><span class="mf">.61.2023.02.25.05.45.43</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="o">&lt;</span><span class="n">you</span><span class="p">.</span><span class="n">name</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="w">        </span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">TLS1_3</span><span class="w"> </span><span class="n">cipher</span><span class="o">=</span><span class="n">TLS_AES_256_GCM_SHA384</span><span class="w"> </span><span class="n">bits</span><span class="o">=</span><span class="mi">256</span><span class="o">/</span><span class="mi">256</span><span class="p">);</span>
<span class="w">        </span><span class="n">Sat</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="n">Feb</span><span class="w"> </span><span class="mi">2023</span><span class="w"> </span><span class="mi">05</span><span class="err">:</span><span class="mi">45</span><span class="err">:</span><span class="mi">44</span><span class="w"> </span><span class="o">-</span><span class="mi">0800</span><span class="w"> </span><span class="p">(</span><span class="n">PST</span><span class="p">)</span>
<span class="n">Received</span><span class="o">-</span><span class="nl">SPF</span><span class="p">:</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="n">google</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">designates</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">permitted</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="n">client</span><span class="o">-</span><span class="n">ip</span><span class="o">=</span><span class="mf">1.2.3.4</span><span class="p">;</span>
<span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">       </span><span class="n">spf</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="n">google</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">designates</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">permitted</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="n">smtp</span><span class="p">.</span><span class="n">mailfrom</span><span class="o">=</span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Received</span><span class="p">:</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">www</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="p">(</span><span class="k">unknown</span><span class="w"> </span><span class="o">[</span><span class="n">5.6.7.8</span><span class="o">]</span><span class="p">)</span>
<span class="w">    </span><span class="k">by</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="p">(</span><span class="k">Postfix</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">ESMTPSA</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">9071</span><span class="n">FD3C93</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="o">&lt;</span><span class="n">you</span><span class="p">.</span><span class="n">name</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="n">Sat</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="n">Feb</span><span class="w"> </span><span class="mi">2023</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">45</span><span class="err">:</span><span class="mi">43</span><span class="w"> </span><span class="o">+</span><span class="mi">0000</span><span class="w"> </span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
<span class="o">~</span>
</code></pre></div>

<h3 id="change-your-domaincom-postfixmaincf-relay-to-your-domainorg">Change <em>your-domain.com</em> postfix/main.cf relay to your-domain.org</h3>
<p>File: /etc/postfix/main.cf</p>
<div class="highlight"><pre><span></span><code>relayhost = [mail.your-domain.org]:465
</code></pre></div>

<h3 id="add-your-domainorg-unix-login-on-host-your-domaincom">Add your-domain.org unix login on host <em>your-domain.com</em></h3>
<p>File: /etc/postfix/sasl/sasl_passwd</p>
<div class="highlight"><pre><span></span><code>[mail.your-domain.org]:465 you:********
</code></pre></div>

<p>Create a postfix DB from flat file</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>postmap<span class="w"> </span>/etc/postfix/sasl/sasl_passwd
</code></pre></div>

<h3 id="enable-tls-on-your-domainorg">Enable TLS on <em>your-domain.org</em></h3>
<p>TLS requires certificate(s) and SASL login verification. </p>
<p>The logon verification is done by Docevot using the userdb setting <em>pam</em>[1], while the postfix SASL verification uses a unix pipe <em>/var/spool/postfix/private/auth</em> to talk to Dovecot.</p>
<p>The encryption is enabled by Let's Encrypt certificates (one for the <em>domain</em>, another for each <em>subdomain</em>), over the smtps (post 465) network socket to the client. The master.cf file -o settings override the main.cf settings, ensuring a connection is <em>only</em> accepted if:</p>
<ul>
<li>TLS certificate is working and accepted by both parties, on port 465</li>
<li>SASL logon passes, using postfix -&gt; Dovecot -&gt; pam login.</li>
</ul>
<h5 id="or">OR</h5>
<ul>
<li>The incoming IP address is part of mynetwork, on port 25</li>
</ul>
<blockquote>
<p>Plugable Authentication Module (PAM) is the Linux login method for users</p>
</blockquote>
<p>Two Steps:</p>
<ol>
<li>
<p>install dovecot</p>
</li>
<li>
<p>The Debian Way</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>dovecot-core
</code></pre></div>

</div>
<ul>
<li>The RedHat Way</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>dovecot
</code></pre></div>

</div>
<p>Add <code>login</code> to dovecot auth</p>
<p>File: /etc/dovecot/conf.d/10-auth.conf</p>
<div class="highlight"><pre><span></span><code>~
     auth_mechanisms = plain login
~
:wq
</code></pre></div>

<p>Set the certificates to letsencrypt, require ssl and prefer server of the ciphers</p>
<p>File: /etc/dovecot/conf.d/10-ssl.conf</p>
<div class="highlight"><pre><span></span><code>~
    ssl = required
~
    ssl_cert = &lt;/etc/letsencrypt/live/your-domain.org/fullchain.pem
    ssl_key = &lt;/etc/letsencrypt/live/your-domain.org/privkey.pem
~
    # Comment out default certs
~
    ssl_prefer_server_ciphers = yes
~
:wq
</code></pre></div>

<p>Set up a local unix pipe for dovecot and postfix to communicate this authorization data, under the service_auth set of brackets.</p>
<p>File: /etc/dovecot/conf.d/10-master.conf</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span>
<span class="w">  </span><span class="n">unix_listener</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">auth</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0660</span>
<span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">  </span><span class="p">}</span>
<span class="o">~</span>
<span class="p">:</span><span class="n">wq</span>
</code></pre></div>

<ol>
<li>Set the receiving certificates in Postfix, require TLS using Dovecot.</li>
</ol>
<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for relaying TLS on .org to the Internet</p>
</blockquote>
<p>File: /etc/postfix/main.cf</p>
<div class="highlight"><pre><span></span><code>~
#smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
#smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_cert_file<span class="w"> </span>=<span class="w"> </span>/etc/letsencrypt/live/your-domain.org/fullchain.pem
smtpd_tls_key_file<span class="w">  </span>=<span class="w"> </span>/etc/letsencrypt/live/your-domain.org/privkey.pem
smtpd_use_tls<span class="w"> </span>=<span class="w"> </span>yes
smtpd_tls_session_cache_database<span class="w"> </span>=<span class="w"> </span>btree:<span class="cp">${</span><span class="n">data_directory</span><span class="cp">}</span>/smtpd_scache
smtpd_tls_security_level=may

~

#<span class="w"> </span>sasl<span class="w"> </span>auth<span class="w"> </span>from<span class="w"> </span>Dovecot
smtpd_sasl_type<span class="w"> </span>=<span class="w"> </span>dovecot
smtpd_sasl_path<span class="w"> </span>=<span class="w"> </span>private/auth
smtpd_sasl_auth_enable<span class="w"> </span>=<span class="w"> </span>yes

~
:wq
</code></pre></div>

<blockquote>
<p>Repeated postfix file contents from above
to clarify this is for relaying TLS on .org to the Internet</p>
</blockquote>
<p>File: /etc/postfix/master.cf</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span>
<span class="err">#</span><span class="w"> </span><span class="o">==========================================================================</span>
<span class="err">#</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">unpriv</span><span class="w">  </span><span class="nx">chroot</span><span class="w">  </span><span class="nx">wakeup</span><span class="w">  </span><span class="nx">maxproc</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span>
<span class="err">#</span><span class="w">               </span><span class="p">(</span><span class="nx">yes</span><span class="p">)</span><span class="w">   </span><span class="p">(</span><span class="nx">yes</span><span class="p">)</span><span class="w">   </span><span class="p">(</span><span class="nx">no</span><span class="p">)</span><span class="w">    </span><span class="p">(</span><span class="nx">never</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="err">#</span><span class="w"> </span><span class="o">==========================================================================</span>
<span class="nx">smtp</span><span class="w">      </span><span class="nx">inet</span><span class="w">  </span><span class="nx">n</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">y</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">smtpd</span>
<span class="nx">smtps</span><span class="w">     </span><span class="nx">inet</span><span class="w">  </span><span class="nx">n</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">y</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">smtpd</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">syslog_name</span><span class="p">=</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">smtps</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_tls_wrappermode</span><span class="p">=</span><span class="nx">yes</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_auth_enable</span><span class="p">=</span><span class="nx">yes</span>
<span class="w">    </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">milter_macro_daemon_name</span><span class="p">=</span><span class="nx">ORIGINATING</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_relay_restrictions</span><span class="p">=</span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="nx">reject</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_recipient_restrictions</span><span class="p">=</span><span class="nx">permit_mynetworks</span><span class="p">,</span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="nx">reject</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_type</span><span class="p">=</span><span class="nx">dovecot</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_path</span><span class="p">=</span><span class="k">private</span><span class="o">/</span><span class="nx">auth</span>
<span class="err">#</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">preceeding</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nx">lines</span><span class="w"> </span><span class="nx">require</span><span class="w"> </span><span class="nx">SSL</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">relay</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">internet</span><span class="w"> </span><span class="p">(.</span><span class="nx">com</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="nx">org</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">internet</span><span class="p">)</span>
<span class="err">#</span><span class="w">  </span><span class="nx">need</span><span class="w"> </span><span class="nx">cert</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">,</span><span class="w"> </span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="p">;</span><span class="w"> </span>
<span class="err">#</span><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="nx">sasl_passwd</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">mail</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">org</span><span class="w"> </span><span class="nx">unix</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">www</span><span class="p">.</span><span class="nx">your</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">com</span>
<span class="o">~</span>
<span class="p">:</span><span class="nx">wq</span>
</code></pre></div>

<ul>
<li>Make sure port 465 (smtps) is opened by Postfix</li>
</ul>
<p>Open on localhost</p>
<div class="highlight"><pre><span></span><code><span class="c1"># nmap -sT -O localhost</span>
<span class="n">Starting</span><span class="w"> </span><span class="n">Nmap</span><span class="w"> </span><span class="m">7.70</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="n">nmap.org</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="m">2023-02-19</span><span class="w"> </span><span class="m">16</span><span class="o">:</span><span class="m">46</span><span class="w"> </span><span class="n">EST</span>
<span class="n">Nmap</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="nf">localhost </span><span class="p">(</span><span class="m">127.0</span><span class="n">.</span><span class="m">0.1</span><span class="p">)</span>
<span class="n">Host</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="nf">up </span><span class="p">(</span><span class="m">0.00019</span><span class="n">s</span><span class="w"> </span><span class="n">latency</span><span class="p">)</span><span class="n">.</span>
<span class="n">Other</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="nf">localhost </span><span class="p">(</span><span class="n">not</span><span class="w"> </span><span class="n">scanned</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="o">::</span><span class="m">1</span>
<span class="n">Not</span><span class="w"> </span><span class="n">shown</span><span class="o">:</span><span class="w"> </span><span class="m">992</span><span class="w"> </span><span class="n">closed</span><span class="w"> </span><span class="n">ports</span>
<span class="n">PORT</span><span class="w">    </span><span class="n">STATE</span><span class="w"> </span><span class="n">SERVICE</span>
<span class="m">22</span><span class="o">/</span><span class="n">tcp</span><span class="w">  </span><span class="n">open</span><span class="w">  </span><span class="n">ssh</span><span class="w">   </span><span class="o">&lt;-</span>
<span class="m">25</span><span class="o">/</span><span class="n">tcp</span><span class="w">  </span><span class="n">open</span><span class="w">  </span><span class="n">smtp</span><span class="w">  </span><span class="o">&lt;-</span>
<span class="m">80</span><span class="o">/</span><span class="n">tcp</span><span class="w">  </span><span class="n">open</span><span class="w">  </span><span class="n">http</span><span class="w">  </span><span class="o">&lt;-</span>
<span class="m">110</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="n">open</span><span class="w">  </span><span class="n">pop3</span>
<span class="m">143</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="n">open</span><span class="w">  </span><span class="n">imap</span>
<span class="m">443</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="n">open</span><span class="w">  </span><span class="n">https</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="m">465</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="n">open</span><span class="w">  </span><span class="n">smtps</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="m">993</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="n">open</span><span class="w">  </span><span class="n">imaps</span>
<span class="m">995</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="n">open</span><span class="w">  </span><span class="n">pop3s</span>
</code></pre></div>

<blockquote>
<p>RedHat 9 /etc/services shows port 465 as <em>urd</em>, so <strong>I switched the urd and alias smtps</strong>.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="nv">grep</span><span class="w"> </span><span class="nv">smtps</span><span class="w"> </span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">services</span>
<span class="nv">smtps</span><span class="w">           </span><span class="mi">465</span><span class="o">/</span><span class="nv">tcp</span><span class="w">           </span><span class="nv">urd</span><span class="w">   </span>#<span class="w"> </span><span class="nv">URL</span><span class="w"> </span><span class="nv">Rendesvous</span><span class="w"> </span><span class="nv">Directory</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">SSM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">SMTP</span><span class="w"> </span><span class="nv">over</span><span class="w"> </span><span class="nv">SSL</span><span class="w"> </span><span class="ss">(</span><span class="nv">TLS</span><span class="ss">)</span>
</code></pre></div>

<p>Now ss looks better:</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> ss -ltap
State        Recv-Q    Send-Q        Local Address:Port            Peer Address:Port     Process                                                   
LISTEN       0         128                 0.0.0.0:ssh                  0.0.0.0:*         users:((&quot;sshd&quot;,pid=1314,fd=3))                           
LISTEN       0         100                 0.0.0.0:smtp                 0.0.0.0:*         users:((&quot;master&quot;,pid=23736,fd=13))                       
LISTEN       0         100                 0.0.0.0:imaps                0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=41))                      
LISTEN       0         100                 0.0.0.0:pop3s                0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=23))                      
LISTEN       0         100                 0.0.0.0:pop3                 0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=21))                      
LISTEN       0         100                 0.0.0.0:imap                 0.0.0.0:*         users:((&quot;dovecot&quot;,pid=23599,fd=39))                      
LISTEN       0         100                 0.0.0.0:smtps                0.0.0.0:*         users:((&quot;master&quot;,pid=23736,fd=17))                       
ESTAB        0         52            1.2.3.4:ssh                   5.6.7.8:44958     users:((&quot;sshd&quot;,pid=2402,fd=4),(&quot;sshd&quot;,pid=2278,fd=4))    
LISTEN       0         128                    [::]:ssh                     [::]:*         users:((&quot;sshd&quot;,pid=1314,fd=4))                           
LISTEN       0         100                    [::]:imaps                   [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=42))                      
LISTEN       0         100                    [::]:pop3s                   [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=24))                      
LISTEN       0         100                    [::]:pop3                    [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=22))                      
LISTEN       0         100                    [::]:imap                    [::]:*         users:((&quot;dovecot&quot;,pid=23599,fd=40))   
</code></pre></div>

<p>Open to internet</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>firewall-cmd<span class="w"> </span>--list-services
<span class="w">  </span>http<span class="w"> </span>https<span class="w"> </span>smtp<span class="w"> </span>smtps<span class="w"> </span>ssh
</code></pre></div>

<h1 id="clients-mail-user-agents-mua">Clients Mail User Agents (MUA)</h1>
<p>These are the programs where a human interface resides, and where everybody reads, sends, deletes, and manages their E-Mail. Names such as: Thunderbird, Evolution, Mutt, Gmail, Outlook, etc.</p>
<ul>
<li>
<p>Mail Transport Agents (MTA) <em>only</em> connect here. Do not connect your MUA to this port!</p>
</li>
<li>
<p>SMTP (port 25): This is an restricted relay port, defined on host example.org and controlled by the /etc/postfix/master.cf smtp definition. Only addresses in $mydestination will be accepted, and nothing else will be relayed in. The transport definition will forward to it's list of addresses/domains. After a client is authenticated, it will be allowed to relay out on port 25. Process <em>master</em>, forked from postfix, performs this responsibility.</p>
<ul>
<li>-o smtpd_relay_restrictions=permit_sasl_authenticated,reject: means that only authenticated connections can relay out</li>
</ul>
</li>
<li>
<p>Client (MUA) connect here to <strong>SEND</strong> mail <em>only</em></p>
</li>
<li>
<p>SMTPS (port 465): This is defined on host example.org, and is always an encrypted port, controlled by the /etc/postfix/master.cf smtps definition. All authentications occur here. Process <em>master</em>, forked from postfix, performs this responsibility.</p>
<ul>
<li>
<p>-o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject: means that only $mynetworks or authenticated connections can submit messages to be sent. MUA will connect using this rule. </p>
</li>
<li>
<p>Authentication is done using /etc/dovecot/conf.d/10-auth.conf <em>auth_mechanism=login</em> definition, over unix pipe <em>unix_listener /var/spool/postfix/private/auth</em> declared in file /etc/dovecot/conf.d/10-master.conf. Linux PAM verification occurs using file /etc/pam.d/dovecot and <em>passdb{driver=pam}</em> in file /etc/dovecot/conf.d/auth-system.conf.ext.</p>
</li>
</ul>
</li>
</ul>
<p>Unix pipe for postfix to dovecot authenication of clients.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/var/spool/postfix/private/auth
srw-rw----<span class="w"> </span><span class="m">1</span><span class="w"> </span>postfix<span class="w"> </span>postfix<span class="w"> </span><span class="m">0</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">10</span>:21<span class="w"> </span>/var/spool/postfix/private/auth
</code></pre></div>

<ul>
<li>
<p>Client (MUA) connect here to <strong>READ/MANAGE</strong> mail <em>only</em></p>
<ul>
<li>
<p>IMAPS (port 993): This is defined on the example.com host Dovecot installation, file /etc/dovecot/conf.d/10-master.conf, section <em>service imap_listener imaps</em>. Process <em>imap</em>, forked from dovecot, performs this responsibility.</p>
</li>
<li>
<p>Authentication is done using /etc/dovecot/conf.d/10-auth.conf <em>auth_mechanism=plain</em> definition, over <em>unix_listener auth_userdb</em> declared in file /etc/dovecot/conf.d/10-master.conf. Linux PAM verification occurs using file /etc/pam.d/dovecot and <em>passdb{driver=pam}</em> in file /etc/dovecot/conf.d/auth-system.conf.ext.</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Port 587, aka: submission, is purposely ommited because it is a <em>partial encryption</em> called STARTTLS. This is deemed un-secure and not recommended.</p>
</blockquote>
<h3 id="mua-connection-definitions">MUA Connection Definitions</h3>
<h4 id="read-mail">Read Mail</h4>
<ul>
<li>Server: mail.example.com</li>
<li>User: &lt;linux user defined on the <a href="/linux-in-house/e-mail.html#user-settings">E-Mail</a> .com host&gt;</li>
<li>Password: &lt;linux user password defined on the <a href="/linux-in-house/e-mail.html#user-settings">E-Mail</a> .com host&gt;</li>
<li>SSL: ON</li>
<li>Port: 993</li>
</ul>
<h4 id="send-mail">Send Mail</h4>
<ul>
<li>Server: smtp.example.org</li>
<li>User: &lt;linux user defined <a href="/linux-in-house/e-mailrelay.html#create-new-users">above</a> on the E-Mail .org host&gt;</li>
<li>Password: &lt;linux user password defined <a href="/linux-in-house/e-mailrelay.html#create-new-users">above</a> on the E-Mail .org host&gt;</li>
<li>SSL: ON</li>
<li>Port: 465</li>
</ul>
<h1 id="debug">Debug</h1>
<h2 id="if-mail-queues-up-to-sendresend-you-can-check-and-clear-to-queue">If mail queues up to send/resend, you can check and clear to queue</h2>
<h5 id="list-mail-queue">List mail queue</h5>
<div class="highlight"><pre><span></span><code>mailq
</code></pre></div>

<h5 id="look-at-message">Look at message</h5>
<div class="highlight"><pre><span></span><code>postcat -vq DCE2182DEA
</code></pre></div>

<h5 id="flush-queue">Flush queue</h5>
<div class="highlight"><pre><span></span><code>postsuper -d ALL deferred
</code></pre></div>

<h5 id="or_1">or</h5>
<div class="highlight"><pre><span></span><code>postqueue -f
</code></pre></div>

<blockquote>
<p>Cache files (send/receive) are in data_directory (/var/lib/postfix) as Berkley Databasees</p>
</blockquote>
<h2 id="install-a-mail-user-agent-for-ssh">Install a Mail User Agent for ssh</h2>
<p>mutt is a nice local mail reader, for times when the network mail may not work, at least the local mail will.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>mutt
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>mutt
</code></pre></div>

<h2 id="install-a-nice-ssh-capable-log-reader">Install a nice ssh capable log reader</h2>
<p>I like <em>lnav</em>. Just run <code>lnav</code> and by default it will read the syslog. Or run <code>lnav /var/log/mail.log</code>.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>lnav
$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>lnav
</code></pre></div>

<h2 id="install-a-package-marking-tool">Install a package marking tool</h2>
<blockquote>
<p>Debian only: apt-clone will create a nice bundle of all your current packages.  Save this off in case you have to re-build your server.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>apt-clone
</code></pre></div>

<h2 id="certificate-expiration-check">Certificate Expiration Check</h2>
<p>Run this every week/day in cron <code>/root/cert_expire.sh 2</code> to E-Mail you reminders before it expires.</p>
<p>File: ~/cert_expire.sh</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># ----------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># File: cert_expire.sh</span>
<span class="c1">#</span>
<span class="c1"># Purpose: See what the expiration date is for Let&#39;s Encrypt Certificate</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#  s_client : The s_client command implements a generic SSL/TLS client</span>
<span class="c1">#              which connects to a remote host using SSL/TLS.</span>
<span class="c1">#  -servername $DOM : Set the TLS SNI (Server Name Indication) extension</span>
<span class="c1">#                      in the ClientHello message to the given value.</span>
<span class="c1">#  -connect $DOM:$PORT : This specifies the host ($DOM) and optional</span>
<span class="c1">#                         port ($PORT) to connect to.</span>
<span class="c1">#  x509 : Run certificate display and signing utility.</span>
<span class="c1">#  -noout : Prevents output of the encoded version of the certificate.</span>
<span class="c1">#  -dates : Prints out the start and expiry dates of a TLS or SSL certificate.</span>
<span class="c1">#</span>
<span class="c1"># Don Cohoon - Jan 2023</span>
<span class="c1"># ----------------------------------------------------------------------</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$#</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">A</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
<span class="k">else</span>
<span class="w">  </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;1) E-Mail&quot;</span>
<span class="w">  </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;2) File&quot;</span>
<span class="w">  </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;3) Web&quot;</span>
<span class="w">  </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;4) Local&quot;</span>
<span class="w">  </span><span class="nb">read</span><span class="w"> </span>A
<span class="k">fi</span>
<span class="k">case</span><span class="w"> </span><span class="si">${</span><span class="nv">A</span><span class="si">}</span>
<span class="w"> </span><span class="k">in</span>
<span class="w">   </span><span class="m">1</span><span class="o">)</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;REMINDER: Restart postfix and dovecot to enable new certs&quot;</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;=&gt; E-Mail Certificate: CTRL-C to exit&quot;</span>
<span class="w">    </span><span class="c1">#/usr/bin/openssl s_client -connect mail.your-domain.org:25 -starttls smtp 2&gt;/dev/null|/usr/bin/openssl x509 -noout -dates</span>
<span class="w">    </span>/usr/bin/openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>mail.your-domain.org:465<span class="w">  </span><span class="m">2</span>&gt;/dev/null<span class="p">|</span>/usr/bin/openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-dates
<span class="w">    </span><span class="p">;;</span>
<span class="w">   </span><span class="m">2</span><span class="o">)</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;=&gt; File Certificate&quot;</span>
<span class="w">    </span>sudo<span class="w"> </span>/usr/bin/openssl<span class="w"> </span>x509<span class="w"> </span>-enddate<span class="w"> </span>-noout<span class="w"> </span>-in<span class="w"> </span>/etc/letsencrypt/live/your-domain.org/fullchain.pem
<span class="w">    </span><span class="p">;;</span>
<span class="w">   </span><span class="m">3</span><span class="o">)</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;REMINDER: Restart apache2 and nginx to enable new certs&quot;</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;=&gt; www.your-domain.org Certificate: CTRL-C to exit&quot;</span>
<span class="w">    </span>/usr/bin/openssl<span class="w"> </span>s_client<span class="w"> </span>-servername<span class="w"> </span>your-domain.org<span class="w"> </span>-connect<span class="w"> </span>www.your-domain.org:443<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>/usr/bin/openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-dates
<span class="w">    </span><span class="p">;;</span>
<span class="w">   </span><span class="m">4</span><span class="o">)</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;REMINDER: Restart apache2 and nginx to enable new certs&quot;</span>
<span class="w">    </span>/usr/bin/echo<span class="w"> </span><span class="s2">&quot;=&gt; Local Web Certificate: CTRL-C to exit&quot;</span>
<span class="w">    </span>/usr/bin/openssl<span class="w"> </span>s_client<span class="w"> </span>-connect<span class="w"> </span>localhost:443<span class="w"> </span><span class="p">|</span><span class="w"> </span>/usr/bin/openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-dates
<span class="w">    </span><span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div>

<h1 id="configuring-spf-policy-agent">Configuring SPF Policy Agent</h1>
<p>We also need to tell our Postfix SMTP server to check for SPF record of incoming emails. This doesn’t help ensure outgoing email delivery but help with detecting forged incoming emails.</p>
<h2 id="install-required-packages">Install required packages:</h2>
<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code>sudo apt install postfix-policyd-spf-python
</code></pre></div>

<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code>sudo dnf install pypolicyd-spf
</code></pre></div>

<h2 id="test-spf">Test SPF</h2>
<p>If you know the sender, recipient, and client_address, you can test them before turning SPF on in postfix.</p>
<blockquote>
<p>Must have blank line as last input for policyd-spf</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">Site</span><span class="w"> </span><span class="nx">Packages</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python3</span><span class="m m-Double">.9</span><span class="o">/</span><span class="nx">site</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span>
<span class="err">#</span><span class="w"> </span><span class="nx">Source</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python3</span><span class="m m-Double">.9</span><span class="o">/</span><span class="nx">site</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">spf_engine</span><span class="o">/*</span>
<span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">libexec</span><span class="o">/</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">policyd</span><span class="o">-</span><span class="nx">spf</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="nx">EOF</span>
<span class="w"> </span><span class="nx">request</span><span class="p">=</span><span class="nx">smtpd_access_policy</span>
<span class="w"> </span><span class="nx">protocol_state</span><span class="p">=</span><span class="nx">RCPT</span>
<span class="w"> </span><span class="nx">protocol_name</span><span class="p">=</span><span class="nx">SMTP</span>
<span class="w"> </span><span class="nx">helo_name</span><span class="p">=</span><span class="nx">ccpub6</span>
<span class="w"> </span><span class="nx">queue_id</span><span class="p">=</span><span class="nx">hv8rp02v1sso</span>
<span class="w"> </span><span class="nx">instance</span><span class="p">=</span><span class="m m-Double">12345.6789</span>
<span class="w"> </span><span class="nx">sender</span><span class="p">=</span><span class="nx">foo</span>
<span class="w"> </span><span class="nx">recipient</span><span class="p">=</span><span class="nx">bar</span>
<span class="w"> </span><span class="nx">client_address</span><span class="p">=</span><span class="m m-Double">1.2.3.4</span>
<span class="w"> </span><span class="nx">client_name</span><span class="p">=</span><span class="nx">bubba</span>

<span class="nx">EOF</span>
</code></pre></div>

<h2 id="configure-spf">Configure SPF</h2>
<p>Add the following lines at the end of the file, which tells Postfix to start the SPF policy daemon when it’s starting itself.</p>
<ul>
<li>Debian</li>
</ul>
<p>File: /etc/postfix/master.cf</p>
<div class="highlight"><pre><span></span><code>policyd-spf  unix  -       n       n       -       0       spawn
    user=policyd-spf argv=/usr/bin/policyd-spf
</code></pre></div>

<ul>
<li>Redhat</li>
</ul>
<p>File: /etc/postfix/master.cf</p>
<div class="highlight"><pre><span></span><code>policyd-spf  unix  -       n       n       -       0       spawn
    user=nobody argv=/usr/libexec/postfix/policyd-spf
</code></pre></div>

<p>Append the following lines at the end of the file. The first line specifies the Postfix policy agent timeout setting. The following lines will impose a restriction on incoming emails by rejecting unauthorized email and checking SPF record.</p>
<p>File: /etc/postfix/main.cf</p>
<div class="highlight"><pre><span></span><code>policyd-spf_time_limit = 3600
smtpd_recipient_restrictions =
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_unauth_destination,
   check_policy_service unix:private/policyd-spf
</code></pre></div>

<h2 id="restart-postfix">Restart Postfix.</h2>
<div class="highlight"><pre><span></span><code>sudo systemctl restart postfix
</code></pre></div>

<p>Next time, when you receive an email from a domain that has an SPF record, you can see the SPF check results in the raw email header. The following header indicates the sender sent the email from an authorized host.</p>
<div class="highlight"><pre><span></span><code>Received-SPF: Pass (sender SPF authorized).
</code></pre></div>

<h2 id="debug-spf">Debug SPF</h2>
<p>Config file, debug setting:</p>
<p>File: /etc/python-policyd-spf/policyd-spf.conf</p>
<div class="highlight"><pre><span></span><code>~
# level 1 is default
debugLevel = 5
~
:wq
</code></pre></div>

<div class="highlight"><pre><span></span><code>man policyd-spf.conf
</code></pre></div>

<p>check_policy_service Unix pipe:</p>
<p>File: /var/spool/postfix/private/policyd-spf </p>
<div class="highlight"><pre><span></span><code><span class="n">srw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">Feb</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">37</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">policyd</span><span class="o">-</span><span class="n">spf</span>
</code></pre></div>

<h2 id="block-domains-and-e-mail-addresses-using-postfix-access">Block Domains and E-Mail Addresses using Postfix access</h2>
<p>The  following example uses an indexed file, so that the order of table
entries does not matter.</p>
<p>File: /etc/postfix/main.cf:</p>
<div class="highlight"><pre><span></span><code> smtpd_client_restrictions =
   check_client_access hash:/etc/postfix/access
</code></pre></div>

<p>The example permits access by  the  client  at
address 1.2.3.4 but rejects all other clients in 1.2.3.0/24. </p>
<p>File: /etc/postfix/access:</p>
<div class="highlight"><pre><span></span><code><span class="mf">1.2.3</span><span class="w">   </span><span class="n">REJECT</span>
<span class="mf">1.2.3.4</span><span class="w"> </span><span class="n">OK</span>
<span class="n">aol</span><span class="mf">.</span><span class="n">com</span><span class="w"> </span><span class="n">REJECT</span>
</code></pre></div>

<p>Create hash map of ascii file, and restart postfix</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>postmap<span class="w">  </span>/etc/postfix/access
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>postfix
</code></pre></div>

<p>Reference: 
 * <a href="http://www.open-spf.org/FAQ/Common_receiver_mistakes/">http://www.open-spf.org/FAQ/Common_receiver_mistakes/</a>
 * <a href="https://www.mankier.com/5/policyd-spf.conf">https://www.mankier.com/5/policyd-spf.conf</a>
 * <a href="http://www.postfix.org/access.5.html">http://www.postfix.org/access.5.html</a></p>
<h1 id="setting-up-dkim">Setting up DKIM</h1>
<p>OpenDKIM is an open source implementation of the DKIM (Domain Keys Identified Mail) sender authentication system proposed by the E-mail Signing Technology Group (ESTG), now standardized by the IETF (RFC6376). It also includes implementations of the RFC5617) Vouch By Reference (VBR, RFC5518) proposed standard and the experimental Authorized Third Party Signatures protocol (ATPS, RFC6541). </p>
<h2 id="install-opendkim">Install OpenDKIM</h2>
<ul>
<li>Debian</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">opendkim</span><span class="w"> </span><span class="n">opendkim</span><span class="o">-</span><span class="n">tools</span>
</code></pre></div>

<ul>
<li>RedHat</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># enable the CodeReady Linux Builder repository. You already have access to it; you just need to enable it.</span>
<span class="n">dnf</span><span class="w"> </span><span class="n">config</span><span class="o">-</span><span class="n">manager</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="o">-</span><span class="n">enabled</span><span class="w"> </span><span class="n">crb</span>
<span class="c1"># install the EPEL RPM</span>
<span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">epel</span><span class="o">-</span><span class="n">release</span><span class="w"> </span><span class="n">epel</span><span class="o">-</span><span class="n">next</span><span class="o">-</span><span class="n">release</span>
<span class="c1"># install</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">opendkim</span><span class="w"> </span><span class="n">opendkim</span><span class="o">-</span><span class="n">tools</span>
</code></pre></div>

<h2 id="configure-opendkim">Configure OpenDKIM</h2>
<p>Add user postfix to group opendkim.</p>
<div class="highlight"><pre><span></span><code>sudo gpasswd -a postfix opendkim
</code></pre></div>

<p>Check OpenDKIM main configuration file for Syslog, Logwhy.</p>
<blockquote>
<p>Logwhy will generate more detailed logs for debugging.</p>
</blockquote>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code>Syslog               yes
Logwhy               yes
</code></pre></div>

<p>Set Canonicalization used when signing messages. The recognized values are relaxed and simple as defined by the DKIM specification. The default is simple. The value may include two different canonicalizations separated by a slash ("/") character, in which case the first will be applied to the header and the second to the body.</p>
<p>Set operating Modes. The string is a concatenation of characters that indicate which mode(s) of operation are desired. Valid modes are s (signer) and v (verifier). The default is sv except in test mode (see the opendkim(8) man page) in which case the default is v. When signing mode is enabled, one of the following combinations must also be set: (a) Domain, KeyFile, Selector, no KeyTable, no SigningTable; (b) KeyTable, SigningTable, no Domain, no KeyFile, no Selector; (c) KeyTable, SetupPolicyScript, no Domain, no KeyFile, no Selector.</p>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code><span class="nx">Canonicalization</span><span class="w">   </span><span class="nx">relaxed</span><span class="o">/</span><span class="nx">simple</span>
<span class="nx">Mode</span><span class="w">               </span><span class="nx">sv</span>
</code></pre></div>

<ul>
<li>Do not set Domain or SubDomains, they are not required because we will use SigningTable.</li>
<li>Do not set Selector, it is not required because we will use SigningTable.</li>
<li>Do not set KeyFile, it is not required because we will use KeyTable.</li>
</ul>
<p>Add restart definitions to the end of the file.</p>
<ul>
<li>
<p>AutoRestart (Boolean): Automatically re-start on failures. Use with caution; if the filter fails instantly after it starts, this can cause a tight fork(2) loop.</p>
</li>
<li>
<p>AutoRestartCount (integer): Sets the maximum automatic restart count. After this number of automatic restarts, the filter will give up and terminate. A value of 0 implies no limit; this is the default.</p>
</li>
<li>
<p>AutoRestartRate (string): Sets the maximum automatic restart rate. If the filter begins restarting faster than the rate defined here, it will give up and terminate. This is a string of the form n/t[u] where n is an integer limiting the count of restarts in the given interval and t[u] defines the time interval through which the rate is calculated; t is an integer and u defines the units thus represented ("s" or "S" for seconds, the default; "m" or "M" for minutes; "h" or "H" for hours; "d" or "D" for days). For example, a value of "10/1h" limits the restarts to 10 in one hour. There is no default, meaning restart rate is not limited.</p>
</li>
</ul>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code>AutoRestart       yes
AutoRestartCount  10
AutoRestartRate   10/1H
</code></pre></div>

<p>Reference: <a href="http://www.opendkim.org/opendkim.conf.5.html">http://www.opendkim.org/opendkim.conf.5.html</a></p>
<h3 id="map-domains-to-keys">Map Domains to Keys</h3>
<p>The next two configuration items will create maps for E-Mail Domains in the <em>From:</em> header, to keys used to sign messages.</p>
<ul>
<li>
<p>KeyTable (dataset): Gives the location of a file mapping key names to signing keys. If present, overrides any KeyFile setting in the configuration file. The data set named here maps each key name to three values: (a) the name of the domain to use in the signature’s "d=" value; (b) the name of the selector to use in the signature’s "s=" value; and (c) either a private key or a path to a file containing a private key. If the first value consists solely of a percent sign ("%") character, it will be replaced by the apparent domain of the sender when generating a signature. If the third value starts with a slash ("/") character, or "./" or "../", then it is presumed to refer to a file from which the private key should be read, otherwise it is itself a PEM-encoded private key or a base64-encoded DER private key; a "%" in the third value in this case will be replaced by the apparent domain name of the sender. The SigningTable (see below) is used to select records from this table to be used to add signatures based on the message sender.</p>
</li>
<li>
<p>SigningTable (dataset): Defines a table used to select one or more signatures to apply to a message based on the address found in the From: header field. Keys in this table vary depending on the type of table used; values in this data set should include one field that contains a name found in the KeyTable (see above) that identifies which key should be used in generating the signature, and an optional second field naming the signer of the message that will be included in the "i=" tag in the generated signature. Note that the "i=" value will not be included in the signature if it conflicts with the signing domain (the "d=" value).</p>
<ul>
<li>
<p>If the first field contains only a "%" character, it will be replaced by the domain found in the From: header field. Similarly, within the optional second field, any "%" character will be replaced by the domain found in the From: header field.</p>
</li>
<li>
<p>If this table specifies a regular expression file ("refile"), then the keys are wildcard patterns that are matched against the address found in the From: header field. Entries are checked in the order in which they appear in the file.</p>
</li>
<li>
<p>For all other database types, the full user@host is checked first, then simply host, then user@.domain (with all superdomains checked in sequence, so "foo.example.com" would first check "user@foo.example.com", then "user@.example.com", then "user@.com"), then .domain, then user@<em>, and finally </em>.</p>
</li>
<li>
<p>In any case, only the first match is applied, unless MultipleSignatures is enabled in which case all matches are applied.</p>
</li>
</ul>
</li>
</ul>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code>KeyTable        /etc/opendkim/KeyTable
SigningTable    refile:/etc/opendkim/SigningTable
</code></pre></div>

<p>KeyTable need "refile:"? (wildcards not allowed)</p>
<h3 id="hosts-to-ignore-when-verifying-signatures">Hosts to ignore when verifying signatures</h3>
<p>Identifies a set of "external" hosts that may send mail through the server as one of the signing domains without credentials as such. This has the effect of suppressing the "external host (hostname) tried to send mail as (domain)" log messages. Entries in the data set should be of the same form as those of the PeerList option below. The set is empty by default.</p>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code>ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
</code></pre></div>

<h3 id="a-set-of-internal-hosts-whose-mail-should-be-signed">A set of internal hosts whose mail should be signed</h3>
<p>Identifies a set internal hosts whose mail should be signed rather than verified. Entries in this data set follow the same form as those of the PeerList option below. If not specified, the default of "127.0.0.1" is applied. Naturally, providing a value here overrides the default, so if mail from 127.0.0.1 should be signed, the list provided here should include that address explicitly.</p>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code>InternalHosts   refile:/etc/opendkim/TrustedHosts
</code></pre></div>

<p>Save and close the file.</p>
<h2 id="create-signing-table-key-table-and-trusted-hosts-file">Create Signing Table, Key Table and Trusted Hosts File</h2>
<h3 id="check-directory-structure-for-opendkim">Check directory structure for OpenDKIM</h3>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>ls<span class="w"> </span>-lR<span class="w"> </span>/etc/opendkim*
-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w">     </span>root<span class="w">     </span><span class="m">5346</span><span class="w"> </span>Mar<span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="m">11</span>:15<span class="w"> </span>/etc/opendkim.conf

/etc/opendkim:
total<span class="w"> </span><span class="m">12</span>
drwx--x---<span class="w"> </span><span class="m">2</span><span class="w"> </span>opendkim<span class="w"> </span>opendkim<span class="w">    </span><span class="m">6</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w">  </span><span class="m">2022</span><span class="w"> </span>keys
-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>opendkim<span class="w"> </span>opendkim<span class="w">  </span><span class="m">339</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w">  </span><span class="m">2022</span><span class="w"> </span>KeyTable
-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>opendkim<span class="w"> </span>opendkim<span class="w"> </span><span class="m">1221</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w">  </span><span class="m">2022</span><span class="w"> </span>SigningTable
-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>opendkim<span class="w"> </span>opendkim<span class="w">  </span><span class="m">378</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">24</span><span class="w">  </span><span class="m">2022</span><span class="w"> </span>TrustedHosts

/etc/opendkim/keys:
total<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<p>If not the same, change the owner from root to opendkim and make sure only opendkim user can read and write to the keys directory.</p>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">chown</span><span class="w"> </span><span class="o">-</span><span class="n">R</span><span class="w"> </span><span class="nl">opendkim</span><span class="p">:</span><span class="n">opendkim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">opendkim</span>

<span class="n">sudo</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="k">go</span><span class="o">-</span><span class="n">rw</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">keys</span>
</code></pre></div>

<h3 id="create-the-signing-table">Create the signing table</h3>
<p>Add two lines to the file. </p>
<p>The first line  tells OpenDKIM that if a sender on your server is using a @your-domain.com address, then it should be signed with the private key identified by default._domainkey.your-domain.com. </p>
<p>The second line tells that your sub-domains will be signed by the private key also.</p>
<p>File: /etc/opendkim/SigningTable</p>
<div class="highlight"><pre><span></span><code><span class="o">*</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w">    </span><span class="k">default</span><span class="p">.</span><span class="n">_domainkey</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="o">*</span><span class="err">@</span><span class="o">*</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w">    </span><span class="k">default</span><span class="p">.</span><span class="n">_domainkey</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>Save and close the file. </p>
<h3 id="create-the-key-table">Create the key table</h3>
<p>Add the following line, defining the location of the private key.</p>
<p>File: /etc/opendkim/KeyTable</p>
<div class="highlight"><pre><span></span><code>default._domainkey.your-domain.com     your-domain.com:default:/etc/opendkim/keys/your-domain.com/default.private
</code></pre></div>

<p>Save and close the file. </p>
<h3 id="create-the-trusted-hosts-file">Create the trusted hosts file</h3>
<p>Tell OpenDKIM if an email is from <em>localhost</em> or the <em>same domain</em>, then <em>only sign the email</em>, and <em>not</em> perform DKIM verification.</p>
<p>File: /etc/opendkim/TrustedHosts</p>
<div class="highlight"><pre><span></span><code><span class="mf">127.0.0.1</span>
<span class="n">localhost</span>

<span class="mf">.</span><span class="n">your</span><span class="o">-</span><span class="n">domain</span><span class="mf">.</span><span class="n">com</span>
</code></pre></div>

<p>Save and close the file.</p>
<blockquote>
<p>Do not add an asterisk to the domain name like this: *.your-domain.com. Put only a dot before the domain name.</p>
</blockquote>
<h2 id="generate-privatepublic-keypair">Generate Private/Public Keypair</h2>
<p>DKIM is used to sign outgoing messages <em>and</em> verify incoming messages, so we need to generate a <em>private key for signing</em> and a <em>public key for remote verifier</em>. Only the public key will be published in DNS.</p>
<h3 id="create-a-separate-folder-for-the-domain">Create a separate folder for the domain.</h3>
<div class="highlight"><pre><span></span><code>sudo mkdir /etc/opendkim/keys/your-domain.com
</code></pre></div>

<h3 id="generate-keys-using-opendkim-genkey-tool">Generate keys using opendkim-genkey tool.</h3>
<blockquote>
<p>You should rotate in new keys every once and a while for protection against private key leaks. Allow seven days before deleting the old keys for existing E-Mails to be delivered.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>sudo opendkim-genkey -b 2048 -d your-domain.com -D /etc/opendkim/keys/your-domain.com -s default -v
opendkim-genkey: generating private key
opendkim-genkey: private key written to default.private
opendkim-genkey: extracting public key
opendkim-genkey: DNS TXT record written to default.txt
</code></pre></div>

<p>The above command will create 2048 bits keys. -d (domain) specifies the domain. -D (directory) specifies the directory where the keys will be stored and we use default as the selector (-s), also known as the name. Once the command is executed, the private key will be written to default.private file and the public key will be written to default.txt file.</p>
<p>Ensure opendkim is the owner of the private key.</p>
<div class="highlight"><pre><span></span><code>sudo chown opendkim:opendkim /etc/opendkim/keys/your-domain.com/default.private
</code></pre></div>

<p>Also change the permission, so only the opendkim user has read and write access to the file.</p>
<div class="highlight"><pre><span></span><code>sudo chmod 600 /etc/opendkim/keys/your-domain.com/default.private
</code></pre></div>

<h2 id="publish-your-public-key-in-dns-records">Publish Your Public Key in DNS Records</h2>
<p>Display the public key</p>
<div class="highlight"><pre><span></span><code>sudo cat /etc/opendkim/keys/your-domain.com/default.txt
default._domainkey  IN  TXT ( &quot;v=DKIM1; k=rsa; &quot;
      &quot;p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAutisB7xnL1B1j88Er2VsEd6WuwifqSThKEcrnlkhnsVhs/UkCd2lHL+dZwivjbfH+4RXIP0LK9shGokPwaA2MHNH3GgAuWZ/Wb6ZrZwqDlmHy+H6Q0/cLsB2Py2HFthq1JUhHW31ZOIqa4qOn2suBntQdizGExHsuMMb1nJpu0lgFJLU848qPQO76QMTcC/TyssiCjLXXSQEsS&quot;
      &quot;Kx0UmeODJ43NKAAS0OqkGBD2UE7/SW54bVpESK32lTIfzk91OdW+zDMzX6myToJtEE9WgOkgD2evSTp02dhKBBRkQvGJ0SF7el34e/smeS+XvodjjOvP2f3qW5cLvrCRByIkFzRwIDAQAB&quot; )  ; ----- DKIM key default for your-domain.com
</code></pre></div>

<p>The string after the p parameter is the public key, it spans two lines in the cat output because the limit per line is 256 characters. It really should be <em>one big long string with no quotes</em>.</p>
<p>In your DNS manager, 
 * create a TXT record, 
 * enter default._domainkey in the name field. 
 * Copy everything between the parentheses and paste it into the value field of the DNS record. Delete all <em>double quotes</em> and <em>white spaces</em> in the value field. Join all the lines into one line.</p>
<p>For Example; look at a recent google e-mail:</p>
<div class="highlight"><pre><span></span><code><span class="nt">X-Google-DKIM-Signature</span><span class="o">:</span><span class="w"> </span><span class="nt">v</span><span class="o">=</span><span class="nt">1</span><span class="o">;</span><span class="w"> </span><span class="nt">a</span><span class="o">=</span><span class="nt">rsa-sha256</span><span class="o">;</span><span class="w"> </span><span class="nt">c</span><span class="o">=</span><span class="nt">relaxed</span><span class="o">/</span><span class="nt">relaxed</span><span class="o">;</span>
<span class="w">        </span><span class="nt">d</span><span class="o">=</span><span class="nt">1e100</span><span class="p">.</span><span class="nc">net</span><span class="o">;</span><span class="w"> </span><span class="nt">s</span><span class="o">=</span><span class="nt">20210112</span><span class="o">;</span><span class="w"> </span><span class="nt">t</span><span class="o">=</span><span class="nt">1677769129</span><span class="o">;</span>
<span class="w">        </span><span class="nt">h</span><span class="o">=</span><span class="nt">to</span><span class="p">:</span><span class="nd">list-unsubscribe</span><span class="p">:</span><span class="nd">user-agent</span><span class="p">:</span><span class="nd">mime-version</span><span class="p">:</span><span class="nd">subject</span><span class="p">:</span><span class="nd">message-id</span><span class="p">:</span><span class="nd">from</span>
<span class="w">         </span><span class="p">:</span><span class="nd">date</span><span class="p">:</span><span class="nd">dkim-signature</span><span class="p">:</span><span class="nd">dkim-signature</span><span class="p">:</span><span class="nd">delivered-to</span><span class="p">:</span><span class="nd">x-gm-message-state</span>
<span class="w">         </span><span class="p">:</span><span class="nd">from</span><span class="p">:</span><span class="nd">to</span><span class="p">:</span><span class="nd">cc</span><span class="p">:</span><span class="nd">subject</span><span class="p">:</span><span class="nd">date</span><span class="p">:</span><span class="nd">message-id</span><span class="p">:</span><span class="nd">reply-to</span><span class="o">;</span>
<span class="w">        </span><span class="nt">bh</span><span class="o">=</span><span class="nt">V22zSr</span><span class="o">/</span><span class="nt">CKU90o7uszazuWVoXgsouLolWaiMhbqvqG8Y</span><span class="o">=;</span>
<span class="w">        </span><span class="nt">b</span><span class="o">=</span><span class="nt">FUH9YP2CWhupcc6eU3hVYigxSWJ2fVJHF1F3DrkJoMb1K3hf9O7vrTWDxqNIOvGmPS</span>
<span class="w">         </span><span class="nt">6sCsgvynVtQ</span><span class="o">+</span><span class="nt">cccVgzc6vZLBYDg3XBdQF6u2hxiMIAAkyPGVUUrYpj</span><span class="o">/</span><span class="nt">OreMj1WkGDkG0</span>
<span class="w">         </span><span class="nt">9yVxpp0UuIK8uyrfswX9zBWT</span><span class="o">/</span><span class="nt">QORjQ4Lfh3KCbzaLX8DbfWoc3P907Ebc8cfvVGDu2wX</span>
<span class="w">         </span><span class="nt">oNBeYjEXb4sywHcVmuUNdg</span><span class="o">//</span><span class="nt">O78sAY5CnSVZ3Gc</span><span class="o">/</span><span class="nt">41</span><span class="o">/</span><span class="nt">pFtNHdCCjQAWSQ</span><span class="o">/</span><span class="nt">W</span><span class="o">/</span><span class="nt">Czfsy2TY</span>
<span class="w">         </span><span class="nt">Ovuebwb71h3VlUpqDIqkaIMZ5rF9pWxqeQgHkIs8Ktgd8CnAhqnk77ZXWk0SR9Q8hkuQ</span>
<span class="w">         </span><span class="o">+</span><span class="nt">BQw</span><span class="o">==</span>
</code></pre></div>

<p>The <em>s</em> and <em>d</em> tags are used to look up the DKIM record. s is the <em>selector</em> while <em>d</em> is the domain.</p>
<p>s=20210112
d=1e100.net</p>
<p>Together they form the DNS lookup string:
<code>20210112._domainkey.1e100.net</code></p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dig<span class="w"> </span>+short<span class="w"> </span>txt<span class="w"> </span><span class="m">20210112</span>._domainkey.1e100.net
<span class="s2">&quot;v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8Sabq+yC2d91PkWTEkjdH2AsaH31YzVJ8PKlQy2GZ9u8vtqfQM88nACYwWAbCQvLwUfCz7hbF/PyM3K/SPlDSk0HqKq89AQjv60br0pK90vWFmzt04ioNcf4QoiJjnnTWD6h5gOM&quot;</span><span class="w"> </span><span class="s2">&quot;ATz4WfdwCrQ9MRF0SjDHteEVeHCK4WKsWKdPshaSLiVfZxiGLv4SZkWye7Zh5iM66MUvYAr3x151AyCQroTNfJY9RN9RK2ZqLdcoulg7S/XMbnzY7EW0P8nPj2jqvMp0bcr13tOzBRnysYiQIu3cjrtyLNfAZobK6tlmy737vkVH27D0rsUrcABrFqvVox61h61JssaRYcwRpwIDAQAB&quot;</span>
</code></pre></div>

<p>Your key lookup should look like:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dig<span class="w"> </span>+short<span class="w"> </span>txt<span class="w"> </span>default._domainkey.your-domain.com
<span class="s2">&quot;v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAutisB7xnL1B1j88Er2VsEd6WuwifqSThKEcrnlkhnsVhs/UkCd2lHL+dZwivjbfH+4RXIP0LK9shGokPwaA2MHNH3GgAuWZ/Wb6ZrZwqDlmHy+H6Q0/cLsB2Py2HFthq1JUhHW31ZOIqa4qOn2suBntQdizGExHsuMMb1nJpu0lgFJLU848qPQO76QMTcC/TyssiCjLXXSQEsS&quot;</span><span class="w"> </span><span class="s2">&quot;Kx0UmeODJ43NKAAS0OqkGBD2UE7/SW54bVpESK32lTIfzk91OdW+zDMzX6myToJtEE9WgOkgD2evSTp02dhKBBRkQvGJ0SF7el34e/smeS+XvodjjOvP2f3qW5cLvrCRByIkFzRwIDAQAB&quot;</span>
</code></pre></div>

<p>Reference: <a href="https://www.cloudflare.com/learning/dns/dns-records/dns-dkim-record/">https://www.cloudflare.com/learning/dns/dns-records/dns-dkim-record/</a></p>
<h2 id="test-dkim-key">Test DKIM Key</h2>
<p>Test your key.</p>
<div class="highlight"><pre><span></span><code>sudo opendkim-testkey -d your-domain.com -s default -vvv
</code></pre></div>

<p>You should see <em>Key OK</em> in the output.</p>
<div class="highlight"><pre><span></span><code>opendkim-testkey: using default configfile /etc/opendkim.conf
opendkim-testkey: checking key &#39;default._domainkey.your-domain.com&#39;
opendkim-testkey: key secure
opendkim-testkey: key OK
</code></pre></div>

<p>Your DKIM record will take some time to propagate to the Internet. </p>
<p>To check, go to <a href="https://www.dmarcanalyzer.com/dkim/dkim-check/">https://www.dmarcanalyzer.com/dkim/dkim-check/</a>, use <em>default</em> as the selector your domain name to check DKIM record propagation.</p>
<h2 id="connect-postfix-to-opendkim">Connect Postfix to OpenDKIM</h2>
<p>Postfix can talk to OpenDKIM via a Unix socket file. It is a good idea to put it where all the other postfix socket files are.</p>
<p>Create the directory OpenDKIM for a socket file and limit is to the opendkim user and postfix group.</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="n">sudo</span><span class="w"> </span><span class="n">mkdir</span><span class="w">                  </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">opendkim</span>
<span class="o">$</span><span class="n">sudo</span><span class="w"> </span><span class="n">chown</span><span class="w"> </span><span class="n">opendkim</span><span class="p">:</span><span class="n">postfix</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">opendkim</span>
</code></pre></div>

<h3 id="set-socket-to-local">Set Socket to local</h3>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code><span class="n">Socket</span><span class="w">    </span><span class="n">local</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">opendkim</span><span class="o">.</span><span class="n">sock</span>
</code></pre></div>

<p>Change the default file as well (if it exists):</p>
<h3 id="add-opendkim-to-postfix-maincf">Add openDKIM to Postfix main.cf</h3>
<blockquote>
<p>milter is a <em>modifier</em> filter</p>
</blockquote>
<p>File: /etc/postfix/main.cf</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> Milter configuration
milter_default_action = accept
milter_protocol = 6
smtpd_milters = local:opendkim/opendkim.sock
non_smtpd_milters = $smtpd_milters
</code></pre></div>

<h3 id="restart-opendkim-and-postfix-service">Restart opendkim and postfix service</h3>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>opendkim<span class="w"> </span>postfix
</code></pre></div>

<h2 id="spf-and-dkim-check">SPF and DKIM Check</h2>
<p>Send a test email to another domain's account, and see if SPF and DKIM checks are passed in the message source.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">dkim</span><span class="o">-</span><span class="n">verifier</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">dkim</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="mi">2048</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="k">key</span><span class="p">)</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">d</span><span class="o">=</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">i</span><span class="o">=</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">b</span><span class="o">=</span><span class="n">yn</span><span class="o">+</span><span class="n">tGP2N</span>
<span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">spf</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">spf</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="n">spf</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">designates</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">permitted</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="n">smtp</span><span class="p">.</span><span class="n">mailfrom</span><span class="o">=</span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>Your email server will <em>also</em> perform SPF and DKIM checks on other domains.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="n">Received</span><span class="o">-</span><span class="nl">SPF</span><span class="p">:</span><span class="w"> </span><span class="n">Pass</span><span class="w"> </span><span class="p">(</span><span class="n">mailfrom</span><span class="p">)</span><span class="w"> </span><span class="k">identity</span><span class="o">=</span><span class="n">mailfrom</span><span class="p">;</span><span class="w"> </span><span class="n">client</span><span class="o">-</span><span class="n">ip</span><span class="o">=</span><span class="mi">1234</span><span class="err">:</span><span class="nl">f8b0</span><span class="p">:</span><span class="mi">5678</span><span class="err">:</span><span class="mi">90</span><span class="o">::</span><span class="mi">372</span><span class="p">;</span><span class="w"> </span><span class="n">helo</span><span class="o">=</span><span class="n">mail</span><span class="o">-</span><span class="n">yw1</span><span class="o">-</span><span class="n">xc2d</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">envelope</span><span class="o">-</span><span class="k">from</span><span class="o">=</span><span class="n">someone</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">receiver</span><span class="o">=&lt;</span><span class="k">UNKNOWN</span><span class="o">&gt;</span><span class="w"> </span>
<span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">you</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">dkim</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="mi">2048</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="k">key</span><span class="p">;</span><span class="w"> </span><span class="n">unprotected</span><span class="p">)</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">d</span><span class="o">=</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">i</span><span class="o">=</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">b</span><span class="o">=</span><span class="ss">&quot;IsoKGudn&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">dkim</span><span class="o">-</span><span class="n">atps</span><span class="o">=</span><span class="n">neutral</span>
</code></pre></div>

<h2 id="postfix-cant-connect-to-opendkim">Postfix Can’t Connect to OpenDKIM</h2>
<p>Check the logs</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>vi<span class="w"> </span>/var/log/mail*
$<span class="w"> </span>sudo<span class="w"> </span>journalctl<span class="w"> </span>-eu<span class="w"> </span>opendkim
</code></pre></div>

<p>If you see this:</p>
<div class="highlight"><pre><span></span><code><span class="k">connect</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">Milter</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">local</span>:<span class="nv">opendkim</span><span class="o">/</span><span class="nv">opendkim</span>.<span class="nv">sock</span>:<span class="w"> </span><span class="nv">No</span><span class="w"> </span><span class="nv">such</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">directory</span>
</code></pre></div>

<p>check the opendkim systemd service.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>opendkim
</code></pre></div>

<p>If opendkim is running, it means Postfix can’t connect to OpenDKIM via the Unix domain socket (local:opendkim/opendkim.sock).</p>
<p>Check the socket file:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/var/spool/postfix/opendkim/opendkim.sock<span class="w"> </span>
srwxrwxr-x<span class="w"> </span><span class="m">1</span><span class="w"> </span>opendkim<span class="w"> </span>opendkim<span class="w"> </span><span class="m">0</span><span class="w"> </span>Mar<span class="w">  </span><span class="m">2</span><span class="w"> </span><span class="m">15</span>:09<span class="w"> </span>/var/spool/postfix/opendkim/opendkim.sock
</code></pre></div>

<p>And postfix user:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>id<span class="w"> </span>postfix
<span class="nv">uid</span><span class="o">=</span><span class="m">89</span><span class="o">(</span>postfix<span class="o">)</span><span class="w"> </span><span class="nv">gid</span><span class="o">=</span><span class="m">89</span><span class="o">(</span>postfix<span class="o">)</span><span class="w"> </span><span class="nv">groups</span><span class="o">=</span><span class="m">89</span><span class="o">(</span>postfix<span class="o">)</span>,12<span class="o">(</span>mail<span class="o">)</span>,988<span class="o">(</span>opendkim<span class="o">)</span>
</code></pre></div>

<p>Be sure the postfix user has group opendkim.</p>
<p>If all else fails, you can configure OpenDKIM to use a TCP/IP socket instead of Unix local socket.</p>
<p>File: /etc/opendkim.conf</p>
<div class="highlight"><pre><span></span><code><span class="n">Socket</span><span class="w">     </span><span class="nl">inet</span><span class="p">:</span><span class="mi">8892</span><span class="nv">@localhost</span>
</code></pre></div>

<p>File: /etc/postfix/main.cf</p>
<div class="highlight"><pre><span></span><code>smtpd_milters = inet:127.0.0.1:8892
</code></pre></div>

<p>Restart OpenDKIM and Postfix.</p>
<div class="highlight"><pre><span></span><code>sudo systemctl restart opendkim postfix
</code></pre></div>

<p>Now Postfix will connect to OpenDKIM via the TCP/IP socket. </p>
<h2 id="configuration-error-in-email-client">Configuration Error in Email Client</h2>
<p>DKIM signing could fail if you <em>do not</em> use STARTTLS or SSL/TLS.</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Port</th>
<th>Encryption</th>
<th>Password</th>
</tr>
</thead>
<tbody>
<tr>
<td>SMTP</td>
<td>587</td>
<td>STARTTLS</td>
<td>Normal</td>
</tr>
<tr>
<td>IMAP</td>
<td>143</td>
<td>STARTTLS</td>
<td>Normal</td>
</tr>
<tr>
<td>SMTP</td>
<td>465</td>
<td>SSL/TLS</td>
<td>Normal</td>
</tr>
<tr>
<td>IMAP</td>
<td>993</td>
<td>SSL/TLS</td>
<td>Normal</td>
</tr>
</tbody>
</table>
<h3 id="wrong-settings">Wrong Settings</h3>
<blockquote>
<p>Port 25 as the SMTP port in mail clients to submit outgoing emails.
No encryption method was selected.</p>
</blockquote>
<h1 id="testing-email-score-and-placement">Testing Email Score and Placement</h1>
<p>Visit Mail-Tester <a href="https://www.mail-tester.com">https://www.mail-tester.com</a> and send an E-Mail to the unique email address displayed on the home page. They will analyze it and return a sender score.</p>
<p>GlockApps <a href="https://glockapps.com/">https://glockapps.com/</a> will show you where your emails are being delivered at Gmail, Outlook, &amp; all major ISPs.</p>
<h1 id="what-is-dmarc">What is DMARC?</h1>
<p>DMARC stands for Domain-based message authentication, reporting and conformance. DMARC is a protcol for protecting your Internet Domain from abuse.</p>
<p>It extends SPF and DKIM using another DNS entry.</p>
<p>Originators of Internet Mail need to be able to associate reliable and authenticated domain identifiers with messages, communicate policies about messages that use those identifiers, and report about mail using those identifiers.  These abilities have several benefits: Receivers can provide feedback to Domain Owners about the use of their domains; this feedback can provide valuable insight about the management of internal operations and the presence of external domain name abuse.</p>
<p>Reference: <a href="https://datatracker.ietf.org/doc/html/rfc7489">https://datatracker.ietf.org/doc/html/rfc7489</a></p>
<h2 id="create-dmarc-record">Create DMARC Record</h2>
<p>DMARC policies are published as a TXT record in DNS.</p>
<ul>
<li>
<p>Before creating a DMARC record, you must first create SPF and DKIM records.</p>
</li>
<li>
<p>Send a test email from your domain, and check the raw email headers at the recipient’s mailbox. 
   Ensure the <em>domain</em> is the same in:</p>
<ul>
<li><em>Return-path: you@domain</em></li>
<li><em>From: you@domain</em> </li>
<li><em>d=domain</em> in the DKIM signature</li>
</ul>
</li>
</ul>
<p>If the 3 domains are identical, then they are aligned.</p>
<p>If <em>Return-Path:</em> or <em>DKIM d=</em> uses a subdomain instead of the main domain name, then this is called relaxed alignment. If no subdomain is used and the main domain names are the same, it’s called strict alignment.</p>
<h3 id="dmarc-record-txt">DMARC Record TXT</h3>
<p>Domain Owner DMARC preferences are stored as DNS TXT records in subdomains named "_dmarc".  For example, the Domain Owner of "example.com" would post DMARC preferences in a TXT record at "_dmarc.example.com".</p>
<p>In your Domain Registration DNS manager add a new <em>TXT</em> record. </p>
<p>Name field:</p>
<div class="highlight"><pre><span></span><code>_dmarc
</code></pre></div>

<p>Value field:</p>
<div class="highlight"><pre><span></span><code><span class="n">v</span><span class="o">=</span><span class="n">DMARC1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="k">none</span><span class="p">;</span><span class="w"> </span><span class="n">pct</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">rua</span><span class="o">=</span><span class="nl">mailto</span><span class="p">:</span><span class="n">dmarc</span><span class="o">-</span><span class="n">reports</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>Definition:</p>
<ul>
<li>v=DMARC1: Version (plain-text; REQUIRED).  Identifies the record retrieved
      as a DMARC record.  It MUST have the value of "DMARC1".</li>
<li>p=none: Requested Mail Receiver policy (plain-text; REQUIRED for policy
      records). </li>
<li>pct=100: (plain-text integer between 0 and 100, inclusive; OPTIONAL;
      default is 100).  Percentage of messages from the Domain Owner's
      mail stream to which the DMARC policy is to be applied. </li>
<li>rua: Addresses to which aggregate feedback is to be sent (comma-
      separated plain-text list of DMARC URIs; OPTIONAL). </li>
</ul>
<p>There are 3 policies you can choose from:</p>
<ul>
<li>none: The Domain Owner requests no specific action be taken
         regarding delivery of messages.</li>
<li>quarantine: The Domain Owner wishes to have email that fails the
         DMARC mechanism check be treated by Mail Receivers as
         suspicious.</li>
<li>reject: The Domain Owner wishes for Mail Receivers to reject
         email that fails the DMARC mechanism check.  Rejection SHOULD
         occur during the SMTP transaction.</li>
</ul>
<p>Another option to consider is: </p>
<ul>
<li>
<p>fo:  Failure reporting options (plain-text; OPTIONAL; default is "0")
      Provides requested options for generation of failure reports.
      Report generators MAY choose to adhere to the requested options.
      This tag's content MUST be ignored if a "ruf" tag (below) is not
      also specified.  The value of this tag is a colon-separated list
      of characters that indicate failure reporting options as follows:</p>
<ul>
<li>
<p>0: Generate a DMARC failure report if all underlying
     authentication mechanisms fail to produce an aligned "pass"
     result.</p>
</li>
<li>
<p>1: Generate a DMARC failure report if any underlying
     authentication mechanism produced something other than an
     aligned "pass" result.</p>
</li>
<li>
<p>d: Generate a DKIM failure report if the message had a signature
     that failed evaluation, regardless of its alignment.  DKIM-
     specific reporting is described in [AFRF-DKIM].</p>
</li>
<li>
<p>s: Generate an SPF failure report if the message failed SPF
     evaluation, regardless of its alignment.  SPF-specific
     reporting is described in [AFRF-SPF].</p>
</li>
</ul>
</li>
<li>
<p>ruf: Addresses to which message-specific failure information is to
      be reported (comma-separated plain-text list of DMARC URIs;
      OPTIONAL).  If present, the Domain Owner is requesting Mail
      Receivers to send detailed failure reports about messages that
      fail the DMARC evaluation in specific ways (see the "fo" tag
      above).</p>
</li>
</ul>
<p>Try fo=1 at first for detailed DMARC failure reports. When you change to a more restrictive policy, use fo=0.</p>
<div class="highlight"><pre><span></span><code><span class="n">v</span><span class="o">=</span><span class="n">DMARC1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="k">none</span><span class="p">;</span><span class="w"> </span><span class="n">pct</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">fo</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">ruf</span><span class="o">=</span><span class="nl">mailto</span><span class="p">:</span><span class="n">dmarc</span><span class="o">-</span><span class="n">reports</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>If you have a domain name that will not send emails, use <code>p=reject</code> policy.</p>
<div class="highlight"><pre><span></span><code>v=DMARC1; p=reject; pct=100;
</code></pre></div>

<h2 id="dmarc-record-check">DMARC Record Check</h2>
<p>You can check your DMARC record from Linux terminal with the following command:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dig<span class="w"> </span>txt<span class="w"> </span>+short<span class="w"> </span>_dmarc.example.com
<span class="s2">&quot;v=DMARC1; p=none; pct=100; rua=mailto:postmaster@your-domain.com&quot;</span>
</code></pre></div>

<p>You can also install opendmarc-check that to check a DMARC record. </p>
<p>Install opendmarc package</p>
<div class="highlight"><pre><span></span><code>sudo apt install opendmarc
</code></pre></div>

<p>It checks DNS and translates the DMARC record to a human readable form.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>opendmarc-check<span class="w"> </span>your-domain.com
DMARC<span class="w"> </span>record<span class="w"> </span><span class="k">for</span><span class="w"> </span>your-domain.com:
<span class="w">    </span>Sample<span class="w"> </span>percentage:<span class="w"> </span><span class="m">100</span>
<span class="w">    </span>DKIM<span class="w"> </span>alignment:<span class="w"> </span>relaxed
<span class="w">    </span>SPF<span class="w"> </span>alignment:<span class="w"> </span>relaxed
<span class="w">    </span>Domain<span class="w"> </span>policy:<span class="w"> </span>none
<span class="w">    </span>Subdomain<span class="w"> </span>policy:<span class="w"> </span>unspecified
<span class="w">    </span>Aggregate<span class="w"> </span>report<span class="w"> </span>URIs:
<span class="w">        </span>mailto:postmaster@your-domain.com
<span class="w">    </span>Failure<span class="w"> </span>report<span class="w"> </span>URIs:
<span class="w">        </span><span class="o">(</span>none<span class="o">)</span>
</code></pre></div>

<h2 id="dmarc-test-e-mail">DMARC Test E-Mail</h2>
<p>Send an email from your domain to another domain's account. If DMARC is configured correctly then you will see <em>dmarc=pass</em> in the <em>Authentication-Results:</em> header.</p>
<div class="highlight"><pre><span></span><code><span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">dmarc</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">dmarc</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="k">from</span><span class="o">=</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">X</span><span class="o">-</span><span class="n">DMARC</span><span class="o">-</span><span class="nl">Info</span><span class="p">:</span><span class="w"> </span><span class="n">pass</span><span class="o">=</span><span class="n">pass</span><span class="p">;</span><span class="w"> </span><span class="n">dmarc</span><span class="o">-</span><span class="n">policy</span><span class="o">=</span><span class="k">none</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="n">r1</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="n">r1</span><span class="p">;</span><span class="w"> </span><span class="n">pdomain</span><span class="o">=</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">X</span><span class="o">-</span><span class="n">DMARC</span><span class="o">-</span><span class="nl">Policy</span><span class="p">:</span><span class="w"> </span><span class="n">v</span><span class="o">=</span><span class="n">DMARC1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="k">none</span><span class="p">;</span><span class="w"> </span><span class="n">pct</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">rua</span><span class="o">=</span><span class="nl">mailto</span><span class="p">:</span><span class="n">postmaster</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">dkim</span><span class="o">-</span><span class="n">verifier</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">dkim</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="mi">2048</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="k">key</span><span class="p">)</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">d</span><span class="o">=</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">i</span><span class="o">=</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">header</span><span class="p">.</span><span class="n">b</span><span class="o">=</span><span class="n">wVFZ</span><span class="o">+</span><span class="mi">19</span><span class="n">t</span>
<span class="n">Authentication</span><span class="o">-</span><span class="nl">Results</span><span class="p">:</span><span class="w"> </span><span class="n">spf</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">spf</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="n">spf</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">designates</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">permitted</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="n">smtp</span><span class="p">.</span><span class="n">mailfrom</span><span class="o">=</span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">Received</span><span class="o">-</span><span class="nl">SPF</span><span class="p">:</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="p">(</span><span class="n">spf</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="n">designates</span><span class="w"> </span><span class="mf">1.2.3.4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">permitted</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="n">receiver</span><span class="o">=</span><span class="n">spf</span><span class="p">.</span><span class="n">icloud</span><span class="p">.</span><span class="n">com</span><span class="p">;</span><span class="w"> </span><span class="n">client</span><span class="o">-</span><span class="n">ip</span><span class="o">=</span><span class="mf">1.2.3.4</span><span class="p">;</span><span class="w"> </span><span class="n">helo</span><span class="o">=</span><span class="n">mail</span><span class="p">.</span><span class="n">your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">org</span><span class="p">;</span><span class="w"> </span><span class="n">envelope</span><span class="o">-</span><span class="k">from</span><span class="o">=</span><span class="n">you</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<h2 id="interpret-a-dmarc-report">Interpret a DMARC Report</h2>
<p>There are two kinds of DMARC reports.</p>
<ul>
<li>Daily XML-based [1] aggregate report generated by Gmail, Yahoo, Hotmail, etc.</li>
<li>Real-time forensic reports (copies of individual pieces of email that fail the DMARC check)</li>
</ul>
<p>Normally you only want to receive the aggregate (rua) report. The data that DMARC produces is invaluable for understanding what is going on for any given email domain. However, raw DMARC report data is super hard to read and understand. </p>
<p>Postmark offers a free service to process these reports. The nice part about Postmark is that you can tell receiving email servers to send XML reports directly to Postmark for processing. So instead of entering your email address in the DMARC record, you enter an email address of postmarkapp.com that is unique to you.</p>
<div class="highlight"><pre><span></span><code><span class="n">v</span><span class="o">=</span><span class="n">DMARC1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="k">none</span><span class="p">;</span><span class="w"> </span><span class="n">pct</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">fo</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">rua</span><span class="o">=</span><span class="nl">mailto</span><span class="p">:</span><span class="k">unique</span><span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="n">you</span><span class="nv">@dmarc</span><span class="p">.</span><span class="n">postmarkapp</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
</code></pre></div>

<p>You can also specify multiple email addresses, separated by commas.</p>
<div class="highlight"><pre><span></span><code><span class="n">v</span><span class="o">=</span><span class="n">DMARC1</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="k">none</span><span class="p">;</span><span class="w"> </span><span class="n">pct</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">fo</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">rua</span><span class="o">=</span><span class="nl">mailto</span><span class="p">:</span><span class="k">unique</span><span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="n">you</span><span class="nv">@dmarc</span><span class="p">.</span><span class="n">postmarkapp</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="nl">mailto</span><span class="p">:</span><span class="n">dmarc</span><span class="o">-</span><span class="n">report</span><span class="nv">@your</span><span class="o">-</span><span class="k">domain</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
</code></pre></div>

<p>After your DMARC record has been verified by Postmark, you will receive a DMARC report weekly every Monday in your email inbox. You don’t need to register an account at Postmark.</p>
<p>Many other firms exist to create DMARC reports. If you are into a lot of E-Mail marketing, you should check some more out.</p>
<ol>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7489#appendix-C">https://datatracker.ietf.org/doc/html/rfc7489#appendix-C</a></li>
</ol>
<p>Reference:</p>
<ul>
<li><a href="https://www.linuxbabe.com/mail-server/create-dmarc-record">https://www.linuxbabe.com/mail-server/create-dmarc-record</a></li>
<li><a href="https://postmarkapp.com">https://postmarkapp.com</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7489#section-7.2">https://datatracker.ietf.org/doc/html/rfc7489#section-7.2</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://lwn.net/">Linux Weekly News</a></li>
                            <li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
                            <li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
                            <li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
                            <li><a href="https://www.thefarside.com/">The Far Side</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://dfcsoftware.github.io/linux-in-house/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://fosstodon.org/@Cohoon">Feedback</a></li>
                            <li><a href="https://fosstodon.org/@Cohoon.rss">Mastodon RSS feed</a></li>
                            <li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
                            <li><a href="/linux-in-house/author/don-cohoon.html">Created by: Don Cohoon</a></li>
                            <li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License </a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>
                Site by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, via <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </p><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                <p> Version:  3.248 </p>
        </footer><!-- /#contentinfo -->

</body>
</html>