<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>PostgreSQLUpgrade</title>
        <link rel="icon" type="image/svg" href="https://dfcsoftware.github.io/linux-in-house/images/favicon.svg">
        <link rel="stylesheet" href="https://dfcsoftware.github.io/linux-in-house/theme/css/main.css" type="text/css" />
        <!-- <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />  -->
        <link href="https://dfcsoftware.github.io/linux-in-house/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Linux Home Administration Atom Feed" />
        <meta name="description" content="PostgreSQL Install and Upgrade Oh my, installing Ubuntu 22.04 installed PostgreSQL 14... wonder what version I am using... Table of Contents..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <table>
                    <td><h1><a href="https://dfcsoftware.github.io/linux-in-house/">Linux Home Administration</a></h1></td>
                    <td> <link href="/linux-in-house/pagefind/pagefind-ui.css" rel="stylesheet" type="text/css">
<script src="/linux-in-house/pagefind/pagefind-ui.js"></script>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script> </td>
                </table>
                <nav><ul>
                    <li class="active"><a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/writing.html">writing</a></li>
                    <li><a href="https://dfcsoftware.github.io/linux-in-house/category/zines.html">zines</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://dfcsoftware.github.io/linux-in-house/postgresqlupgrade.html" rel="bookmark"
           title="Permalink to PostgreSQLUpgrade">PostgreSQLUpgrade</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-01-25T10:20:00-05:00">
                Published: Wed 25 January 2023
        </abbr>
		<br />
        <abbr class="modified" title="2024-04-19T09:30:00-04:00">
                Updated: Fri 19 April 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://dfcsoftware.github.io/linux-in-house/author/don-cohoon.html">Don Cohoon</a>
        </address>
<p>In <a href="https://dfcsoftware.github.io/linux-in-house/category/linux.html">linux</a>.</p>
<p>tags: <a href="https://dfcsoftware.github.io/linux-in-house/tag/systems.html">systems</a> <a href="https://dfcsoftware.github.io/linux-in-house/tag/db.html">db</a> </p>
</footer><!-- /.post-info -->      <h1 id="postgresql-install-and-upgrade">PostgreSQL Install and Upgrade</h1>
<p>Oh my, installing Ubuntu 22.04 installed PostgreSQL 14... wonder what version I am using...</p>
<p><br/></p>
<hr>
<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#postgresql-install-and-upgrade">PostgreSQL Install and Upgrade</a><ul>
<li><a href="#establish-baseline">Establish Baseline</a><ul>
<li><a href="#what-is-installed">What is installed?</a></li>
<li><a href="#which-one-is-live">Which one is live</a></li>
</ul>
</li>
<li><a href="#export-and-import-pg_dump">Export and Import (pg_dump)</a></li>
<li><a href="#do-the-upgrade-pg_upgrade">Do the Upgrade (pg_upgrade)</a></li>
<li><a href="#remove-old-postgresql-install">Remove old postgresql install</a></li>
</ul>
</li>
<li><a href="#binsh">!/bin/sh</a><ul>
<li><a href="#continue">Continue</a></li>
</ul>
</li>
</ul>
</div>
<hr>
<h2 id="establish-baseline">Establish Baseline</h2>
<h4 id="what-is-installed">What is installed?</h4>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_lsclusters<span class="w"> </span>
Ver<span class="w"> </span>Cluster<span class="w"> </span>Port<span class="w"> </span>Status<span class="w">                </span>Owner<span class="w">     </span>Data<span class="w"> </span>directory<span class="w">               </span>Log<span class="w"> </span>file
<span class="m">9</span>.3<span class="w"> </span>main<span class="w">    </span><span class="m">5433</span><span class="w"> </span>down,binaries_missing<span class="w"> </span>&lt;unknown&gt;<span class="w"> </span>/var/lib/postgresql/9.3/main<span class="w"> </span>/var/log/postgresql/postgresql-9.3-main.log
<span class="m">9</span>.5<span class="w"> </span>main<span class="w">    </span><span class="m">5432</span><span class="w"> </span>down,binaries_missing<span class="w"> </span>&lt;unknown&gt;<span class="w"> </span>/var/lib/postgresql/9.5/main<span class="w"> </span>/var/log/postgresql/postgresql-9.5-main.log
<span class="m">10</span><span class="w">  </span>main<span class="w">    </span><span class="m">5434</span><span class="w"> </span>down<span class="w">                  </span>postgres<span class="w">  </span>/var/lib/postgresql/10/main<span class="w">  </span>/var/log/postgresql/postgresql-10-main.log
<span class="m">12</span><span class="w">  </span>main<span class="w">    </span><span class="m">5432</span><span class="w"> </span>online<span class="w">                </span>postgres<span class="w">  </span>/var/lib/postgresql/12/main<span class="w">  </span>/var/log/postgresql/postgresql-12-main.log
<span class="m">14</span><span class="w">  </span>main<span class="w">    </span><span class="m">5435</span><span class="w"> </span>online<span class="w">                </span>postgres<span class="w">  </span>/var/lib/postgresql/14/main<span class="w">  </span>/var/log/postgresql/postgresql-14-main.log
</code></pre></div>

<p>Well now, that's quite a mess. Let's try to clean that up and get current.</p>
<p><em>Binaries:</em></p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>/var/lib/postgresql/
<span class="m">10</span><span class="w">  </span><span class="m">12</span><span class="w">  </span><span class="m">14</span>
</code></pre></div>

<p>So 10,12 and 14 are installed. That matches our pg_lsclusters perl script.</p>
<p><em>Configurations:</em></p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>/etc/postgresql/*
/etc/postgresql/10:
main

/etc/postgresql/12:
main

/etc/postgresql/14:
main

/etc/postgresql/9.3:
main

/etc/postgresql/9.5:
main
</code></pre></div>

<p>Configs are hanging around for 9.3, 9.5, 10, 12, 14</p>
<p><em>Cleaning up:</em>
List of config files</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/etc/postgresql/9.3/main/
total<span class="w"> </span><span class="m">48</span>
-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">   </span><span class="m">315</span><span class="w"> </span>Apr<span class="w"> </span><span class="m">18</span><span class="w">  </span><span class="m">2015</span><span class="w"> </span>environment
-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">   </span><span class="m">143</span><span class="w"> </span>Apr<span class="w"> </span><span class="m">18</span><span class="w">  </span><span class="m">2015</span><span class="w"> </span>pg_ctl.conf
-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">  </span><span class="m">4970</span><span class="w"> </span>Jun<span class="w">  </span><span class="m">4</span><span class="w">  </span><span class="m">2016</span><span class="w"> </span>pg_hba.conf
-rw-r-----<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">  </span><span class="m">1636</span><span class="w"> </span>Apr<span class="w"> </span><span class="m">18</span><span class="w">  </span><span class="m">2015</span><span class="w"> </span>pg_ident.conf
-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">20816</span><span class="w"> </span>Mar<span class="w">  </span><span class="m">9</span><span class="w">  </span><span class="m">2018</span><span class="w"> </span>postgresql.conf
-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">   </span><span class="m">382</span><span class="w"> </span>Mar<span class="w">  </span><span class="m">9</span><span class="w">  </span><span class="m">2018</span><span class="w"> </span>start.conf
</code></pre></div>

<p>What was the data directory for v 9.3?</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>grep<span class="w"> </span>data_directory<span class="w"> </span>/etc/postgresql/9.3/main/postgresql.conf<span class="w"> </span>
<span class="nv">data_directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/var/lib/postgresql/9.3/main&#39;</span><span class="w">     </span><span class="c1"># use data in another directory</span>
</code></pre></div>

<p>Is it empty?</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/var/lib/postgresql/9.3/main
ls:<span class="w"> </span>cannot<span class="w"> </span>access<span class="w"> </span><span class="s1">&#39;/var/lib/postgresql/9.3/main&#39;</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</code></pre></div>

<p>Then it is ok to remove~</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dpkg<span class="w"> </span>-l<span class="p">|</span>grep<span class="w"> </span><span class="s1">&#39;postgresql.*.9&#39;</span>
</code></pre></div>

<p>Packages are long gone, just remove left overs.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/run/postgresql/9.3/
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/postgresql/9.3/
$<span class="w"> </span>sudo<span class="w">             </span>rm<span class="w"> </span>-rf<span class="w"> </span>/usr/lib/postgresql/9.3/
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/etc/postgresql/9.3/
</code></pre></div>

<p>(repeat for 9.5)</p>
<p>Version 10 is installed, but down as per pg_lsclusters.
Check v10:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>grep<span class="w"> </span>data_directory<span class="w"> </span>/etc/postgresql/10/main/postgresql.conf<span class="w"> </span>
<span class="nv">data_directory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/var/lib/postgresql/10/main&#39;</span><span class="w">      </span><span class="c1"># use data in another directory</span>

$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/var/lib/postgresql/10/main
total<span class="w"> </span><span class="m">80</span>
drwx------<span class="w"> </span><span class="m">8</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w">  </span><span class="m">1</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>base
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">14</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>global
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_commit_ts
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_dynshmem
drwx------<span class="w"> </span><span class="m">4</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">14</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>pg_logical
drwx------<span class="w"> </span><span class="m">4</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_multixact
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">14</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>pg_notify
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_replslot
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_serial
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_snapshots
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">14</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>pg_stat
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_stat_tmp
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_subtrans
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_tblspc
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_twophase
-rw-------<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">    </span><span class="m">3</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>PG_VERSION
drwx------<span class="w"> </span><span class="m">3</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w">  </span><span class="m">6</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>pg_wal
drwx------<span class="w"> </span><span class="m">2</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>pg_xact
-rw-------<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">   </span><span class="m">88</span><span class="w"> </span>Dec<span class="w"> </span><span class="m">31</span><span class="w">  </span><span class="m">2019</span><span class="w"> </span>postgresql.auto.conf
-rw-------<span class="w"> </span><span class="m">1</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w">  </span><span class="m">170</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">14</span><span class="w">  </span><span class="m">2020</span><span class="w"> </span>postmaster.opts
</code></pre></div>

<p>Yep, havn't been touched in three+ years</p>
<p>Which one <em>is</em> running?</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>/var/run/postgresql/
<span class="m">12</span>-main.pg_stat_tmp<span class="w">  </span><span class="m">12</span>-main.pid<span class="w">  </span><span class="m">14</span>-main.pg_stat_tmp<span class="w">  </span><span class="m">14</span>-main.pid
</code></pre></div>

<p>Again, this matches pg_lsclusters.</p>
<p>Any open ports?</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>grep<span class="w"> </span>port<span class="w"> </span>/etc/postgresql/10/main/postgresql.conf<span class="w"> </span>
<span class="nv">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5434</span><span class="w">             </span><span class="c1"># (change requires restart)</span>
<span class="w">                    </span><span class="c1"># supported by the operating system:</span>
<span class="w">                    </span><span class="c1"># supported by the operating system:</span>
<span class="w">                    </span><span class="c1">#   %r = remote host and port</span>

$<span class="w"> </span>nmap<span class="w"> </span>localhost<span class="w">  </span>-p<span class="w"> </span><span class="m">5434</span>
Starting<span class="w"> </span>Nmap<span class="w"> </span><span class="m">7</span>.80<span class="w"> </span><span class="o">(</span><span class="w"> </span>https://nmap.org<span class="w"> </span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span><span class="m">2023</span>-01-30<span class="w"> </span><span class="m">10</span>:34<span class="w"> </span>EST
Nmap<span class="w"> </span>scan<span class="w"> </span>report<span class="w"> </span><span class="k">for</span><span class="w"> </span>localhost<span class="w"> </span><span class="o">(</span><span class="m">127</span>.0.0.1<span class="o">)</span>
Host<span class="w"> </span>is<span class="w"> </span>up<span class="w"> </span><span class="o">(</span><span class="m">0</span>.000082s<span class="w"> </span>latency<span class="o">)</span>.

PORT<span class="w">     </span>STATE<span class="w">  </span>SERVICE
<span class="m">5434</span>/tcp<span class="w"> </span>closed<span class="w"> </span>sgi-arrayd

Nmap<span class="w"> </span><span class="k">done</span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>IP<span class="w"> </span>address<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>host<span class="w"> </span>up<span class="o">)</span><span class="w"> </span>scanned<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.03<span class="w"> </span>seconds
</code></pre></div>

<p>Good, port is <em>closed</em> for version 10 of postgresql. No one could be possibly using it, and the database files have not been touched in over 3 years. (Call me parinoid, but I have been burned before.)</p>
<p>Then it is ok to remove~</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dpkg<span class="w"> </span>-l<span class="p">|</span>grep<span class="w"> </span><span class="s1">&#39;postgresql.*.10&#39;</span>
ii<span class="w">  </span>postgresql-10<span class="w">                                 </span><span class="m">10</span>.12-0ubuntu0.18.04.1<span class="w">                       </span>amd64<span class="w">        </span>object-relational<span class="w"> </span>SQL<span class="w"> </span>database,<span class="w"> </span>version<span class="w"> </span><span class="m">10</span><span class="w"> </span>server
ii<span class="w">  </span>postgresql-client-10<span class="w">                          </span><span class="m">10</span>.12-0ubuntu0.18.04.1<span class="w">                       </span>amd64<span class="w">        </span>front-end<span class="w"> </span>programs<span class="w"> </span><span class="k">for</span><span class="w"> </span>PostgreSQL<span class="w"> </span><span class="m">10</span>
ii<span class="w">  </span>postgresql-doc-10<span class="w">                             </span><span class="m">10</span>.12-0ubuntu0.18.04.1<span class="w">                       </span>all<span class="w">          </span>documentation<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>PostgreSQL<span class="w"> </span>database<span class="w"> </span>management<span class="w"> </span>system
ii<span class="w">  </span>postgresql-server-dev-10<span class="w">                      </span><span class="m">10</span>.12-0ubuntu0.18.04.1<span class="w">                       </span>amd64<span class="w">        </span>development<span class="w"> </span>files<span class="w"> </span><span class="k">for</span><span class="w"> </span>PostgreSQL<span class="w"> </span><span class="m">10</span><span class="w"> </span>server-side<span class="w"> </span>programming
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>purge<span class="w"> </span>postgresql-10<span class="w"> </span>postgresql-client-10<span class="w"> </span>postgresql-doc-10<span class="w"> </span>postgresql-server-dev-10
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/run/postgresql/10/
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/postgresql/10/
$<span class="w"> </span>sudo<span class="w">             </span>rm<span class="w"> </span>-rf<span class="w"> </span>/usr/lib/postgresql/10/
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/etc/postgresql/10/
</code></pre></div>

<p>Checking the pg_lsclusters once more</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_lsclusters<span class="w"> </span>
Ver<span class="w"> </span>Cluster<span class="w"> </span>Port<span class="w"> </span>Status<span class="w"> </span>Owner<span class="w">    </span>Data<span class="w"> </span>directory<span class="w">              </span>Log<span class="w"> </span>file
<span class="m">12</span><span class="w">  </span>main<span class="w">    </span><span class="m">5432</span><span class="w"> </span>online<span class="w"> </span>postgres<span class="w"> </span>/var/lib/postgresql/12/main<span class="w"> </span>/var/log/postgresql/postgresql-12-main.log
<span class="m">14</span><span class="w">  </span>main<span class="w">    </span><span class="m">5435</span><span class="w"> </span>online<span class="w"> </span>postgres<span class="w"> </span>/var/lib/postgresql/14/main<span class="w"> </span>/var/log/postgresql/postgresql-14-main.log
</code></pre></div>

<h3 id="which-one-is-live">Which one is live</h3>
<p>Ahhh yes, much better now. Let's see where is the live database in use.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql
psql<span class="w"> </span><span class="o">(</span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">)</span>,<span class="w"> </span>server<span class="w"> </span><span class="m">12</span>.12<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">12</span>.12-0ubuntu0.20.04.1<span class="o">))</span>
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>The banner of psql tells us the executiable psql is version 14.6, while the server is 12.12.
Also notice the <em>current</em> excutable path is postgresql version 14.</p>
<p>Which database is actually running?</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ps<span class="w"> </span>-jH<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>u<span class="w"> </span>
USER<span class="w">         </span>PID<span class="w">    </span>PGID<span class="w">     </span>SID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
postgres<span class="w">    </span><span class="m">1645</span><span class="w">    </span><span class="m">1645</span><span class="w">    </span><span class="m">1645</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.1<span class="w"> </span><span class="m">248112</span><span class="w"> </span><span class="m">19972</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">5</span>:27<span class="w"> </span>/usr/lib/postgresql/12/bin/postgres<span class="w"> </span>-D<span class="w"> </span>/var/lib/post
postgres<span class="w">    </span><span class="m">1789</span><span class="w">    </span><span class="m">1789</span><span class="w">    </span><span class="m">1789</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">248216</span><span class="w">  </span><span class="m">4252</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">12</span>/main:<span class="w"> </span>checkpointer<span class="w">   </span>
postgres<span class="w">    </span><span class="m">1791</span><span class="w">    </span><span class="m">1791</span><span class="w">    </span><span class="m">1791</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">248112</span><span class="w">  </span><span class="m">3808</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:20<span class="w">   </span>postgres:<span class="w"> </span><span class="m">12</span>/main:<span class="w"> </span>background<span class="w"> </span>writer<span class="w">   </span>
postgres<span class="w">    </span><span class="m">1793</span><span class="w">    </span><span class="m">1793</span><span class="w">    </span><span class="m">1793</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">248112</span><span class="w">  </span><span class="m">4364</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:20<span class="w">   </span>postgres:<span class="w"> </span><span class="m">12</span>/main:<span class="w"> </span>walwriter<span class="w">   </span>
postgres<span class="w">    </span><span class="m">1795</span><span class="w">    </span><span class="m">1795</span><span class="w">    </span><span class="m">1795</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">248796</span><span class="w">  </span><span class="m">6748</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:37<span class="w">   </span>postgres:<span class="w"> </span><span class="m">12</span>/main:<span class="w"> </span>autovacuum<span class="w"> </span>launcher<span class="w">   </span>
postgres<span class="w">    </span><span class="m">1796</span><span class="w">    </span><span class="m">1796</span><span class="w">    </span><span class="m">1796</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">102752</span><span class="w">  </span><span class="m">4012</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">1</span>:34<span class="w">   </span>postgres:<span class="w"> </span><span class="m">12</span>/main:<span class="w"> </span>stats<span class="w"> </span>collector<span class="w">   </span>
postgres<span class="w">    </span><span class="m">1798</span><span class="w">    </span><span class="m">1798</span><span class="w">    </span><span class="m">1798</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">248656</span><span class="w">  </span><span class="m">4684</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">12</span>/main:<span class="w"> </span>logical<span class="w"> </span>replication<span class="w"> </span>launcher<span class="w">   </span>
postgres<span class="w">    </span><span class="m">1564</span><span class="w">    </span><span class="m">1564</span><span class="w">    </span><span class="m">1564</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.1<span class="w"> </span><span class="m">218008</span><span class="w"> </span><span class="m">20920</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:20<span class="w"> </span>/usr/lib/postgresql/14/bin/postgres<span class="w"> </span>-D<span class="w"> </span>/var/lib/post
postgres<span class="w">    </span><span class="m">1762</span><span class="w">    </span><span class="m">1762</span><span class="w">    </span><span class="m">1762</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218128</span><span class="w">  </span><span class="m">5964</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>checkpointer<span class="w"> </span>
postgres<span class="w">    </span><span class="m">1763</span><span class="w">    </span><span class="m">1763</span><span class="w">    </span><span class="m">1763</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218008</span><span class="w">  </span><span class="m">4080</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:10<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>background<span class="w"> </span>writer<span class="w"> </span>
postgres<span class="w">    </span><span class="m">1764</span><span class="w">    </span><span class="m">1764</span><span class="w">    </span><span class="m">1764</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218008</span><span class="w">  </span><span class="m">4664</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:10<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>walwriter<span class="w"> </span>
postgres<span class="w">    </span><span class="m">1765</span><span class="w">    </span><span class="m">1765</span><span class="w">    </span><span class="m">1765</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218548</span><span class="w">  </span><span class="m">6576</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:09<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>autovacuum<span class="w"> </span>launcher<span class="w"> </span>
postgres<span class="w">    </span><span class="m">1766</span><span class="w">    </span><span class="m">1766</span><span class="w">    </span><span class="m">1766</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">72600</span><span class="w">  </span><span class="m">3668</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:10<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>stats<span class="w"> </span>collector<span class="w"> </span>
postgres<span class="w">    </span><span class="m">1767</span><span class="w">    </span><span class="m">1767</span><span class="w">    </span><span class="m">1767</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218444</span><span class="w">  </span><span class="m">4968</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span>Jan13<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>logical<span class="w"> </span>replication<span class="w"> </span>launcher<span class="w"> </span>
</code></pre></div>

<p>Both! <slap face></p>
<p>More information on the <em>current</em> database <em>software</em> can be found with <code>pg_config</code></p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pg_config<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>VERSION
<span class="nv">VERSION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>PostgreSQL<span class="w"> </span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">)</span>
</code></pre></div>

<p>The executable winner is v14. What about our database?</p>
<p>Remember the port number?</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_lsclusters<span class="w"> </span>
Ver<span class="w"> </span>Cluster<span class="w"> </span>Port<span class="w"> </span>Status<span class="w"> </span>Owner<span class="w">    </span>Data<span class="w"> </span>directory<span class="w">              </span>Log<span class="w"> </span>file
<span class="m">12</span><span class="w">  </span>main<span class="w">    </span><span class="m">5432</span><span class="w"> </span>online<span class="w"> </span>postgres<span class="w"> </span>/var/lib/postgresql/12/main<span class="w"> </span>/var/log/postgresql/postgresql-12-main.log
<span class="m">14</span><span class="w">  </span>main<span class="w">    </span><span class="m">5435</span><span class="w"> </span>online<span class="w"> </span>postgres<span class="w"> </span>/var/lib/postgresql/14/main<span class="w"> </span>/var/log/postgresql/postgresql-14-main.log
</code></pre></div>

<p>The port number for v14 is 5435.
Check v14 databases:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql<span class="w"> </span>-p<span class="w"> </span><span class="m">5435</span>
psql<span class="w"> </span><span class="o">(</span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">))</span>
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># \l</span>
<span class="w">                                  </span>List<span class="w"> </span>of<span class="w"> </span>databases
<span class="w">   </span>Name<span class="w">    </span><span class="p">|</span><span class="w">  </span>Owner<span class="w">   </span><span class="p">|</span><span class="w"> </span>Encoding<span class="w"> </span><span class="p">|</span><span class="w">   </span>Collate<span class="w">   </span><span class="p">|</span><span class="w">    </span>Ctype<span class="w">    </span><span class="p">|</span><span class="w">   </span>Access<span class="w"> </span>privileges<span class="w">   </span>
-----------+----------+----------+-------------+-------------+-----------------------
<span class="w"> </span>postgres<span class="w">  </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>
<span class="w"> </span>template0<span class="w"> </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">=</span>c/postgres<span class="w">          </span>+
<span class="w">           </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w"> </span><span class="nv">postgres</span><span class="o">=</span>CTc/postgres
<span class="w"> </span>template1<span class="w"> </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">=</span>c/postgres<span class="w">          </span>+
<span class="w">           </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w"> </span><span class="nv">postgres</span><span class="o">=</span>CTc/postgres
<span class="o">(</span><span class="m">3</span><span class="w"> </span>rows<span class="o">)</span>

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>The port number for v12 is 5432:
Check v12 databases:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql<span class="w"> </span>-p<span class="w"> </span><span class="m">5432</span>
psql<span class="w"> </span><span class="o">(</span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">)</span>,<span class="w"> </span>server<span class="w"> </span><span class="m">12</span>.12<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">12</span>.12-0ubuntu0.20.04.1<span class="o">))</span>
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># \l</span>
<span class="w">                                      </span>List<span class="w"> </span>of<span class="w"> </span>databases
<span class="w">        </span>Name<span class="w">        </span><span class="p">|</span><span class="w">  </span>Owner<span class="w">   </span><span class="p">|</span><span class="w"> </span>Encoding<span class="w"> </span><span class="p">|</span><span class="w">   </span>Collate<span class="w">   </span><span class="p">|</span><span class="w">    </span>Ctype<span class="w">    </span><span class="p">|</span><span class="w">   </span>Access<span class="w"> </span>privileges<span class="w">   </span>
--------------------+----------+----------+-------------+-------------+-----------------------
<span class="w"> </span>contrib_regression<span class="w"> </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>
<span class="w"> </span>owncloud<span class="w">           </span><span class="p">|</span><span class="w"> </span>mycloud<span class="w">  </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>
<span class="w"> </span>postgres<span class="w">           </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>
<span class="w"> </span>roundcube<span class="w">          </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>
<span class="w"> </span>template0<span class="w">          </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">=</span>c/postgres<span class="w">          </span>+
<span class="w">                    </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w"> </span><span class="nv">postgres</span><span class="o">=</span>CTc/postgres
<span class="w"> </span>template1<span class="w">          </span><span class="p">|</span><span class="w"> </span>postgres<span class="w"> </span><span class="p">|</span><span class="w"> </span>UTF8<span class="w">     </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span>en_US.UTF-8<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">=</span>c/postgres<span class="w">          </span>+
<span class="w">                    </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w"> </span><span class="nv">postgres</span><span class="o">=</span>CTc/postgres
<span class="o">(</span><span class="m">6</span><span class="w"> </span>rows<span class="o">)</span>

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p>I see owncloud and roundcube databases on v12, but not v14. So I have to decide; I want to upgrade v12 to 14, and v14 has nothing I need.</p>
<p>Two ways to go:
* pg_dump [1] v12 data, then load into v14
* pg_upgrade [2] cluster v12 to v14</p>
<ol>
<li><a href="https://www.postgresql.org/docs/current/app-pgdump.html">https://www.postgresql.org/docs/current/app-pgdump.html</a></li>
<li><a href="https://www.postgresql.org/docs/current/pgupgrade.html">https://www.postgresql.org/docs/current/pgupgrade.html</a></li>
</ol>
<h2 id="export-and-import-pg_dump">Export and Import (pg_dump)</h2>
<p>Our first example will focus on the roundcube database.</p>
<p>First take the application down</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>apache2
</code></pre></div>

<ol>
<li>pg_dump saves the data and schema (port 5432; v12)</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_dump<span class="w"> </span>-p<span class="w"> </span><span class="m">5432</span><span class="w"> </span>-d<span class="w"> </span>roundcube<span class="w"> </span>-f<span class="w"> </span>/tmp/roundcube_upgrade.sql
</code></pre></div>

<ol>
<li>create a new database in the new version (port 5435; v14)</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>createdb<span class="w"> </span>-p<span class="w"> </span><span class="m">5435</span><span class="w"> </span>roundcube
</code></pre></div>

<ol>
<li>Check for alternate tablespace and create it in the new db as needed:</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>tablespace<span class="w"> </span>/etc/postgresql/12/main/postgresql.conf<span class="w"> </span>
<span class="c1">#default_tablespace = &#39;&#39;        # a tablespace name, &#39;&#39; uses the default</span>
<span class="c1">#temp_tablespaces = &#39;&#39;          # a list of tablespace names, &#39;&#39; uses</span>
<span class="w">                    </span><span class="c1"># only default tablespace</span>

$<span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>tablespace<span class="w"> </span>/tmp/roundcube_upgrade.sql<span class="w"> </span>
SET<span class="w"> </span><span class="nv">default_tablespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</code></pre></div>

<p>Create <em>if needed</em> in the new v14 cluster</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>-p<span class="w"> </span><span class="m">5435</span>
postgres#<span class="w"> </span>create<span class="w"> </span>tablespace<span class="w"> </span><span class="s1">&#39;your_tablespace&#39;</span><span class="w"> </span>location<span class="w"> </span><span class="s1">&#39;your_tablespace_location&#39;</span>
postgres#<span class="w"> </span><span class="se">\q</span>
</code></pre></div>

<ol>
<li>At last reload the dump file:</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql<span class="w"> </span>-p<span class="w"> </span><span class="m">5435</span><span class="w"> </span>-d<span class="w"> </span>roundcube<span class="w"> </span>-f<span class="w"> </span>/tmp/roundcube_upgrade.sql<span class="w"> </span>&gt;/rmp/roundcube_upgrade.log
</code></pre></div>

<p>Ooops~ Role is missing~</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>error<span class="w"> </span>/tmp/roundcube_upgrade.log
psql:/tmp/roundcube_upgrade.sql:35:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:50:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:66:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:79:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:93:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:106:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:121:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:135:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:155:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:169:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:182:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:198:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:212:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:234:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:248:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:263:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:277:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:291:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:303:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:322:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
psql:/tmp/roundcube_upgrade.sql:336:<span class="w"> </span>ERROR:<span class="w">  </span>role<span class="w"> </span><span class="s2">&quot;roundcube&quot;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist
</code></pre></div>

<p>Get attributes from the old database</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql<span class="w"> </span>-p<span class="w"> </span><span class="m">5432</span><span class="w"> </span>-d<span class="w"> </span>roundcube
psql<span class="w"> </span><span class="o">(</span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">)</span>,<span class="w"> </span>server<span class="w"> </span><span class="m">12</span>.12<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">12</span>.12-0ubuntu0.20.04.1<span class="o">))</span>
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>help.

<span class="nv">roundcube</span><span class="o">=</span><span class="c1"># \du+ roundcube</span>
<span class="w">                  </span>List<span class="w"> </span>of<span class="w"> </span>roles
<span class="w"> </span>Role<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>Attributes<span class="w"> </span><span class="p">|</span><span class="w"> </span>Member<span class="w"> </span>of<span class="w"> </span><span class="p">|</span><span class="w"> </span>Description<span class="w"> </span>
-----------+------------+-----------+-------------
<span class="w"> </span>roundcube<span class="w"> </span><span class="p">|</span><span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="o">{}</span><span class="w">        </span><span class="p">|</span><span class="w"> </span>

<span class="nv">roundcube</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<blockquote>
<p>User is just a fancy name for role.</p>
</blockquote>
<p>Add to new database. </p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql<span class="w"> </span>-p<span class="w"> </span><span class="m">5435</span>
psql<span class="w"> </span><span class="o">(</span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">))</span>
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c1"># create user roundcube;</span>
CREATE<span class="w"> </span>ROLE
</code></pre></div>

<p>Re-apply grant statements from pg_dump sql. The commands are at the line numbers above, and we can grep for these commands:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39; OWNER TO roundcube&#39;</span><span class="w">  </span>/tmp/roundcube_upgrade.sql<span class="w"> </span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_index<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_messages<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_shared<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_thread<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contactgroupmembers<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contactgroups<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contactgroups_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contacts<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contacts_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.dictionary<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.filestore<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.filestore_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.identities<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.identities_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.searches<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.searches_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.session<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.system<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.users<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.users_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
</code></pre></div>

<p>Then copy/paste them into v14 database:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>psql<span class="w"> </span>-p<span class="w"> </span><span class="m">5435</span><span class="w"> </span>-d<span class="w"> </span>roundcube
psql<span class="w"> </span><span class="o">(</span><span class="m">14</span>.6<span class="w"> </span><span class="o">(</span>Ubuntu<span class="w"> </span><span class="m">14</span>.6-0ubuntu0.22.04.1<span class="o">))</span>
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>help.

<span class="nv">roundcube</span><span class="o">=</span><span class="c1"># </span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_index<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_messages<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_shared<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.cache_thread<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contactgroupmembers<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contactgroups<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contactgroups_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contacts<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.contacts_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.dictionary<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.filestore<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.filestore_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.identities<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.identities_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.searches<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.searches_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.session<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.system<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.users<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE<span class="w"> </span>public.users_seq<span class="w"> </span>OWNER<span class="w"> </span>TO<span class="w"> </span>roundcube<span class="p">;</span>
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
ALTER<span class="w"> </span>TABLE
<span class="nv">roundcube</span><span class="o">=</span><span class="c1"># \q</span>
</code></pre></div>

<p><em>Finished!</em></p>
<p>Of course you need to test the app, but that's another story.</p>
<h2 id="do-the-upgrade-pg_upgrade">Do the Upgrade (pg_upgrade)</h2>
<p>This consists of upgrading the whole <em>cluster</em>. That takes every database in v12 to v14.</p>
<blockquote>
<p>The new cluster must <em>not</em> contain user databases with the same name. If you are following along, drop the <em>new</em> roundcube database on v14.</p>
<p>Check for required libraries, or else it will fail with this error:</p>
<p>Your installation references loadable libraries that are missing from the
new installation.  You can add these libraries to the new installation,
or remove the functions using them from the old installation.  A list of
problem libraries is in the file:
    loadable_libraries.txt</p>
<p>Failure, exiting
<code>$ cat loadable_libraries.txt
could not load library "$libdir/plv8-2.3.13": ERROR:  could not access file "$libdir/plv8-2.3.13": No such file or directory
In database: postgres</code></p>
<p>Fix:
<code>postgres=# drop extension plv8 cascade;;
NOTICE:  drop cascades to function plv8_test(text[],text[])
DROP EXTENSION</code>
</p>
</blockquote>
<p>First gather some information.</p>
<p>Executable directories:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pg_config<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>BINDIR
<span class="nv">BINDIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/lib/postgresql/14/bin

$<span class="w"> </span>ls<span class="w"> </span>-ld<span class="w"> </span>/usr/lib/postgresql/*/bin
drwxr-xr-x<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">06</span>:01<span class="w"> </span>/usr/lib/postgresql/12/bin
drwxr-xr-x<span class="w"> </span><span class="m">2</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">18</span>:12<span class="w"> </span>/usr/lib/postgresql/14/bin
</code></pre></div>

<p>Config directories:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pg_config<span class="p">|</span>grep<span class="w"> </span>SYSCONFDIR
<span class="nv">SYSCONFDIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/etc/postgresql-common

$<span class="w"> </span>ls<span class="w"> </span>-ld<span class="w"> </span>/etc/postgresql/*/main/
drwxr-xr-x<span class="w"> </span><span class="m">3</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:55<span class="w"> </span>/etc/postgresql/12/main/
drwxr-xr-x<span class="w"> </span><span class="m">3</span><span class="w"> </span>postgres<span class="w"> </span>postgres<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Sep<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">15</span>:32<span class="w"> </span>/etc/postgresql/14/main/
</code></pre></div>

<ol>
<li>First take the application and <em>both</em> database clusters down down:
   ```
   $ sudo systemctl disable apache2</li>
</ol>
<p>$ sudo systemctl stop postgresql@12-main</p>
<p>$ sudo systemctl stop postgresql@14-main</p>
<p>$ sudo -u postgres pg_lsclusters 
   Ver Cluster Port Status Owner    Data directory              Log file
   12  main    5432 down   postgres /var/lib/postgresql/12/main /var/log/postgresql/postgresql-12-main.log
   14  main    5435 down   postgres /var/lib/postgresql/14/main /var/log/postgresql/postgresql-14-main.log</p>
<p>$ ps -jH -U postgres -u postgres u 
   USER         PID    PGID     SID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
   ```</p>
<ol>
<li>pg_upgrade is the animal of choice. Log into a shell of the postgres user and change to a writeable directory, it will create a log file (pg_upgrade_internal.log) there.</li>
</ol>
<p>```
   $ sudo -u postgres bash
   $ cd ~
   $ pwd
   /var/lib/postgresql</p>
<p>$ id
   uid=136(postgres) gid=143(postgres) groups=143(postgres)
   ```</p>
<blockquote>
<p>-link will not copy the data files, just make a hard filesystem link [1] from the existing directory to the new <code>data_directory</code> specified in the <code>/etc/postgresql/*/main/postgresql.conf</code> file. This is useful for very large databases. </p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">*</span> -b : old PostgreSQL executable directory
<span class="k">*</span> -B : new PostgreSQL executable directory
<span class="k">*</span> -d : old database cluster configuration directory
<span class="k">*</span> -D : new database cluster configuration directory
</code></pre></div>

<p><code>$ /usr/lib/postgresql/14/bin/pg_upgrade \
          -b /usr/lib/postgresql/12/bin/  -B /usr/lib/postgresql/14/bin/ \
          -d /etc/postgresql/12/main/     -D /etc/postgresql/14/main/    \
          --link</code></p>
<p>Output:
   ```
   $ /usr/lib/postgresql/14/bin/pg_upgrade           -b /usr/lib/postgresql/12/bin/  -B /usr/lib/postgresql/14/bin/           -d /etc/postgresql/12/main/     -D /etc/postgresql/14/main/              --link
   Finding the real data directory for the source cluster      ok
   Finding the real data directory for the target cluster      ok
   Performing Consistency Checks</p>
<hr>
<p>Checking cluster versions                                   ok
   Checking database user is the install user                  ok
   Checking database connection settings                       ok
   Checking for prepared transactions                          ok
   Checking for system-defined composite types in user tables  ok
   Checking for reg* data types in user tables                 ok
   Checking for contrib/isn with bigint-passing mismatch       ok
   Checking for user-defined encoding conversions              ok
   Checking for user-defined postfix operators                 ok
   Checking for incompatible polymorphic functions             ok
   Creating dump of global objects                             ok
   Creating dump of database schemas
                                                               ok
   Checking for presence of required libraries                 ok
   Checking database user is the install user                  ok
   Checking for prepared transactions                          ok
   Checking for new cluster tablespace directories             ok</p>
<p>If pg_upgrade fails after this point, you must re-initdb the
   new cluster before continuing.</p>
<p>Performing Upgrade</p>
<hr>
<p>Analyzing all rows in the new cluster                       ok
   Freezing all rows in the new cluster                        ok
   Deleting files from new pg_xact                             ok
   Copying old pg_xact to new server                           ok
   Setting oldest XID for new cluster                          ok
   Setting next transaction ID and epoch for new cluster       ok
   Deleting files from new pg_multixact/offsets                ok
   Copying old pg_multixact/offsets to new server              ok
   Deleting files from new pg_multixact/members                ok
   Copying old pg_multixact/members to new server              ok
   Setting next multixact ID and offset for new cluster        ok
   Resetting WAL archives                                      ok
   Setting frozenxid and minmxid counters in new cluster       ok
   Restoring global objects in the new cluster                 ok
   Restoring database schemas in the new cluster
                                                               ok
   Adding ".old" suffix to old global/pg_control               ok</p>
<p>If you want to start the old cluster, you will need to remove
   the ".old" suffix from /var/lib/postgresql/12/main/global/pg_control.old.
   Because "link" mode was used, the old cluster cannot be safely
   started once the new cluster has been started.</p>
<p>Linking user relation files
                                                               ok
   Setting next OID for new cluster                            ok
   Sync data directory to disk                                 ok
   Creating script to delete old cluster                       ok
   Checking for extension updates                              ok</p>
<p>Upgrade Complete</p>
<hr>
<p>Optimizer statistics are not transferred by pg_upgrade.
   Once you start the new server, consider running:
       /usr/lib/postgresql/14/bin/vacuumdb --all --analyze-in-stages</p>
<p>Running this script will delete the old cluster's data files:
       ./delete_old_cluster.sh
   ```</p>
<ol>
<li>Now bring up the PostgreSQL 14 service:</li>
</ol>
<p>```
   $ sudo systemctl start postgresql@14-main
   $ psql -p 5435
   psql (14.6 (Ubuntu 14.6-0ubuntu0.22.04.1))
   Type "help" for help.</p>
<p>postgres=# \l
                                         List of databases
           Name        |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges <br>
   --------------------+----------+----------+-------------+-------------+-----------------------
    contrib_regression | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
    owncloud           | mycloud  | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
    postgres           | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
    roundcube          | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
    template0          | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                       |          |          |             |             | postgres=CTc/postgres
    template1          | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | postgres=CTc/postgres+
                       |          |          |             |             | =c/postgres
   (6 rows)</p>
<p>postgres=# \c roundcube
   You are now connected to database "roundcube" as user "postgres".</p>
<p>roundcube=# select * from system;
          name        |   value  <br>
   -------------------+------------
    roundcube-version | 2019092900
   (1 row)</p>
<p>```</p>
<p>Here we see our happy little owncloud, roundcube and contrib_regression databases, migrated from v12 to v14.</p>
<p><em>Enjoy!</em> </p>
<ol>
<li>
<blockquote>
<p>If you use link mode, the upgrade will be much faster (no file copying) and use less disk space, but you will not be able to access your old cluster once you start the new cluster after the upgrade. Link mode also requires that the old and new cluster data directories be in the same file system. (Tablespaces and pg_wal can be on different file systems.) Clone mode provides the same speed and disk space advantages but does not cause the old cluster to be unusable once the new cluster is started. Clone mode also requires that the old and new data directories be in the same file system. This mode is only available on certain operating systems and file systems.</p>
</blockquote>
</li>
</ol>
<h2 id="remove-old-postgresql-install">Remove old postgresql install</h2>
<p>Once the new databases have been tested and run for a while, don't forget to clean up.</p>
<p>Follow the pg_upgrade advice:</p>
<blockquote>
<p>Once you start the new server, consider running:</p>
<p><code>/usr/lib/postgresql/14/bin/vacuumdb --all --analyze-in-stages</code></p>
<p>Running this script will delete the old cluster's data files:</p>
<p><code>./delete_old_cluster.sh</code></p>
<p>```
$ cat delete_old_cluster.sh </p>
<h1 id="binsh">!/bin/sh</h1>
<p>rm -rf '/var/lib/postgresql/12/main'
```</p>
</blockquote>
<p>Then do the physical left over sweeping.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>purge<span class="w"> </span>postgresql-12<span class="w"> </span>postgresql-client-12<span class="w"> </span>postgresql-doc-12<span class="w"> </span>postgresql-server-dev-12
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/run/postgresql/12/
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/postgresql/12/
$<span class="w"> </span>sudo<span class="w">             </span>rm<span class="w"> </span>-rf<span class="w"> </span>/usr/lib/postgresql/12/
$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/etc/postgresql/12/
</code></pre></div>

<p>Finally, check the clusters:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pg_lsclusters<span class="w"> </span>
Ver<span class="w"> </span>Cluster<span class="w"> </span>Port<span class="w"> </span>Status<span class="w"> </span>Owner<span class="w">    </span>Data<span class="w"> </span>directory<span class="w">              </span>Log<span class="w"> </span>file
<span class="m">14</span><span class="w">  </span>main<span class="w">    </span><span class="m">5435</span><span class="w"> </span>online<span class="w"> </span>postgres<span class="w"> </span>/var/lib/postgresql/14/main<span class="w"> </span>/var/log/postgresql/postgresql-14-main.log

$<span class="w"> </span>ps<span class="w"> </span>-jH<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>u
USER<span class="w">         </span>PID<span class="w">    </span>PGID<span class="w">     </span>SID<span class="w"> </span>%CPU<span class="w"> </span>%MEM<span class="w">    </span>VSZ<span class="w">   </span>RSS<span class="w"> </span>TTY<span class="w">      </span>STAT<span class="w"> </span>START<span class="w">   </span>TIME<span class="w"> </span>COMMAND
postgres<span class="w">  </span><span class="m">718566</span><span class="w">  </span><span class="m">718566</span><span class="w">  </span><span class="m">718565</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">   </span><span class="m">9612</span><span class="w">  </span><span class="m">5128</span><span class="w"> </span>pts/2<span class="w">    </span>S+<span class="w">   </span><span class="m">15</span>:20<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>bash
postgres<span class="w">  </span><span class="m">752071</span><span class="w">  </span><span class="m">752071</span><span class="w">  </span><span class="m">752071</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.1<span class="w"> </span><span class="m">218008</span><span class="w"> </span><span class="m">29184</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w"> </span>/usr/lib/postgresql/14/bin/postgres<span class="w"> </span>-D<span class="w"> </span>/var/lib/postgresql/14/main<span class="w"> </span>-c<span class="w"> </span><span class="nv">config_file</span><span class="o">=</span>
postgres<span class="w">  </span><span class="m">752073</span><span class="w">  </span><span class="m">752073</span><span class="w">  </span><span class="m">752073</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218144</span><span class="w"> </span><span class="m">12600</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>checkpointer<span class="w"> </span>
postgres<span class="w">  </span><span class="m">752074</span><span class="w">  </span><span class="m">752074</span><span class="w">  </span><span class="m">752074</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218008</span><span class="w">  </span><span class="m">7004</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>background<span class="w"> </span>writer<span class="w"> </span>
postgres<span class="w">  </span><span class="m">752075</span><span class="w">  </span><span class="m">752075</span><span class="w">  </span><span class="m">752075</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218008</span><span class="w"> </span><span class="m">11484</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>walwriter<span class="w"> </span>
postgres<span class="w">  </span><span class="m">752076</span><span class="w">  </span><span class="m">752076</span><span class="w">  </span><span class="m">752076</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218680</span><span class="w">  </span><span class="m">9416</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>autovacuum<span class="w"> </span>launcher<span class="w"> </span>
postgres<span class="w">  </span><span class="m">752077</span><span class="w">  </span><span class="m">752077</span><span class="w">  </span><span class="m">752077</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">73024</span><span class="w">  </span><span class="m">6960</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>stats<span class="w"> </span>collector<span class="w"> </span>
postgres<span class="w">  </span><span class="m">752078</span><span class="w">  </span><span class="m">752078</span><span class="w">  </span><span class="m">752078</span><span class="w">  </span><span class="m">0</span>.0<span class="w">  </span><span class="m">0</span>.0<span class="w"> </span><span class="m">218444</span><span class="w">  </span><span class="m">7588</span><span class="w"> </span>?<span class="w">        </span>Ss<span class="w">   </span><span class="m">16</span>:25<span class="w">   </span><span class="m">0</span>:00<span class="w">   </span>postgres:<span class="w"> </span><span class="m">14</span>/main:<span class="w"> </span>logical<span class="w"> </span>replication<span class="w"> </span>launcher<span class="w"> </span>
</code></pre></div>

<h2 id="continue">Continue</h2>
<p>Now that you have upgraded to the happy new cluster, consider moving data files to a better database protection disk.</p>
<p>Same time, same channel, on the next episode of Linux in the Home.</p>
<p>Proceed in the order presented, some things are depending on prior setups.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://lwn.net/">Linux Weekly News</a></li>
                            <li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
                            <li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
                            <li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
                            <li><a href="https://www.thefarside.com/">The Far Side</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://dfcsoftware.github.io/linux-in-house/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://fosstodon.org/@LinuxintheHouse">Feedback</a></li>
                            <li><a href="https://fosstodon.org/@LinuxintheHouse.rss">Mastodon RSS feed</a></li>
                            <li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
                            <li><a href="/linux-in-house/author/don-cohoon.html">Created by: Don Cohoon</a></li>
                            <li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License </a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>
                Site by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, via <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </p><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                <p> Version:  3.140 </p>
        </footer><!-- /#contentinfo -->

</body>
</html>