<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>VirtualMachines</title>
        <link rel="stylesheet" href="https://dfcsoftware.github.io/theme/css/main.css" />
        <link href="https://dfcsoftware.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Linux Home Administration Atom Feed" />
        <meta name="description" content="Virtual Machines (VM) A Virtual Machine (VM) is a way to create a whole operating system, with many applications, that is able to be moved from..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <table>
                    <td><h1><a href="https://dfcsoftware.github.io/">Linux Home Administration</a></h1></td>
                    <td> <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script> </td>
                </table>
                <nav><ul>
                    <li><a href="https://dfcsoftware.github.io/category/forest.html">forest</a></li>
                    <li class="active"><a href="https://dfcsoftware.github.io/category/linux.html">linux</a></li>
                    <li><a href="https://dfcsoftware.github.io/category/writing.html">writing</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://dfcsoftware.github.io/virtualmachines.html" rel="bookmark"
           title="Permalink to VirtualMachines">VirtualMachines</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-06-29T00:00:00-04:00">
                Published: Thu 29 June 2023
        </abbr>
		<br />
        <abbr class="modified" title="2024-04-19T09:30:00-04:00">
                Updated: Fri 19 April 2024
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://dfcsoftware.github.io/author/don-cohoon.html">Don Cohoon</a>
        </address>
<p>In <a href="https://dfcsoftware.github.io/category/linux.html">linux</a>.</p>
<p>tags: <a href="https://dfcsoftware.github.io/tag/systems.html">systems</a> </p>
</footer><!-- /.post-info -->      <h1 id="virtual-machines-vm">Virtual Machines (VM)</h1>
<p>A Virtual Machine (VM) is a way to create a whole operating system, with many applications, that is able to be moved from one physical machine to another physical machine. This has advantages in case of hardware, location or network problems to quickly and correctly restore service.</p>
<p><br/></p>
<hr>
<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#virtual-machines-vm">Virtual Machines (VM)</a><ul>
<li><a href="#install-prerequisites">Install Prerequisites</a></li>
<li><a href="#install-cockpit">Install Cockpit</a></li>
<li><a href="#virtual-machines-in-cockpit">Virtual machines in Cockpit</a><ul>
<li><a href="#create-storage-pools-with-cockpit">Create storage pools with Cockpit</a></li>
<li><a href="#create-a-new-virtual-machine">Create a new virtual machine</a></li>
<li><a href="#examine-a-virtual-machine">Examine a virtual machine</a></li>
<li><a href="#network-on-a-virtual-machine">Network on a virtual machine</a><ul>
<li><a href="#nat-vm-network-vm-network-default">NAT VM Network (VM network default)</a></li>
<li><a href="#bridged-vm-network-physical-host-bridge">Bridged VM Network (Physical Host bridge)</a></li>
<li><a href="#redhat-way-1">RedHat Way [1]</a></li>
<li><a href="#debian-way">Debian Way</a></li>
</ul>
</li>
<li><a href="#sharing-files-with-physical-and-virtual-hosts">Sharing files with physical and virtual hosts</a></li>
</ul>
</li>
<li><a href="#virtual-storage-pools-on-nfs">Virtual Storage Pools on NFS</a></li>
<li><a href="#clone-virtual-machine">Clone Virtual Machine</a><ul>
<li><a href="#copy-data-files">Copy Data Files</a></li>
</ul>
</li>
<li><a href="#if-the-ip-address-changed-in-the-vm">If the IP Address changed in the VM</a></li>
<li><a href="#configuration-files">Configuration Files</a></li>
</ul>
</li>
</ul>
</div>
<hr>
<p>The following descriptions follow a VM on Redhat/AlmaLinux/RockyLinux/CENTOS 9 using qemu virtualizer and the Cockpit management web console. We also set the VM network up for external access and share files with the physical host's NFS mount. [1]</p>
<ol>
<li><a href="/nas.html#connect-to-nfs-server-from-linux-client">NFS client</a></li>
</ol>
<p>Reference: </p>
<ul>
<li><a href="https://www.qemu.org/">https://www.qemu.org/</a></li>
<li><a href="https://libvirt.org/">https://libvirt.org/</a></li>
<li><a href="https://www.linux-kvm.org/page/Main_Page">https://www.linux-kvm.org/page/Main_Page</a></li>
</ul>
<h2 id="install-prerequisites">Install Prerequisites</h2>
<p>Install the virtualization hypervisor packages.</p>
<ul>
<li>Redhat:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>qemu-kvm<span class="w"> </span>libvirt<span class="w"> </span>virt-install<span class="w"> </span>virt-viewer
</code></pre></div>

<ul>
<li>Start the virtualization services:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span><span class="k">for</span><span class="w"> </span>drv<span class="w"> </span><span class="k">in</span><span class="w"> </span>qemu<span class="w"> </span>network<span class="w"> </span>nodedev<span class="w"> </span>nwfilter<span class="w"> </span>secret<span class="w"> </span>storage<span class="w"> </span>interface<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>virt<span class="si">${</span><span class="nv">drv</span><span class="si">}</span>d<span class="o">{</span>,-ro,-admin<span class="o">}</span>.socket<span class="p">;</span><span class="w"> </span><span class="k">done</span>
</code></pre></div>

<p>Reference: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/assembly_enabling-virtualization-in-rhel-9_configuring-and-managing-virtualization#proc_enabling-virtualization-in-rhel-9_assembly_enabling-virtualization-in-rhel-9">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/assembly_enabling-virtualization-in-rhel-9_configuring-and-managing-virtualization#proc_enabling-virtualization-in-rhel-9_assembly_enabling-virtualization-in-rhel-9</a></p>
<ul>
<li>Debian:</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>qemu-kvm<span class="w"> </span>libvirt-daemon<span class="w">  </span>bridge-utils<span class="w"> </span>virtinst<span class="w"> </span>libvirt-daemon-system
</code></pre></div>

<p>Load the network module into the running kernel</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>modprobe<span class="w"> </span>vhost_net
$<span class="w"> </span>lsmod<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>vhost
vhost_net<span class="w">              </span><span class="m">36864</span><span class="w">  </span><span class="m">0</span>
tun<span class="w">                    </span><span class="m">61440</span><span class="w">  </span><span class="m">1</span><span class="w"> </span>vhost_net
vhost<span class="w">                  </span><span class="m">57344</span><span class="w">  </span><span class="m">1</span><span class="w"> </span>vhost_net
vhost_iotlb<span class="w">            </span><span class="m">16384</span><span class="w">  </span><span class="m">1</span><span class="w"> </span>vhost
tap<span class="w">                    </span><span class="m">28672</span><span class="w">  </span><span class="m">1</span><span class="w"> </span>vhost_net
</code></pre></div>

<p>Make it load at boot time by adding this line</p>
<p>File: /etc/modules </p>
<div class="highlight"><pre><span></span><code>vhost_net
</code></pre></div>

<p>Optional Tools:</p>
<ul>
<li>libguestfs is a set of tools for accessing and modifying virtual machine (VM) disk images. You can use this for viewing and editing files inside guests, scripting changes to VMs, monitoring disk used/free statistics, creating guests, P2V, V2V, performing backups, cloning VMs, building VMs, formatting disks, resizing disks, and much more.</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w">  </span>libguestfs-tools
</code></pre></div>

<ul>
<li>The libosinfo project comprises three parts</li>
</ul>
<p>A database of metadata about operating systems, hypervisors, virtual hardware and more
A GObject based library API for querying information from the database
Command line tools for querying &amp; extracting information from the database</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libosinfo-bin
</code></pre></div>

<ul>
<li>qemu-system and virt-manager allow command line and graphical starting, stopping, configuring qemu-kvm systems</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w">  </span>libguestfs-tools<span class="w"> </span>libosinfo-bin<span class="w">  </span>qemu-system<span class="w"> </span>virt-manager
</code></pre></div>

<ul>
<li>Bridge definitions</li>
</ul>
<p>Install bridge-utils</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>bridge-utils
</code></pre></div>

<p>Add the iface br0 inet dhcp, and assign bridge_ports to an ethernet interface (probably USB)</p>
<p>File:  /etc/network/interfaces</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> This file describes the network interfaces available on your system
<span class="gh">#</span> and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

<span class="gh">#</span> The loopback network interface
auto lo
iface lo inet loopback

<span class="gh">#</span> USB Ethernet
auto enxc87f54384756
iface enxc87f54384756 inet manual

<span class="gh">#</span> Bridge setup
auto br0
iface br0 inet dhcp
    bridge_ports enxc87f54384756
...
$ ip a
~
3: enxc87f54384756: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master br0 state UP group default qlen 1000
    link/ether c8:7f:54:93:56:44 brd ff:ff:ff:ff:ff:ff
~
6: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 86:32:53:56:4a:fa brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.2/24 brd 192.168.1.1 scope global dynamic br0
       valid_lft 86082sec preferred_lft 86082sec
    inet6 fe80::8432:53ff:fe56:4edf/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre></div>

<ul>
<li>Debian - Single ethernet device bridge</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">bridge</span><span class="o">-</span><span class="n">utils</span>

<span class="c1"># add bridge</span>
<span class="n">brctl</span><span class="w"> </span><span class="n">addbr</span><span class="w"> </span><span class="n">br0</span>

<span class="c1"># add interface</span>
<span class="n">ip</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="n">show</span>
<span class="n">brctl</span><span class="w"> </span><span class="n">addif</span><span class="w"> </span><span class="n">br0</span><span class="w"> </span><span class="n">eth0</span><span class="w"> </span>

<span class="n">https</span><span class="o">://</span><span class="n">wiki.debian.org</span><span class="o">/</span><span class="n">BridgeNetworkConnections</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">ifup</span><span class="w"> </span><span class="n">br0</span>

<span class="c1"># -&gt; Permanent Configuration &lt;-</span>
<span class="c1">#</span>
<span class="c1"># File: /etc/network/interfaces</span>
<span class="c1">#</span>
<span class="c1"># This file describes the network interfaces available on your system</span>
<span class="c1"># and how to activate them. For more information, see interfaces(5).</span>

<span class="n">source</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">interfaces.d</span><span class="o">/*</span>

<span class="c1"># The loopback network interface</span>
<span class="n">auto</span><span class="w"> </span><span class="n">lo</span>
<span class="n">iface</span><span class="w"> </span><span class="n">lo</span><span class="w"> </span><span class="n">inet</span><span class="w"> </span><span class="n">loopback</span>

<span class="c1"># USB Ethernet</span>
<span class="n">auto</span><span class="w"> </span><span class="n">enxc87f54935633</span>
<span class="n">iface</span><span class="w"> </span><span class="n">enxc87f54935633</span><span class="w"> </span><span class="n">inet</span><span class="w"> </span><span class="n">manual</span>

<span class="c1"># Bridge setup</span>
<span class="n">auto</span><span class="w"> </span><span class="n">br0</span>
<span class="n">iface</span><span class="w"> </span><span class="n">br0</span><span class="w"> </span><span class="n">inet</span><span class="w"> </span><span class="n">dhcp</span>
<span class="w">    </span><span class="n">bridge_ports</span><span class="w"> </span><span class="n">enxc87f54935633</span>
</code></pre></div>

<p>Reference:</p>
<ul>
<li><a href="https://wiki.debian.org/BridgeNetworkConnections">https://wiki.debian.org/BridgeNetworkConnections</a></li>
</ul>
<p>Reference:</p>
<ul>
<li><a href="https://wiki.debian.org/BridgeNetworkConnections">https://wiki.debian.org/BridgeNetworkConnections</a></li>
<li><a href="https://wiki.libvirt.org/Networking.html#debian-ubuntu-bridging">https://wiki.libvirt.org/Networking.html#debian-ubuntu-bridging</a></li>
</ul>
<blockquote>
<p>??? Apparmor and Selinux may require more permission. , maybe using /home, trying /local</p>
</blockquote>
<p>/etc/apparmor.d/local/abstractions/libvirt-qemu</p>
<ul>
<li>Set user and group 
File: /etc/libvirt/qemu.conf</li>
</ul>
<div class="highlight"><pre><span></span><code>~
user = &quot;libvirt-qemu&quot;
group = &quot;libvirt-qemu&quot;
~
</code></pre></div>

<p>Then reboot.</p>
<h2 id="install-cockpit">Install Cockpit</h2>
<p>Cockpit is a web based system allowing full management of systems, including virtual qemu systems.</p>
<p>Install packages cockpit and cockpit-machine.</p>
<blockquote>
<p>Install postfix first on Debian, or else exim4 mail server will be installed with cockpit</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>cockpit<span class="w"> </span>cockpit-machines
</code></pre></div>

<p>Start Cockpit and libvirtd:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>libvirtd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>libvirtd
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>cockpit.socket
</code></pre></div>

<p>To log in to Cockpit, open your web browser to localhost:9090 and enter your Linux username and password.</p>
<p>Reference: <a href="https://www.redhat.com/sysadmin/intro-cockpit">https://www.redhat.com/sysadmin/intro-cockpit</a></p>
<h2 id="virtual-machines-in-cockpit">Virtual machines in Cockpit</h2>
<p>Click on Virtual machines to open the virtual machine panel.</p>
<p>If you have existing virtual machines with libvirt, Cockpit detects them. Should Cockpit fail to detect existing virtual machines, you can import them by clicking the Import VM button.</p>
<p>Cockpit knows the virtual machine's state and can start or stop it. In the pop-up menu on the right, you can clone, rename, and delete the virtual machine.</p>
<h3 id="create-storage-pools-with-cockpit">Create storage pools with Cockpit</h3>
<p>A storage pool is space that you designate as being available to store virtual machine images. You can set a network location, an iSCSI target, or a filesystem.</p>
<p>In Cockpit, to create a storage pool, click the Storage pool button at the top of the virtual machine panel.</p>
<p>View storage pools</p>
<div class="highlight"><pre><span></span><code><span class="c">$ sudo virsh pool</span><span class="nb">-</span><span class="c">list </span><span class="nb">--</span><span class="c">all </span><span class="nb">--</span><span class="c">details</span>
<span class="c"> Name   State     Autostart   Persistent   Capacity   Allocation   Available</span>
<span class="nb">------------------------------------------------------------------------------</span>
<span class="c"> data   running   yes         yes          1</span><span class="nt">.</span><span class="c">27 TiB   15</span><span class="nt">.</span><span class="c">45 GiB    1</span><span class="nt">.</span><span class="c">25 TiB</span>
</code></pre></div>

<p>If no storage space is created, the default /var/lib/machines will be used.</p>
<p>Reference: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/managing-storage-for-virtual-machines_configuring-and-managing-virtualization#assembly_managing-virtual-machine-storage-pools-using-the-cli_managing-storage-for-virtual-machines">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/managing-storage-for-virtual-machines_configuring-and-managing-virtualization#assembly_managing-virtual-machine-storage-pools-using-the-cli_managing-storage-for-virtual-machines</a></p>
<h3 id="create-a-new-virtual-machine">Create a new virtual machine</h3>
<p>To create a new Virtual Machine, click the Create VM button on the right side of the virtual machine panel.</p>
<p>You can download a recent operating system version from a drop-down list, or you can choose an ISO image on your local drive, or you can have the virtual machine boot from a Preboot Execution Environment (PXE) server.</p>
<p>Reference: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/assembly_creating-virtual-machines_configuring-and-managing-virtualization">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/assembly_creating-virtual-machines_configuring-and-managing-virtualization</a></p>
<p>Start it:</p>
<div class="highlight"><pre><span></span><code><span class="nv">virsh</span><span class="w"> </span><span class="o">--</span><span class="k">connect</span><span class="w"> </span><span class="nv">qemu</span>:<span class="o">///</span><span class="nv">system</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">almalinux9</span><span class="o">-</span><span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">6</span>
</code></pre></div>

<p>Restart install:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virt-install<span class="w"> </span>--connect<span class="w"> </span>qemu:///system<span class="w"> </span>--quiet<span class="w"> </span>--os-variant<span class="w"> </span>almalinux9<span class="w"> </span>--reinstall<span class="w"> </span>almalinux9-2023-10-6<span class="w"> </span>--wait<span class="w"> </span>-1<span class="w"> </span>--noautoconsole<span class="w"> </span>--install<span class="w"> </span><span class="nv">os</span><span class="o">=</span>almalinux9<span class="w"> </span>
</code></pre></div>

<h3 id="examine-a-virtual-machine">Examine a virtual machine</h3>
<p>Display the info about your virtual machines</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>virt-host-validate

QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>hardware<span class="w"> </span>virtualization<span class="w">                                 </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">if</span><span class="w"> </span>device<span class="w"> </span>/dev/kvm<span class="w"> </span>exists<span class="w">                                   </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">if</span><span class="w"> </span>device<span class="w"> </span>/dev/kvm<span class="w"> </span>is<span class="w"> </span>accessible<span class="w">                            </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">if</span><span class="w"> </span>device<span class="w"> </span>/dev/vhost-net<span class="w"> </span>exists<span class="w">                             </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">if</span><span class="w"> </span>device<span class="w"> </span>/dev/net/tun<span class="w"> </span>exists<span class="w">                               </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>cgroup<span class="w"> </span><span class="s1">&#39;cpu&#39;</span><span class="w"> </span>controller<span class="w"> </span>support<span class="w">                         </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>cgroup<span class="w"> </span><span class="s1">&#39;cpuacct&#39;</span><span class="w"> </span>controller<span class="w"> </span>support<span class="w">                     </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>cgroup<span class="w"> </span><span class="s1">&#39;cpuset&#39;</span><span class="w"> </span>controller<span class="w"> </span>support<span class="w">                      </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>cgroup<span class="w"> </span><span class="s1">&#39;memory&#39;</span><span class="w"> </span>controller<span class="w"> </span>support<span class="w">                      </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>cgroup<span class="w"> </span><span class="s1">&#39;devices&#39;</span><span class="w"> </span>controller<span class="w"> </span>support<span class="w">                     </span>:<span class="w"> </span>WARN<span class="w"> </span><span class="o">(</span>Enable<span class="w"> </span><span class="s1">&#39;devices&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>kernel<span class="w"> </span>Kconfig<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>mount/enable<span class="w"> </span>cgroup<span class="w"> </span>controller<span class="w"> </span><span class="k">in</span><span class="w"> </span>your<span class="w"> </span>system<span class="o">)</span>
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>cgroup<span class="w"> </span><span class="s1">&#39;blkio&#39;</span><span class="w"> </span>controller<span class="w"> </span>support<span class="w">                       </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>device<span class="w"> </span>assignment<span class="w"> </span>IOMMU<span class="w"> </span>support<span class="w">                         </span>:<span class="w"> </span>PASS
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">if</span><span class="w"> </span>IOMMU<span class="w"> </span>is<span class="w"> </span>enabled<span class="w"> </span>by<span class="w"> </span>kernel<span class="w">                               </span>:<span class="w"> </span>WARN<span class="w"> </span><span class="o">(</span>IOMMU<span class="w"> </span>appears<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>disabled<span class="w"> </span><span class="k">in</span><span class="w"> </span>kernel.<span class="w"> </span>Add<span class="w"> </span><span class="nv">intel_iommu</span><span class="o">=</span>on<span class="w"> </span>to<span class="w"> </span>kernel<span class="w"> </span>cmdline<span class="w"> </span>arguments<span class="o">)</span>
QEMU:<span class="w"> </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>secure<span class="w"> </span>guest<span class="w"> </span>support<span class="w">                                    </span>:<span class="w"> </span>WARN<span class="w"> </span><span class="o">(</span>Unknown<span class="w"> </span><span class="k">if</span><span class="w"> </span>this<span class="w"> </span>platform<span class="w"> </span>has<span class="w"> </span>Secure<span class="w"> </span>Guest<span class="w"> </span>support<span class="o">)</span>
</code></pre></div>

<p>Start a VM</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>start<span class="w"> </span>demo-guest1
</code></pre></div>

<p>Stop a VM</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>shutdown<span class="w"> </span>demo-guest1
</code></pre></div>

<p>VM Diagnostics: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/diagnosing-virtual-machine-problems_configuring-and-managing-virtualization">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/diagnosing-virtual-machine-problems_configuring-and-managing-virtualization</a></p>
<h3 id="network-on-a-virtual-machine">Network on a virtual machine</h3>
<h4 id="nat-vm-network-vm-network-default">NAT VM Network (VM network <em>default</em>)</h4>
<p>By <em>default</em>, a newly created VM connects to a NAT-type network that uses virbr0, the default virtual bridge on the host. This ensures that the VM can use the host’s network interface controller (NIC) for connecting to outside networks, but the VM is <em>not reachable from external systems</em>.</p>
<blockquote>
<p>See file /etc/libvirt/network/default.xml</p>
</blockquote>
<p><img alt="Virtual Machine NAT" src="/images/graph-virtual-machine.svg"></p>
<h4 id="bridged-vm-network-physical-host-bridge">Bridged VM Network (Physical Host <em>bridge</em>)</h4>
<p>If you require a VM to appear on the same <em>external</em> network as the hypervisor, you must use bridged mode instead. To do so, attach the VM to a bridge device connected to the hypervisor’s physical network device.</p>
<blockquote>
<p>See file /etc/nmstate/50-create-bridge.yml below</p>
</blockquote>
<p><img alt="Virtual Machine Bridge" src="/images/graph-virtual-machine2.svg"></p>
<h4 id="redhat-way-1">RedHat Way [1]</h4>
<ul>
<li>Create a nmstate configuration file on the physical host.</li>
</ul>
<p>Install nmstate, is not already done</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>nmstate
</code></pre></div>

<p>In this example the host IP address will be fixed at 192.168.1.12, and the guest (VM) will pick up a DHCP address from the local DHCP server. Of course you should change the router address (192.168.1.1) and maybe the DNS resolvers (1.1.1.1 and 1.0.0.1). The port (eno1) is the machine's onboard ethernet port. Port eno1 will no longer have an IP address, rather bridge interface owns the IP address.</p>
<blockquote>
<p>Bridge should be created <strong>before</strong> any vlan to allow routing for bridge. Otherwise the vlan will become the first route, blocking outside access.</p>
</blockquote>
<p>File: /etc/nmstate/50-create-bridge.yml</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/configuring_and_managing_networking/index#proc_configuring-a-network-bridge-by-using-nmstatectl_configuring-a-network-bridge</span>
<span class="err">#</span><span class="w"> </span><span class="o">---</span>
<span class="nx">interfaces</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">virbr0</span>
<span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="nx">linux</span><span class="o">-</span><span class="nx">bridge</span>
<span class="w">  </span><span class="nx">ipv4</span><span class="p">:</span>
<span class="w">    </span><span class="nx">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nx">address</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">ip</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">192.168.1.12</span>
<span class="w">      </span><span class="nx">prefix</span><span class="o">-</span><span class="nx">length</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span>
<span class="w">    </span><span class="nx">dhcp</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="nx">ipv6</span><span class="p">:</span>
<span class="w">    </span><span class="nx">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="nx">bridge</span><span class="p">:</span>
<span class="w">    </span><span class="nx">options</span><span class="p">:</span>
<span class="w">      </span><span class="nx">stp</span><span class="p">:</span>
<span class="w">        </span><span class="nx">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="nx">vlan</span><span class="o">-</span><span class="nx">protocol</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">802.1</span><span class="nx">q</span>
<span class="w">    </span><span class="nx">port</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">eno1</span>
</code></pre></div>

<blockquote>
<p>It is important to <em>disable</em> the <strong>default</strong> virbr0 network interface within Cockpit/virsh. </p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>net-destroy<span class="w"> </span>default
Network<span class="w"> </span>default<span class="w"> </span>stopped
$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>net-autostart<span class="w"> </span>--disable<span class="w"> </span>default
Network<span class="w"> </span>default<span class="w"> </span>unmarked<span class="w"> </span>as<span class="w"> </span>autostarted

$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>net-list<span class="w"> </span>--all
<span class="w"> </span>Name<span class="w">      </span>State<span class="w">      </span>Autostart<span class="w">   </span>Persistent
----------------------------------------------
<span class="w"> </span>default<span class="w">   </span>inactive<span class="w">   </span>no<span class="w">          </span>yes
</code></pre></div>

<p>Hint: net-destroy only stops the running process ;-)</p>
<p>Apply the bridge network config, fix any errors.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>nmstatectl<span class="w"> </span>apply<span class="w"> </span>/etc/nmstate/50-create-bridge.yml
</code></pre></div>

<p>IP address check on physical machine</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>virbr0
<span class="m">5</span>:<span class="w"> </span>virbr0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span><span class="m">25</span>:54:01:f3:2a:2e<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>inet<span class="w"> </span><span class="m">192</span>.168.1.12/24<span class="w"> </span>brd<span class="w"> </span><span class="m">192</span>.168.1.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>noprefixroute<span class="w"> </span>virbr0
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>eno1
<span class="m">2</span>:<span class="w"> </span>eno1:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>fq_codel<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>3c:49:7a:b9:e7:6f<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>altname<span class="w"> </span>enp0s31f6
</code></pre></div>

<p>Notice virbr0 is the master of eno1.</p>
<p>Make the changes permanent</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nmstate
</code></pre></div>

<blockquote>
<p>This will rename file 50-create-bridge.yml to 50-create-bridge.applied. To re-apply if changes are needed, rename the file to 50-create-bridge.yml before restarting the service nmstate.</p>
</blockquote>
<ul>
<li>The <strong>VM</strong> should use virbr0 as it's network interface. Using Cockpit add a Bridged network to the <strong>VM</strong>.</li>
</ul>
<p>image libvirt-bridge.png
<img alt="libvirt-bridge.png" src="/images/libvirt-bridge.png"></p>
<p>-&gt; OR &lt;- define it using virsh:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>edit<span class="w"> </span>vm_machine
<span class="nt">&lt;domain</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>
~
<span class="w">  </span><span class="nt">&lt;devices&gt;</span>
~
<span class="w">    </span><span class="nt">&lt;interface</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;mac</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;52:54:00:0b:4b:a8&#39;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;source</span><span class="w"> </span><span class="na">bridge=</span><span class="s">&#39;virbr0&#39;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;model</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/interface&gt;</span>
~
</code></pre></div>

<p>Reference:</p>
<ul>
<li><a href="https://libvirt.org/formatnetwork.html#using-an-existing-host-bridge">https://libvirt.org/formatnetwork.html#using-an-existing-host-bridge</a></li>
<li><a href="https://libvirt.org/manpages/virsh.html">https://libvirt.org/manpages/virsh.html</a></li>
<li>Virtual Machine XML file location: /etc/libvirt/qemu/</li>
</ul>
<p>Afterwords it will look like this:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>domiflist<span class="w"> </span>vm_machine
<span class="w"> </span>Interface<span class="w">   </span>Type<span class="w">     </span>Source<span class="w">   </span>Model<span class="w">    </span>MAC
-----------------------------------------------------------
<span class="w"> </span>vnet5<span class="w">       </span>bridge<span class="w">   </span>virbr0<span class="w">   </span>virtio<span class="w">   </span><span class="m">22</span>:53:06:f9:d2:e1
</code></pre></div>

<p>vnet5 is automatically created, with virbr0 as it's master. Typically, a vnet will be added to a bridge interface which means plugging the VM into a switch.</p>
<div class="highlight"><pre><span></span><code><span class="mi">25</span><span class="o">:</span><span class="w"> </span><span class="n">vnet5</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="o">,</span><span class="n">MULTICAST</span><span class="o">,</span><span class="n">UP</span><span class="o">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">noqueue</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="n">virbr0</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">UNKNOWN</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">qlen</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">ether</span><span class="w"> </span><span class="n">fe</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="n">f7</span><span class="o">:</span><span class="n">d2</span><span class="o">:</span><span class="mi">40</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="n">ff</span><span class="o">:</span><span class="n">ff</span><span class="o">:</span><span class="n">ff</span><span class="o">:</span><span class="n">ff</span><span class="o">:</span><span class="n">ff</span><span class="o">:</span><span class="n">ff</span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="n">fe80</span><span class="o">::</span><span class="n">fc54</span><span class="o">:</span><span class="n">ff</span><span class="o">:</span><span class="n">fef7</span><span class="o">:</span><span class="n">d240</span><span class="o">/</span><span class="mi">64</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="n">link</span><span class="w"> </span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span>
</code></pre></div>

<p>Physical network interface (eno1) -&gt; bridge (virbr0) &lt;- Virtual network interface (vnet5) </p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>bridge<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>virbr0
<span class="m">2</span>:<span class="w"> </span>eno1:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>forwarding<span class="w"> </span>priority<span class="w"> </span><span class="m">32</span><span class="w"> </span>cost<span class="w"> </span><span class="m">100</span><span class="w"> </span>
<span class="m">25</span>:<span class="w"> </span>vnet5:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>forwarding<span class="w"> </span>priority<span class="w"> </span><span class="m">32</span><span class="w"> </span>cost<span class="w"> </span><span class="m">100</span><span class="w"> </span>
$<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>master<span class="w"> </span>virbr0
<span class="m">2</span>:<span class="w"> </span>eno1:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>fq_codel<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>mode<span class="w"> </span>DEFAULT<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>1c:69:7a:09:e7:61<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>altname<span class="w"> </span>enp0s31f6
<span class="m">25</span>:<span class="w"> </span>vnet5:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>mode<span class="w"> </span>DEFAULT<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>fe:54:00:f7:d2:40<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</code></pre></div>

<h4 id="debian-way">Debian Way</h4>
<p>In this host, we have a USB-A to Ethernet dongle. Plugging it in created a network device called enxc87f54935633.</p>
<blockquote>
<p>This is important if you need to preserve your existing ethernet connection while configuring a new bridge.</p>
</blockquote>
<p>In this example the host IP address will be fixed at 192.168.1.10, and the guest (VM) will pick up a DHCP address from the local DHCP server. Of course you should change the router address (192.168.1.1) and maybe the DNS resolvers (1.1.1.1 and 1.0.0.1). The ethernets (enxc87f54935633) is a USB-A ethernet port. Ethernet enxc87f54935633 will no longer have an IP address, rather bridge interface owns the IP address.</p>
<p>File: /etc/netplan/60-bridge-init.yaml </p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">bridge</span><span class="o">-</span><span class="n">utils</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="err">#</span><span class="w"> </span><span class="n">USB</span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nl">Ethernet</span><span class="p">:</span><span class="w"> </span><span class="n">enxc87f54935633</span>
<span class="nl">network</span><span class="p">:</span>
<span class="w">  </span><span class="nl">version</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="nl">renderer</span><span class="p">:</span><span class="w"> </span><span class="n">networkd</span>

<span class="w">  </span><span class="nl">ethernets</span><span class="p">:</span>
<span class="w">    </span><span class="nl">enxc87f54935633</span><span class="p">:</span>
<span class="w">      </span><span class="nl">dhcp4</span><span class="p">:</span><span class="w"> </span><span class="k">false</span><span class="w"> </span>
<span class="w">      </span><span class="nl">dhcp6</span><span class="p">:</span><span class="w"> </span><span class="k">false</span><span class="w"> </span>

<span class="w">  </span><span class="nl">bridges</span><span class="p">:</span>
<span class="w">    </span><span class="nl">virbr0</span><span class="p">:</span>
<span class="w">      </span><span class="nl">interfaces</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">enxc87f54935633</span><span class="o">]</span>
<span class="w">      </span><span class="nl">addresses</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">192.168.1.10/24</span><span class="o">]</span>
<span class="w">      </span><span class="nl">routes</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="k">to</span><span class="err">:</span><span class="w"> </span><span class="k">default</span>
<span class="w">        </span><span class="nl">via</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168.1.1</span>
<span class="w">        </span><span class="nl">metric</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="k">on</span><span class="o">-</span><span class="nl">link</span><span class="p">:</span><span class="w"> </span><span class="k">true</span>
<span class="w">      </span><span class="nl">mtu</span><span class="p">:</span><span class="w"> </span><span class="mi">1500</span>
<span class="w">      </span><span class="nl">nameservers</span><span class="p">:</span>
<span class="w">        </span><span class="nl">addresses</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">1.1.1.1</span><span class="o">]</span>
<span class="w">      </span><span class="k">parameters</span><span class="err">:</span>
<span class="w">        </span><span class="nl">stp</span><span class="p">:</span><span class="w"> </span><span class="k">true</span>
<span class="w">        </span><span class="n">forward</span><span class="o">-</span><span class="nl">delay</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span>
<span class="w">      </span><span class="nl">dhcp4</span><span class="p">:</span><span class="w"> </span><span class="k">no</span>
<span class="w">      </span><span class="nl">dhcp6</span><span class="p">:</span><span class="w"> </span><span class="k">no</span>
</code></pre></div>

<blockquote>
<p>It is important to <em>disable</em> the <strong>default</strong> virbr0 network interface within Cockpit/virsh. </p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>net-destroy<span class="w"> </span>default
Network<span class="w"> </span>default<span class="w"> </span>stopped
$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>net-autostart<span class="w"> </span>--disable<span class="w"> </span>default
Network<span class="w"> </span>default<span class="w"> </span>unmarked<span class="w"> </span>as<span class="w"> </span>autostarted

$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>net-list<span class="w"> </span>--all
<span class="w"> </span>Name<span class="w">      </span>State<span class="w">      </span>Autostart<span class="w">   </span>Persistent
----------------------------------------------
<span class="w"> </span>default<span class="w">   </span>inactive<span class="w">   </span>no<span class="w">          </span>yes
</code></pre></div>

<p>Hint: net-destroy only stops the running process ;-)</p>
<p>Apply the bridge network config, fix any errors.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>netplan<span class="w"> </span>apply<span class="w"> </span>/etc/netplan/60-bridge-init.yaml
...
</code></pre></div>

<p>Check the interface</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>virbr0
<span class="m">28</span>:<span class="w"> </span>virbr0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>ee:a7:6e:d0:3b:53<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>inet<span class="w"> </span><span class="m">192</span>.168.50.63/24<span class="w"> </span>brd<span class="w"> </span><span class="m">192</span>.168.50.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>virbr0
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>fe80::eca7:6eff:fed0:3b53/64<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>enxc87f54935633
<span class="m">27</span>:<span class="w"> </span>enxc87f54935633:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>fq_codel<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>c8:7f:54:93:56:33<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</code></pre></div>

<p>Notice virbr0 is the master of enxc87f54935633.</p>
<ul>
<li>The <strong>VM</strong> should use virbr0 as it's network interface. Using Cockpit add a Bridged network to the <strong>VM</strong>.</li>
</ul>
<p>image libvirt-bridge.png
<img alt="libvirt-bridge.png" src="/images/libvirt-bridge.png"></p>
<p>-&gt; OR &lt;- define it using virsh:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>edit<span class="w"> </span>vm_machine
<span class="nt">&lt;domain</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>
~
<span class="w">  </span><span class="nt">&lt;devices&gt;</span>
~
<span class="w">    </span><span class="nt">&lt;interface</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;mac</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;52:54:00:0b:4b:a8&#39;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;source</span><span class="w"> </span><span class="na">bridge=</span><span class="s">&#39;virbr0&#39;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;model</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/interface&gt;</span>
~
</code></pre></div>

<p>Reference:
 * <a href="https://libvirt.org/formatnetwork.html#using-an-existing-host-bridge">https://libvirt.org/formatnetwork.html#using-an-existing-host-bridge</a>
 * <a href="https://libvirt.org/manpages/virsh.html">https://libvirt.org/manpages/virsh.html</a>
 * Virtual Machine XML file location: /etc/libvirt/qemu/</p>
<p>Afterwords it will look like this:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>domiflist<span class="w"> </span>vm-machine
<span class="w"> </span>Interface<span class="w">   </span>Type<span class="w">     </span>Source<span class="w">   </span>Model<span class="w">    </span>MAC
-----------------------------------------------------------
<span class="w"> </span>vnet13<span class="w">      </span>bridge<span class="w">   </span>virbr0<span class="w">   </span>virtio<span class="w">   </span><span class="m">51</span>:34:07:0b:4a:a1
</code></pre></div>

<p>vnet13 is automatically created, with virbr0 as it's master.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>vnet13
<span class="m">30</span>:<span class="w"> </span>vnet13:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>fe:54:00:0b:4b:a8<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>inet6<span class="w"> </span>fe80::fc54:ff:fe0b:4ba8/64<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</code></pre></div>

<p>Physical network interface (enxc87f54935633) -&gt; bridge (virbr0) &lt;- Virtual network interface (vnet13) </p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>brctl<span class="w"> </span>show<span class="w"> </span>virbr0
bridge<span class="w"> </span>name<span class="w"> </span>bridge<span class="w"> </span>id<span class="w">       </span>STP<span class="w"> </span>enabled<span class="w"> </span>interfaces
virbr0<span class="w">      </span><span class="m">8000</span>.eea76ed03b53<span class="w">   </span>yes<span class="w">     </span>enxc87f54935633
<span class="w">                                                        </span>vnet13
$<span class="w"> </span>bridge<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>virbr0
<span class="m">27</span>:<span class="w"> </span>enxc87f54935633:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>forwarding<span class="w"> </span>priority<span class="w"> </span><span class="m">32</span><span class="w"> </span>cost<span class="w"> </span><span class="m">4</span><span class="w"> </span>
<span class="m">30</span>:<span class="w"> </span>vnet13:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>forwarding<span class="w"> </span>priority<span class="w"> </span><span class="m">32</span><span class="w"> </span>cost<span class="w"> </span><span class="m">100</span><span class="w"> </span>
$<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>master<span class="w"> </span>virbr0
<span class="m">27</span>:<span class="w"> </span>enxc87f54935633:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>fq_codel<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>mode<span class="w"> </span>DEFAULT<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>c8:7f:54:93:56:33<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="m">30</span>:<span class="w"> </span>vnet13:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>virbr0<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>mode<span class="w"> </span>DEFAULT<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span>fe:54:00:0b:4b:a8<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</code></pre></div>

<p>Reference:</p>
<ol>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_networking/configuring-a-network-bridge_configuring-and-managing-networking#proc_configuring-a-network-bridge-by-using-nmstatectl_configuring-a-network-bridge">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_networking/configuring-a-network-bridge_configuring-and-managing-networking#proc_configuring-a-network-bridge-by-using-nmstatectl_configuring-a-network-bridge</a></li>
</ol>
<h3 id="sharing-files-with-physical-and-virtual-hosts">Sharing files with physical and virtual hosts</h3>
<ul>
<li>Make a directory on the VM</li>
</ul>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/data
</code></pre></div>

<ul>
<li>In Cockpit on the physical host &gt; Shared directories, add this directory to the Source path, and create a mount tag; i.e.: data</li>
</ul>
<div class="highlight"><pre><span></span><code>Source path    Mount tag    
-------------- ---------
/data/         data
</code></pre></div>

<ul>
<li>In the VM update fstab</li>
</ul>
<p>File: /etc/fstab</p>
<div class="highlight"><pre><span></span><code>~
<span class="gh">#</span> virt share :
<span class="gh">#</span> mount_tag /mnt/mount/path virtiofs rw,noatime,_netdev 0 0
data /data virtiofs rw,noatime,_netdev 0 0
~
</code></pre></div>

<p>Mount it</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mount<span class="w"> </span>/data
</code></pre></div>

<p>Now the shared filesystem will be mounted upon every VM start.</p>
<p>Alternative: Manual mount</p>
<div class="highlight"><pre><span></span><code><span class="cp">#mount -t virtiofs [mount tag] [mount point]</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">virtiofs</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">/</span><span class="n">data</span>
</code></pre></div>

<p>Reference: <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/sharing-files-between-the-host-and-its-virtual-machines_configuring-and-managing-virtualization#proc_using-the-web-console-to-share-files-between-the-host-and-its-virtual-machines-using-virtiofs_sharing-files-between-the-host-and-its-virtual-machines-using-virtio-fs">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/sharing-files-between-the-host-and-its-virtual-machines_configuring-and-managing-virtualization#proc_using-the-web-console-to-share-files-between-the-host-and-its-virtual-machines-using-virtiofs_sharing-files-between-the-host-and-its-virtual-machines-using-virtio-fs</a></p>
<h2 id="virtual-storage-pools-on-nfs">Virtual Storage Pools on NFS</h2>
<p>The advantages of virtual machine storage pools on NFS are:</p>
<ul>
<li>Raid protection on NFS</li>
<li>Ability to move VM from one host to another without copying data files</li>
<li>Hardware upgrades, failures and network outages are easier to recover from</li>
</ul>
<p>To support multiple hosts, the definition files need to be copied and updated on each host in advance:</p>
<ol>
<li>The VM definition file, located in /etc/libvirt/qemu/<VM Name>.xml</li>
<li>The storage pool definition file, located in /etc/libvirt/storage/<storage pool name>.xml</li>
<li>A virtual bridge definition file, located in /etc/netplan for Ubuntu or /etc/nmstate for RedHat</li>
</ol>
<p>Define a storage pool at the host level and it will mount the NFS volume when libvirtd systemd process starts.</p>
<p>The Source is your NFS client mount as exposed by the NFS server.</p>
<p>The Target is your local NFS client directory to mount it on.</p>
<p>The Name is what you use with virsh/Cockpit to add Storage Volumes (logical disks) to the VM.</p>
<p>File: /etc/libvirt/storage/my_vm01.xml </p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!--</span>
<span class="cm">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span>
<span class="cm">OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:</span>
<span class="cm">  virsh pool-edit my_vm_pool</span>
<span class="cm">or other application using the libvirt API.</span>
<span class="cm">--&gt;</span>

<span class="nt">&lt;pool</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;netfs&#39;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;name&gt;</span>my_vm_pool<span class="nt">&lt;/name&gt;</span>
<span class="w">  </span><span class="nt">&lt;uuid&gt;</span>7c847772-0565-4d26-a3bc-46e4634fb84f<span class="nt">&lt;/uuid&gt;</span>
<span class="w">  </span><span class="nt">&lt;capacity</span><span class="w"> </span><span class="na">unit=</span><span class="s">&#39;bytes&#39;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/capacity&gt;</span>
<span class="w">  </span><span class="nt">&lt;allocation</span><span class="w"> </span><span class="na">unit=</span><span class="s">&#39;bytes&#39;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/allocation&gt;</span>
<span class="w">  </span><span class="nt">&lt;available</span><span class="w"> </span><span class="na">unit=</span><span class="s">&#39;bytes&#39;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/available&gt;</span>
<span class="w">  </span><span class="nt">&lt;source&gt;</span>
<span class="w">    </span><span class="nt">&lt;host</span><span class="w"> </span><span class="na">name=</span><span class="s">&#39;192.168.1.65&#39;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;dir</span><span class="w"> </span><span class="na">path=</span><span class="s">&#39;/mnt/vol032/vm_data/&#39;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;format</span><span class="w"> </span><span class="na">type=</span><span class="s">&#39;auto&#39;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/source&gt;</span>
<span class="w">  </span><span class="nt">&lt;target&gt;</span>
<span class="w">    </span><span class="nt">&lt;path&gt;</span>/vm_data/<span class="nt">&lt;/path&gt;</span>
<span class="w">  </span><span class="nt">&lt;/target&gt;</span>
<span class="nt">&lt;/pool&gt;</span>
</code></pre></div>

<p>Copy or create your Storage Volumes to the <code>dir path</code> on the NFS server, then add them via virsh/Cockpit.</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> Create Volume
<span class="gh">#</span>
sudo virsh vol-create-as my_vm_pool test_vol2.qcow2 2G
<span class="gh">#</span>    my_vm_pool: Is the pool name.
<span class="gh">#</span>    test_vol2: This is the name of the volume.
<span class="gh">#</span>    2G: This is the storage capacity of the volume.
<span class="gh">#</span>
# List volumes
<span class="gh">#</span>
$ sudo virsh vol-list --pool my_vm_pool --details
 Name               Path                        Type   Capacity    Allocation
-----------------------------------------------------------------------------
 test_vol02.qcow2   /vm_data/test_vol02.qcow2   file   2.00 GiB    0.65 GiB
</code></pre></div>

<p>Reference:</p>
<ul>
<li>/etc/libvirt/storage/<pool name>.xml</li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/managing-storage-for-virtual-machines_configuring-and-managing-virtualization#proc_creating-nfs-based-storage-pools-using-the-web-console_assembly_managing-virtual-machine-storage-pools-using-the-web-console">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_virtualization/managing-storage-for-virtual-machines_configuring-and-managing-virtualization#proc_creating-nfs-based-storage-pools-using-the-web-console_assembly_managing-virtual-machine-storage-pools-using-the-web-console</a>* </li>
</ul>
<h2 id="clone-virtual-machine">Clone Virtual Machine</h2>
<p>1st clone:</p>
<ul>
<li>Create vlan on 1st ethernet adapter (ensure network switch support vlans) [1]</li>
<li>Add NFS mount, if not already there [2]</li>
<li>Create nmstate bridge virbr0 on 2nd ethernet adapter (can use USB/Ethernet adapter) [3]</li>
<li>Re-create 1st adapter as fixed address in nmstate [4]</li>
<li>Create storage pool as type NFS, using Cockpit [5]</li>
<li>Import VM, using storage pool data as nfs, using Cockpit</li>
<li>Delete <em>default</em> VM network using Cockpit</li>
<li>Create VM network <em>bridge</em> on VM (use host's virbr0), using Cockpit</li>
<li>Change /etc/nmstate/<em>.applied to </em>.yml, reboot to get route working</li>
<li>Change owner of Storage Volume to <em>libvirtd-qemu</em> for Debian or <em>qemu</em> for RedHat on NAS</li>
</ul>
<blockquote>
<p>It really helps to use a secondary network adapter, because the routing will be lost to the main IP and you have to use the console to get it back. Also one adapter can handle the NFS traffic while the other handles the VM traffic.</p>
</blockquote>
<ol>
<li>
<p><a href="/virtualip.html">vlan</a></p>
</li>
<li>
<p><a href="/nas.html#connect-to-nfs-server-from-linux-client">nfs</a></p>
</li>
<li>
<p><a href="/virtualmachines.html#network-on-a-virtual-machine">Network on a virtual machine</a></p>
</li>
<li>
<p>Fixed IP address; servers should have this</p>
</li>
</ol>
<p>File: /etc/nmstate/40-create-eno1.yml </p>
<div class="highlight"><pre><span></span><code><span class="o">---</span>
<span class="nx">interfaces</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">eno1</span>
<span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="nx">ethernet</span>
<span class="w">  </span><span class="nx">state</span><span class="p">:</span><span class="w"> </span><span class="nx">up</span>
<span class="w">  </span><span class="nx">ipv4</span><span class="p">:</span>
<span class="w">    </span><span class="nx">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="nx">address</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">ip</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">192.168.1.12</span>
<span class="w">      </span><span class="nx">prefix</span><span class="o">-</span><span class="nx">length</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span>
<span class="w">    </span><span class="nx">dhcp</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="nx">ipv6</span><span class="p">:</span>
<span class="w">    </span><span class="nx">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>

<span class="nx">routes</span><span class="p">:</span>
<span class="w">  </span><span class="nx">config</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nx">destination</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>
<span class="w">    </span><span class="nx">next</span><span class="o">-</span><span class="nx">hop</span><span class="o">-</span><span class="kd">interface</span><span class="p">:</span><span class="w"> </span><span class="nx">eno1</span>
<span class="w">    </span><span class="nx">next</span><span class="o">-</span><span class="nx">hop</span><span class="o">-</span><span class="nx">address</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">192.168.1.1</span>

<span class="nx">dns</span><span class="o">-</span><span class="nx">resolver</span><span class="p">:</span>
<span class="w">  </span><span class="nx">config</span><span class="p">:</span>
<span class="w">    </span><span class="nx">search</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>
<span class="w">    </span><span class="nx">server</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="m m-Double">1.1.1.1</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="m m-Double">8.8.8.8</span>
</code></pre></div>

<p>Apply change:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>nmstatectl<span class="w"> </span>apply<span class="w"> </span>/etc/nmstate/40-create-eno1.yml
</code></pre></div>

<ol>
<li><a href="/virtualmachines.html#virtual-storage-pools-on-nfs">VM NFS Storage Pool</a></li>
</ol>
<h3 id="copy-data-files">Copy Data Files</h3>
<p>Now the easy part.</p>
<ol>
<li>Stop the VM on the old host, using Cockpit. <strong>Remember to disable autostart!</strong></li>
<li>Copy the Storage Pool data file(s) to your NFS mount, if not already done.</li>
<li>Start your VM on the new host, and enjoy!</li>
</ol>
<p>In the future you can just stop the VM on the old host, then start the new VM on the new host, assuming they are both on NFS..</p>
<blockquote>
<p><strong>Remember to disable autostart on the Storage Pool and VM on the old host!</strong> If 'Failed to get "write" lock, Is another process using the image [/data_vm/data01]?', make sure other host has stopped VM and storage pool.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>virsh<span class="w"> </span>pool-autostart<span class="w"> </span>--disable<span class="w"> </span>my_vm01
Pool<span class="w"> </span>my_vm01<span class="w"> </span>unmarked<span class="w"> </span>as<span class="w"> </span>autostarted
</code></pre></div>

<h2 id="if-the-ip-address-changed-in-the-vm">If the IP Address changed in the VM</h2>
<ul>
<li>Copy new SSH keys with new IP address (delete old on remote)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> SSH Copy
$ ssh-copy-id &lt;remote IP&gt;

<span class="gh">#</span> SSH Delete
$ ssh &lt;remote IP&gt; grep -n &lt;remote IP&gt; ~/.ssh/known_hosts
2:192.168.1.4 ssh-rsa 
</code></pre></div>

<blockquote>
<p>Delete line number 2 in file ~/.ssh/known_hosts on host <remote IP></p>
</blockquote>
<ul>
<li>
<p>Edit apache configuration to reflect new IP address (File: /etc/httpd/conf/httpd.conf)</p>
</li>
<li>
<p>Edit Nextcloud configuration, to add IP address to list of trusted hosts (File: /var/www/nextcloud/config/config.php)</p>
</li>
</ul>
<blockquote>
<p>Restart apache to pick up changes <code>sudo systemctl restart httpd</code></p>
</blockquote>
<h2 id="configuration-files">Configuration Files</h2>
<div class="highlight"><pre><span></span><code><span class="n">/etc/libvirt</span>
<span class="n">├── hooks</span>
<span class="n">├── libvirt-admin.conf</span>
<span class="n">├── libvirt.conf</span>
<span class="n">├── libvirtd.conf</span>
<span class="n">├── libxl.conf</span>
<span class="n">├── libxl-lockd.conf</span>
<span class="n">├── libxl-sanlock.conf</span>
<span class="n">├── lxc.conf</span>
<span class="n">├── nwfilter</span>
<span class="n">│   ├── allow-arp.xml</span>
<span class="n">│   ├── allow-dhcp-server.xml</span>
<span class="n">│   ├── allow-dhcpv6-server.xml</span>
<span class="n">│   ├── allow-dhcpv6.xml</span>
<span class="n">│   ├── allow-dhcp.xml</span>
<span class="n">│   ├── allow-incoming-ipv4.xml</span>
<span class="n">│   ├── allow-incoming-ipv6.xml</span>
<span class="n">│   ├── allow-ipv4.xml</span>
<span class="n">│   ├── allow-ipv6.xml</span>
<span class="n">│   ├── clean-traffic-gateway.xml</span>
<span class="n">│   ├── clean-traffic.xml</span>
<span class="n">│   ├── no-arp-ip-spoofing.xml</span>
<span class="n">│   ├── no-arp-mac-spoofing.xml</span>
<span class="n">│   ├── no-arp-spoofing.xml</span>
<span class="n">│   ├── no-ip-multicast.xml</span>
<span class="n">│   ├── no-ip-spoofing.xml</span>
<span class="n">│   ├── no-ipv6-multicast.xml</span>
<span class="n">│   ├── no-ipv6-spoofing.xml</span>
<span class="n">│   ├── no-mac-broadcast.xml</span>
<span class="n">│   ├── no-mac-spoofing.xml</span>
<span class="n">│   ├── no-other-l2-traffic.xml</span>
<span class="n">│   ├── no-other-rarp-traffic.xml</span>
<span class="n">│   ├── qemu-announce-self-rarp.xml</span>
<span class="n">│   └── qemu-announce-self.xml</span>
<span class="n">├── qemu</span>
<span class="n">│   ├── autostart</span>
<span class="n">│   │   └── my_vm01.xml -&gt; /etc/libvirt/qemu/my_vm01.xml</span>
<span class="n">│   ├── my_vm01.xml</span>
<span class="n">│   ├── my_vm02.xml</span>
<span class="n">│   ├── networks</span>
<span class="n">│   │   ├── autostart</span>
<span class="n">│   │   └── default.xml</span>
<span class="n">│   └── test_vm42.xml</span>
<span class="n">├── qemu.conf</span>
<span class="n">├── qemu-lockd.conf</span>
<span class="n">├── qemu-sanlock.conf</span>
<span class="n">├── secrets</span>
<span class="n">├── storage</span>
<span class="n">│   ├── autostart</span>
<span class="n">│   │   └── my_vm01.xml -&gt; /etc/libvirt/storage/my_vm01.xml</span>
<span class="n">│   ├── my_vm01.xml</span>
<span class="n">│   └── my_vm02.xml</span>
<span class="n">├── virtlockd.conf</span>
<span class="n">└── virtlogd.conf</span>

<span class="n">9 directories, 45 files</span>
</code></pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://lwn.net/">Linux Weekly News</a></li>
                            <li><a href="https://fullcirclemagazine.org/">Full Circle Magazine</a></li>
                            <li><a href="https://www.linuxjournal.com/">Linux Journal</a></li>
                            <li><a href="https://www.linux-magazine.com/">Linux Magazine</a></li>
                            <li><a href="https://www.thefarside.com/">The Far Side</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://dfcsoftware.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://fosstodon.org/@LinuxintheHouse">Feedback</a></li>
                            <li><a href="https://fosstodon.org/@LinuxintheHouse.rss">Mastodon RSS feed</a></li>
                            <li><a href="https://linux-in-the-house.pages.dev/">Book</a></li>
                            <li><a href="/author/don-cohoon.html">Created by: Don Cohoon</a></li>
                            <li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License </a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>
                Site by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, via <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </p><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                <p> Version:  3.40 </p>
        </footer><!-- /#contentinfo -->

</body>
</html>